<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartRound_Sequential.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._1880</a> &gt; <span class="el_source">StartRound_Sequential.java</span></div><h1>StartRound_Sequential.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package net.sf.rails.game.specific._1880;


import net.sf.rails.common.DisplayBuffer;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.Player;
import net.sf.rails.game.StartItem;
import net.sf.rails.game.StartRound;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.Certificate;
import net.sf.rails.game.state.ArrayListState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.GenericState;
import rails.game.action.*;

/**
 * @author Martin
 * 
 * Rails 2.0: OK
 * 
 */
public class StartRound_Sequential extends StartRound {

<span class="fc" id="L29">    private final GenericState&lt;Player&gt; startingPlayer =</span>
<span class="fc" id="L30">            GenericState.create(this, &quot;startingPlayer&quot;);</span>
<span class="fc" id="L31">    private final GenericState&lt;StartItem&gt; currentItem =</span>
<span class="fc" id="L32">            GenericState.create(this, &quot;currentItem&quot;);</span>
<span class="fc" id="L33">    private final ArrayListState&lt;Player&gt; passedPlayers = </span>
<span class="fc" id="L34">            ArrayListState.create(this, &quot;passedPlayers&quot;);</span>

    public StartRound_Sequential(GameManager parent, String id) {
<span class="fc" id="L37">        super(parent, id, true, false, false);</span>
        // bidding yes, but no base prices and buying
<span class="fc" id="L39">    }</span>

    @Override
    public void start() {
<span class="fc" id="L43">        super.start();</span>

        // crude fix for StartItem hardcoded SetMinimumbid ignoring the initial
        // value out of the XMLs....
        // FIXME: Is this undo proof?
<span class="fc bfc" id="L48" title="All 2 branches covered.">        for (StartItem item : startPacket.getItems()) {</span>
<span class="fc" id="L49">            item.setMinimumBid(item.getBasePrice());</span>
<span class="fc" id="L50">        }</span>

<span class="fc" id="L52">        startingPlayer.set(playerManager.getCurrentPlayer());</span>
<span class="fc" id="L53">        setPossibleActions();</span>
<span class="fc" id="L54">    }</span>

    private void updateBiddingItem() {
<span class="fc" id="L57">        StartItem firstUnsoldItem = startPacket.getFirstUnsoldItem();</span>
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (firstUnsoldItem == null) {</span>
<span class="nc" id="L59">            finishRound();</span>
<span class="fc bfc" id="L60" title="All 2 branches covered.">        } else if (currentItem.value() != firstUnsoldItem) {</span>
<span class="fc bfc" id="L61" title="All 2 branches covered.">            if (currentItem.value() != null) {</span>
<span class="fc" id="L62">                setNextStartingPlayer();</span>
            }
<span class="fc" id="L64">            currentItem.set(firstUnsoldItem);</span>
<span class="fc" id="L65">            currentItem.value().setStatus(StartItem.BIDDABLE);</span>
<span class="fc" id="L66">            passedPlayers.clear();</span>
        }        
<span class="fc" id="L68">    }</span>

    private void setNextBiddingPlayer() {
<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        for (Player p: playerManager.getNextPlayers(false)) {</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">            if (!passedPlayers.contains(p)) {</span>
                // TODO: What happens if all players have passed?
<span class="fc" id="L74">                playerManager.setCurrentPlayer(p);</span>
<span class="fc" id="L75">                break;</span>
            }
<span class="fc" id="L77">        }</span>
<span class="fc" id="L78">    }</span>

    private void setNextStartingPlayer() {
<span class="fc" id="L81">        Player nextPlayer = playerManager.getNextPlayerAfter(startingPlayer.value());</span>
<span class="fc" id="L82">        startingPlayer.set(nextPlayer);</span>
<span class="fc" id="L83">        playerManager.setCurrentPlayer(nextPlayer);</span>
<span class="fc" id="L84">    }</span>

    @Override
    public boolean setPossibleActions() {
<span class="fc" id="L88">        updateBiddingItem();</span>

<span class="fc bfc" id="L90" title="All 2 branches covered.">        if (playerManager.getCurrentPlayer() == startPlayer) {</span>
<span class="fc" id="L91">            ReportBuffer.add(this,&quot;&quot;);</span>
        }

<span class="pc bpc" id="L94" title="1 of 2 branches missed.">        if (currentItem != null) {</span>
<span class="pc bpc" id="L95" title="1 of 2 branches missed.">            if (playerManager.getCurrentPlayer().getCash() &gt;= currentItem.value().getMinimumBid()) {</span>
<span class="fc" id="L96">                possibleActions.add(new BidStartItem(currentItem.value(),</span>
<span class="fc" id="L97">                        currentItem.value().getMinimumBid(), startPacket.getModulus(), true));</span>
            }
<span class="fc" id="L99">            possibleActions.add(new NullAction(NullAction.Mode.PASS));</span>
        }
        
<span class="fc" id="L102">        return true;</span>
    }
    
    @Override
    protected boolean bid(String playerName, BidStartItem bidItem) {
<span class="fc" id="L107">        Player player = playerManager.getPlayerByName(playerName);</span>
<span class="fc" id="L108">        int bidAmount = bidItem.getActualBid();</span>

<span class="pc bpc" id="L110" title="1 of 2 branches missed.">        if (validateBid(playerName, bidItem) != true) {</span>
<span class="nc" id="L111">            return false;</span>
        }

<span class="fc bfc" id="L114" title="All 2 branches covered.">        if (currentItem.value().getBid(player) &gt; 0) {</span>
<span class="fc" id="L115">            player.unblockCash(currentItem.value().getBid(player));</span>
        }
             
<span class="fc" id="L118">        currentItem.value().setBid(bidAmount, player);</span>
<span class="fc" id="L119">        player.blockCash(bidAmount);</span>

<span class="fc" id="L121">        ReportBuffer.add(this, LocalText.getText(&quot;BID_ITEM_LOG&quot;,</span>
                playerName,
<span class="fc" id="L123">                Bank.format(this,bidAmount),</span>
<span class="fc" id="L124">                bidItem.getStartItem().getId(),</span>
<span class="fc" id="L125">                Bank.format(this,player.getFreeCash())));        </span>
        
<span class="pc bpc" id="L127" title="1 of 2 branches missed.">        if ((passedPlayers.size() == (getRoot().getPlayerManager().getNumberOfPlayers() - 1))</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            &amp;&amp; (currentItem.value().getBidder() != null)) {</span>
        // One player has bid, everyone else has passed.
<span class="nc" id="L130">            assignItem(currentItem.value().getBidder(), currentItem.value(),</span>
<span class="nc" id="L131">                    currentItem.value().getBid());</span>
        } else {
<span class="fc" id="L133">            setNextBiddingPlayer();</span>
        }
<span class="fc" id="L135">        return true;</span>
    }
    
    private boolean validateBid(String playerName, BidStartItem bidItem) {
<span class="fc" id="L139">        String errMsg = null;</span>

        while (true) {
            // Check player
<span class="pc bpc" id="L143" title="1 of 2 branches missed.">            if (!playerName.equals(playerManager.getCurrentPlayer().getId())) {</span>
<span class="nc" id="L144">                errMsg = LocalText.getText(&quot;WrongPlayer&quot;, playerName, playerManager.getCurrentPlayer().getId());</span>
<span class="nc" id="L145">                break;</span>
            }

            // Is the current item correct?
<span class="pc bpc" id="L149" title="1 of 2 branches missed.">            if (currentItem.value() != bidItem.getStartItem()) {</span>
<span class="nc" id="L150">                errMsg = LocalText.getText(&quot;WrongItem&quot;, playerName, playerManager.getCurrentPlayer().getId());</span>
<span class="nc" id="L151">                break;</span>
            }
            
            // Check item
<span class="fc" id="L155">            boolean validItem = false;</span>
<span class="pc bpc" id="L156" title="1 of 2 branches missed.">            for (StartItemAction activeItem : possibleActions.getType(StartItemAction.class)) {</span>
<span class="pc bpc" id="L157" title="1 of 2 branches missed.">                if (bidItem.equalsAsOption(activeItem)) {</span>
<span class="fc" id="L158">                    validItem = true;</span>
<span class="fc" id="L159">                    break;</span>
                }
<span class="nc" id="L161">            }</span>
            
<span class="pc bpc" id="L163" title="1 of 2 branches missed.">            if (!validItem) {</span>
<span class="nc" id="L164">                errMsg = LocalText.getText(&quot;ActionNotAllowed&quot;, bidItem.toString());</span>
<span class="nc" id="L165">                break;</span>
            }

            // Is the item buyable?
<span class="pc bpc" id="L169" title="1 of 2 branches missed.">            if (bidItem.getStatus() != StartItem.BIDDABLE) {</span>
<span class="nc" id="L170">                errMsg = LocalText.getText(&quot;NotForSale&quot;);</span>
<span class="nc" id="L171">                break;</span>
            }

            // Bid must be at least 5 above last bid
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">            if (bidItem.getActualBid() &lt; currentItem.value().getMinimumBid()) {</span>
<span class="nc" id="L176">                errMsg = LocalText.getText(&quot;BidTooLow&quot;, &quot;&quot; + currentItem.value().getMinimumBid());</span>
<span class="nc" id="L177">                break;</span>
            }

            // Bid must be a multiple of the modulus
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">            if (bidItem.getActualBid() % startPacket.getModulus() != 0) {</span>
<span class="nc" id="L182">                errMsg = LocalText.getText(&quot;BidMustBeMultipleOf&quot;, bidItem.getActualBid(),</span>
<span class="nc" id="L183">                        startPacket.getMinimumIncrement());</span>
<span class="nc" id="L184">                break;</span>
            }

        // Has the buyer enough cash?
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">            if (bidItem.getActualBid() &gt; playerManager.getCurrentPlayer().getCash()) {</span>
<span class="nc" id="L189">                errMsg = LocalText.getText(&quot;BidTooHigh&quot;, Bank.format(this, bidItem.getActualBid()));</span>
<span class="nc" id="L190">                break;</span>
            }

        break;
        }

<span class="pc bpc" id="L196" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L197">            DisplayBuffer.add(this, LocalText.getText(&quot;InvalidBid&quot;,</span>
                    playerName,
<span class="nc" id="L199">                    currentItem.value().getId(),</span>
                    errMsg ));
<span class="nc" id="L201">            return false;</span>
        }

<span class="fc" id="L204">        return true;</span>
    }

    @Override
    protected boolean pass(NullAction action, String playerName) {
<span class="fc" id="L209">        Player player = playerManager.getPlayerByName(playerName);</span>

<span class="pc bpc" id="L211" title="1 of 2 branches missed.">        if (validatePass(playerName) != true) {</span>
<span class="nc" id="L212">            return false;</span>
        }

<span class="fc" id="L215">        ReportBuffer.add(this, LocalText.getText(&quot;PASSES&quot;, playerName));</span>
        
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (currentItem.value().getBid(player) &gt; 0) {</span>
<span class="fc" id="L218">            player.unblockCash(currentItem.value().getBid(player));</span>
        }

<span class="fc" id="L221">        currentItem.value().setPass(player);</span>
<span class="fc" id="L222">        passedPlayers.add(player);</span>
        
<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (passedPlayers.size() == playerManager.getNumberOfPlayers()) {</span>
        // All players have passed - reduce price or run an operating round
<span class="nc" id="L226">            ReportBuffer.add(this, LocalText.getText(&quot;ALL_PASSED&quot;));</span>
<span class="nc bnc" id="L227" title="All 2 branches missed.">            if (currentItem.value().getNoBidsReaction() == StartItem.NoBidsReaction.REDUCE_AND_REBID) {</span>
<span class="nc" id="L228">                currentItem.value().reduceBasePriceBy(5); // TODO: Make not 5</span>
                // If the price was reduced to 0, assign the company to the starting bidder instead
<span class="nc bnc" id="L230" title="All 2 branches missed.">                if (currentItem.value().getBasePrice() == 0) {</span>
<span class="nc" id="L231">                    assignItem((Player) startingPlayer.value(), currentItem.value(), 0);</span>
                } else {
<span class="nc" id="L233">                    ReportBuffer.add(this, LocalText.getText(</span>
                            &quot;ITEM_PRICE_REDUCED&quot;,
<span class="nc" id="L235">                                    currentItem.value().getId(),</span>
<span class="nc" id="L236">                                    Bank.format(this, startPacket.getFirstItem().getBasePrice()) ));</span>
<span class="nc" id="L237">                    currentItem.value().setMinimumBid(currentItem.value().getBasePrice());</span>
<span class="nc" id="L238">                    passedPlayers.clear();</span>
<span class="nc" id="L239">                    setNextBiddingPlayer();</span>
                }
            } else {
<span class="nc" id="L242">                gameManager.reportAllPlayersPassed();</span>
<span class="nc" id="L243">                passedPlayers.clear();</span>
<span class="nc" id="L244">                finishRound(); // TODO: Can this work?  How will it know to not start second start round?</span>
            }
<span class="fc bfc" id="L246" title="All 2 branches covered.">        } else if ((passedPlayers.size() == (getRoot().getPlayerManager().getNumberOfPlayers() - 1))</span>
<span class="pc bpc" id="L247" title="1 of 2 branches missed.">            &amp;&amp; (currentItem.value().getBidder() != null)) {</span>
        // One player has bid, everyone else has passed.
<span class="fc" id="L249">            assignItem(currentItem.value().getBidder(), currentItem.value(), currentItem.value().getBid()); // Could re-assign starting player...</span>
        } else {
        // There are other players yet to bid
<span class="fc" id="L252">            setNextBiddingPlayer();     </span>
        }
<span class="fc" id="L254">        return true;</span>
    }

    private boolean validatePass(String playerName) {
<span class="pc bpc" id="L258" title="1 of 2 branches missed.">        if (!playerName.equals(playerManager.getCurrentPlayer().getId())) {</span>
<span class="nc" id="L259">                DisplayBuffer.add(this, LocalText.getText(&quot;InvalidPass&quot;, playerName,</span>
<span class="nc" id="L260">                        LocalText.getText(&quot;WrongPlayer&quot;, playerName, playerManager.getCurrentPlayer().getId())));</span>
<span class="nc" id="L261">                return false;</span>
            }
<span class="fc" id="L263">        return true;</span>
    }

    protected void assignItem(Player player, StartItem item, int price) {
<span class="fc" id="L267">        Certificate primary = item.getPrimary();</span>
<span class="fc" id="L268">        Currency.toBank(player, price);</span>
<span class="fc" id="L269">        primary.moveTo(player);</span>
<span class="fc" id="L270">        item.setSold(player, price);</span>
<span class="fc" id="L271">        ReportBuffer.add(this, LocalText.getText(&quot;BuysItemFor&quot;,</span>
<span class="fc" id="L272">                player.getId(),</span>
<span class="fc" id="L273">                primary.toText(),</span>
<span class="fc" id="L274">                Bank.format(this, price) ));</span>
<span class="fc" id="L275">        itemAssigned(player, item, price);</span>
<span class="fc" id="L276">    }</span>
    
    protected void itemAssigned(Player player, StartItem item, int price) {
<span class="nc" id="L279">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>