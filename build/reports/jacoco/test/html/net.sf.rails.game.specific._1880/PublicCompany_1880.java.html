<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PublicCompany_1880.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._1880</a> &gt; <span class="el_source">PublicCompany_1880.java</span></div><h1>PublicCompany_1880.java</h1><pre class="source lang-java linenums">/**
 * 
 */
package net.sf.rails.game.specific._1880;

import java.util.ArrayList;
import java.util.List;
import java.util.Set;

import com.google.common.collect.ImmutableSet;

import net.sf.rails.algorithms.RevenueAdapter;
import net.sf.rails.algorithms.RevenueStaticModifier;
import net.sf.rails.common.parser.ConfigurationException;
import net.sf.rails.common.parser.Tag;
import net.sf.rails.game.CompanyManager;
import net.sf.rails.game.MapHex;
import net.sf.rails.game.Phase;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.RailsItem;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.financial.StockSpace;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.IntegerState;
import net.sf.rails.game.state.Owner;
import net.sf.rails.common.GuiDef;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;


public class PublicCompany_1880 extends PublicCompany implements RevenueStaticModifier {


    /** 
     *  Buildingrights belong to Phases in 1880 the player will be asked to choose which combination
     *   he wants and subsequently his company will be granted the appropriate rightsModel. Further the value
     *  of the presidents share depends on the building right.
     *  A Player has the maximum of 3 phases without the use of a special power of a certain private paper.
     *  Example : A) Player chooses to build in Phase A+B+C (or B+C+D) this will lead to a president share value of 20%
     *            B) Player chooses to build in Phase A+B (or B+C or C+D) this will lead to a president share value of 30 %
     *            C) Player chooses to build in Phase A (or B or C or D) this will lead to a president share value of 40 %
     *    The BitSet BuildingRights should be able to handle the information :
     *    Bit 1 set True Player can build in Phase A
     *    Bit 2 set True Player can build in Phase B
     *    Bit 3 set True Player can build in Phase C
     *    Bit 4 set True Player can build in Phase D
     *    
     */
<span class="fc" id="L52">    private BuildingRights_1880 buildingRights = new BuildingRights_1880(this, &quot;buildingRights&quot;); </span>
   
    //Implementation of PhaseAction to be able to handle the CommunistPhase
<span class="fc" id="L55">    private BooleanState canStockPriceMove = BooleanState.create(this, &quot;canStockPriceMove&quot;, true);</span>
<span class="fc" id="L56">    private BooleanState canPresidentSellShare = BooleanState.create(this, &quot;canPresidentSellShare&quot;, true);</span>
            
<span class="fc" id="L58">    private BooleanState allCertsAvail = BooleanState.create(this, &quot;allCertsAvail&quot;, false);</span>
    
<span class="fc" id="L60">    private BooleanState fullyCapitalized = BooleanState.create(this, &quot;fullyCapitalized&quot;, false);</span>
<span class="fc" id="L61">    private BooleanState fullCapitalAvailable = BooleanState.create (this, &quot;fullCapitalAvailable&quot;, false);</span>
<span class="fc" id="L62">    private int extraCapital = 0; // Just one Change at Start of the game, can stay as it is..</span>
    
    protected IntegerState formationOrderIndex;
    
<span class="fc" id="L66">    protected IntegerState operationSlotIndex = IntegerState.create(this,&quot;OperatingSlot&quot;, 0);</span>
  
    /**
     * 
     */
    public PublicCompany_1880(RailsItem parent, String Id) {
<span class="fc" id="L72">        super(parent, Id);</span>
<span class="fc" id="L73">    }</span>
    
    public void start(StockSpace startSpace) {
<span class="fc" id="L76">        extraCapital = 5 * (startSpace.getPrice());</span>
<span class="fc" id="L77">        super.start(startSpace);</span>
<span class="fc" id="L78">    }</span>

    /* (non-Javadoc)
     * @see rails.game.PublicCompany#configureFromXML(rails.common.parser.Tag)
     */
    @Override
    public void configureFromXML(Tag tag) throws ConfigurationException {
<span class="fc" id="L85">        super.configureFromXML(tag);</span>
<span class="fc" id="L86">    }</span>
    
    
    /* (non-Javadoc)
     * @see rails.game.PublicCompany#finishConfiguration(rails.game.GameManagerI)
     */
    @Override
    public void finishConfiguration(RailsRoot root)
            throws ConfigurationException {
<span class="fc" id="L95">        super.finishConfiguration(root);</span>
<span class="fc" id="L96">        root.getGameManager().setGuiParameter (GuiDef.Parm.HAS_ANY_RIGHTS, true);</span>
<span class="fc" id="L97">        root.getRevenueManager().addStaticModifier(this);</span>
<span class="fc" id="L98">    }</span>

    /**
     * @param buildingRights the buildingRights to set
     */
    public void setBuildingRights(String buildingRights) {
<span class="fc" id="L104">        this.buildingRights.set(buildingRights);</span>
<span class="fc" id="L105">    }</span>

    public void addBuildingPermit(String permitName) {
<span class="nc" id="L108">        buildingRights.set(buildingRights.toText() + &quot;+&quot; + permitName);</span>
<span class="nc" id="L109">    }</span>

    
    public boolean modifyCalculator(RevenueAdapter revenueAdapter) {
<span class="nc" id="L113">        return false;</span>
    }

    public void stockPriceCanMove() {
<span class="fc" id="L117">        canStockPriceMove.set(true);</span>
<span class="fc" id="L118">    }</span>
        
    public void stockPriceCannotMove() {
<span class="fc" id="L121">        canStockPriceMove.set(false);</span>
<span class="fc" id="L122">    }</span>
    
    public boolean canStockPriceMove() {
<span class="fc" id="L125">        return (canStockPriceMove.value());</span>
    }

    /** Don't move the space if the company is withholding train income during the CommunistPhase
     * 
     */
    @Override
    public void withhold(int amount) {
<span class="fc bfc" id="L133" title="All 2 branches covered.">        if (canStockPriceMove.value() == true)  {</span>
<span class="fc" id="L134">            getRoot().getStockMarket().withhold(this);</span>
        }
<span class="fc" id="L136">    }</span>
    
    public void payout(int amount) {
<span class="fc bfc" id="L139" title="All 2 branches covered.">        if (canStockPriceMove.value() == true)  {</span>
<span class="fc" id="L140">            getRoot().getStockMarket().payOut(this);</span>
        }
<span class="fc" id="L142">    }</span>

    public void presidentCanSellShare() {
<span class="fc" id="L145">        canPresidentSellShare.set(true);</span>
<span class="fc" id="L146">    }</span>
        
    public void presidentCannotSellShare() {
<span class="fc" id="L149">        canPresidentSellShare.set(false);</span>
<span class="fc" id="L150">    }</span>
    
    public boolean canPresidentSellShare() {
<span class="fc" id="L153">        return (canPresidentSellShare.value());</span>
    }


    public void setFloatPercentage(int i) {
<span class="fc" id="L158">        this.floatPerc=i;</span>
        
<span class="fc" id="L160">    }</span>
    
    @Override
    public boolean canRunTrains() {
<span class="fc bfc" id="L164" title="All 2 branches covered.">        return portfolio.getNumberOfTrains() &gt; 0;       </span>
    }
    
    /* (non-Javadoc)
     * @see rails.game.PublicCompany#getNumberOfTileLays(java.lang.String)
     */
    @Override
    public int getNumberOfTileLays(String tileColour) {
<span class="fc" id="L172">        Phase phase = getRoot().getPhaseManager().getCurrentPhase();</span>
        
<span class="fc bfc" id="L174" title="All 4 branches covered.">         if ((tileColour.equals(&quot;yellow&quot;)) &amp;&amp; (this.getId().equals(&quot;BCR&quot;))) {</span>
<span class="fc" id="L175">             return 2;</span>
         }
<span class="fc" id="L177">         int tileLays = phase.getTileLaysPerColour(getType().getId(), tileColour);</span>
<span class="fc bfc" id="L178" title="All 2 branches covered.">             if (tileLays &lt;= 1) {</span>
<span class="fc" id="L179">                 extraTiles.set(null);</span>
<span class="fc" id="L180">                 return tileLays;</span>
                 }
            // More than one tile lay allowed.
<span class="fc" id="L183">             return tileLays;</span>
     }

    
    /* (non-Javadoc)
     * @see rails.algorithms.RevenueStaticModifier#prettyPrint(rails.algorithms.RevenueAdapter)
     */
    public String prettyPrint(RevenueAdapter revenueAdapter) {
<span class="nc" id="L191">        return null;</span>
    }
    
    /*
     * @param Phase
     */
    public boolean hasBuildingRightForPhase(Phase phase) {
<span class="fc" id="L198">        return buildingRights.canBuildInPhase(phase);</span>
    }
    
    /*
     * If we have a different president share percentage we have to remove the old certificate structure 
     * and rebuild a new structure. There will be no subsequent certificate alterations in 1880.
     * 
     * @author Martin Brumm
     * @param percentage
     * 
     * To be called from the StartRound_1880 / StockRoundWindow_1880
     */
    // TODO: Rails 2.0 Check if this is not too complicated and raises problems with undo
    public void setPresidentShares(int percentage) {
<span class="nc" id="L212">        int share = 0;</span>
        
        //Create a new President Certificate with the shares (percentage)
<span class="nc" id="L215">        PublicCertificate certificate = new PublicCertificate(this, &quot;President&quot;, (percentage/10), true,</span>
                true, 1.0f, 0);
        
        //we need to bring that Certificate to the List, do we have to place it at a specific place ? I hope not...
<span class="nc" id="L219">        Owner scrapHeap = getRoot().getBank().getScrapHeap();</span>
<span class="nc bnc" id="L220" title="All 2 branches missed.">        for (PublicCertificate cert : certificates.view()) {</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">            if (cert.isPresidentShare()) { // get the president share and remove that...</span>
<span class="nc" id="L222">                cert.moveTo(scrapHeap);</span>
<span class="nc" id="L223">                certificates.remove(cert);</span>
<span class="nc bnc" id="L224" title="All 2 branches missed.">            } else if (share &gt;= (100-(percentage) )) {</span>
<span class="nc" id="L225">                    cert.moveTo(scrapHeap);</span>
<span class="nc" id="L226">                    certificates.remove(cert);</span>
            } else {
<span class="nc" id="L228">                    cert.setCertificateCount(1.0f);</span>
<span class="nc" id="L229">                    share += cert.getShare();</span>
            }
             
<span class="nc" id="L232">        }</span>
        //Now add the new president share to the list ; do we have to call namecertificates ?
        
<span class="nc" id="L235">        certificates.add(0,certificate); //Need to make sure the new share is at position 0 !</span>
<span class="nc" id="L236">        nameCertificates(); //Just to be sure..</span>
        PublicCertificate cert;
<span class="nc bnc" id="L238" title="All 2 branches missed.">        for (int i = 0; i &lt; certificates.size(); i++) {</span>
<span class="nc" id="L239">            cert = certificates.get(i);</span>
<span class="nc" id="L240">            cert.setUniqueId(getId(), i);</span>
<span class="nc" id="L241">            cert.setInitiallyAvailable(cert.isInitiallyAvailable());</span>
        }
        
<span class="nc" id="L244">          Owner bankIPO= getRoot().getBank().getIpo();</span>
<span class="nc" id="L245">          certificate.moveTo(bankIPO);</span>
<span class="nc" id="L246">    }</span>

    /**
     * @return the fullyCapitalised
     */
    public boolean isFullyCapitalized() {
<span class="nc" id="L252">        return fullyCapitalized.value();</span>
    }

    /**
     * @param fullyCapitalised the fullyCapitalised to set
     */
    public void setFullyCapitalized(boolean fullyCapitalised) {
<span class="nc" id="L259">        this.fullyCapitalized.set(fullyCapitalised);</span>
<span class="nc" id="L260">    }</span>

    /**
     * @return the allCertsAvail
     */
    public boolean getAllCertsAvail() {
<span class="nc" id="L266">        return allCertsAvail.value();</span>
    }

    /**
     * @param flag the allCertsAvail to set
     */
    public void setAllCertsAvail(boolean flag ) {
<span class="fc" id="L273">        this.allCertsAvail.set(flag);</span>
<span class="fc" id="L274">    }</span>
    
    public boolean certsAvailableForSale() {
<span class="fc bfc" id="L277" title="All 4 branches covered.">        if ((sharesInIpo() == 5) &amp;&amp; (allCertsAvail.value() == false)) {</span>
<span class="fc" id="L278">            return false;</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">        } else if (sharesInIpo() == 0) {</span>
<span class="fc" id="L280">            return false;</span>
        }
<span class="fc" id="L282">        return true;</span>
    }
    
    public int sharesInIpo() {
<span class="fc" id="L286">        int sharesInIpo = 0;</span>
<span class="fc bfc" id="L287" title="All 2 branches covered.">        for (PublicCertificate cert : certificates) {</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">            if (cert.getOwner() == getRoot().getBank().getIpo()) {</span>
<span class="fc" id="L289">                sharesInIpo += cert.getShares();</span>
            }
<span class="fc" id="L291">        }</span>
<span class="fc" id="L292">        return sharesInIpo;</span>
    }
    
    public void setFullFundingAvail() {
<span class="fc" id="L296">        this.fullCapitalAvailable.set(true);</span>
<span class="fc" id="L297">        checkToFullyCapitalize();</span>
<span class="fc" id="L298">    }</span>

    public void sharePurchased() {
<span class="fc bfc" id="L301" title="All 2 branches covered.">        if (fullyCapitalized.value() == true) {</span>
<span class="fc" id="L302">            return;</span>
        }
<span class="fc" id="L304">        checkToFullyCapitalize();</span>
<span class="fc" id="L305">    }</span>
    
    protected boolean checkToFullyCapitalize() {
<span class="fc bfc" id="L308" title="All 8 branches covered.">        if ((hasFloated() == true) &amp;&amp; (sharesInIpo() &lt;= 5) &amp;&amp; (fullCapitalAvailable.value() == true) &amp;&amp; (getFloatPercentage() != 60)) {</span>
<span class="fc" id="L309">            fullyCapitalized.set(true);</span>
<span class="fc" id="L310">            Currency.wire(getRoot().getBank(),extraCapital,this);  </span>
<span class="fc" id="L311">            ReportBuffer.add(this, LocalText.getText(&quot;ReceivesCashforRemainingShares&quot;,</span>
<span class="fc" id="L312">                    this.getLongName(),</span>
<span class="fc" id="L313">                    Bank.format(this, extraCapital) ));</span>
<span class="fc" id="L314">            return true;</span>
        }
<span class="fc" id="L316">        return false;</span>
    }
    
   public BuildingRights_1880 getRightsModel () {
<span class="nc" id="L320">        return buildingRights;</span>
    }
    
    static public List&lt;PublicCompany_1880&gt; getPublicCompanies(CompanyManager companyManager) {
<span class="fc" id="L324">        List&lt;PublicCompany_1880&gt; companies = new ArrayList&lt;PublicCompany_1880&gt;();</span>
<span class="fc bfc" id="L325" title="All 2 branches covered.">        for (PublicCompany company : companyManager.getAllPublicCompanies()) {</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">            if (company instanceof PublicCompany_1880) {</span>
<span class="fc" id="L327">                companies.add((PublicCompany_1880) company);</span>
            }
<span class="fc" id="L329">        }</span>
<span class="fc" id="L330">        return companies;</span>
    }


    /* (non-Javadoc)
     * @see rails.game.PublicCompany#getBaseTokenLayCost(rails.game.MapHex)
     */
    @Override
    public int getBaseTokenLayCost(MapHex hex) {
<span class="fc" id="L339">        Phase phase = getRoot().getPhaseManager().getCurrentPhase();</span>
<span class="pc bpc" id="L340" title="1 of 2 branches missed.">        if (phase.getRealName().startsWith(&quot;D&quot;)) {</span>
            int result;
<span class="nc" id="L342">            result = super.getBaseTokenLayCost(hex) * 2;</span>
<span class="nc" id="L343">            return result;</span>
        }
<span class="fc" id="L345">        return super.getBaseTokenLayCost(hex);</span>
    }

    @Override
    public Set&lt;Integer&gt; getBaseTokenLayCosts() {
<span class="nc" id="L350">        Phase phase = getRoot().getPhaseManager().getCurrentPhase();</span>
        // double token costs in phase D
<span class="nc bnc" id="L352" title="All 2 branches missed.">        if (phase.getRealName().startsWith(&quot;D&quot;)) {</span>
<span class="nc" id="L353">            ImmutableSet.Builder&lt;Integer&gt; doubleCosts = ImmutableSet.builder();</span>
<span class="nc bnc" id="L354" title="All 2 branches missed.">            for (Integer cost:super.getBaseTokenLayCosts()) {</span>
<span class="nc" id="L355">                doubleCosts.add(cost * 2);</span>
<span class="nc" id="L356">            }</span>
<span class="nc" id="L357">            return doubleCosts.build();</span>
        }
<span class="nc" id="L359">        return super.getBaseTokenLayCosts();</span>
    }
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>