<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CompanyManager.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game</a> &gt; <span class="el_source">CompanyManager.java</span></div><h1>CompanyManager.java</h1><pre class="source lang-java linenums">package net.sf.rails.game;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import net.sf.rails.common.LocalText;
import net.sf.rails.common.parser.Configurable;
import net.sf.rails.common.parser.ConfigurationException;
import net.sf.rails.common.parser.Tag;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


public class CompanyManager extends RailsManager implements Configurable {

    /**
     * This is the name by which the CompanyManager should be registered with
     * the ComponentManager.
     */
    public static final String COMPONENT_NAME = &quot;CompanyManager&quot;;

    /** A List with all private companies */
<span class="fc" id="L26">    private final List&lt;PrivateCompany&gt; lPrivateCompanies =</span>
            new ArrayList&lt;&gt;();

    /** A List with all public companies */
<span class="fc" id="L30">    private final List&lt;PublicCompany&gt; lPublicCompanies =</span>
            new ArrayList&lt;&gt;();

    /** A map with all private companies by name */
<span class="fc" id="L34">    private final Map&lt;String, PrivateCompany&gt; mPrivateCompanies =</span>
            new HashMap&lt;&gt;();

    /** A map with all public (i.e. non-private) companies by name */
<span class="fc" id="L38">    private final Map&lt;String, PublicCompany&gt; mPublicCompanies =</span>
            new HashMap&lt;&gt;();

    /** A map of all type names to maps of companies of that type by name */
    // TODO Redundant, current usage can be replaced.
<span class="fc" id="L43">    private final Map&lt;String, Map&lt;String, Company&gt;&gt; mCompaniesByTypeAndName =</span>
            new HashMap&lt;&gt;();

    /** A list of all company types */
<span class="fc" id="L47">    private final List&lt;CompanyType&gt; lCompanyTypes = new ArrayList&lt;&gt;();</span>

    /** A list of all start packets (usually one) */
<span class="fc" id="L50">    protected List&lt;StartPacket&gt; startPackets = new ArrayList&lt;&gt;();</span>
    /** A map of all start packets, keyed by name. Default name is &quot;Initial&quot; */
<span class="fc" id="L52">    private final Map&lt;String, StartPacket&gt; startPacketMap</span>
        = new HashMap&lt;&gt;();

    /** A map to enable translating aliases to names */
<span class="fc" id="L56">    protected Map&lt;String, String&gt; aliases = null;</span>

<span class="fc" id="L58">    private int numberOfPublicCompanies = 0;</span>

<span class="fc" id="L60">    private static final Logger log =</span>
<span class="fc" id="L61">            LoggerFactory.getLogger(CompanyManager.class);</span>

    protected GameManager gameManager;

    /**
     * Used by Configure (via reflection) only
     */
    public CompanyManager(RailsRoot parent, String id) {
<span class="fc" id="L69">        super(parent, id);</span>
<span class="fc" id="L70">    }</span>

    /*
     * NOTES: 1. we don't have a map over all companies, because some games have
     * duplicate names, e.g. B&amp;O in 1830. 2. we have both a map and a list of
     * private/public companies to preserve configuration sequence while
     * allowing direct access.
     */

    /**
     */
    public void configureFromXML(Tag tag) throws ConfigurationException {

<span class="fc" id="L83">        gameManager = getRoot().getGameManager();</span>

        /** A map with all company types, by type name */
        // Localised here as it has no permanent use
<span class="fc" id="L87">        Map&lt;String, CompanyType&gt; mCompanyTypes</span>
              = new HashMap&lt;&gt;();

        //NEW//
<span class="fc" id="L91">        Map&lt;String, Tag&gt; typeTags = new HashMap&lt;String, Tag&gt;();</span>

<span class="fc bfc" id="L93" title="All 2 branches covered.">        for (Tag compTypeTag : tag.getChildren(CompanyType.ELEMENT_ID)) {</span>
            // Extract the attributes of the Component
<span class="fc" id="L95">            String name =</span>
<span class="fc" id="L96">                    compTypeTag.getAttributeAsString(CompanyType.NAME_TAG);</span>
<span class="pc bpc" id="L97" title="1 of 2 branches missed.">            if (name == null) {</span>
<span class="nc" id="L98">                throw new ConfigurationException(</span>
<span class="nc" id="L99">                        LocalText.getText(&quot;UnnamedCompanyType&quot;));</span>
            }
<span class="fc" id="L101">            String className =</span>
<span class="fc" id="L102">                    compTypeTag.getAttributeAsString(CompanyType.CLASS_TAG);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (className == null) {</span>
<span class="nc" id="L104">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;CompanyTypeHasNoClass&quot;, name));
            }
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">            if (mCompanyTypes.get(name) != null) {</span>
<span class="nc" id="L108">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;CompanyTypeConfiguredTwice&quot;, name));
            }

<span class="fc" id="L112">            CompanyType companyType = CompanyType.create(this, name, className);</span>
<span class="fc" id="L113">            mCompanyTypes.put(name, companyType);</span>
<span class="fc" id="L114">            lCompanyTypes.add(companyType);</span>

            // Further parsing is done within CompanyType
<span class="fc" id="L117">            companyType.configureFromXML(compTypeTag);</span>

            //NEW//
<span class="fc" id="L120">            typeTags.put(name, compTypeTag);</span>
<span class="fc" id="L121">        }</span>

        /* Read and configure the companies */
<span class="fc bfc" id="L124" title="All 2 branches covered.">        for (Tag companyTag : tag.getChildren(Company.COMPANY_ELEMENT_ID)) {</span>
            // Extract the attributes of the Component
<span class="fc" id="L126">            String name =</span>
<span class="fc" id="L127">                    companyTag.getAttributeAsString(Company.COMPANY_NAME_TAG);</span>
<span class="pc bpc" id="L128" title="1 of 2 branches missed.">            if (name == null) {</span>
<span class="nc" id="L129">                throw new ConfigurationException(</span>
<span class="nc" id="L130">                        LocalText.getText(&quot;UnnamedCompany&quot;));</span>
            }
<span class="fc" id="L132">            String type =</span>
<span class="fc" id="L133">                    companyTag.getAttributeAsString(Company.COMPANY_TYPE_TAG);</span>
<span class="pc bpc" id="L134" title="1 of 2 branches missed.">            if (type == null) {</span>
<span class="nc" id="L135">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;CompanyHasNoType&quot;, name));
            }
<span class="fc" id="L138">            CompanyType cType = mCompanyTypes.get(type);</span>
<span class="pc bpc" id="L139" title="1 of 2 branches missed.">            if (cType == null) {</span>
<span class="nc" id="L140">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;CompanyHasUnknownType&quot;, name, type ));
            }
            try {

                //NEW//Company company = cType.createCompany(name, companyTag);
<span class="fc" id="L146">                Tag typeTag = typeTags.get(type);</span>
<span class="fc" id="L147">                Company company = cType.createCompany(name, typeTag, companyTag);</span>

                /* Private or public */
<span class="fc bfc" id="L150" title="All 2 branches covered.">                if (company instanceof PrivateCompany) {</span>
<span class="fc" id="L151">                    mPrivateCompanies.put(name, (PrivateCompany) company);</span>
<span class="fc" id="L152">                    lPrivateCompanies.add((PrivateCompany) company);</span>

<span class="pc bpc" id="L154" title="1 of 2 branches missed.">                } else if (company instanceof PublicCompany) {</span>
<span class="fc" id="L155">                    ((PublicCompany)company).setIndex (numberOfPublicCompanies++);</span>
<span class="fc" id="L156">                    mPublicCompanies.put(name, (PublicCompany) company);</span>
<span class="fc" id="L157">                    lPublicCompanies.add((PublicCompany) company);</span>
                }
                /* By type and name */
<span class="fc bfc" id="L160" title="All 2 branches covered.">                if (!mCompaniesByTypeAndName.containsKey(type))</span>
<span class="fc" id="L161">                    mCompaniesByTypeAndName.put(type,</span>
                            new HashMap&lt;String, Company&gt;());
<span class="fc" id="L163">                (mCompaniesByTypeAndName.get(type)).put(</span>
                        name, company);

<span class="fc" id="L166">                String alias = company.getAlias();</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">                if (alias != null) createAlias (alias, name);</span>

<span class="nc" id="L169">            } catch (Exception e) {</span>
<span class="nc" id="L170">                throw new ConfigurationException(LocalText.getText(</span>
<span class="nc" id="L171">                        &quot;ClassCannotBeInstantiated&quot;, cType.getClassName()), e);</span>
<span class="fc" id="L172">            }</span>

<span class="fc" id="L174">        }</span>

        /* Read and configure the start packets */
<span class="fc" id="L177">        List&lt;Tag&gt; packetTags = tag.getChildren(&quot;StartPacket&quot;);</span>

<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        if (packetTags != null) {</span>
<span class="fc bfc" id="L180" title="All 2 branches covered.">            for (Tag packetTag : tag.getChildren(&quot;StartPacket&quot;)) {</span>
                // Extract the attributes of the Component
<span class="fc" id="L182">                String name = packetTag.getAttributeAsString(&quot;name&quot;, StartPacket.DEFAULT_ID);</span>
<span class="fc" id="L183">                String roundClass =</span>
<span class="fc" id="L184">                        packetTag.getAttributeAsString(&quot;roundClass&quot;);</span>
<span class="pc bpc" id="L185" title="1 of 2 branches missed.">                if (roundClass == null) {</span>
<span class="nc" id="L186">                    throw new ConfigurationException(LocalText.getText(</span>
                            &quot;StartPacketHasNoClass&quot;, name));
                }

<span class="fc" id="L190">                StartPacket sp = StartPacket.create(this, name, roundClass);</span>
<span class="fc" id="L191">                startPackets.add(sp);</span>
<span class="fc" id="L192">                startPacketMap.put(name, sp);</span>

<span class="fc" id="L194">                sp.configureFromXML(packetTag);</span>
<span class="fc" id="L195">            }</span>
        }

<span class="fc" id="L198">    }</span>

    // Post XML parsing initialisations
    public void finishConfiguration (RailsRoot root)
    throws ConfigurationException {

<span class="fc bfc" id="L204" title="All 2 branches covered.">        for (PublicCompany comp : lPublicCompanies) {</span>
<span class="fc" id="L205">            comp.finishConfiguration(root);</span>
<span class="fc" id="L206">        }</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">        for (PrivateCompany comp : lPrivateCompanies) {</span>
<span class="fc" id="L208">            comp.finishConfiguration(root);</span>
<span class="fc" id="L209">        }</span>

<span class="fc" id="L211">    }</span>

    public void initStartPackets(GameManager gameManager) {
        // initialize startPackets
<span class="fc bfc" id="L215" title="All 2 branches covered.">        for (StartPacket packet: startPackets) {</span>
<span class="fc" id="L216">            packet.init(gameManager);</span>
<span class="fc" id="L217">        }</span>
<span class="fc" id="L218">    }</span>

    private void createAlias (String alias, String name) {
<span class="fc bfc" id="L221" title="All 2 branches covered.">        if (aliases == null) {</span>
<span class="fc" id="L222">            aliases = new HashMap&lt;String, String&gt;();</span>
        }
<span class="fc" id="L224">        aliases.put(alias, name);</span>
<span class="fc" id="L225">    }</span>

    public String checkAlias (String alias) {
<span class="fc bfc" id="L228" title="All 4 branches covered.">        if (aliases != null &amp;&amp; aliases.containsKey(alias)) {</span>
<span class="fc" id="L229">            return aliases.get(alias);</span>
        } else {
<span class="fc" id="L231">            return alias;</span>
        }
    }

    public String checkAliasInCertId (String certId) {
<span class="fc" id="L236">        String[] parts = certId.split(&quot;-&quot;);</span>
<span class="fc" id="L237">        String realName = checkAlias (parts[0]);</span>
<span class="pc bpc" id="L238" title="1 of 2 branches missed.">        if (!parts[0].equals(realName)) {</span>
<span class="nc" id="L239">            return realName + &quot;-&quot; + parts[1];</span>
        } else {
<span class="fc" id="L241">            return certId;</span>
        }
    }
    /**
     *
     */
    public PrivateCompany getPrivateCompany(String name) {
<span class="fc" id="L248">        return mPrivateCompanies.get(name);</span>
    }

    public PublicCompany getPublicCompany(String name) {
<span class="fc" id="L252">        return mPublicCompanies.get(checkAlias(name));</span>
    }

    public List&lt;PrivateCompany&gt; getAllPrivateCompanies() {
<span class="fc" id="L256">        return lPrivateCompanies;</span>
    }

    public List&lt;PublicCompany&gt; getAllPublicCompanies() {
<span class="fc" id="L260">        return lPublicCompanies;</span>
    }

    public List&lt;CompanyType&gt; getCompanyTypes() {
<span class="nc" id="L264">		return lCompanyTypes;</span>
	}

	public Company getCompany(String type, String name) {

<span class="pc bpc" id="L269" title="1 of 2 branches missed.">        if (mCompaniesByTypeAndName.containsKey(type)) {</span>
<span class="fc" id="L270">            return (mCompaniesByTypeAndName.get(type)).get(checkAlias(name));</span>
        } else {
<span class="nc" id="L272">            return null;</span>
        }
    }

    public void closeAllPrivates() {
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">        if (lPrivateCompanies == null) return;</span>
<span class="fc bfc" id="L278" title="All 2 branches covered.">        for (PrivateCompany priv : lPrivateCompanies) {</span>
<span class="fc bfc" id="L279" title="All 2 branches covered.">            if (priv.isCloseable()) // check if private is closeable</span>
<span class="fc" id="L280">                priv.setClosed();</span>
<span class="fc" id="L281">        }</span>
<span class="fc" id="L282">    }</span>

    public List&lt;PrivateCompany&gt; getPrivatesOwnedByPlayers() {
<span class="nc" id="L285">        List&lt;PrivateCompany&gt; privatesOwnedByPlayers =</span>
                new ArrayList&lt;PrivateCompany&gt;();
<span class="nc bnc" id="L287" title="All 2 branches missed.">        for (PrivateCompany priv : getAllPrivateCompanies()) {</span>
<span class="nc bnc" id="L288" title="All 2 branches missed.">            if (priv.getOwner() instanceof Player) {</span>
<span class="nc" id="L289">                privatesOwnedByPlayers.add(priv);</span>
            }
<span class="nc" id="L291">        }</span>
<span class="nc" id="L292">        return privatesOwnedByPlayers;</span>
    }

    public StartPacket getStartPacket (int index) {
<span class="nc" id="L296">        return startPackets.get(index);</span>
    }

    public StartPacket getStartPacket (String name) {
<span class="nc" id="L300">        return startPacketMap.get(name);</span>
    }

    /** Pass number of turns for which a certain company type can lay extra tiles of a certain colour. */
    // NOTE: Called by phase.finishConfiguration().
    // This implies, that the CompanyManager configuration must finished be BEFORE PhaseManager.
    // (We shouldn't have such dependencies...)
    // TODO: Resolve the issues mentioned above
    public void addExtraTileLayTurnsInfo (Map&lt;String, Integer&gt; extraTileTurns) {
<span class="fc bfc" id="L309" title="All 2 branches covered.">        for (String typeAndColour : extraTileTurns.keySet()) {</span>
<span class="fc" id="L310">            String[] keys = typeAndColour.split(&quot;~&quot;);</span>
<span class="fc" id="L311">            Map&lt;String, Company&gt; companies = mCompaniesByTypeAndName.get(keys[0]);</span>
<span class="pc bpc" id="L312" title="1 of 2 branches missed.">            if (companies != null) {</span>
<span class="fc bfc" id="L313" title="All 2 branches covered.">                for (Company company : companies.values()) {</span>
<span class="fc" id="L314">                    ((PublicCompany)company).addExtraTileLayTurnsInfo(keys[1], extraTileTurns.get(typeAndColour));</span>
<span class="fc" id="L315">                }</span>
            }
<span class="fc" id="L317">        }</span>
<span class="fc" id="L318">    }</span>

    public StartPacket getNextUnfinishedStartPacket() {
<span class="fc bfc" id="L321" title="All 2 branches covered.">      for (StartPacket packet: startPackets) {</span>
<span class="fc bfc" id="L322" title="All 2 branches covered.">          if ( !packet.areAllSold() ) {</span>
<span class="fc" id="L323">              return packet;</span>

              }
<span class="fc" id="L326">          }</span>
<span class="fc" id="L327">      return null;</span>
    }

    /**
     * @param id of the startItem
     * @return the startItem with that id
     */
    public StartItem getStartItemById(String id) {
<span class="pc bpc" id="L335" title="1 of 2 branches missed.">        for (StartPacket packet:startPackets) {</span>
<span class="fc bfc" id="L336" title="All 2 branches covered.">            for (StartItem item:packet.getItems()) {</span>
<span class="fc bfc" id="L337" title="All 2 branches covered.">                if (item.getId().equals(id)) {</span>
<span class="fc" id="L338">                    return item;</span>
                }
<span class="fc" id="L340">            }</span>
<span class="fc" id="L341">        }</span>
<span class="nc" id="L342">        return null;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>