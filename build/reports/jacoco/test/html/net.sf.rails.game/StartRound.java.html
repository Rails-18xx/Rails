<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartRound.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game</a> &gt; <span class="el_source">StartRound.java</span></div><h1>StartRound.java</h1><pre class="source lang-java linenums">package net.sf.rails.game;

import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.*;
import net.sf.rails.common.*;
import net.sf.rails.util.Util;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.Certificate;
import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.state.ArrayListState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.IntegerState;
import net.sf.rails.game.state.Model;


public abstract class StartRound extends Round {
<span class="fc" id="L21">    private static final Logger log = LoggerFactory.getLogger(StartRound.class);</span>

    // FIXME: StartRounds do not set Priority Player

    // static at creation
    protected final StartPacket startPacket;
    protected final String variant;

    // static at start
    protected Player startPlayer;


    // The following have to be initialized by the sub-classes
    /**
     * Should the UI present bidding into and facilities? This value MUST be set
     * in the actual StartRound constructor.
     */
    protected final boolean hasBidding;

    /**
     * Should the UI show base prices? Not useful if the items are all equal, as
     * in 1841 and 18EU.
     */
    protected final boolean hasBasePrices;

    /**
     * Is buying allowed in the start round?  Not in the first start round of
     * 1880, for example, where everything is auctioned.
     */
    protected final boolean hasBuying;

<span class="fc" id="L52">    private String StartRoundName=&quot;Start of Initial StartRound&quot;;</span>

    // dynamic variables
<span class="fc" id="L55">    protected final ArrayListState&lt;StartItem&gt; itemsToSell = ArrayListState.create(this, &quot;itemsToSell&quot;);</span>
<span class="fc" id="L56">    protected final IntegerState numPasses = IntegerState.create(this, &quot;numPasses&quot;);</span>

    protected StartRound(GameManager parent, String id, boolean hasBidding, boolean hasBasePrices, boolean hasBuying) {
<span class="fc" id="L59">        super (parent, id);</span>
<span class="fc" id="L60">        this.hasBidding = hasBidding;</span>
<span class="fc" id="L61">        this.hasBasePrices = hasBasePrices;</span>
<span class="fc" id="L62">        this.hasBuying = hasBuying;</span>

<span class="fc" id="L64">        this.startPacket = parent.getStartPacket();</span>

<span class="fc" id="L66">        String variant =  GameOption.getValue(this, GameOption.VARIANT);</span>
<span class="fc" id="L67">        this.variant = Util.valueWithDefault(variant, &quot;&quot;);</span>

<span class="fc" id="L69">        guiHints.setVisibilityHint(GuiDef.Panel.STATUS, true);</span>
<span class="fc" id="L70">        guiHints.setVisibilityHint(GuiDef.Panel.STOCK_MARKET, false);</span>
<span class="fc" id="L71">        guiHints.setVisibilityHint(GuiDef.Panel.MAP, true);</span>
<span class="fc" id="L72">        guiHints.setActivePanel(GuiDef.Panel.START_ROUND);</span>
<span class="fc" id="L73">    }</span>

    protected StartRound(GameManager parent, String id) {
        // default case, set bidding, basePrices and buying all to true
<span class="fc" id="L77">        this(parent, id, true, true, true);</span>
<span class="fc" id="L78">    }</span>

    public void start() {
<span class="fc bfc" id="L81" title="All 2 branches covered.">        for (StartItem item : startPacket.getItems()) {</span>
            // New: we only include items that have not yet been sold
            // at the start of the current StartRound
<span class="fc bfc" id="L84" title="All 2 branches covered.">            if (!item.isSold()) {</span>
<span class="fc" id="L85">                itemsToSell.add(item);</span>
            }
<span class="fc" id="L87">        }</span>
<span class="fc" id="L88">        numPasses.set(0);</span>

        // init current with priority player
<span class="fc" id="L91">        startPlayer = playerManager.setCurrentToPriorityPlayer();</span>

<span class="fc" id="L93">        ReportBuffer.add(this, LocalText.getText(&quot;StartOfInitialRound&quot;));</span>
<span class="fc" id="L94">        ReportBuffer.add(this, LocalText.getText(&quot;HasPriority&quot;,</span>
<span class="fc" id="L95">                startPlayer.getId()));</span>
<span class="fc" id="L96">    }</span>
    @Override
    public boolean process(PossibleAction action) {
<span class="fc" id="L99">        boolean result = false;</span>

<span class="fc" id="L101">        log.debug(&quot;Processing action {}&quot;, action);</span>

<span class="fc bfc" id="L103" title="All 2 branches covered.">        if (action instanceof NullAction &amp;&amp;</span>
<span class="pc bpc" id="L104" title="1 of 2 branches missed.">                ((NullAction)action).getMode() == NullAction.Mode.PASS) {</span>
<span class="fc" id="L105">            String playerName = action.getPlayerName();</span>
<span class="fc" id="L106">            NullAction nullAction = (NullAction) action;</span>
<span class="fc" id="L107">            result = pass(nullAction, playerName);</span>

<span class="pc bpc" id="L109" title="1 of 2 branches missed.">        } else if (action instanceof StartItemAction) {</span>

<span class="fc" id="L111">            StartItemAction startItemAction = (StartItemAction) action;</span>
<span class="fc" id="L112">            String playerName = action.getPlayerName();</span>

<span class="fc" id="L114">            log.debug(&quot;Item details: {}&quot;, startItemAction.toString());</span>

<span class="fc bfc" id="L116" title="All 2 branches covered.">            if (startItemAction instanceof BuyStartItem) {</span>

<span class="fc" id="L118">                BuyStartItem buyAction = (BuyStartItem) startItemAction;</span>
<span class="fc bfc" id="L119" title="All 2 branches covered.">                if (buyAction.hasSharePriceToSet()</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">                        &amp;&amp; buyAction.getAssociatedSharePrice() == 0) {</span>
                    // We still need a share price for this item
<span class="nc" id="L122">                    startItemAction.getStartItem().setStatus(</span>
                            StartItem.NEEDS_SHARE_PRICE);
                    // We must set the priority player, though
<span class="nc" id="L125">                    playerManager.setPriorityPlayerToNext();</span>
<span class="nc" id="L126">                    result = true;</span>
                } else {
<span class="fc" id="L128">                    result = buy(playerName, buyAction);</span>
                }
<span class="pc bpc" id="L130" title="1 of 2 branches missed.">            } else if (startItemAction instanceof BidStartItem) {</span>
<span class="fc" id="L131">                result = bid(playerName, (BidStartItem) startItemAction);</span>
            }
<span class="fc" id="L133">        } else {</span>

<span class="nc" id="L135">            DisplayBuffer.add(this, LocalText.getText(&quot;UnexpectedAction&quot;,</span>
<span class="nc" id="L136">                    action.toString()));</span>
        }

<span class="fc" id="L139">        startPacketChecks();</span>

<span class="fc bfc" id="L141" title="All 2 branches covered.">        if (startPacket.areAllSold()) {</span>
            /*
             * If the complete start packet has been sold, start a Stock round,
             */
<span class="fc" id="L145">            possibleActions.clear();</span>
<span class="fc" id="L146">            finishRound();</span>
        }

<span class="fc" id="L149">        return result;</span>
    }

    /** Stub to allow start packet cleanups in subclasses */
    protected void startPacketChecks() {
<span class="fc" id="L154">        return;</span>
    }

    /*----- Processing player actions -----*/

    /**
     * The current player bids on a given start item.
     *
     * @param playerName The name of the current player (for checking purposes).
     * @param itemName The name of the start item on which the bid is placed.
     * @param amount The bid amount.
     */
    protected abstract boolean bid(String playerName, BidStartItem startItem);

    /**
     * Buy a start item against the base price.
     *
     * @param playerName Name of the buying player.
     * @param itemName Name of the bought start item.
     * @param sharePrice If nonzero: share price if item contains a President's
     * share
     * @return False in case of any errors.
     */

    protected boolean buy(String playerName, BuyStartItem boughtItem) {
<span class="fc" id="L179">        StartItem item = boughtItem.getStartItem();</span>
<span class="fc" id="L180">        int lastBid = item.getBid();</span>
<span class="fc" id="L181">        String errMsg = null;</span>
<span class="fc" id="L182">        Player player = playerManager.getCurrentPlayer();</span>
<span class="fc" id="L183">        int price = 0;</span>
<span class="fc" id="L184">        int sharePrice = 0;</span>
<span class="fc" id="L185">        String shareCompName = &quot;&quot;;</span>

        while (true) {
<span class="pc bpc" id="L188" title="1 of 2 branches missed.">            if (!boughtItem.setSharePriceOnly()) {</span>
<span class="pc bpc" id="L189" title="1 of 2 branches missed.">                if (item.getStatus() != StartItem.BUYABLE) {</span>
<span class="nc" id="L190">                    errMsg = LocalText.getText(&quot;NotForSale&quot;);</span>
<span class="nc" id="L191">                    break;</span>
                }

<span class="fc" id="L194">                price = item.getBasePrice();</span>
<span class="pc bpc" id="L195" title="1 of 2 branches missed.">                if (item.getBid() &gt; price) price = item.getBid();</span>

<span class="pc bpc" id="L197" title="1 of 2 branches missed.">                if (player.getFreeCash() &lt; price) {</span>
<span class="nc" id="L198">                    errMsg = LocalText.getText(&quot;NoMoney&quot;);</span>
<span class="nc" id="L199">                    break;</span>
                }
            } else {
<span class="nc" id="L202">                price = item.getBid();</span>
            }

<span class="fc bfc" id="L205" title="All 2 branches covered.">            if (boughtItem.hasSharePriceToSet()) {</span>
<span class="fc" id="L206">                shareCompName = boughtItem.getCompanyToSetPriceFor();</span>
<span class="fc" id="L207">                sharePrice = boughtItem.getAssociatedSharePrice();</span>
<span class="pc bpc" id="L208" title="1 of 2 branches missed.">                if (sharePrice == 0) {</span>
<span class="nc" id="L209">                    errMsg =</span>
<span class="nc" id="L210">                        LocalText.getText(&quot;NoSharePriceSet&quot;, shareCompName);</span>
<span class="nc" id="L211">                    break;</span>
                }
<span class="pc bpc" id="L213" title="1 of 2 branches missed.">                if ((stockMarket.getStartSpace(sharePrice)) == null) {</span>
<span class="nc" id="L214">                    errMsg =</span>
<span class="nc" id="L215">                        LocalText.getText(&quot;InvalidStartPrice&quot;,</span>
<span class="nc" id="L216">                                    Bank.format(this, sharePrice),</span>
                                shareCompName );
                    break;
                }
            }
            break;
        }

<span class="pc bpc" id="L224" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L225">            DisplayBuffer.add(this, LocalText.getText(&quot;CantBuyItem&quot;,</span>
                    playerName,
<span class="nc" id="L227">                    item.getId(),</span>
                    errMsg ));
<span class="nc" id="L229">            return false;</span>
        }

<span class="fc" id="L232">        assignItem(player, item, price, sharePrice);</span>

        // Set priority (only if the item was not auctioned)
        // ASSUMPTION: getting an item in auction mode never changes priority
<span class="pc bpc" id="L236" title="1 of 2 branches missed.">        if (lastBid == 0) {</span>
<span class="fc" id="L237">            playerManager.setPriorityPlayerToNext();</span>
        }
<span class="fc" id="L239">        playerManager.setCurrentToNextPlayer();</span>

<span class="fc" id="L241">        numPasses.set(0);</span>

<span class="fc" id="L243">        return true;</span>

    }

    /**
     * This method executes the start item buy action.
     *
     * @param player Buying player.
     * @param item Start item being bought.
     * @param price Buy price.
     */
    protected void assignItem(Player player, StartItem item, int price,
            int sharePrice) {
<span class="fc" id="L256">        Certificate primary = item.getPrimary();</span>
<span class="fc" id="L257">        String priceText = Currency.toBank(player, price);</span>
<span class="fc" id="L258">        ReportBuffer.add(this,LocalText.getText(&quot;BuysItemFor&quot;,</span>
<span class="fc" id="L259">                player.getId(),</span>
<span class="fc" id="L260">                primary.toText(),</span>
                priceText ));
<span class="fc" id="L262">        primary.moveTo(player);</span>
<span class="fc" id="L263">        checksOnBuying(primary, sharePrice);</span>
<span class="fc bfc" id="L264" title="All 2 branches covered.">        if (item.hasSecondary()) {</span>
<span class="fc" id="L265">            Certificate extra = item.getSecondary();</span>
<span class="fc" id="L266">            ReportBuffer.add(this,LocalText.getText(&quot;ALSO_GETS&quot;,</span>
<span class="fc" id="L267">                    player.getId(),</span>
<span class="fc" id="L268">                    extra.toText()));</span>
<span class="fc" id="L269">            extra.moveTo(player);</span>
<span class="fc" id="L270">            checksOnBuying(extra, sharePrice);</span>
        }
<span class="fc" id="L272">        item.setSold(player, price);</span>
<span class="fc" id="L273">    }</span>

    protected void checksOnBuying(Certificate cert, int sharePrice) {
<span class="fc bfc" id="L276" title="All 2 branches covered.">        if (cert instanceof PublicCertificate) {</span>
<span class="fc" id="L277">            PublicCertificate pubCert = (PublicCertificate) cert;</span>
<span class="fc" id="L278">            PublicCompany comp = pubCert.getCompany();</span>
            // Start the company, look for a fixed start price
<span class="fc bfc" id="L280" title="All 2 branches covered.">            if (!comp.hasStarted()) {</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">                if (!comp.hasStockPrice()) {</span>
<span class="fc" id="L282">                    comp.start();</span>
<span class="fc bfc" id="L283" title="All 2 branches covered.">                } else if (pubCert.isPresidentShare()) {</span>
                    /* Company to be started. Check if it has a start price */
<span class="fc bfc" id="L285" title="All 2 branches covered.">                    if (sharePrice &gt; 0) {</span>
                        // User has told us the start price
<span class="fc" id="L287">                        comp.start(sharePrice);</span>
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">                    } else if (comp.getIPOPrice() != 0) {</span>
                        // Company has a known start price
<span class="fc" id="L290">                        comp.start();</span>
                    } else {
<span class="nc" id="L292">                        log.error(&quot;No start price for &quot; + comp.getId());</span>
                    }
                }
            }
<span class="pc bpc" id="L296" title="1 of 4 branches missed.">            if (comp.hasStarted() &amp;&amp; !comp.hasFloated()) {</span>
<span class="fc" id="L297">                checkFlotation(comp);</span>
            }
<span class="fc bfc" id="L299" title="All 2 branches covered.">            if (comp.hasStarted()) comp.checkPresidency();  // Needed for 1835 BY</span>
        }
<span class="fc" id="L301">    }</span>

    /**
     * Process a player's pass.
     * @param action TODO
     * @param playerName The name of the current player (for checking purposes).
     */
    protected abstract boolean pass(NullAction action, String playerName);

    @Override
    protected void finishRound() {
<span class="fc" id="L312">        super.finishRound();</span>
<span class="fc" id="L313">    }</span>

    /*----- Setting up the UI for the next action -----*/

    /**
     * Get the current list of start items.
     *
     * @return An array of start items, possibly empry.
     */

    public List&lt;StartItem&gt; getStartItems() {

<span class="nc" id="L325">        return itemsToSell.view();</span>
    }

    /**
     * Get a list of items that the current player may bid upon.
     *
     * @return An array of start items, possibly empty.
     */

    public StartPacket getStartPacket() {
<span class="fc" id="L335">        return startPacket;</span>
    }

    public boolean hasBidding() {
<span class="nc" id="L339">        return hasBidding;</span>
    }

    public boolean hasBuying() {
<span class="nc" id="L343">        return hasBuying;</span>
    }

    public boolean hasBasePrices() {
<span class="nc" id="L347">        return hasBasePrices;</span>
    }

    public Model getBidModel(int privateIndex, Player player) {
<span class="nc" id="L351">        return (itemsToSell.get(privateIndex)).getBidForPlayerModel(player);</span>
    }

    public Model getMinimumBidModel(int privateIndex) {
<span class="nc" id="L355">        return (itemsToSell.get(privateIndex)).getMinimumBidModel();</span>
    }

    // TODO: Maybe this should be a subclass of a readableCashModel
    public Model getFreeCashModel(Player player) {
<span class="nc" id="L360">        return player.getFreeCashModel();</span>
    }

    // TODO: Maybe this should be a subclass of a readableCashModel
    public Model getBlockedCashModel(Player player) {
<span class="nc" id="L365">        return player.getBlockedCashModel();</span>
    }
    /**
     * @return the startRoundName
     */
    public String getStartRoundName() {
<span class="nc" id="L371">        return StartRoundName;</span>
    }

    /**
     * @param startRoundName the startRoundName to set
     */
    public void setStartRoundName(String startRoundName) {
<span class="nc" id="L378">        StartRoundName = startRoundName;</span>
<span class="nc" id="L379">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>