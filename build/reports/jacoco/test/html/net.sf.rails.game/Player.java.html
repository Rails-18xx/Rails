<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>Player.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game</a> &gt; <span class="el_source">Player.java</span></div><h1>Player.java</h1><pre class="source lang-java linenums">package net.sf.rails.game;

import java.util.Map;

import com.google.common.collect.Maps;

import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.financial.RailsMoneyOwner;
import net.sf.rails.game.model.CalculatedMoneyModel;
import net.sf.rails.game.model.CertificateCountModel;
import net.sf.rails.game.model.CountingMoneyModel;
import net.sf.rails.game.model.MoneyModel;
import net.sf.rails.game.model.PlayerNameModel;
import net.sf.rails.game.model.PortfolioModel;
import net.sf.rails.game.model.PortfolioOwner;
import net.sf.rails.game.model.PurseMoneyModel;
import net.sf.rails.game.model.CalculatedMoneyModel.CalculationMethod;
import net.sf.rails.game.model.SoldThisRoundModel;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.ChangeActionOwner;
import net.sf.rails.game.state.IntegerState;
import net.sf.rails.game.state.Purse;

public class Player extends RailsAbstractItem implements RailsMoneyOwner, PortfolioOwner, ChangeActionOwner, Comparable&lt;Player&gt; {

    // FIXME: Rails 2.0 Do we need the index number?
    
    
    // dynamic data (states and models)
<span class="fc" id="L30">    private final IntegerState index = IntegerState.create(this, &quot;index&quot;);</span>
<span class="fc" id="L31">    private final PortfolioModel portfolio = PortfolioModel.create(this);</span>
<span class="fc" id="L32">    private final CertificateCountModel certCount = CertificateCountModel.create(portfolio);</span>

<span class="fc" id="L34">    private final PurseMoneyModel cash = </span>
<span class="fc" id="L35">            PurseMoneyModel.create(this, &quot;cash&quot;, false);</span>
    private final CalculatedMoneyModel freeCash;
<span class="fc" id="L37">    private final CountingMoneyModel blockedCash = CountingMoneyModel.create(this, &quot;blockedCash&quot;, false);</span>
    private final CalculatedMoneyModel worth;
<span class="fc" id="L39">    private final CountingMoneyModel lastORWorthIncrease = CountingMoneyModel.create(this, &quot;lastORIncome&quot;, false);</span>

<span class="fc" id="L41">    private final BooleanState bankrupt = BooleanState.create(this, &quot;isBankrupt&quot;);</span>
<span class="fc" id="L42">    private final IntegerState worthAtORStart = IntegerState.create(this, &quot;worthAtORStart&quot;);</span>
<span class="fc" id="L43">    private final Map&lt;PublicCompany, SoldThisRoundModel&gt; soldThisRound = Maps.newHashMap();</span>
<span class="fc" id="L44">    private final PlayerNameModel playerNameModel = PlayerNameModel.create(this);</span>

    private Player(PlayerManager parent, String id, int index) {
<span class="fc" id="L47">        super(parent, id);</span>
<span class="fc" id="L48">        this.index.set(index);</span>

<span class="fc" id="L50">        blockedCash.setSuppressZero(true);</span>
<span class="fc" id="L51">        lastORWorthIncrease.setDisplayNegative(true);</span>
        
        // definitions of freeCash
<span class="fc" id="L54">        CalculationMethod freeCashMethod = new CalculationMethod(){ </span>
            public int calculate() {
<span class="fc" id="L56">                return cash.value() - blockedCash.value();</span>
            }
            public boolean initialised() {
<span class="nc bnc" id="L59" title="All 4 branches missed.">                return cash.initialised() &amp;&amp; blockedCash.initialised();</span>
            }
        };
<span class="fc" id="L62">        freeCash = CalculatedMoneyModel.create(this, &quot;freeCash&quot;, freeCashMethod);</span>
<span class="fc" id="L63">        cash.addModel(freeCash);</span>
<span class="fc" id="L64">        blockedCash.addModel(freeCash);</span>
        
        // define definitions of worth
<span class="fc" id="L67">        CalculationMethod worthMethod = new CalculationMethod(){</span>
            public int calculate() {
                // if player is bankrupt cash is not counted
                // as this was generated during forced selling
                int worth;
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">                if (bankrupt.value()) {</span>
<span class="nc" id="L73">                    worth = 0;</span>
                } else {
<span class="fc" id="L75">                    worth = cash.value();</span>
                }

<span class="fc bfc" id="L78" title="All 2 branches covered.">                for (PublicCertificate cert : getPortfolioModel().getCertificates()) {</span>
<span class="fc" id="L79">                    worth += cert.getCompany().getGameEndPrice() * cert.getShares();</span>
<span class="fc" id="L80">                }</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">                for (PrivateCompany priv : getPortfolioModel().getPrivateCompanies()) {</span>
<span class="fc" id="L82">                    worth += priv.getBasePrice();</span>
<span class="fc" id="L83">                }</span>
<span class="fc" id="L84">                return worth;</span>
            }
            public boolean initialised() {
<span class="nc" id="L87">                return cash.initialised();</span>
            }
        };
<span class="fc" id="L90">        worth = CalculatedMoneyModel.create(this, &quot;worth&quot;, worthMethod);</span>
<span class="fc" id="L91">        portfolio.addModel(worth);</span>
<span class="fc" id="L92">        cash.addModel(worth);</span>
<span class="fc" id="L93">    }</span>
    
    public static Player create(PlayerManager parent, String id, int index) {
<span class="fc" id="L96">        return new Player(parent, id, index);</span>
    }
    
    public PlayerManager getParent() {
<span class="fc" id="L100">        return (PlayerManager)super.getParent();</span>
    }
    
    public void finishConfiguration(RailsRoot root) {
<span class="fc" id="L104">        portfolio.finishConfiguration();</span>
        
        // create soldThisRound states
<span class="fc bfc" id="L107" title="All 2 branches covered.">        for (PublicCompany company:root.getCompanyManager().getAllPublicCompanies()) {</span>
<span class="fc" id="L108">            soldThisRound.put(company, SoldThisRoundModel.create(this, company));</span>
<span class="fc" id="L109">        }</span>
        // make worth aware of market model
<span class="fc" id="L111">        root.getStockMarket().getMarketModel().addModel(worth);</span>
<span class="fc" id="L112">    }</span>
    
    public String getNameAndPriority() {
<span class="nc bnc" id="L115" title="All 2 branches missed.">        return getId() + (getParent().getPriorityPlayer() == this ? &quot; PD&quot; : &quot;&quot;);</span>
    }
    
    public PlayerNameModel getPlayerNameModel() {
<span class="nc" id="L119">        return playerNameModel;</span>
    }

    /**
     * Get the player's total worth.
     *
     * @return Total worth
     */
    public int getWorth() {
<span class="fc" id="L128">        return worth.value();</span>
    }

    public CalculatedMoneyModel getWorthModel() {
<span class="nc" id="L132">        return worth;</span>
    }

    public MoneyModel getLastORWorthIncrease () {
<span class="fc" id="L136">        return lastORWorthIncrease;</span>
    }

    public void setWorthAtORStart () {
<span class="fc" id="L140">        worthAtORStart.set(getWorth());</span>
<span class="fc" id="L141">    }</span>

    public void setLastORWorthIncrease () {
<span class="fc" id="L144">        lastORWorthIncrease.set(getWorth() - worthAtORStart.value());</span>
<span class="fc" id="L145">    }</span>

    public int getCashValue() {
<span class="fc" id="L148">        return cash.value();</span>
    }
    
    public void updateWorth () {
        // FIXME: Is this method still required
        // worth.update();
<span class="nc" id="L154">    }</span>

    public CertificateCountModel getCertCountModel() {
<span class="nc" id="L157">        return certCount;</span>
    }

    public CalculatedMoneyModel getFreeCashModel() {
<span class="nc" id="L161">        return freeCash;</span>
    }

    public MoneyModel getBlockedCashModel() {
<span class="nc" id="L165">        return blockedCash;</span>
    }

    /**
     * Block cash allocated by a bid.
     *
     * @param amount Amount of cash to be blocked.
     * @return false if the amount was not available.
     */
    public boolean blockCash(int amount) {
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        if (amount &gt; cash.value() - blockedCash.value()) {</span>
<span class="nc" id="L176">            return false;</span>
        } else {
<span class="fc" id="L178">            blockedCash.change(amount);</span>
            // TODO: is this still required?
            // freeCash.update();
<span class="fc" id="L181">            return true;</span>
        }
    }

    /**
     * Unblock cash.
     *
     * @param amount Amount to be unblocked.
     * @return false if the given amount was not blocked.
     */
    public boolean unblockCash(int amount) {
<span class="fc bfc" id="L192" title="All 2 branches covered.">        if (amount &gt; blockedCash.value()) {</span>
<span class="fc" id="L193">            return false;</span>
        } else {
<span class="fc" id="L195">            blockedCash.change(-amount);</span>
            // TODO: is this still required?
            // freeCash.update();
<span class="fc" id="L198">            return true;</span>
        }
    }

    /**
     * @return the unblocked cash (available for bidding)
     */
    public int getFreeCash() {
<span class="fc" id="L206">        return freeCash.value();</span>
    }

    public int getBlockedCash() {
<span class="nc" id="L210">        return blockedCash.value();</span>
    }

    public int getIndex() {
<span class="fc" id="L214">        return index.value();</span>
    }

    public void setIndex(int index) {
<span class="fc" id="L218">        this.index.set(index);</span>
<span class="fc" id="L219">    }</span>

    public void setBankrupt () {
<span class="nc" id="L222">    	bankrupt.set(true);</span>
<span class="nc" id="L223">    }</span>

    public boolean isBankrupt () {
<span class="fc" id="L226">    	return bankrupt.value();</span>
    }
    
    public void resetSoldThisRound() {
<span class="fc bfc" id="L230" title="All 2 branches covered.">        for (SoldThisRoundModel state:soldThisRound.values()) {</span>
<span class="fc" id="L231">            state.set(false);</span>
<span class="fc" id="L232">        }</span>
<span class="fc" id="L233">    }</span>
    
    public boolean hasSoldThisRound(PublicCompany company) {
<span class="fc" id="L236">        return soldThisRound.get(company).value();</span>
    }
    
    public void setSoldThisRound(PublicCompany company) {
<span class="fc" id="L240">        soldThisRound.get(company).set(true);</span>
<span class="fc" id="L241">    }</span>
    
    public SoldThisRoundModel getSoldThisRoundModel(PublicCompany company) {
<span class="nc" id="L244">        return soldThisRound.get(company);</span>
    }

    // MoneyOwner interface
    public Purse getPurse() {
<span class="fc" id="L249">        return cash.getPurse();</span>
    }
    
    public int getCash() {
<span class="fc" id="L253">        return cash.getPurse().value();</span>
    }

    // Owner interface
    public PortfolioModel getPortfolioModel() {
<span class="fc" id="L258">        return portfolio;</span>
    }
    
    /**
     * Compare Players by their total worth, in descending order. This method
     * implements the Comparable interface.
     * second level decision is by name
     */
    public int compareTo(Player p) {
        // first by wealth
<span class="fc" id="L268">        int result = -new Integer(getWorth()).compareTo(new Integer(p.getWorth()));</span>
        // then by name
<span class="fc bfc" id="L270" title="All 2 branches covered.">        if (result == 0)</span>
<span class="fc" id="L271">            result = getId().compareTo(p.getId());</span>
<span class="fc" id="L272">        return result;</span>
    }

    public PurseMoneyModel getWallet() {
<span class="nc" id="L276">        return cash;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>