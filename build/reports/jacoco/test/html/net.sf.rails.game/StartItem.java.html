<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartItem.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game</a> &gt; <span class="el_source">StartItem.java</span></div><h1>StartItem.java</h1><pre class="source lang-java linenums">package net.sf.rails.game;


import java.util.List;
import java.util.Map;

import net.sf.rails.game.financial.BankPortfolio;
import net.sf.rails.game.financial.Certificate;
import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.model.CountingMoneyModel;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.GenericState;
import net.sf.rails.game.state.IntegerState;
import net.sf.rails.game.state.Model;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.common.collect.Maps;

/**
 * Each object of this class represents a &quot;start packet item&quot;, which consist of
 * one or two certificates. The whole start packet must be bought before the
 * stock rounds can start. &lt;p&gt; During XML parsing, only the certificate name and
 * other attributes are saved. The certificate objects are linked to in the
 * later initialisation step.
 */

public class StartItem extends RailsAbstractItem {

    // Fixed properties
<span class="fc" id="L32">    protected Certificate primary = null;</span>
<span class="fc" id="L33">    protected Certificate secondary = null;</span>
<span class="fc" id="L34">    protected final CountingMoneyModel basePrice = CountingMoneyModel.create(this, &quot;basePrice&quot;, false);</span>
    protected boolean reduceable;
<span class="fc" id="L36">    protected int row = 0;</span>
<span class="fc" id="L37">    protected int column = 0;</span>
    protected int index;

    // Bids
<span class="fc" id="L41">    protected final GenericState&lt;Player&gt; lastBidder = GenericState.create(this, &quot;lastBidder&quot;);</span>
<span class="fc" id="L42">    protected final Map&lt;Player, CountingMoneyModel&gt; bids = Maps.newHashMap();</span>
<span class="fc" id="L43">    protected final CountingMoneyModel minimumBid = CountingMoneyModel.create(this, &quot;minimumBid&quot;, false);</span>
<span class="fc" id="L44">    protected final Map&lt;Player, BooleanState&gt; active = Maps.newHashMap();</span>

    /**
     * Status of the start item (buyable? biddable?) regardless whether the
     * current player has the amount of (unblocked) cash to buy it or to bid on
     * it.
     */
<span class="fc" id="L51">    protected final IntegerState status = IntegerState.create(this, &quot;status&quot;);</span>

    public static final int UNAVAILABLE = 0;
    public static final int BIDDABLE = 1;
    public static final int BUYABLE = 2;
    public static final int SELECTABLE = 3;
    public static final int AUCTIONED = 4;
    public static final int NEEDS_SHARE_PRICE = 5; // TODO No longer used (may
    // not be true after
    // bidding), needs code
    // cleanup
    public static final int SOLD = 6;

<span class="fc" id="L64">    protected static final String[] statusName =</span>
            new String[] { &quot;Unavailable&quot;, &quot;Biddable&quot;, &quot;Buyable&quot;, &quot;Selectable&quot;,
                    &quot;Auctioned&quot;, &quot;NeedingSharePrice&quot;, &quot;Sold&quot; };

    // For initialisation purposes only
    protected String type;
    protected boolean president;
<span class="fc" id="L71">    protected String name2 = null;</span>
<span class="fc" id="L72">    protected String type2 = null;</span>
<span class="fc" id="L73">    protected boolean president2 = false;</span>

<span class="fc" id="L75">    public enum NoBidsReaction {</span>
<span class="fc" id="L76">        REDUCE_AND_REBID,</span>
<span class="fc" id="L77">        RUN_OPERATING_ROUND</span>
    };

<span class="fc" id="L80">    protected NoBidsReaction noBidsReaction = NoBidsReaction.RUN_OPERATING_ROUND;</span>

<span class="fc" id="L82">    private static final Logger log =</span>
<span class="fc" id="L83">            LoggerFactory.getLogger(StartItem.class);</span>

    /**
     * The constructor, taking the properties of the &quot;primary&quot; (often teh only)
     * certificate. The parameters are only stored, real initialisation is done
     * by the init() method.
     */
    protected StartItem(RailsItem parent, String id, String type, int index, boolean president) {
<span class="fc" id="L91">        super(parent, id);</span>
<span class="fc" id="L92">        this.type = type;</span>
<span class="fc" id="L93">        this.index = index;</span>
<span class="fc" id="L94">        this.president = president;</span>

<span class="fc" id="L96">        minimumBid.setSuppressZero(true);</span>

<span class="fc" id="L98">    }</span>

    /**
     * @param name The Company name of the primary certificate. This name will
     * also become the name of the start item itself.
     * @param type The CompanyType name of the primary certificate.
     * @param president True if the primary certificate is the president's
     * share.
     * @return a fully intialized StartItem
     */
    public static StartItem create(RailsItem parent, String name, String type, int price, boolean reduceable, int index, boolean president){
<span class="fc" id="L109">        StartItem item = new StartItem(parent, name, type, index, president);</span>
<span class="fc" id="L110">        item.initBasePrice(price);</span>
<span class="fc" id="L111">        item.setReducePrice(reduceable);</span>
<span class="fc" id="L112">        return item;</span>
    }

    protected void initBasePrice(int basePrice) {
<span class="fc" id="L116">        this.basePrice.set(basePrice);</span>
<span class="fc" id="L117">    }</span>

    protected void setReducePrice(boolean reduceable) {
<span class="fc" id="L120">        this.reduceable = reduceable;</span>
<span class="fc" id="L121">    }</span>

    /**
     * Add a secondary certificate, that &quot;comes with&quot; the primary certificate.
     *
     * @param name2 The Company name of the secondary certificate.
     * @param type2 The CompanyType name of the secondary certificate.
     * @param president2 True if the secondary certificate is the president's
     * share.
     */
    public void setSecondary(String name2, String type2, boolean president2) {
<span class="fc" id="L132">        this.name2 = name2;</span>
<span class="fc" id="L133">        this.type2 = type2;</span>
<span class="fc" id="L134">        this.president2 = president2;</span>
<span class="fc" id="L135">    }</span>

    /**
     * Add a secondary certificate, that &quot;comes with&quot; the primary certificate
     * after initialization.
     *
     * @param secondary The secondary certificate.
     */
    public void setSecondary(Certificate secondary) {
<span class="nc" id="L144">        this.secondary = secondary;</span>
<span class="nc" id="L145">    }</span>

    /**
     * Initialisation, to be called after all XML parsing has completed, and
     * after IPO initialisation.
     */
    public void init(GameManager gameManager) {

<span class="fc" id="L153">        List&lt;Player&gt; players = getRoot().getPlayerManager().getPlayers();</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">        for (Player p: players) {</span>
            // TODO: Check if this is correct or that it should be initialized with zero
<span class="fc" id="L156">            CountingMoneyModel bid = CountingMoneyModel.create(this, &quot;bidBy_&quot; + p.getId(), false);</span>
<span class="fc" id="L157">            bid.setSuppressZero(true);</span>
<span class="fc" id="L158">            bids.put(p, bid);</span>
<span class="fc" id="L159">            active.put(p, BooleanState.create(this, &quot;active_&quot; + p.getId()));</span>
<span class="fc" id="L160">        }</span>
        // TODO Leave this for now, but it should be done
        // in the game-specific StartRound class
<span class="fc" id="L163">        minimumBid.set(basePrice.value() + 5);</span>

<span class="fc" id="L165">        BankPortfolio ipo = getRoot().getBank().getIpo();</span>
<span class="fc" id="L166">        BankPortfolio unavailable = getRoot().getBank().getUnavailable();</span>

<span class="fc" id="L168">        CompanyManager compMgr = getRoot().getCompanyManager();</span>

<span class="fc" id="L170">        Company company = compMgr.getCompany(type, getId());</span>
<span class="fc bfc" id="L171" title="All 2 branches covered.">        if (company instanceof PrivateCompany) {</span>
<span class="fc" id="L172">            primary = (Certificate) company;</span>
        } else {
<span class="fc" id="L174">            primary = ipo.getPortfolioModel().findCertificate((PublicCompany) company, president);</span>
            // Move the certificate to the &quot;unavailable&quot; pool.
<span class="fc" id="L176">            PublicCertificate pubcert = (PublicCertificate) primary;</span>
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">            if (pubcert.getOwner() == null</span>
<span class="pc bpc" id="L178" title="1 of 2 branches missed.">                || pubcert.getOwner() != unavailable.getParent()) {</span>
<span class="fc" id="L179">                pubcert.moveTo(unavailable);</span>
            }
        }

        // Check if there is another certificate
<span class="fc bfc" id="L184" title="All 2 branches covered.">        if (name2 != null) {</span>

<span class="fc" id="L186">            Company company2 = compMgr.getCompany(type2, name2);</span>
<span class="pc bpc" id="L187" title="1 of 2 branches missed.">            if (company2 instanceof PrivateCompany) {</span>
<span class="nc" id="L188">                secondary = (Certificate) company2;</span>
            } else {
<span class="fc" id="L190">                secondary =</span>
<span class="fc" id="L191">                        ipo.getPortfolioModel().findCertificate((PublicCompany) company2,</span>
                                president2);
                // Move the certificate to the &quot;unavailable&quot; pool.
                // FIXME: This is still an issue to resolve  ???
<span class="fc" id="L195">                PublicCertificate pubcert2 = (PublicCertificate) secondary;</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                if (pubcert2.getOwner() != unavailable) {</span>
<span class="fc" id="L197">                    pubcert2.moveTo(unavailable);</span>
                }
            }
        }

<span class="fc" id="L202">    }</span>

    public int getIndex() {
<span class="fc" id="L205">        return index;</span>
    }

    /**
     * Set the start packet row. &lt;p&gt; Applies to games like 1835 where start
     * items are organised and become available in rows.
     *
     * @param row
     */
    protected void setRow(int row) {
<span class="fc" id="L215">        this.row = row;</span>
<span class="fc" id="L216">    }</span>

    /**
     * Set the start packet row. &lt;p&gt; Applies to games like 1837 where start
     * items are organised and become available in columns.
     *
     * @param row
     */
    protected void setColumn(int column) {
<span class="nc" id="L225">        this.column = column;</span>
<span class="nc" id="L226">    }</span>

    /**
     * Get the row number.
     *
     * @see setRow()
     * @return The row number. Default 0.
     */
    public int getRow() {
<span class="fc" id="L235">        return row;</span>
    }

    /**
     * Get the column number.
     *
     * @see setColumn()
     * @return The column number. Default 0.
     */
    public int getColumn() {
<span class="nc" id="L245">        return column;</span>
    }

    /**
     * Get the primary (or only) certificate.
     *
     * @return The primary certificate object.
     */
    public Certificate getPrimary() {
<span class="fc" id="L254">        return primary;</span>
    }

    /**
     * Check if there is a secondary certificate.
     *
     * @return True if there is a secondary certificate.
     */
    public boolean hasSecondary() {
<span class="fc bfc" id="L263" title="All 2 branches covered.">        return secondary != null;</span>
    }

    /**
     * Get the secondary certificate.
     *
     * @return The secondary certificate object, or null if it does not exist.
     */
    public Certificate getSecondary() {
<span class="fc" id="L272">        return secondary;</span>
    }

    /**
     * Get the start item base price.
     *
     * @return The base price.
     */
    public int getBasePrice() {
<span class="fc" id="L281">        return basePrice.value();</span>
    }

    public boolean getReduceable() {
<span class="fc" id="L285">        return reduceable;</span>
    }

    public void reduceBasePriceBy(int amount) {
<span class="fc" id="L289">        basePrice.change(-amount);</span>
<span class="fc" id="L290">    }</span>


    /**
     * Register a bid. &lt;p&gt; This method does &lt;b&gt;not&lt;/b&gt; check off the amount of
     * money that a player has available for bidding.
     *
     * @param amount The bid amount.
     * @param bidder The bidding player.
     */
    public void setBid(int amount, Player bidder) {
<span class="fc" id="L301">        CountingMoneyModel bid = bids.get(bidder);</span>
<span class="fc" id="L302">        bid.set(amount);</span>
<span class="fc" id="L303">        bid.setSuppressZero(false);</span>
<span class="fc" id="L304">        active.get(bidder).set(true);</span>
<span class="fc" id="L305">        lastBidder.set(bidder);</span>
<span class="fc" id="L306">        minimumBid.set(amount + 5);</span>
<span class="fc" id="L307">    }</span>

    /**
     * Get the currently highest bid amount.
     *
     * @return The bid amount (0 if there have been no bids yet).
     */
    public int getBid() {
<span class="fc bfc" id="L315" title="All 2 branches covered.">        if (lastBidder.value() == null) {</span>
<span class="fc" id="L316">            return 0;</span>
        } else {
<span class="fc" id="L318">            return bids.get(lastBidder.value()).value();</span>
        }
    }

    /**
     * Get the highest bid done so far by a particular player.
     *
     * @param player The name of the player.
     * @return The bid amount for this player (default 0).
     */
    public int getBid(Player player) {
<span class="fc" id="L329">        return bids.get(player).value();</span>
    }

    /**
     * Return the total number of players that has done bids so far on this
     * item.
     *
     * @return The number of bidders.
     */
    public int getBidders() {
<span class="fc" id="L339">        int bidders = 0;</span>
<span class="fc bfc" id="L340" title="All 2 branches covered.">        for (Player bidder:active.keySet()) {</span>
<span class="fc bfc" id="L341" title="All 2 branches covered.">            if (active.get(bidder).value() == true) {</span>
<span class="fc" id="L342">                bidders++;</span>
            }
<span class="fc" id="L344">        }</span>
<span class="fc" id="L345">        return bidders;</span>
    }

    /**
     * Get the highest bidder so far.
     *
     * @return The player object that did the highest bid.
     */
    public Player getBidder() {
<span class="fc" id="L354">        return lastBidder.value();</span>
    }

    public void setPass(Player player) {
<span class="fc" id="L358">        active.get(player).set(false);</span>
<span class="fc" id="L359">        CountingMoneyModel bid = bids.get(player);</span>
<span class="fc" id="L360">        bid.set(0);</span>
<span class="fc" id="L361">        bid.setSuppressZero(true);</span>
<span class="fc" id="L362">    }</span>

    /**
     * Get the minimum allowed next bid. TODO 5 should be configurable.
     *
     * @return Minimum bid
     */
    public int getMinimumBid() {
<span class="fc" id="L370">        return minimumBid.value();</span>
    }

    public void setMinimumBid(int value) {
<span class="fc" id="L374">        minimumBid.set(value);</span>
<span class="fc" id="L375">    }</span>

    /**
     * Check if a player has done any bids on this start item.
     *
     * @param playerName The name of the player.
     * @return True if this player is active for this startItem
     */
    public boolean isActive(Player player) {
<span class="fc" id="L384">        return active.get(player).value();</span>
    }


    /**
     * Set all players to active on this start item.  Used when
     * players who did not place a bid are still allowed to
     * participate in an auction (e.g. 1862)
     */
    public void setAllActive() {
<span class="fc bfc" id="L394" title="All 2 branches covered.">        for (Player p:active.keySet()) {</span>
<span class="fc" id="L395">            active.get(p).set(true);</span>
<span class="fc" id="L396">        }</span>
<span class="fc" id="L397">    }</span>

    /**
     * Check if the start item has been sold.
     *
     * @return True if this item has been sold.
     */
    public boolean isSold() {
<span class="fc bfc" id="L405" title="All 2 branches covered.">        return status.value() == SOLD;</span>
    }

    /**
     * Set the start item sold status.
     *
     * @param sold The new sold status (usually true).
     */
    public void setSold(Player player, int buyPrice) {
<span class="fc" id="L414">        status.set(SOLD);</span>


<span class="fc" id="L417">        lastBidder.set(player);</span>

        // For display purposes, set all lower bids to zero
<span class="fc bfc" id="L420" title="All 2 branches covered.">        for (Player p:bids.keySet()) {</span>
<span class="fc" id="L421">            CountingMoneyModel bid = bids.get(p);</span>
            // Unblock any bid money
<span class="fc bfc" id="L423" title="All 2 branches covered.">            if (bid.value() &gt; 0) {</span>
<span class="fc" id="L424">                p.unblockCash(bid.value());</span>
<span class="fc bfc" id="L425" title="All 2 branches covered.">                if (p != player) {</span>
<span class="fc" id="L426">                    bid.set(0);</span>
<span class="fc" id="L427">                    bid.setSuppressZero(true);</span>
                }
<span class="fc" id="L429">                active.get(p).set(false);;</span>
            }
<span class="fc" id="L431">        }</span>
        // for winning bidder set bid to buyprice
<span class="fc" id="L433">        bids.get(player).set(buyPrice);</span>
<span class="fc" id="L434">        minimumBid.set(0);</span>
<span class="fc" id="L435">    }</span>

    /**
     * This method indicates if there is a company for which a par price must be
     * set when this start item is bought. The UI can use this to ask for the
     * price immediately, so bypassing the extra &quot;price asking&quot; intermediate
     * step.
     *
     * @return A public company for which a price must be set.
     */
    public PublicCompany needsPriceSetting() {
        PublicCompany company;

<span class="pc bpc" id="L448" title="1 of 2 branches missed.">        if ((company = checkNeedForPriceSetting(primary)) != null) {</span>
<span class="nc" id="L449">            return company;</span>
<span class="fc bfc" id="L450" title="All 2 branches covered.">        } else if (secondary != null</span>
<span class="fc bfc" id="L451" title="All 2 branches covered.">                   &amp;&amp; ((company = checkNeedForPriceSetting(secondary)) != null)) {</span>
<span class="fc" id="L452">            return company;</span>
        }

<span class="fc" id="L455">        return null;</span>
    }

    /**
     * If a start item component a President's certificate that needs price
     * setting, return the name of thecompany for which the price must be set.
     *
     * @param certificate
     * @return Name of public company, or null
     */
    protected PublicCompany checkNeedForPriceSetting(Certificate certificate) {

<span class="fc bfc" id="L467" title="All 2 branches covered.">        if (!(certificate instanceof PublicCertificate)) return null;</span>

<span class="fc" id="L469">        PublicCertificate publicCert = (PublicCertificate) certificate;</span>

<span class="fc bfc" id="L471" title="All 2 branches covered.">        if (!publicCert.isPresidentShare()) return null;</span>

<span class="fc" id="L473">        PublicCompany company = publicCert.getCompany();</span>

<span class="fc bfc" id="L475" title="All 2 branches covered.">        if (!company.hasStockPrice()) return null;</span>

<span class="fc bfc" id="L477" title="All 2 branches covered.">        if (company.getIPOPrice() != 0) return null;</span>

<span class="fc" id="L479">        return company;</span>

    }

    public int getStatus() {
<span class="fc" id="L484">        return status.value();</span>
    }

    public IntegerState getStatusModel () {
<span class="nc" id="L488">        return status;</span>
    }

    public String getStatusName() {
<span class="nc" id="L492">        return statusName[status.value()];</span>
    }

    public void setStatus(int status) {
<span class="fc" id="L496">        this.status.set(status);</span>
<span class="fc" id="L497">    }</span>

    public Model getBasePriceModel() {
<span class="nc" id="L500">        return basePrice;</span>
    }

    public Model getBidForPlayerModel(Player player) {
<span class="nc" id="L504">        return bids.get(player);</span>
    }

    public Model getMinimumBidModel() {
<span class="nc" id="L508">        return minimumBid;</span>
    }

    public String getType() {
<span class="nc" id="L512">        return type;</span>
    }

    public void setNoBidsReaction(NoBidsReaction action) {
<span class="nc" id="L516">        this.noBidsReaction = action;</span>
<span class="nc" id="L517">    }</span>

    public NoBidsReaction getNoBidsReaction() {
<span class="nc" id="L520">        return noBidsReaction;</span>
    }

    public String getText () {
<span class="nc" id="L524">        return toString();</span>
    }

}

</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>