<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PlayerShareUtils.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.financial</a> &gt; <span class="el_source">PlayerShareUtils.java</span></div><h1>PlayerShareUtils.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.financial;

import java.util.Iterator;
import java.util.List;
import java.util.SortedSet;

import net.sf.rails.game.GameDef;
import net.sf.rails.game.Player;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.GameDef.Parm;
import net.sf.rails.game.financial.PublicCertificate.Combination;
import net.sf.rails.game.model.CertificatesModel;
import net.sf.rails.game.state.Portfolio;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.ImmutableSortedSet;

/**
 * PlayerShareUtils is a class with static methods around president changes etc.
 */
<span class="nc" id="L21">public class PlayerShareUtils {</span>
    
    public static SortedSet&lt;Integer&gt; sharesToSell (PublicCompany company, Player player) {
        
<span class="fc bfc" id="L25" title="All 2 branches covered.">        if (company.hasMultipleCertificates()) {</span>
<span class="pc bpc" id="L26" title="1 of 2 branches missed.">            if (player == company.getPresident()) {</span>
<span class="fc" id="L27">                return presidentSellMultiple(company, player);</span>
            } else {
<span class="nc" id="L29">                return otherSellMultiple(company, player);</span>
            }
        } else {
<span class="pc bpc" id="L32" title="1 of 2 branches missed.">            if (player == company.getPresident()) {</span>
<span class="fc" id="L33">                return presidentSellStandard(company, player);</span>
            } else {
<span class="nc" id="L35">                return otherSellStandard(company, player);</span>
            }
        }
        
    }
    
    public static int poolAllowsShareNumbers(PublicCompany company) {
<span class="fc" id="L42">        int poolShares = Bank.getPool(company).getPortfolioModel().getShareNumber(company);</span>
<span class="fc" id="L43">        int poolMax = (GameDef.getGameParameterAsInt(company, GameDef.Parm.POOL_SHARE_LIMIT) / company.getShareUnit() </span>
                - poolShares);
<span class="fc" id="L45">        return poolMax;</span>
    }
    
    // President selling for companies WITHOUT multiple certificates
    private static SortedSet&lt;Integer&gt; presidentSellStandard(PublicCompany company, Player president) {
<span class="fc" id="L50">        int presidentShares = president.getPortfolioModel().getShareNumber(company);</span>
<span class="fc" id="L51">        int poolShares = poolAllowsShareNumbers(company);</span>
        
        // check if there is a potential new president ...
<span class="fc" id="L54">        int presidentCertificateShares = company.getPresidentsShare().getShares();</span>
<span class="fc" id="L55">        Player potential = company.findPlayerToDump();</span>

        int maxShares;
<span class="pc bpc" id="L58" title="1 of 2 branches missed.">        if (potential == null) {</span>
            // ... if there is none, selling is only possible until the presidentCerificate or pool maximum
<span class="nc" id="L60">            maxShares = Math.min(presidentShares - presidentCertificateShares, poolShares);</span>
        } else { 
            // otherwise until pool maximum only
<span class="fc" id="L63">            maxShares = Math.min(presidentShares, poolShares);</span>
        }
         
<span class="fc" id="L66">        ImmutableSortedSet.Builder&lt;Integer&gt; sharesToSell = ImmutableSortedSet.naturalOrder();</span>
<span class="fc bfc" id="L67" title="All 2 branches covered.">        for (int s=1; s &lt;= maxShares; s++) {</span>
<span class="fc" id="L68">            sharesToSell.add(s);</span>
        }
<span class="fc" id="L70">        return sharesToSell.build();</span>
    }
    
    // Non-president selling for companies WITHOUT multiple certificates
    private static SortedSet&lt;Integer&gt; otherSellStandard(PublicCompany company, Player player) {
<span class="fc" id="L75">        int playerShares = player.getPortfolioModel().getShareNumber(company);</span>
<span class="fc" id="L76">        int poolShares = poolAllowsShareNumbers(company);</span>
        
<span class="fc" id="L78">        ImmutableSortedSet.Builder&lt;Integer&gt; sharesToSell = ImmutableSortedSet.naturalOrder();</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">        for (int s=1; s &lt;= Math.min(playerShares, poolShares); s++) {</span>
<span class="fc" id="L80">            sharesToSell.add(s);</span>
        }
<span class="fc" id="L82">        return sharesToSell.build();</span>
    }
    
    
    // President selling for companies WITH multiple certificates
    private static SortedSet&lt;Integer&gt; presidentSellMultiple(PublicCompany company, Player president) {
        
        // first: check what number of shares have to be dumped
<span class="fc" id="L90">        int presidentShareNumber = president.getPortfolioModel().getShare(company);</span>
<span class="fc" id="L91">        PublicCertificate presidentCert = company.getPresidentsShare();</span>
<span class="fc" id="L92">        Player potential = company.findPlayerToDump();</span>
<span class="fc" id="L93">        int potentialShareNumber = potential.getPortfolioModel().getShare(company);</span>
<span class="fc" id="L94">        int shareNumberDumpDifference = presidentShareNumber - potentialShareNumber;</span>
<span class="fc" id="L95">        boolean presidentShareOnly = false;</span>
        
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (presidentCert.getShare() == presidentShareNumber)  { // Only President Share to be sold...</span>
<span class="fc" id="L98">            presidentShareOnly = true;</span>
        }
        
        // ... if this is less than what the pool allows =&gt; goes back to non-president selling
<span class="fc" id="L102">        int poolAllows = poolAllowsShareNumbers(company);</span>
<span class="fc bfc" id="L103" title="All 4 branches covered.">        if ((shareNumberDumpDifference &lt;= poolAllows) &amp;&amp; (!presidentShareOnly)) {</span>
<span class="fc" id="L104">            return otherSellMultiple(company, president);</span>
        }
        
        // second: separate the portfolio into other shares and president certificate
<span class="fc" id="L108">        ImmutableList.Builder&lt;PublicCertificate&gt; otherCerts = ImmutableList.builder();</span>
<span class="fc bfc" id="L109" title="All 2 branches covered.">        for (PublicCertificate c:president.getPortfolioModel().getCertificates(company)) {</span>
<span class="fc bfc" id="L110" title="All 2 branches covered.">            if (!c.isPresidentShare()) {</span>
<span class="fc" id="L111">                otherCerts.add(c);</span>
            }
<span class="fc" id="L113">        }</span>
        
        // third: retrieve the share number combinations of the non-president certificates
<span class="fc" id="L116">        SortedSet&lt;Integer&gt; otherShareNumbers = CertificatesModel.shareNumberCombinations(otherCerts.build(), poolAllows);</span>
        
        // fourth: combine pool and potential certificates, those are possible returns
<span class="fc" id="L119">        ImmutableList.Builder&lt;PublicCertificate&gt; returnCerts = ImmutableList.builder();</span>
<span class="fc" id="L120">        returnCerts.addAll(Bank.getPool(company).getPortfolioModel().getCertificates(company));</span>
<span class="fc" id="L121">        returnCerts.addAll(potential.getPortfolioModel().getCertificates(company));</span>
<span class="fc" id="L122">        SortedSet&lt;Integer&gt; returnShareNumbers = CertificatesModel.shareNumberCombinations(returnCerts.build(), presidentCert.getShares());</span>
        
<span class="fc" id="L124">        ImmutableSortedSet.Builder&lt;Integer&gt; sharesToSell = ImmutableSortedSet.naturalOrder();</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">        for (Integer s:otherShareNumbers) {</span>
<span class="pc bpc" id="L126" title="1 of 2 branches missed.">            if (s &lt;= shareNumberDumpDifference){</span>
                // shareNumber is below or equal the dump difference =&gt; add as possibility to sell without dump
<span class="fc" id="L128">                sharesToSell.add(s);</span>
            }
            // now check if there are dumping possibilities
<span class="fc bfc" id="L131" title="All 2 branches covered.">            for (int d=1; d &lt;= presidentCert.getShares(); d++) {</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">                if (s+d &lt;= poolAllows) { </span>
                    // d is the amount sold in addition to standard shares, returned has the remaining part of the president share
<span class="fc" id="L134">                    int remaining = presidentCert.getShares() - d;</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">                    if (returnShareNumbers.contains(remaining)) {</span>
<span class="fc" id="L136">                        sharesToSell.add(s+d);</span>
                    }
                } else {
                    break; // pool is full
                }
            }
<span class="fc" id="L142">        }</span>
<span class="fc" id="L143">        return sharesToSell.build();</span>
    }
    
    // Non-president selling for companies WITH multiple certificates
    private static SortedSet&lt;Integer&gt; otherSellMultiple(PublicCompany company, Player player) {
        
        // check if there is a multiple certificate inside the portfolio
<span class="fc bfc" id="L150" title="All 2 branches covered.">        if (player.getPortfolioModel().containsMultipleCert(company)) {</span>
<span class="fc" id="L151">            int poolAllows = poolAllowsShareNumbers(company);</span>
<span class="fc" id="L152">            SortedSet&lt;PublicCertificate&gt; certificates = player.getPortfolioModel().getCertificates(company);</span>
<span class="fc" id="L153">            return CertificatesModel.shareNumberCombinations(certificates, poolAllows);</span>
        } else { // otherwise standard case
<span class="fc" id="L155">            return otherSellStandard(company, player);</span>
        }
    }

    // FIXME: Rails 2.x This is a helper function as long as the sold certificates are not stored
    public static int presidentShareNumberToSell(PublicCompany company, Player president, Player dumpedPlayer,  int nbCertsToSell) {
<span class="fc" id="L161">        int dumpThreshold = president.getPortfolioModel().getShareNumber(company) - dumpedPlayer.getPortfolioModel().getShareNumber(company);</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">        if (nbCertsToSell &gt; dumpThreshold) {</span>
            // reduce the nbCertsToSell by the presidentShare (but it can be sold partially...)
<span class="fc" id="L164">            return Math.min(company.getPresidentsShare().getShares(), nbCertsToSell);</span>
        } else {
<span class="fc" id="L166">            return 0;</span>
        }
    }
    
    // FIXME: Rails 2.x This is a helper function as long as the sold certificates are not stored
    public static List&lt;PublicCertificate&gt; findCertificatesToSell(PublicCompany company, Player player, int nbCertsToSell, int shareUnits) {
  
        // check for &lt;= 0 =&gt; empty list
<span class="fc bfc" id="L174" title="All 2 branches covered.">        if (nbCertsToSell &lt;= 0) {</span>
<span class="fc" id="L175">            return ImmutableList.of();</span>
        }
        
<span class="fc" id="L178">        ImmutableList.Builder&lt;PublicCertificate&gt; certsToSell = ImmutableList.builder();</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">        for (PublicCertificate cert:player.getPortfolioModel().getCertificates(company)) {</span>
<span class="fc bfc" id="L180" title="All 4 branches covered.">            if (!cert.isPresidentShare() &amp;&amp; cert.getShares() == shareUnits) {</span>
<span class="fc" id="L181">                certsToSell.add(cert);</span>
<span class="fc" id="L182">                nbCertsToSell--;</span>
<span class="fc bfc" id="L183" title="All 2 branches covered.">                if (nbCertsToSell == 0) {</span>
<span class="fc" id="L184">                    break;</span>
                }
            }
<span class="pc bpc" id="L187" title="1 of 4 branches missed.">                else if (cert.isPresidentShare() &amp;&amp; cert.getShares()== shareUnits) {</span>
<span class="nc" id="L188">                    certsToSell.add(cert);</span>
<span class="nc" id="L189">                    nbCertsToSell--;</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                    if (nbCertsToSell == 0) {</span>
<span class="nc" id="L191">                        break;</span>
                }
            }
<span class="fc" id="L194">        }</span>
        
<span class="fc" id="L196">        return certsToSell.build();</span>
    }
    
    public static void executePresidentTransferAfterDump(PublicCompany company, Player newPresident, BankPortfolio bankTo, int presSharesToSell) {
        
        // 1. Move the swap certificates from new president to the pool
<span class="fc" id="L202">        PublicCertificate presidentCert = company.getPresidentsShare();</span>

        // ... get all combinations for the presidentCert share numbers
<span class="fc" id="L205">        SortedSet&lt;Combination&gt; combinations = CertificatesModel.certificateCombinations(</span>
<span class="fc" id="L206">                newPresident.getPortfolioModel().getCertificates(company), presidentCert.getShares());</span>
    
        // ... move them to the Bank
        // FIXME: this should be based on a selection of the new president, however it chooses the combination with most certificates
<span class="fc" id="L210">        Combination swapToBank = combinations.last();</span>
<span class="fc" id="L211">        Portfolio.moveAll(swapToBank, bankTo);</span>
        
        // 2. Move the replace certificates from the bank to the old president
        
        // What is the difference between the shares to sell and the president share number
<span class="fc" id="L216">        int replaceShares = presidentCert.getShares() - presSharesToSell;</span>
<span class="fc bfc" id="L217" title="All 2 branches covered.">        if (replaceShares &gt; 0) {</span>
<span class="fc" id="L218">            combinations = CertificatesModel.certificateCombinations(</span>
<span class="fc" id="L219">                    bankTo.getPortfolioModel().getCertificates(company), replaceShares);</span>
            // FIXME: this should be based on a selection of the previous president, however it chooses the combination with least certificates
<span class="fc" id="L221">            Combination swapFromBank = combinations.first();</span>
            // ... move to (old) president
<span class="fc" id="L223">            Portfolio.moveAll(swapFromBank, company.getPresident());</span>
        }
        
        // 3. Transfer the president certificate
<span class="fc" id="L227">        presidentCert.moveTo(newPresident);</span>
<span class="fc" id="L228">    }</span>
    
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>