<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NationalFormationRound.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.financial</a> &gt; <span class="el_source">NationalFormationRound.java</span></div><h1>NationalFormationRound.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.financial;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.DiscardTrain;
import rails.game.action.FoldIntoNational;
import rails.game.action.PossibleAction;

import com.google.common.collect.Iterables;

import net.sf.rails.common.DisplayBuffer;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.BaseToken;
import net.sf.rails.game.Company;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.MapHex;
import net.sf.rails.game.Phase;
import net.sf.rails.game.Player;
import net.sf.rails.game.PrivateCompany;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.Stop;
import net.sf.rails.game.Train;
import net.sf.rails.game.round.RoundFacade;
import net.sf.rails.game.special.ExchangeForShare;
import net.sf.rails.game.special.SpecialProperty;
import net.sf.rails.game.state.Currency;

public class NationalFormationRound extends StockRound {
<span class="nc" id="L36">    private static final Logger log = LoggerFactory.getLogger(NationalFormationRound.class);</span>

    public NationalFormationRound(GameManager parent, String id) {
<span class="nc" id="L39">        super(parent, id);</span>
        // TODO Auto-generated constructor stub
<span class="nc" id="L41">    }</span>


    private static PublicCompany nationalToFound;
    private PublicCompany nationalStartingMinor;
    private Phase phase;
    private boolean startNational;
    private boolean forcedStart;
    private boolean mergeNational;
    private boolean forcedMerge;
    private List&lt;Company&gt; foldablePreNationals;

<span class="nc" id="L53">    protected enum Step {</span>
<span class="nc" id="L54">            START,</span>
<span class="nc" id="L55">            MERGE,</span>
<span class="nc" id="L56">            DISCARD_TRAINS</span>
        }

    private Step step;


    public static boolean nationalIsComplete(GameManager gameManager, String nationalInFounding) {

<span class="nc bnc" id="L64" title="All 2 branches missed.">        for (PublicCompany company : gameManager.getAllPublicCompanies()) {</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">            if (company.isRelatedToNational(nationalInFounding)) {</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                 if (!company.isClosed()) return false;</span>
            }
<span class="nc" id="L68">        }</span>
<span class="nc" id="L69">        return true;</span>
    }

    @Override
    public void start() {

<span class="nc" id="L75">        PublicCompany nationalToFound = gameManager.getNationalToFound();</span>
<span class="nc" id="L76">        phase = Phase.getCurrent(this);</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">        startNational = !nationalToFound.hasStarted();</span>
<span class="nc" id="L78">        forcedMerge = phase.getId().equals(&quot;5&quot;); //TODO Make setable</span>
<span class="nc bnc" id="L79" title="All 4 branches missed.">        forcedStart = phase.getId().equals(&quot;4+4&quot;) || forcedMerge;//TODO Make setable</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">        mergeNational = !nationalIsComplete(gameManager, nationalToFound.getId());</span>

<span class="nc" id="L82">        ReportBuffer.add(this, LocalText.getText(&quot;StartFormationRound&quot;, nationalToFound.getId()));</span>
<span class="nc" id="L83">        log.debug(&quot;StartNational={} forcedStart={} mergeNational={} forcedMerge={}&quot;, startNational, forcedStart, mergeNational, forcedMerge);</span>

<span class="nc bnc" id="L85" title="All 2 branches missed.">        step = startNational ? Step.START : Step.MERGE;</span>

<span class="nc bnc" id="L87" title="All 2 branches missed.">        if (step == Step.START) { //Attention there might be more than one National in Merge at once..</span>

<span class="nc" id="L89">            nationalStartingMinor = getRoot().getCompanyManager().getPublicCompany(nationalToFound.getFoundingStartCompany());</span>
<span class="nc" id="L90">            setCurrentPlayer(nationalStartingMinor.getPresident());</span>
<span class="nc" id="L91">            gameManager.setNationalFormationStartingPlayer( nationalToFound, currentPlayer);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            if (forcedStart) {</span>
<span class="nc" id="L93">                executeStartNational(true, nationalToFound);</span>
<span class="nc" id="L94">                step = Step.MERGE;</span>
            }
        }

<span class="nc bnc" id="L98" title="All 2 branches missed.">        if (step == Step.MERGE) {</span>
<span class="nc" id="L99">            startingPlayer</span>
<span class="nc" id="L100">            = gameManager.getNationalFormationStartingPlayer(nationalToFound);</span>
<span class="nc" id="L101">            log.debug(&quot;Original National starting player was {}&quot;, startingPlayer.getId());</span>
<span class="nc" id="L102">            setCurrentPlayer(startingPlayer);</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (forcedMerge) {</span>
                Set&lt;SpecialProperty&gt; sps;
<span class="nc" id="L105">                setFoldablePreNationals(nationalToFound.getAlias());</span>
<span class="nc" id="L106">                List&lt;Company&gt; foldables = new ArrayList&lt;Company&gt; ();</span>
<span class="nc bnc" id="L107" title="All 2 branches missed.">                for (PrivateCompany company : gameManager.getAllPrivateCompanies()) {</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">                    if (company.isClosed()) continue;</span>
<span class="nc" id="L109">                    sps = company.getSpecialProperties();</span>
<span class="nc bnc" id="L110" title="All 6 branches missed.">                    if (sps != null &amp;&amp; !sps.isEmpty() &amp;&amp; Iterables.get(sps, 0) instanceof ExchangeForShare) {</span>
<span class="nc" id="L111">                        foldables.add(company);</span>
                    }
<span class="nc" id="L113">                }</span>
<span class="nc bnc" id="L114" title="All 2 branches missed.">                for (PublicCompany company : gameManager.getAllPublicCompanies()) {</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">                    if (company.isClosed()) continue;</span>
<span class="nc" id="L116">                    sps = company.getSpecialProperties();</span>
<span class="nc bnc" id="L117" title="All 6 branches missed.">                    if (sps != null &amp;&amp; !sps.isEmpty() &amp;&amp; Iterables.get(sps, 0) instanceof ExchangeForShare) {</span>
<span class="nc" id="L118">                        foldables.add(company);</span>
                    }
<span class="nc" id="L120">                }</span>
<span class="nc" id="L121">                executeExchange (foldables, false, true);</span>

                // Check if the National must discard any trains
<span class="nc bnc" id="L124" title="All 2 branches missed.">                if (nationalToFound.getNumberOfTrains() &gt; nationalToFound.getCurrentTrainLimit()) {</span>
<span class="nc" id="L125">                    step = Step.DISCARD_TRAINS;</span>
                } else {
<span class="nc" id="L127">                    finishRound();</span>
                }
<span class="nc" id="L129">            } else {</span>
<span class="nc" id="L130">                findNextMergingPlayer(false);</span>
            }
        }
<span class="nc" id="L133">    }</span>

    private void setFoldablePreNationals(String nationalInFounding2) {

<span class="nc" id="L137">        foldablePreNationals = new ArrayList&lt;Company&gt; ();</span>

        PublicCompany company;
        Set&lt;SpecialProperty&gt; sps;
<span class="nc bnc" id="L141" title="All 2 branches missed.">        for (PublicCertificate cert : currentPlayer.getPortfolioModel().getCertificates()) {</span>
<span class="nc" id="L142">            company = cert.getCompany();</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">            if (company.isRelatedToNational(nationalInFounding2)) {</span>
<span class="nc" id="L144">                sps = company.getSpecialProperties();</span>
<span class="nc bnc" id="L145" title="All 6 branches missed.">                if (sps != null &amp;&amp; !sps.isEmpty() &amp;&amp; Iterables.get(sps, 0) instanceof ExchangeForShare) {</span>
<span class="nc" id="L146">                    foldablePreNationals.add(company);</span>
                }
             }
<span class="nc" id="L149">        }</span>
<span class="nc" id="L150">    }</span>

    @Override
    public boolean setPossibleActions() {

<span class="nc bnc" id="L155" title="All 2 branches missed.">        if (step == Step.START) {</span>
<span class="nc" id="L156">            Player startingMinorOwner = nationalStartingMinor.getPresident();</span>
<span class="nc" id="L157">            startingPlayer = startingMinorOwner;</span>
<span class="nc" id="L158">            setCurrentPlayer(startingMinorOwner);</span>
<span class="nc" id="L159">            ReportBuffer.add(this, LocalText.getText(&quot;StartingPlayer&quot;,</span>
<span class="nc" id="L160">                    playerManager.getCurrentPlayer().getId()</span>
                    ));

<span class="nc" id="L163">            possibleActions.add(new FoldIntoNational(nationalStartingMinor));</span>

<span class="nc bnc" id="L165" title="All 2 branches missed.">        } else if (step == Step.MERGE) {</span>

<span class="nc" id="L167">            possibleActions.add(new FoldIntoNational(foldablePreNationals));</span>

<span class="nc bnc" id="L169" title="All 2 branches missed.">        } else if (step == Step.DISCARD_TRAINS) {</span>

<span class="nc bnc" id="L171" title="All 2 branches missed.">            if (nationalToFound.getNumberOfTrains() &gt; nationalToFound.getCurrentTrainLimit()) {</span>
<span class="nc" id="L172">                log.debug(&quot;+++ National {} has {}, limit is {}&quot;, nationalToFound.getLongName(), nationalToFound.getNumberOfTrains(), nationalToFound.getCurrentTrainLimit());</span>
<span class="nc" id="L173">                possibleActions.add(new DiscardTrain(nationalToFound,</span>
<span class="nc" id="L174">                        nationalToFound.getPortfolioModel().getUniqueTrains(), true));</span>
            }
        }
<span class="nc" id="L177">        return true;</span>

    }


    @Override
    protected boolean processGameSpecificAction(PossibleAction action) {

<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (action instanceof FoldIntoNational) {</span>

<span class="nc" id="L187">            FoldIntoNational a = (FoldIntoNational) action;</span>

<span class="nc bnc" id="L189" title="All 2 branches missed.">            if (step == Step.START) {</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                if (!startNational(a)) {</span>
<span class="nc" id="L191">                    finishRound();</span>
                } else {
<span class="nc" id="L193">                    step = Step.MERGE;</span>
<span class="nc" id="L194">                    findNextMergingPlayer(false);</span>
                }

<span class="nc bnc" id="L197" title="All 2 branches missed.">            } else if (step == Step.MERGE) {</span>

<span class="nc" id="L199">                mergeIntoNational (a);</span>

            }

<span class="nc" id="L203">            return true;</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        } else if (action instanceof DiscardTrain) {</span>

<span class="nc" id="L207">            discardTrain ((DiscardTrain) action);</span>
<span class="nc" id="L208">            return true;</span>

        } else {
<span class="nc" id="L211">            return false;</span>
        }
    }

    protected boolean findNextMergingPlayer(boolean skipCurrentPlayer) {

        while (true) {

<span class="nc bnc" id="L219" title="All 2 branches missed.">            if (skipCurrentPlayer) {</span>
<span class="nc" id="L220">                setNextPlayer();</span>
<span class="nc bnc" id="L221" title="All 2 branches missed.">                if (playerManager.getCurrentPlayer() == startingPlayer) {</span>
<span class="nc bnc" id="L222" title="All 2 branches missed.">                    if (nationalToFound.getNumberOfTrains() &gt; nationalToFound.getCurrentTrainLimit()) {</span>
<span class="nc" id="L223">                        step = Step.DISCARD_TRAINS;</span>
                    } else {
<span class="nc" id="L225">                        finishRound();</span>
                    }
<span class="nc" id="L227">                    return false;</span>
                }
            }

<span class="nc" id="L231">            setFoldablePreNationals(nationalToFound.getAlias());</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (!foldablePreNationals.isEmpty()) return true;</span>
<span class="nc" id="L233">            skipCurrentPlayer = true;</span>
        }
    }

    private boolean startNational(FoldIntoNational action) {

        // Validate
<span class="nc" id="L240">        String errMsg = null;</span>

<span class="nc" id="L242">        List&lt;Company&gt; folded = action.getFoldedCompanies();</span>
<span class="nc bnc" id="L243" title="All 4 branches missed.">        boolean folding = folded != null &amp;&amp; !folded.isEmpty();</span>

<span class="nc bnc" id="L245" title="All 2 branches missed.">        while (folding) {</span>
<span class="nc bnc" id="L246" title="All 2 branches missed.">            if (!(nationalStartingMinor.getId().equals(action.getFoldedCompanyNames()))) {</span>
<span class="nc" id="L247">                errMsg = LocalText.getText(&quot;WrongCompany&quot;,</span>
<span class="nc" id="L248">                        action.getFoldedCompanyNames(),</span>
<span class="nc" id="L249">                        nationalStartingMinor.getId());</span>
                break;
            }
            break;
        }

<span class="nc bnc" id="L255" title="All 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L256">            DisplayBuffer.add(this, LocalText.getText(&quot;CannotMerge&quot;,</span>
<span class="nc" id="L257">                    action.getFoldedCompanyNames(),</span>
<span class="nc" id="L258">                    nationalToFound.getId(),</span>
                    errMsg));
<span class="nc" id="L260">            return false;</span>
        }

        // all actions linked during formation round to avoid serious undo problems

        // FIXME: changeStack.linkToPreviousMoveSet();

<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (folding) executeStartNational(false, nationalToFound);</span>

<span class="nc" id="L269">        return folding;</span>
    }

    private void executeStartNational(boolean display, PublicCompany comp) {

<span class="nc" id="L274">        nationalToFound.start();</span>
<span class="nc" id="L275">        String message = LocalText.getText(&quot;START_MERGED_COMPANY&quot;,</span>
<span class="nc" id="L276">                comp.getId(),</span>
<span class="nc" id="L277">                Bank.format(this, nationalToFound.getIPOPrice()),</span>
<span class="nc" id="L278">                nationalToFound.getStartSpace().toText());</span>
<span class="nc" id="L279">        ReportBuffer.add(this, message);</span>
<span class="nc bnc" id="L280" title="All 2 branches missed.">        if (display) DisplayBuffer.add(this, message);</span>

        // add money from sold shares
        // Move cash and shares where required
<span class="nc" id="L284">        int capFactor = nationalToFound.getSoldPercentage() / (nationalToFound.getShareUnit() * nationalToFound.getShareUnitsForSharePrice());</span>
<span class="nc" id="L285">        int cash = capFactor * nationalToFound.getIPOPrice();</span>

<span class="nc bnc" id="L287" title="All 2 branches missed.">        if (cash &gt; 0) {</span>
<span class="nc" id="L288">            String cashText = Currency.fromBank(cash, nationalToFound);</span>
<span class="nc" id="L289">            ReportBuffer.add(this, LocalText.getText(&quot;FloatsWithCash&quot;,</span>
<span class="nc" id="L290">                nationalToFound.getId(),</span>
                cashText ));
<span class="nc" id="L292">        } else {</span>
<span class="nc" id="L293">            ReportBuffer.add(this, LocalText.getText(&quot;Floats&quot;,</span>
<span class="nc" id="L294">                    nationalToFound.getId()));</span>
        }

<span class="nc" id="L297">        executeExchange (Arrays.asList(new Company[]{nationalStartingMinor}), true, false);</span>
<span class="nc" id="L298">        nationalToFound.setFloated();</span>
<span class="nc" id="L299">    }</span>

    private boolean mergeIntoNational(FoldIntoNational action) {

        // Validate
        // String errMsg = null;

<span class="nc" id="L306">        List&lt;Company&gt; folded = action.getFoldedCompanies();</span>
<span class="nc bnc" id="L307" title="All 4 branches missed.">        boolean folding = folded != null &amp;&amp; !folded.isEmpty();</span>

<span class="nc bnc" id="L309" title="All 2 branches missed.">        while (folding) {</span>
            // TODO Some validation needed
            break;
        }

        // TODO: This is now dead code, but won't be when some sensible validations exist
        /*
        if (errMsg != null) {
            DisplayBuffer.add(this, LocalText.getText(&quot;CannotMerge&quot;,
                    action.getFoldedCompanyNames(),
                    PR_ID,
                    errMsg));
            return false;
        }
        */

        // all actions linked during formation round to avoid serious undo problems

        // FIMXE: changeStack.linkToPreviousMoveSet();

        // Execute
<span class="nc bnc" id="L330" title="All 2 branches missed.">        if (folding) executeExchange (folded, false, false);</span>

<span class="nc" id="L332">        findNextMergingPlayer(true);</span>

<span class="nc" id="L334">        return folding;</span>
    }

    private void executeExchange(List&lt;Company&gt; companies, boolean president, boolean display) {

        ExchangeForShare efs;
        PublicCertificate cert;
        Player player;
<span class="nc bnc" id="L342" title="All 2 branches missed.">        for (Company company : companies) {</span>
<span class="nc" id="L343">            log.debug(&quot;Merging company &quot;+company.getId());</span>
<span class="nc bnc" id="L344" title="All 2 branches missed.">            if (company instanceof PrivateCompany) {</span>
<span class="nc" id="L345">                player = (Player)((PrivateCompany)company).getOwner();</span>
            } else {
<span class="nc" id="L347">                player = ((PublicCompany)company).getPresident();</span>
            }
            // Shortcut, sp should be checked
<span class="nc" id="L350">            efs = (ExchangeForShare) Iterables.get(company.getSpecialProperties(), 0);</span>
<span class="nc" id="L351">            cert = unavailable.findCertificate(nationalToFound, efs.getShare()/nationalToFound.getShareUnit(),</span>
                    president);
<span class="nc" id="L353">            cert.moveTo(player);</span>
            //company.setClosed();
<span class="nc" id="L355">            String message = LocalText.getText(&quot;MERGE_MINOR_LOG&quot;,</span>
<span class="nc" id="L356">                    player.getId(),</span>
<span class="nc" id="L357">                    company.getId(),</span>
<span class="nc" id="L358">                    nationalToFound.getId(),</span>
<span class="nc bnc" id="L359" title="All 2 branches missed.">                    company instanceof PrivateCompany ? &quot;no&quot;</span>
<span class="nc" id="L360">                            : Bank.format(this, ((PublicCompany)company).getCash()),</span>
<span class="nc bnc" id="L361" title="All 2 branches missed.">                    company instanceof PrivateCompany ? &quot;no&quot;</span>
<span class="nc" id="L362">                            : ((PublicCompany)company).getPortfolioModel().getTrainList().size());</span>
<span class="nc" id="L363">            ReportBuffer.add(this, message);</span>
<span class="nc bnc" id="L364" title="All 2 branches missed.">            if (display) DisplayBuffer.add(this, message);</span>
<span class="nc" id="L365">            message = LocalText.getText(&quot;GetShareForMinor&quot;,</span>
<span class="nc" id="L366">                    player.getId(),</span>
<span class="nc" id="L367">                    cert.getShare(),</span>
<span class="nc" id="L368">                    nationalToFound.getId(),</span>
<span class="nc" id="L369">                    ipo.getParent().getId(),</span>
<span class="nc" id="L370">                    company.getId());</span>
<span class="nc" id="L371">            ReportBuffer.add(this, message);</span>
<span class="nc bnc" id="L372" title="All 2 branches missed.">            if (display) DisplayBuffer.add(this, message);</span>

<span class="nc bnc" id="L374" title="All 2 branches missed.">            if (company instanceof PublicCompany) {</span>

<span class="nc" id="L376">                PublicCompany minor = (PublicCompany) company;</span>

                // Replace the home token
<span class="nc" id="L379">                BaseToken token = Iterables.get(minor.getAllBaseTokens(),0);</span>
<span class="nc" id="L380">                Stop city = (Stop) token.getOwner();</span>
<span class="nc" id="L381">                MapHex hex = city.getParent();</span>
<span class="nc" id="L382">                token.moveTo(minor);</span>
<span class="nc bnc" id="L383" title="All 4 branches missed.">                if (!hex.hasTokenOfCompany(nationalToFound) &amp;&amp; hex.layBaseToken(nationalToFound, city)) {</span>
                    /* TODO: the false return value must be impossible. */
<span class="nc" id="L385">                    message = LocalText.getText(&quot;ExchangesBaseToken&quot;,</span>
<span class="nc" id="L386">                            nationalToFound.getId(), minor.getId(),</span>
<span class="nc" id="L387">                            city.getRelatedNumber());</span>
<span class="nc" id="L388">                    ReportBuffer.add(this, message);</span>
<span class="nc bnc" id="L389" title="All 2 branches missed.">                    if (display) DisplayBuffer.add(this, message);</span>

<span class="nc" id="L391">                    nationalToFound.layBaseToken(hex, 0);</span>
                }

                // Move any cash
<span class="nc bnc" id="L395" title="All 2 branches missed.">                if (minor.getCash() &gt; 0) {</span>
<span class="nc" id="L396">                    Currency.wireAll(minor, nationalToFound);</span>
                }

                // Move any trains
                // TODO: Simplify code due to trainlist being immutable anyway
<span class="nc" id="L401">                List&lt;Train&gt; trains = new ArrayList&lt;Train&gt; (minor.getPortfolioModel().getTrainList());</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">                for (Train train : trains) {</span>
<span class="nc" id="L403">                    nationalToFound.getPortfolioModel().addTrain(train);</span>
<span class="nc" id="L404">                }</span>
            }

            // Close the merged companies
<span class="nc" id="L408">            company.setClosed();</span>
<span class="nc" id="L409">        }</span>

<span class="nc" id="L411">    }</span>

    public boolean discardTrain(DiscardTrain action) {

<span class="nc" id="L415">        Train train = action.getDiscardedTrain();</span>
<span class="nc" id="L416">        PublicCompany company = action.getCompany();</span>

<span class="nc" id="L418">        String errMsg = null;</span>

        // Dummy loop to enable a quick jump out.
        while (true) {
            // Checks
            // Must be correct step
<span class="nc bnc" id="L424" title="All 2 branches missed.">            if (company != nationalToFound) {</span>
<span class="nc" id="L425">                errMsg = LocalText.getText(&quot;WrongCompany&quot;, company.getId(), nationalToFound.getId());</span>
<span class="nc" id="L426">                break;</span>
            }

<span class="nc bnc" id="L429" title="All 4 branches missed.">            if (train == null &amp;&amp; action.isForced()) {</span>
<span class="nc" id="L430">                errMsg = LocalText.getText(&quot;NoTrainSpecified&quot;);</span>
<span class="nc" id="L431">                break;</span>
            }

            // Does the company own such a train?
<span class="nc bnc" id="L435" title="All 2 branches missed.">            if (!company.getPortfolioModel().getTrainList().contains(train)) {</span>
<span class="nc" id="L436">                errMsg =</span>
<span class="nc" id="L437">                    LocalText.getText(&quot;CompanyDoesNotOwnTrain&quot;,</span>
<span class="nc" id="L438">                                company.getId(),</span>
<span class="nc" id="L439">                                train.toText() );</span>
                break;
            }

            break;
        }
<span class="nc bnc" id="L445" title="All 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L446">            DisplayBuffer.add(this, LocalText.getText(&quot;CannotDiscardTrain&quot;,</span>
<span class="nc" id="L447">                    company.getId(),</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                    (train != null ?train.toText() : &quot;?&quot;),</span>
                    errMsg ));
<span class="nc" id="L450">            return false;</span>
        }

        /* End of validation, start of execution */

        // FIXME: if (action.isForced()) changeStack.linkToPreviousMoveSet();

<span class="nc" id="L457">        train.discard();</span>

        // We still might have another excess train
        // TODO: would be better to have DiscardTrain discard multiple trains
<span class="nc bnc" id="L461" title="All 2 branches missed.">        if (nationalToFound.getNumberOfTrains() &gt; nationalToFound.getCurrentTrainLimit()) {</span>
<span class="nc" id="L462">            step = Step.DISCARD_TRAINS;</span>
        } else {
<span class="nc" id="L464">            finishRound();</span>
        }

<span class="nc" id="L467">        return true;</span>
    }

    @Override
    protected void finishRound() {
<span class="nc" id="L472">        RoundFacade interruptedRound = gameManager.getInterruptedRound();</span>
<span class="nc" id="L473">        ReportBuffer.add(this, &quot; &quot;);</span>
<span class="nc bnc" id="L474" title="All 2 branches missed.">        if (interruptedRound != null) {</span>
<span class="nc" id="L475">            ReportBuffer.add(this, LocalText.getText(&quot;EndOfFormationRound&quot;, nationalToFound.getId(),</span>
<span class="nc" id="L476">                    interruptedRound.getRoundName()));</span>
        } else {
<span class="nc" id="L478">            ReportBuffer.add(this, LocalText.getText(&quot;EndOfFormationRoundNoInterrupt&quot;, nationalToFound.getId()));</span>
        }

<span class="nc bnc" id="L481" title="All 2 branches missed.">        if (nationalToFound.hasStarted()) nationalToFound.checkPresidency();</span>
<span class="nc" id="L482">        nationalToFound.setOperated(); // To allow immediate share selling</span>
        //        super.finishRound();
        // Inform GameManager
<span class="nc" id="L485">        gameManager.nextRound(this);</span>
<span class="nc" id="L486">    }</span>


    @Override
    public String toString() {
<span class="nc" id="L491">        return &quot;1837 KuKFormationRound&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>