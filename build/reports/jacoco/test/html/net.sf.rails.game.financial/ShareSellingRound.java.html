<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ShareSellingRound.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.financial</a> &gt; <span class="el_source">ShareSellingRound.java</span></div><h1>ShareSellingRound.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.financial;

import java.util.ArrayList;
import java.util.Iterator;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.PossibleAction;
import rails.game.action.SellShares;
import net.sf.rails.common.*;
import net.sf.rails.game.GameDef;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.Player;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.model.PortfolioModel;
import net.sf.rails.game.round.RoundFacade;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.IntegerState;


// TODO: Check if un-initialized states cause undo problems
public class ShareSellingRound extends StockRound {
<span class="fc" id="L25">    private static final Logger log = LoggerFactory.getLogger(ShareSellingRound.class);</span>

    protected RoundFacade parentRound;
    protected Player sellingPlayer;
    protected IntegerState cashToRaise; // intialized later
    protected PublicCompany cashNeedingCompany;
    protected boolean dumpOtherCompaniesAllowed;

    protected List&lt;SellShares&gt; sellableShares;

    /**
     * Created using Configure
     */
    // change: ShareSellingRound is not really a (full) Round, only a single player acting
    // requires: make an independent Round for EnforcedSelling that uses the selling shares activity
    public ShareSellingRound(GameManager parent, String id) {
<span class="fc" id="L41">        super(parent, id);</span>
<span class="fc" id="L42">        guiHints.setActivePanel(GuiDef.Panel.STATUS);</span>
<span class="fc" id="L43">    }</span>

    public void start(RoundFacade parentRound, Player sellingPlayer, int cashToRaise,
            PublicCompany cashNeedingCompany, boolean dumpOtherCompaniesAllowed) {
<span class="fc" id="L47">        log.info(&quot;Share selling round started, player=&quot;</span>
<span class="fc" id="L48">                +sellingPlayer.getId()+&quot; cash=&quot;+cashToRaise);</span>
<span class="fc" id="L49">        ReportBuffer.add(this, LocalText.getText(&quot;PlayerMustSellShares&quot;,</span>
<span class="fc" id="L50">                sellingPlayer.getId(),</span>
<span class="fc" id="L51">                Bank.format(this, cashToRaise)));</span>
<span class="fc" id="L52">        this.parentRound = parentRound;</span>
<span class="fc" id="L53">        currentPlayer = this.sellingPlayer = sellingPlayer;</span>
<span class="fc" id="L54">        this.cashNeedingCompany = cashNeedingCompany;</span>
<span class="fc" id="L55">        this.cashToRaise = IntegerState.create(this, &quot;CashToRaise&quot;, cashToRaise);</span>

<span class="fc" id="L57">        this.dumpOtherCompaniesAllowed = dumpOtherCompaniesAllowed;</span>
<span class="fc" id="L58">        log.debug(&quot;Forced selling, dumpOtherCompaniesAllowed = &quot; + dumpOtherCompaniesAllowed);</span>
<span class="fc" id="L59">        getRoot().getPlayerManager().setCurrentPlayer(sellingPlayer);</span>
<span class="fc" id="L60">        getSellableShares();</span>
<span class="pc bpc" id="L61" title="1 of 2 branches missed.">        if (getSellableShares().isEmpty()) {</span>
<span class="nc" id="L62">            ReportBuffer.add(this, LocalText.getText(&quot;YouMustRaiseCashButCannot&quot;,</span>
<span class="nc" id="L63">                    Bank.format(this, this.cashToRaise.value())));</span>
<span class="nc" id="L64">            DisplayBuffer.add(this, LocalText.getText(&quot;YouMustRaiseCashButCannot&quot;,</span>
<span class="nc" id="L65">                    Bank.format(this, this.cashToRaise.value())));</span>
<span class="nc" id="L66">            currentPlayer.setBankrupt();</span>
<span class="nc" id="L67">            gameManager.registerBankruptcy();</span>
        }
<span class="fc" id="L69">    }</span>

    @Override
    public boolean mayCurrentPlayerSellAnything() {
<span class="nc" id="L73">        return true;</span>
    }

    @Override
    public boolean mayCurrentPlayerBuyAnything() {
<span class="nc" id="L78">        return false;</span>
    }

    @Override
    public boolean setPossibleActions() {

<span class="fc" id="L84">        possibleActions.clear();</span>

<span class="fc" id="L86">        setSellableShares();</span>

<span class="fc bfc" id="L88" title="All 2 branches covered.">        for (PossibleAction pa : possibleActions.getList()) {</span>
<span class="fc" id="L89">            log.debug(currentPlayer.getId() + &quot; may: &quot; + pa.toString());</span>
<span class="fc" id="L90">        }</span>

<span class="fc" id="L92">        return true;</span>
    }

    @Override
    public void setSellableShares() {
<span class="fc" id="L97">        possibleActions.addAll(sellableShares);</span>
<span class="fc" id="L98">    }</span>

    /**
     * Create a list of certificates that a player may sell in an emergency
     * share selling round, taking all rules taken into account.
     *
     * FIXME: Rails 2.x Adopt the new code from StockRound
     */
    protected List&lt;SellShares&gt; getSellableShares () {

<span class="fc" id="L108">        sellableShares = new ArrayList&lt;SellShares&gt; ();</span>

        int price;
        int number;
        int share, maxShareToSell;
<span class="fc" id="L113">        PortfolioModel playerPortfolio = currentPlayer.getPortfolioModel();</span>

        /*
         * First check of which companies the player owns stock, and what
         * maximum percentage he is allowed to sell.
         */
<span class="fc bfc" id="L119" title="All 2 branches covered.">        for (PublicCompany company : companyManager.getAllPublicCompanies()) {</span>

            // Check if shares of this company can be sold at all
<span class="fc bfc" id="L122" title="All 2 branches covered.">            if (!mayPlayerSellShareOfCompany(company)) continue;</span>

<span class="fc" id="L124">            share = maxShareToSell = playerPortfolio.getShare(company);</span>
<span class="fc bfc" id="L125" title="All 2 branches covered.">            if (maxShareToSell == 0) continue;</span>

            /* May not sell more than the Pool can accept */
<span class="fc" id="L128">            maxShareToSell =</span>
<span class="fc" id="L129">                Math.min(maxShareToSell,</span>
<span class="fc" id="L130">                        GameDef.getGameParameterAsInt(this, GameDef.Parm.POOL_SHARE_LIMIT)</span>
<span class="fc" id="L131">                        - pool.getShare(company));</span>
<span class="pc bpc" id="L132" title="1 of 2 branches missed.">            if (maxShareToSell == 0) continue;</span>

            /*
             * If the current Player is president, check if he can dump the
             * presidency onto someone else
             *
             * Two reasons for the check:
             * A) President not allowed to sell that company
             * Thus keep enough shares to stay president
             *
             * Example here
             * share = 60%, other player holds 40%, maxShareToSell &gt; 30%
             * =&gt; requires selling of president

             * B) President allowed to sell that company
             * In that case the president share can be sold
             *
             * Example here
             * share = 60%, , president share = 20%, maxShareToSell &gt; 40%
             * =&gt; requires selling of president
             */
<span class="fc bfc" id="L153" title="All 2 branches covered.">            if (company.getPresident() == currentPlayer) {</span>
<span class="fc" id="L154">                int presidentShare =</span>
<span class="fc" id="L155">                    company.getCertificates().get(0).getShare();</span>
                boolean dumpPossible;
<span class="fc" id="L157">                log.debug(&quot;Forced selling check: company = &quot; + company +</span>
                        &quot;, share = &quot; + share + &quot;, maxShareToSell = &quot; + maxShareToSell);
<span class="fc bfc" id="L159" title="All 4 branches covered.">                if (company == cashNeedingCompany || !dumpOtherCompaniesAllowed) {</span>
                    // case A: selling of president not allowed (either company triggered share selling or no dump of others)
<span class="fc" id="L161">                    int maxOtherShares = 0;</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">                    for (Player player : getRoot().getPlayerManager().getPlayers()) {</span>
<span class="fc bfc" id="L163" title="All 2 branches covered.">                        if (player == currentPlayer) continue;</span>
<span class="fc" id="L164">                        maxOtherShares = Math.max(maxOtherShares, player.getPortfolioModel().getShare(company));</span>
<span class="fc" id="L165">                    }</span>
                    // limit shares to sell to difference between president and second largest ownership
<span class="fc" id="L167">                    maxShareToSell = Math.min(maxShareToSell, share - maxOtherShares);</span>
<span class="fc" id="L168">                    dumpPossible = false; // and no dump is possible by definition</span>
<span class="fc" id="L169">                } else {</span>
                    // case B: potential sale of president certificate possible
<span class="pc bpc" id="L171" title="1 of 2 branches missed.">                    if (share - maxShareToSell &lt; presidentShare) {</span>
                        // dump necessary
<span class="fc" id="L173">                        dumpPossible = false;</span>
<span class="fc bfc" id="L174" title="All 2 branches covered.">                        for (Player player : getRoot().getPlayerManager().getPlayers()) {</span>
<span class="fc bfc" id="L175" title="All 2 branches covered.">                            if (player == currentPlayer) continue;</span>
                            // there is a player with holding exceeding the president share
<span class="pc bpc" id="L177" title="1 of 2 branches missed.">                            if (player.getPortfolioModel().getShare(company) &gt;= presidentShare) {</span>
<span class="nc" id="L178">                                dumpPossible = true;</span>
<span class="nc" id="L179">                                break;</span>
                            }
<span class="fc" id="L181">                        }</span>
                    } else {
<span class="nc" id="L183">                        dumpPossible = false; // no dump necessary</span>
                    }
                }
<span class="pc bpc" id="L186" title="1 of 2 branches missed.">                if (!dumpPossible) {</span>
                    // keep presidentShare at minimum
<span class="fc" id="L188">                    maxShareToSell = Math.min(maxShareToSell, share - presidentShare);</span>
                }
            }

            /*
             * Check what share units the player actually owns. In some games
             * (e.g. 1835) companies may have different ordinary shares: 5% and
             * 10%, or 10% and 20%. The president's share counts as a multiple
             * of the lowest ordinary share unit type.
             */
            // Take care for max. 4 share units per share
<span class="fc" id="L199">            int[] shareCountPerUnit = new int[5];</span>
<span class="fc bfc" id="L200" title="All 2 branches covered.">            for (PublicCertificate c : playerPortfolio.getCertificates(company)) {</span>
<span class="fc bfc" id="L201" title="All 2 branches covered.">                if (c.isPresidentShare()) {</span>
<span class="fc" id="L202">                    shareCountPerUnit[1] += c.getShares();</span>
                } else {
<span class="fc" id="L204">                    ++shareCountPerUnit[c.getShares()];</span>
                }
<span class="fc" id="L206">            }</span>
            // TODO The above ignores that a dumped player must be
            // able to exchange the president's share.

            /*
             * Check the price. If a cert was sold before this turn, the
             * original price is still valid
             */
<span class="fc bfc" id="L214" title="All 2 branches covered.">            if (sellPrices.containsKey(company)) {</span>
<span class="fc" id="L215">                price = (sellPrices.get(company)).getPrice();</span>
            } else {
<span class="fc" id="L217">                price = company.getMarketPrice();</span>
            }

<span class="fc bfc" id="L220" title="All 2 branches covered.">            for (int shareSize = 1; shareSize &lt;= 4; shareSize++) {</span>
<span class="fc" id="L221">                number = shareCountPerUnit[shareSize];</span>
<span class="fc bfc" id="L222" title="All 2 branches covered.">                if (number == 0) continue;</span>
<span class="fc" id="L223">                number =</span>
<span class="fc" id="L224">                    Math.min(number, maxShareToSell</span>
<span class="fc" id="L225">                            / (shareSize * company.getShareUnit()));</span>
<span class="pc bpc" id="L226" title="1 of 2 branches missed.">                if (number == 0) continue;</span>

                // May not sell more than is needed to buy the train
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">                while (number &gt; 0</span>
<span class="fc bfc" id="L230" title="All 2 branches covered.">                       &amp;&amp; ((number - 1) * price) &gt; cashToRaise.value())</span>
<span class="fc" id="L231">                    number--;</span>

<span class="pc bpc" id="L233" title="1 of 2 branches missed.">                if (number &gt; 0) {</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">                    for (int i=1; i&lt;=number; i++) {</span>
<span class="fc" id="L235">                        sellableShares.add(new SellShares(company, shareSize, i, price));</span>
                    }
                }
            }
<span class="fc" id="L239">        }</span>
<span class="fc" id="L240">        return sellableShares;</span>
    }

    @Override
    public boolean sellShares(SellShares action) {
<span class="fc" id="L245">        PortfolioModel portfolio = currentPlayer.getPortfolioModel();</span>
<span class="fc" id="L246">        String playerName = currentPlayer.getId();</span>
<span class="fc" id="L247">        String errMsg = null;</span>
<span class="fc" id="L248">        String companyName = action.getCompanyName();</span>
<span class="fc" id="L249">        PublicCompany company =</span>
<span class="fc" id="L250">            companyManager.getPublicCompany(action.getCompanyName());</span>
<span class="fc" id="L251">        PublicCertificate cert = null;</span>
<span class="fc" id="L252">        PublicCertificate presCert = null;</span>
<span class="fc" id="L253">        List&lt;PublicCertificate&gt; certsToSell =</span>
                new ArrayList&lt;PublicCertificate&gt;();
<span class="fc" id="L255">        Player dumpedPlayer = null;</span>
<span class="fc" id="L256">        int presSharesToSell = 0;</span>
<span class="fc" id="L257">        int numberToSell = action.getNumber();</span>
<span class="fc" id="L258">        int shareUnits = action.getShareUnits();</span>
<span class="fc" id="L259">        int presidentExchange = action.getPresidentExchange();</span>


        // Dummy loop to allow a quick jump out
        while (true) {

            // Check everything
<span class="pc bpc" id="L266" title="1 of 2 branches missed.">            if (numberToSell &lt;= 0) {</span>
<span class="nc" id="L267">                errMsg = LocalText.getText(&quot;NoSellZero&quot;);</span>
<span class="nc" id="L268">                break;</span>
            }

            // Check company
<span class="pc bpc" id="L272" title="1 of 2 branches missed.">            if (company == null) {</span>
<span class="nc" id="L273">                errMsg = LocalText.getText(&quot;NoCompany&quot;);</span>
<span class="nc" id="L274">                break;</span>
            }

            // May player sell this company
<span class="pc bpc" id="L278" title="1 of 2 branches missed.">            if (!mayPlayerSellShareOfCompany(company)) {</span>
<span class="nc" id="L279">                errMsg = LocalText.getText(&quot;SaleNotAllowed&quot;, companyName);</span>
<span class="nc" id="L280">                break;</span>
            }

            // The player must have the share(s)
<span class="pc bpc" id="L284" title="1 of 2 branches missed.">            if (portfolio.getShare(company) &lt; numberToSell) {</span>
<span class="nc" id="L285">                errMsg = LocalText.getText(&quot;NoShareOwned&quot;);</span>
<span class="nc" id="L286">                break;</span>
            }

            // The pool may not get over its limit.
<span class="fc" id="L290">            if (pool.getShare(company) + numberToSell * company.getShareUnit()</span>
<span class="pc bpc" id="L291" title="1 of 2 branches missed.">                    &gt; GameDef.getGameParameterAsInt(this, GameDef.Parm.POOL_SHARE_LIMIT)) {</span>
<span class="nc" id="L292">                errMsg = LocalText.getText(&quot;PoolOverHoldLimit&quot;);</span>
<span class="nc" id="L293">                break;</span>
            }

            // Find the certificates to sell
<span class="fc" id="L297">            Iterator&lt;PublicCertificate&gt; it =</span>
<span class="fc" id="L298">                    portfolio.getCertificates(company).iterator();</span>
<span class="pc bpc" id="L299" title="1 of 4 branches missed.">            while (numberToSell &gt; 0 &amp;&amp; it.hasNext()) {</span>
<span class="fc" id="L300">                cert = it.next();</span>
<span class="fc bfc" id="L301" title="All 2 branches covered.">                if (cert.isPresidentShare()) {</span>
                    // Remember the president's certificate in case we need it
<span class="pc bpc" id="L303" title="1 of 2 branches missed.">                    if (cert.isPresidentShare()) presCert = cert;</span>
                    continue;
<span class="pc bpc" id="L305" title="1 of 2 branches missed.">                } else if (shareUnits != cert.getShares()) {</span>
                    // Wrong number of share units
<span class="nc" id="L307">                    continue;</span>
                }
                // OK, we will sell this one
<span class="fc" id="L310">                certsToSell.add(cert);</span>
<span class="fc" id="L311">                numberToSell--;</span>
            }
<span class="pc bpc" id="L313" title="1 of 2 branches missed.">            if (numberToSell == 0) presCert = null;</span>

<span class="pc bpc" id="L315" title="3 of 4 branches missed.">            if (numberToSell &gt; 0 &amp;&amp; presCert != null</span>
<span class="nc bnc" id="L316" title="All 2 branches missed.">                    &amp;&amp; numberToSell &lt;= presCert.getShares()) {</span>
                // Not allowed to dump the company that needs the train
<span class="nc bnc" id="L318" title="All 4 branches missed.">                if (company == cashNeedingCompany || !dumpOtherCompaniesAllowed) {</span>
<span class="nc" id="L319">                    errMsg =</span>
<span class="nc" id="L320">                        LocalText.getText(&quot;CannotDumpTrainBuyingPresidency&quot;);</span>
<span class="nc" id="L321">                    break;</span>
                }
                // More to sell and we are President: see if we can dump it.
                Player otherPlayer, previousPlayer;
<span class="nc" id="L325">                previousPlayer = getRoot().getPlayerManager().getCurrentPlayer();</span>
<span class="nc bnc" id="L326" title="All 2 branches missed.">                for (int i = 0; i &lt;= numberOfPlayers; i++) {</span>
<span class="nc" id="L327">                    otherPlayer = getRoot().getPlayerManager().getNextPlayerAfter(previousPlayer);</span>
<span class="nc bnc" id="L328" title="All 2 branches missed.">                    if (otherPlayer.getPortfolioModel().getShare(company) &gt;= presCert.getShare()) {</span>
                        // Check if he has the right kind of share
<span class="nc bnc" id="L330" title="All 2 branches missed.">                        if (numberToSell &gt; 1</span>
<span class="nc bnc" id="L331" title="All 2 branches missed.">                            || otherPlayer.getPortfolioModel().ownsCertificates(</span>
                                        company, 1, false) &gt;= 1) {
                            // The poor sod.
<span class="nc" id="L334">                            dumpedPlayer = otherPlayer;</span>
<span class="nc" id="L335">                            presSharesToSell = numberToSell;</span>
<span class="nc" id="L336">                            numberToSell = 0;</span>
<span class="nc" id="L337">                            break;</span>
                        }
                    }
<span class="nc" id="L340">                    previousPlayer = otherPlayer;</span>
                }
            }
            // Check if we could sell them all
<span class="pc bpc" id="L344" title="1 of 2 branches missed.">            if (numberToSell &gt; 0) {</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">                if (presCert != null) {</span>
<span class="nc" id="L346">                    errMsg = LocalText.getText(&quot;NoDumping&quot;);</span>
                } else {
<span class="nc" id="L348">                    errMsg = LocalText.getText(&quot;NotEnoughShares&quot;);</span>
                }
<span class="nc" id="L350">                break;</span>
            }

            break;
        }

<span class="fc" id="L356">        int numberSold = action.getNumber();</span>
<span class="pc bpc" id="L357" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L358">            DisplayBuffer.add(this, LocalText.getText(&quot;CantSell&quot;,</span>
                    playerName,
<span class="nc" id="L360">                    numberSold,</span>
                    companyName,
                    errMsg ));
<span class="nc" id="L363">            return false;</span>
        }

        // All seems OK, now do the selling.
        StockSpace sellPrice;
        int price;

        // Get the sell price (does not change within a turn)
<span class="fc bfc" id="L371" title="All 2 branches covered.">        if (sellPrices.containsKey(company)</span>
<span class="pc bpc" id="L372" title="1 of 2 branches missed.">                &amp;&amp; GameOption.getAsBoolean(this, &quot;SeparateSalesAtSamePrice&quot;)) {</span>
<span class="fc" id="L373">            price = (sellPrices.get(company).getPrice());</span>
        } else {
<span class="fc" id="L375">            sellPrice = company.getCurrentSpace();</span>
<span class="fc" id="L376">            price = sellPrice.getPrice();</span>
<span class="fc" id="L377">            sellPrices.put(company, sellPrice);</span>
        }
<span class="fc" id="L379">        int cashAmount = numberSold * price * shareUnits;</span>


        // FIXME: changeStack.linkToPreviousMoveSet();

<span class="fc" id="L384">        String cashText = Currency.fromBank(cashAmount, currentPlayer);</span>
<span class="fc" id="L385">        ReportBuffer.add(this, LocalText.getText(&quot;SELL_SHARES_LOG&quot;,</span>
                playerName,
<span class="fc" id="L387">                numberSold,</span>
<span class="fc" id="L388">                company.getShareUnit(),</span>
<span class="fc" id="L389">                numberSold * company.getShareUnit(),</span>
                companyName,
                cashText ));

<span class="fc" id="L393">        boolean soldBefore = sellPrices.containsKey(company);</span>

<span class="fc" id="L395">        adjustSharePrice (company, numberSold, soldBefore);</span>

<span class="pc bpc" id="L397" title="1 of 2 branches missed.">        if (!company.isClosed()) {</span>

<span class="fc" id="L399">            executeShareTransfer (company, certsToSell,</span>
                    dumpedPlayer, presSharesToSell);
        }

<span class="fc" id="L403">        cashToRaise.add(-numberSold * price);</span>

<span class="fc bfc" id="L405" title="All 2 branches covered.">        if (cashToRaise.value() &lt;= 0) {</span>
<span class="fc" id="L406">            gameManager.finishShareSellingRound();</span>
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">        } else if (getSellableShares().isEmpty()) {</span>
<span class="nc" id="L408">            DisplayBuffer.add(this, LocalText.getText(&quot;YouMustRaiseCashButCannot&quot;,</span>
<span class="nc" id="L409">                    Bank.format(this, cashToRaise.value())));</span>
<span class="nc" id="L410">            currentPlayer.setBankrupt();</span>
<span class="nc" id="L411">            gameManager.registerBankruptcy();</span>
        }

<span class="fc" id="L414">        return true;</span>
    }

    public int getRemainingCashToRaise() {
<span class="nc" id="L418">        return cashToRaise.value();</span>
    }

    public PublicCompany getCompanyNeedingCash() {
<span class="nc" id="L422">        return cashNeedingCompany;</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L427">        return &quot;ShareSellingRound&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>