<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StockMarket.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.financial</a> &gt; <span class="el_source">StockMarket.java</span></div><h1>StockMarket.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.financial;

import com.google.common.collect.ImmutableSortedSet;
import com.google.common.collect.Lists;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.common.parser.Configurable;
import net.sf.rails.common.parser.ConfigurationException;
import net.sf.rails.common.parser.Tag;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.RailsManager;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.game.model.StockMarketModel;

import java.util.HashMap;
import java.util.List;
import java.util.SortedSet;
import java.util.TreeSet;


public class StockMarket extends RailsManager implements Configurable {
    /**
     * This is the name by which the CompanyManager should be registered with
     * the ComponentManager.
     */
    public static final String COMPONENT_NAME = &quot;StockMarket&quot;;

    public static final String DEFAULT = &quot;default&quot;;

<span class="fc" id="L30">    protected final HashMap&lt;String, StockSpaceType&gt; stockSpaceTypes = new HashMap&lt;&gt;();</span>
<span class="fc" id="L31">    protected final HashMap&lt;String, StockSpace&gt; stockChartSpaces = new HashMap&lt;&gt;();</span>
<span class="fc" id="L32">    protected final SortedSet&lt;StockSpace&gt; startSpaces = new TreeSet&lt;&gt;();</span>

<span class="fc" id="L34">    protected final StockMarketModel marketModel = StockMarketModel.create(this);</span>

    protected StockSpace stockChart[][];
<span class="fc" id="L37">    protected int numRows = 0;</span>
<span class="fc" id="L38">    protected int numCols = 0;</span>
    protected StockSpaceType defaultType;

    /* Game-specific flags */
<span class="fc" id="L42">    protected boolean upOrDownRight = false;</span>
    /* Sold out and at top: go down or right (1870) */

    // TODO: There used to be a BooleanState gameOver, did this have a function?

    /**
     * Used by Configure (via reflection) only
     */
    public StockMarket(RailsRoot parent, String id) {
<span class="fc" id="L51">        super(parent, id);</span>
<span class="fc" id="L52">    }</span>

    /**
     * @see net.sf.rails.common.parser.Configurable#configureFromXML(Tag)
     */
    public void configureFromXML(Tag tag) throws ConfigurationException {
        // Define a default stockspace type with colour white
<span class="fc" id="L59">        defaultType = new StockSpaceType(DEFAULT, StockSpaceType.WHITE);</span>
<span class="fc" id="L60">        stockSpaceTypes.put(DEFAULT, defaultType);</span>

        /* Read and configure the stock market space types */
<span class="fc" id="L63">        List&lt;Tag&gt; typeTags = tag.getChildren(StockSpaceType.ELEMENT_ID);</span>

<span class="fc bfc" id="L65" title="All 2 branches covered.">        if (typeTags != null) {</span>
<span class="fc bfc" id="L66" title="All 2 branches covered.">            for (Tag typeTag : typeTags) {</span>
                /* Extract the attributes of the Stock space type */
<span class="fc" id="L68">                String name =</span>
<span class="fc" id="L69">                        typeTag.getAttributeAsString(StockSpaceType.NAME_TAG);</span>
<span class="pc bpc" id="L70" title="1 of 2 branches missed.">                if (name == null) {</span>
<span class="nc" id="L71">                    throw new ConfigurationException(</span>
<span class="nc" id="L72">                            LocalText.getText(&quot;UnnamedStockSpaceType&quot;));</span>
                }
<span class="fc" id="L74">                String colour =</span>
<span class="fc" id="L75">                        typeTag.getAttributeAsString(StockSpaceType.COLOUR_TAG);</span>

                /* Check for duplicates */
<span class="pc bpc" id="L78" title="1 of 2 branches missed.">                if (stockSpaceTypes.get(name) != null) {</span>
<span class="nc" id="L79">                    throw new ConfigurationException(LocalText.getText(</span>
                            &quot;StockSpaceTypeConfiguredTwice&quot;, name));
                }

                /* Create the type */
<span class="fc" id="L84">                StockSpaceType type = new StockSpaceType(name, colour);</span>
<span class="fc" id="L85">                stockSpaceTypes.put(name, type);</span>

                // Check the stock space type flags
<span class="fc bfc" id="L88" title="All 2 branches covered.">                type.setNoBuyLimit(typeTag.getChild(StockSpaceType.NO_BUY_LIMIT_TAG) != null);</span>
<span class="pc bpc" id="L89" title="1 of 2 branches missed.">                type.setNoCertLimit(typeTag.getChild(StockSpaceType.NO_CERT_LIMIT_TAG) != null);</span>
<span class="fc bfc" id="L90" title="All 2 branches covered.">                type.setNoHoldLimit(typeTag.getChild(StockSpaceType.NO_HOLD_LIMIT_TAG) != null);</span>
<span class="fc" id="L91">            }</span>
        }

        /* Read and configure the stock market spaces */
<span class="fc" id="L95">        List&lt;Tag&gt; spaceTags = tag.getChildren(StockSpace.ELEMENT_ID);</span>
        StockSpaceType type;
        int row, col;
<span class="fc bfc" id="L98" title="All 2 branches covered.">        for (Tag spaceTag : spaceTags) {</span>
<span class="fc" id="L99">            type = null;</span>

            // Extract the attributes of the Stock space
<span class="fc" id="L102">            String name = spaceTag.getAttributeAsString(StockSpace.NAME_TAG);</span>
<span class="pc bpc" id="L103" title="1 of 2 branches missed.">            if (name == null) {</span>
<span class="nc" id="L104">                throw new ConfigurationException(</span>
<span class="nc" id="L105">                        LocalText.getText(&quot;UnnamedStockSpace&quot;));</span>
            }
<span class="fc" id="L107">            String price = spaceTag.getAttributeAsString(StockSpace.PRICE_TAG);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">            if (price == null) {</span>
<span class="nc" id="L109">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;StockSpaceHasNoPrice&quot;, name));
            }
<span class="fc" id="L112">            String typeName =</span>
<span class="fc" id="L113">                    spaceTag.getAttributeAsString(StockSpace.TYPE_TAG);</span>
<span class="fc bfc" id="L114" title="All 2 branches covered.">            if (typeName != null</span>
<span class="pc bpc" id="L115" title="1 of 2 branches missed.">                    &amp;&amp; (type = stockSpaceTypes.get(typeName)) == null) {</span>
<span class="nc" id="L116">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;StockSpaceTypeUndefined&quot;, type));
            }
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (type == null) type = defaultType;</span>

<span class="pc bpc" id="L121" title="1 of 2 branches missed.">            if (stockChartSpaces.get(name) != null) {</span>
<span class="nc" id="L122">                throw new ConfigurationException(LocalText.getText(</span>
                        &quot;StockSpacesConfiguredTwice&quot;, name));
            }

<span class="fc" id="L126">            StockSpace space = StockSpace.create(this, name, Integer.parseInt(price), type);</span>
<span class="fc" id="L127">            stockChartSpaces.put(name, space);</span>

<span class="fc" id="L129">            row = Integer.parseInt(name.substring(1));</span>
<span class="fc" id="L130">            col = (name.toUpperCase().charAt(0) - '@');</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">            if (row &gt; numRows) numRows = row;</span>
<span class="fc bfc" id="L132" title="All 2 branches covered.">            if (col &gt; numCols) numCols = col;</span>

            // Loop through the stock space flags
<span class="fc bfc" id="L135" title="All 2 branches covered.">            if (spaceTag.getChild(StockSpace.START_SPACE_TAG) != null) {</span>
<span class="fc" id="L136">                space.setStart(true);</span>
<span class="fc" id="L137">                startSpaces.add(space);</span>
            }
<span class="fc bfc" id="L139" title="All 2 branches covered.">            space.setClosesCompany(spaceTag.getChild(StockSpace.CLOSES_COMPANY_TAG) != null);</span>
<span class="fc bfc" id="L140" title="All 2 branches covered.">            space.setEndsGame(spaceTag.getChild(StockSpace.GAME_OVER_TAG) != null);</span>
<span class="pc bpc" id="L141" title="1 of 2 branches missed.">            space.setBelowLedge(spaceTag.getChild(StockSpace.BELOW_LEDGE_TAG) != null);</span>
<span class="pc bpc" id="L142" title="1 of 2 branches missed.">            space.setLeftOfLedge(spaceTag.getChild(StockSpace.LEFT_OF_LEDGE_TAG) != null);</span>

<span class="fc" id="L144">        }</span>

<span class="fc" id="L146">        stockChart = new StockSpace[numRows][numCols];</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">        for (StockSpace space : stockChartSpaces.values()) {</span>
<span class="fc" id="L148">            stockChart[space.getRow()][space.getColumn()] = space;</span>
<span class="fc" id="L149">        }</span>

<span class="pc bpc" id="L151" title="1 of 2 branches missed.">        upOrDownRight = tag.getChild(&quot;UpOrDownRight&quot;) != null;</span>

<span class="fc" id="L153">    }</span>

    /**
     * Final initialisations, to be called after all XML processing is complete.
     * The purpose is to register fixed company start prices.
     */
    public void finishConfiguration(RailsRoot root) {
<span class="fc bfc" id="L160" title="All 2 branches covered.">        for (PublicCompany comp : root.getCompanyManager().getAllPublicCompanies()) {</span>
<span class="pc bpc" id="L161" title="1 of 4 branches missed.">            if (!comp.hasStarted() &amp;&amp; comp.getStartSpace() != null) {</span>
<span class="fc" id="L162">                comp.getStartSpace().addFixedStartPrice(comp);</span>
            }
<span class="fc" id="L164">        }</span>

<span class="fc" id="L166">    }</span>

    public StockSpace getStockSpace(int row, int col) {
<span class="pc bpc" id="L169" title="4 of 8 branches missed.">        if (row &gt;= 0 &amp;&amp; row &lt; numRows &amp;&amp; col &gt;= 0 &amp;&amp; col &lt; numCols) {</span>
<span class="fc" id="L170">            return stockChart[row][col];</span>
        } else {
<span class="nc" id="L172">            return null;</span>
        }
    }

    public StockSpace getStockSpace(String name) {
<span class="fc" id="L177">        return stockChartSpaces.get(name);</span>
    }

    /*--- Actions ---*/

    public void start(PublicCompany company, StockSpace price) {
<span class="fc" id="L183">        prepareMove(company, null, price);</span>
        // make marketModel updating on company price model
<span class="fc" id="L185">        company.getCurrentPriceModel().addModel(marketModel);</span>
<span class="fc" id="L186">    }</span>

    public void payOut(PublicCompany company) {
<span class="fc" id="L189">        moveRightOrUp(company);</span>
<span class="fc" id="L190">    }</span>

    public void withhold(PublicCompany company) {
<span class="fc" id="L193">        moveLeftOrDown(company);</span>
<span class="fc" id="L194">    }</span>

    public void sell(PublicCompany company, int numberOfSpaces) {
<span class="fc" id="L197">        moveDown(company, numberOfSpaces);</span>
<span class="fc" id="L198">    }</span>

    public void soldOut(PublicCompany company) {
<span class="fc" id="L201">        moveUp(company);</span>
<span class="fc" id="L202">    }</span>

    public void moveUp(PublicCompany company) {
<span class="fc" id="L205">        StockSpace oldsquare = company.getCurrentSpace();</span>
<span class="fc" id="L206">        StockSpace newsquare = oldsquare;</span>
<span class="fc" id="L207">        int row = oldsquare.getRow();</span>
<span class="fc" id="L208">        int col = oldsquare.getColumn();</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">        if (row &gt; 0) {</span>
<span class="fc" id="L210">            newsquare = getStockSpace(row - 1, col);</span>
<span class="pc bpc" id="L211" title="3 of 4 branches missed.">        } else if (upOrDownRight &amp;&amp; col &lt; numCols - 1) {</span>
<span class="nc" id="L212">            newsquare = getStockSpace(row + 1, col + 1);</span>
        }
<span class="fc bfc" id="L214" title="All 2 branches covered.">        if (newsquare != null) prepareMove(company, oldsquare, newsquare);</span>
<span class="fc" id="L215">    }</span>

    public void close(PublicCompany company) {
<span class="fc" id="L218">        prepareMove(company, company.getCurrentSpace(), null);</span>
<span class="fc" id="L219">    }</span>

    protected void moveDown(PublicCompany company, int numberOfSpaces) {
<span class="fc" id="L222">        StockSpace oldsquare = company.getCurrentSpace();</span>
<span class="fc" id="L223">        StockSpace newsquare = oldsquare;</span>
<span class="fc" id="L224">        int row = oldsquare.getRow();</span>
<span class="fc" id="L225">        int col = oldsquare.getColumn();</span>

        /* Drop the indicated number of rows */
<span class="fc" id="L228">        int newrow = row + numberOfSpaces;</span>

        /* Don't drop below the bottom of the chart */
<span class="fc bfc" id="L231" title="All 4 branches covered.">        while (newrow &gt;= numRows || getStockSpace(newrow, col) == null)</span>
<span class="fc" id="L232">            newrow--;</span>

        // Check if company may enter a &quot;Closed&quot; area
<span class="pc bpc" id="L235" title="3 of 4 branches missed.">        while (getStockSpace(newrow, col).closesCompany() &amp;&amp; !company.canClose())</span>
<span class="nc" id="L236">            newrow--;</span>

        /*
         * If marker landed just below a ledge, and NOT because it was bounced
         * by the bottom of the chart, it will stay just above the ledge.
         */
<span class="pc bpc" id="L242" title="3 of 4 branches missed.">        if (getStockSpace(newrow, col).isBelowLedge()</span>
<span class="nc" id="L243">                &amp;&amp; newrow == row + numberOfSpaces) newrow--;</span>

<span class="fc bfc" id="L245" title="All 2 branches covered.">        if (newrow &gt; row) {</span>
<span class="fc" id="L246">            newsquare = getStockSpace(newrow, col);</span>
        }
<span class="fc bfc" id="L248" title="All 2 branches covered.">        if (newsquare != oldsquare) {</span>
<span class="fc" id="L249">            prepareMove(company, oldsquare, newsquare);</span>
        }
<span class="fc" id="L251">    }</span>

    protected void moveRightOrUp(PublicCompany company) {
        /* Ignore the amount for now */
<span class="fc" id="L255">        StockSpace oldsquare = company.getCurrentSpace();</span>
<span class="fc" id="L256">        StockSpace newsquare = oldsquare;</span>
<span class="fc" id="L257">        int row = oldsquare.getRow();</span>
<span class="fc" id="L258">        int col = oldsquare.getColumn();</span>
<span class="pc bpc" id="L259" title="2 of 4 branches missed.">        if (col &lt; numCols - 1 &amp;&amp; !oldsquare.isLeftOfLedge()</span>
<span class="fc bfc" id="L260" title="All 2 branches covered.">                &amp;&amp; (newsquare = getStockSpace(row, col + 1)) != null) {</span>
<span class="pc bpc" id="L261" title="1 of 2 branches missed.">        } else if (row &gt; 0</span>
<span class="pc bpc" id="L262" title="1 of 2 branches missed.">                &amp;&amp; (newsquare = getStockSpace(row - 1, col)) != null) {</span>
        }
<span class="fc" id="L264">        prepareMove(company, oldsquare, newsquare);</span>
<span class="fc" id="L265">    }</span>

    protected void moveLeftOrDown(PublicCompany company) {
<span class="fc" id="L268">        StockSpace oldsquare = company.getCurrentSpace();</span>
<span class="fc" id="L269">        StockSpace newsquare = oldsquare;</span>
<span class="fc" id="L270">        int row = oldsquare.getRow();</span>
<span class="fc" id="L271">        int col = oldsquare.getColumn();</span>
<span class="fc bfc" id="L272" title="All 4 branches covered.">        if (col &gt; 0 &amp;&amp; (newsquare = getStockSpace(row, col - 1)) != null) {</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">        } else if (row &lt; numRows - 1 &amp;&amp;</span>
<span class="pc bpc" id="L274" title="1 of 2 branches missed.">                (newsquare = getStockSpace(row + 1, col)) != null) {</span>
        } else {
<span class="fc" id="L276">            newsquare = oldsquare;</span>
        }
<span class="fc" id="L278">        prepareMove(company, oldsquare, newsquare);</span>
<span class="fc" id="L279">    }</span>

    protected void prepareMove(PublicCompany company, StockSpace from,
                               StockSpace to) {
        // To be written to a log file in the future.
<span class="fc bfc" id="L284" title="All 4 branches covered.">        if (from != null &amp;&amp; from == to) {</span>
<span class="fc" id="L285">            ReportBuffer.add(this, LocalText.getText(&quot;PRICE_STAYS_LOG&quot;,</span>
<span class="fc" id="L286">                    company.getId(),</span>
<span class="fc" id="L287">                    Bank.format(this, from.getPrice()),</span>
<span class="fc" id="L288">                    from.getId()));</span>
<span class="fc" id="L289">            return;</span>
<span class="fc bfc" id="L290" title="All 4 branches covered.">        } else if (from == null &amp;&amp; to != null) {</span>
            ;
<span class="fc bfc" id="L292" title="All 4 branches covered.">        } else if (from != null &amp;&amp; to != null) {</span>
<span class="fc" id="L293">            ReportBuffer.add(this, LocalText.getText(&quot;PRICE_MOVES_LOG&quot;,</span>
<span class="fc" id="L294">                    company.getId(),</span>
<span class="fc" id="L295">                    Bank.format(this, from.getPrice()),</span>
<span class="fc" id="L296">                    from.getId(),</span>
<span class="fc" id="L297">                    Bank.format(this, to.getPrice()),</span>
<span class="fc" id="L298">                    to.getId()));</span>

            /* Check for rails.game closure */
<span class="pc bpc" id="L301" title="1 of 2 branches missed.">            if (to.endsGame()) {</span>
<span class="nc" id="L302">                ReportBuffer.add(this, LocalText.getText(&quot;GAME_OVER&quot;));</span>
<span class="nc" id="L303">                getRoot().getGameManager().registerMaxedSharePrice(company, to);</span>
            }

        }
<span class="fc" id="L307">        company.setCurrentSpace(to);</span>

<span class="fc bfc" id="L309" title="All 2 branches covered.">        if (to != null) {</span>
<span class="fc" id="L310">            to.addToken(company);</span>
        }
<span class="fc bfc" id="L312" title="All 2 branches covered.">        if (from != null) {</span>
<span class="fc" id="L313">            from.removeToken(company);</span>
        }
<span class="fc" id="L315">    }</span>

    // FIXME: The StockSpace changes have to update the players worth
    // thus link the state of company space to the players worth

    /**
     * Return start prices as list of prices
     */
    @Deprecated
    public List&lt;Integer&gt; getStartPrices() {
<span class="fc" id="L325">        List&lt;Integer&gt; prices = Lists.newArrayList();</span>
<span class="fc bfc" id="L326" title="All 2 branches covered.">        for (StockSpace space : startSpaces) {</span>
<span class="fc" id="L327">            prices.add(space.getPrice());</span>
<span class="fc" id="L328">        }</span>
<span class="fc" id="L329">        return prices;</span>
    }

    /**
     * Return start prices as an sorted set of stockspaces
     */
    public ImmutableSortedSet&lt;StockSpace&gt; getStartSpaces() {
<span class="nc" id="L336">        return ImmutableSortedSet.copyOf(startSpaces);</span>
    }

    @Deprecated
    public StockSpace getStartSpace(int price) {
<span class="pc bpc" id="L341" title="1 of 2 branches missed.">        for (StockSpace space : startSpaces) {</span>
<span class="fc bfc" id="L342" title="All 2 branches covered.">            if (space.getPrice() == price) return space;</span>
<span class="fc" id="L343">        }</span>
<span class="nc" id="L344">        return null;</span>
    }

    /**
     * @return number of columns
     */
    public int getNumberOfColumns() {
<span class="nc" id="L351">        return numCols;</span>
    }

    /**
     * @return number of rows
     */
    public int getNumberOfRows() {
<span class="nc" id="L358">        return numRows;</span>
    }

    public StockMarketModel getMarketModel() {
<span class="fc" id="L362">        return marketModel;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>