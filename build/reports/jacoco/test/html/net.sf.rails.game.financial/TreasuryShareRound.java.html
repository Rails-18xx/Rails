<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TreasuryShareRound.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.financial</a> &gt; <span class="el_source">TreasuryShareRound.java</span></div><h1>TreasuryShareRound.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.financial;

import java.util.*;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.*;
import net.sf.rails.common.DisplayBuffer;
import net.sf.rails.common.GuiDef;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.GameDef;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.OperatingRound;
import net.sf.rails.game.Player;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.model.PortfolioModel;
import net.sf.rails.game.round.RoundFacade;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.Portfolio;

import com.google.common.collect.ImmutableSet;
import com.google.common.collect.ImmutableSetMultimap;
import com.google.common.collect.Iterables;


// Change: TreasuryShareRound is a workaround as StockRound
// It is a single Activity to allow companies buying or selling shares
public class TreasuryShareRound extends StockRound {
<span class="fc" id="L32">    private static final Logger log = LoggerFactory.getLogger(TreasuryShareRound.class);</span>

    protected Player sellingPlayer;
    protected PublicCompany operatingCompany;
<span class="fc" id="L36">    private final BooleanState hasBought = BooleanState.create(this, &quot;hasBought&quot;) ;</span>
<span class="fc" id="L37">    private final BooleanState hasSold = BooleanState.create(this, &quot;hasSold&quot;);</span>

    /**
     * Created via Configure
     */
    public TreasuryShareRound(GameManager parent, String id) {
<span class="fc" id="L43">        super(parent, id);</span>
<span class="fc" id="L44">        guiHints.setActivePanel(GuiDef.Panel.STATUS);</span>
<span class="fc" id="L45">    }</span>

    // TODO: Check if this still works, as the initialization was moved back to here
    public void start(RoundFacade parentRound) {
<span class="fc" id="L49">        log.info(&quot;Treasury share trading round started&quot;);</span>
<span class="fc" id="L50">        operatingCompany = ((OperatingRound)parentRound).getOperatingCompany();</span>
<span class="fc" id="L51">        sellingPlayer = operatingCompany.getPresident();</span>
<span class="fc" id="L52">        getRoot().getPlayerManager().setCurrentPlayer(sellingPlayer);</span>
<span class="fc" id="L53">        currentPlayer = sellingPlayer;</span>
<span class="fc" id="L54">    }</span>

    @Override
    public boolean mayCurrentPlayerSellAnything() {
<span class="nc" id="L58">        return false;</span>
    }

    @Override
    public boolean mayCurrentPlayerBuyAnything() {
<span class="nc" id="L63">        return false;</span>
    }

    @Override
    public boolean setPossibleActions() {

<span class="fc" id="L69">        possibleActions.clear();</span>

<span class="pc bpc" id="L71" title="1 of 2 branches missed.">        if (operatingCompany.mustHaveOperatedToTradeShares()</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">                &amp;&amp; !operatingCompany.hasOperated()) return true;</span>

<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (!hasSold.value()) setBuyableCerts();</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">        if (!hasBought.value()) setSellableCerts();</span>

<span class="fc bfc" id="L77" title="All 2 branches covered.">        if (possibleActions.isEmpty()) {</span>
            // TODO Finish the round before it started...
        }

<span class="fc" id="L81">        possibleActions.add(new NullAction(NullAction.Mode.DONE));</span>

<span class="fc bfc" id="L83" title="All 2 branches covered.">        for (PossibleAction pa : possibleActions.getList()) {</span>
<span class="fc" id="L84">            log.debug(operatingCompany.getId() + &quot; may: &quot; + pa.toString());</span>
<span class="fc" id="L85">        }</span>

<span class="fc" id="L87">        return true;</span>
    }

    /**
     * Create a list of certificates that a player may buy in a Stock Round,
     * taking all rules into account.
     *
     * @return List of buyable certificates.
     */
    @Override
    public void setBuyableCerts() {
        ImmutableSet&lt;PublicCertificate&gt; certs;
        PublicCertificate cert;
        PortfolioModel from;
        int price;
        int number;

<span class="fc" id="L104">        int cash = operatingCompany.getCash();</span>

        /* Get the unique Pool certificates and check which ones can be bought */
<span class="fc" id="L107">        from = pool;</span>
<span class="fc" id="L108">        ImmutableSetMultimap&lt;PublicCompany, PublicCertificate&gt; map =</span>
<span class="fc" id="L109">            from.getCertsPerCompanyMap();</span>

<span class="fc bfc" id="L111" title="All 2 branches covered.">        for (PublicCompany comp: map.keySet()) {</span>
<span class="fc" id="L112">            certs = map.get(comp);</span>
            // if (certs.isEmpty()) continue; // TODO: Check if removal is correct

<span class="fc" id="L115">            cert = Iterables.get(certs, 0);</span>

            // TODO For now, only consider own certificates.
            // This will have to be revisited with 1841.
<span class="fc bfc" id="L119" title="All 2 branches covered.">            if (comp != operatingCompany) continue;</span>

            // Shares already owned
<span class="fc" id="L122">            int ownedShare =</span>
<span class="fc" id="L123">                    operatingCompany.getPortfolioModel().getShare(operatingCompany);</span>
            // Max share that may be owned
<span class="fc" id="L125">            int maxShare = GameDef.getGameParameterAsInt(this, GameDef.Parm.TREASURY_SHARE_LIMIT);</span>
            // Max number of shares to add
<span class="fc" id="L127">            int maxBuyable =</span>
<span class="fc" id="L128">                (maxShare - ownedShare) / operatingCompany.getShareUnit();</span>
            // Max number of shares to buy
<span class="fc" id="L130">            number = Math.min(certs.size(), maxBuyable);</span>
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">            if (number == 0) continue;</span>

<span class="fc" id="L133">            price = comp.getMarketPrice();</span>

            // Does the company have enough cash?
<span class="fc bfc" id="L136" title="All 4 branches covered.">            while (number &gt; 0 &amp;&amp; cash &lt; number * price)</span>
<span class="fc" id="L137">                number--;</span>

<span class="fc bfc" id="L139" title="All 2 branches covered.">            if (number &gt; 0) {</span>
<span class="fc" id="L140">                possibleActions.add(new BuyCertificate(comp, cert.getShare(), from.getParent(), price,</span>
                        number));
            }
<span class="fc" id="L143">        }</span>

<span class="fc" id="L145">    }</span>

    /**
     * Create a list of certificates that the company may sell, taking all rules
     * taken into account. &lt;br&gt;Note: old code that provides for ownership of
     * presidencies of other companies has been retained, but not tested. This
     * code will be needed for 1841.
     *
     * @return List of sellable certificates.
     */
    public void setSellableCerts() {
        int price;
        int number;
        int maxShareToSell;

<span class="fc" id="L160">        PortfolioModel companyPortfolio = operatingCompany.getPortfolioModel();</span>

        /*
         * First check of which companies the player owns stock, and what
         * maximum percentage he is allowed to sell.
         */
<span class="fc bfc" id="L166" title="All 2 branches covered.">        for (PublicCompany company : companyManager.getAllPublicCompanies()) {</span>

            // Can't sell shares that have no price
<span class="fc bfc" id="L169" title="All 2 branches covered.">            if (!company.hasStarted()) continue;</span>

<span class="fc" id="L171">            maxShareToSell = companyPortfolio.getShare(company);</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">            if (maxShareToSell == 0) continue;</span>

            /* May not sell more than the Pool can accept */
<span class="fc" id="L175">            maxShareToSell =</span>
<span class="fc" id="L176">                Math.min(maxShareToSell,</span>
<span class="fc" id="L177">                        GameDef.getGameParameterAsInt(this, GameDef.Parm.POOL_SHARE_LIMIT)</span>
<span class="fc" id="L178">                        - pool.getShare(company));</span>
<span class="pc bpc" id="L179" title="1 of 2 branches missed.">            if (maxShareToSell == 0) continue;</span>

            /*
             * Check what share units the player actually owns. In some games
             * (e.g. 1835) companies may have different ordinary shares: 5% and
             * 10%, or 10% and 20%. The president's share counts as a multiple
             * of the lowest ordinary share unit type.
             */
            // Take care for max. 4 share units per share
<span class="fc" id="L188">            int[] shareCountPerUnit = new int[5];</span>
<span class="fc bfc" id="L189" title="All 2 branches covered.">            for (PublicCertificate c : companyPortfolio.getCertificates(company)) {</span>
<span class="pc bpc" id="L190" title="1 of 2 branches missed.">                if (c.isPresidentShare()) {</span>
<span class="nc" id="L191">                    shareCountPerUnit[1] += c.getShares();</span>
                } else {
<span class="fc" id="L193">                    ++shareCountPerUnit[c.getShares()];</span>
                }
<span class="fc" id="L195">            }</span>
            // TODO The above ignores that a dumped player must be
            // able to exchange the president's share.

            /*
             * Check the price. If a cert was sold before this turn, the
             * original price is still valid
             */
<span class="fc bfc" id="L203" title="All 2 branches covered.">            if (sellPrices.containsKey(company)) {</span>
<span class="fc" id="L204">                price = (sellPrices.get(company)).getPrice();</span>
            } else {
<span class="fc" id="L206">                price = company.getMarketPrice();</span>
            }

<span class="fc bfc" id="L209" title="All 2 branches covered.">            for (int shareSize = 1; shareSize &lt;= 4; shareSize++) {</span>
<span class="fc" id="L210">                number = shareCountPerUnit[shareSize];</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">                if (number == 0) continue;</span>
<span class="fc" id="L212">                number =</span>
<span class="fc" id="L213">                    Math.min(number, maxShareToSell</span>
<span class="fc" id="L214">                            / (shareSize * company.getShareUnit()));</span>
<span class="pc bpc" id="L215" title="1 of 2 branches missed.">                if (number == 0) continue;</span>

<span class="fc bfc" id="L217" title="All 2 branches covered.">                for (int i=1; i&lt;=number; i++) {</span>
<span class="fc" id="L218">                    possibleActions.add(new SellShares(company, shareSize, i, price));</span>
                }
            }
<span class="fc" id="L221">        }</span>
<span class="fc" id="L222">    }</span>

    /**
     * Buying one or more single or double-share certificates (more is sometimes
     * possible)
     *
     * @param player The player that wants to buy shares.
     * @param action The executed action
     * @return True if the certificates could be bought. False indicates an
     * error.
     */
    @Override
    public boolean buyShares(String playerName, BuyCertificate action) {

<span class="fc" id="L236">        PublicCompany company = action.getCompany();</span>
<span class="fc" id="L237">        PortfolioModel from = action.getFromPortfolio();</span>
<span class="fc" id="L238">        String companyName = company.getId();</span>
<span class="fc" id="L239">        int number = action.getNumberBought();</span>
<span class="fc" id="L240">        int shareUnit = company.getShareUnit();</span>
<span class="fc" id="L241">        int sharePerCert = action.getSharePerCertificate();</span>
<span class="fc" id="L242">        int share = number * sharePerCert;</span>
<span class="fc" id="L243">        int shares = share/shareUnit;</span>

<span class="fc" id="L245">        String errMsg = null;</span>
<span class="fc" id="L246">        int price = 0;</span>
        // TODO: Might not be needed anymore, replaced by company
<span class="fc" id="L248">        PortfolioModel portfolio = null;</span>

<span class="fc" id="L250">        currentPlayer = playerManager.getCurrentPlayer();</span>

        // Dummy loop to allow a quick jump out
        while (true) {

            // Check everything
            // Only the player that has the turn may act
<span class="pc bpc" id="L257" title="1 of 2 branches missed.">            if (!playerName.equals(currentPlayer.getId())) {</span>
<span class="nc" id="L258">                errMsg = LocalText.getText(&quot;WrongPlayer&quot;, playerName, currentPlayer.getId());</span>
<span class="nc" id="L259">                break;</span>
            }

            // Check company
<span class="fc" id="L263">            company = companyManager.getPublicCompany(companyName);</span>
<span class="pc bpc" id="L264" title="1 of 2 branches missed.">            if (company == null) {</span>
<span class="nc" id="L265">                errMsg = LocalText.getText(&quot;CompanyDoesNotExist&quot;, companyName);</span>
<span class="nc" id="L266">                break;</span>
            }
<span class="pc bpc" id="L268" title="1 of 2 branches missed.">            if (company != operatingCompany) {</span>
<span class="nc" id="L269">                errMsg =</span>
<span class="nc" id="L270">                    LocalText.getText(&quot;WrongCompany&quot;,</span>
                            companyName,
<span class="nc" id="L272">                                operatingCompany.getId() );</span>

            }

            // The company must have floated
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">            if (!company.hasFloated()) {</span>
<span class="nc" id="L278">                errMsg = LocalText.getText(&quot;NotYetFloated&quot;, companyName);</span>
<span class="nc" id="L279">                break;</span>
            }
<span class="pc bpc" id="L281" title="1 of 2 branches missed.">            if (company.mustHaveOperatedToTradeShares()</span>
<span class="pc bpc" id="L282" title="1 of 2 branches missed.">                    &amp;&amp; !company.hasOperated()) {</span>
<span class="nc" id="L283">                errMsg = LocalText.getText(&quot;NotYetOperated&quot;, companyName);</span>
<span class="nc" id="L284">                break;</span>
            }

            // Company may not buy after sell
<span class="pc bpc" id="L288" title="1 of 2 branches missed.">            if (hasSold.value()) {</span>
<span class="nc" id="L289">                errMsg = LocalText.getText(&quot;MayNotBuyAndSell&quot;, companyName);</span>
<span class="nc" id="L290">                break;</span>
            }

            // Check if that many shares are available
<span class="pc bpc" id="L294" title="1 of 2 branches missed.">            if (share &gt; from.getShare(company)) {</span>
<span class="nc" id="L295">                errMsg =</span>
<span class="nc" id="L296">                    LocalText.getText(&quot;NotAvailable&quot;,</span>
                            companyName,
<span class="nc" id="L298">                                from.getId() );</span>
<span class="nc" id="L299">                break;</span>
            }

<span class="fc" id="L302">            portfolio = operatingCompany.getPortfolioModel();</span>

            // Check if company would exceed the per-company share limit
<span class="fc" id="L305">            int treasuryShareLimit = GameDef.getGameParameterAsInt(this, GameDef.Parm.TREASURY_SHARE_LIMIT);</span>
<span class="pc bpc" id="L306" title="1 of 2 branches missed.">            if (portfolio.getShare(company) + share &gt; treasuryShareLimit) {</span>
<span class="nc" id="L307">                errMsg =</span>
<span class="nc" id="L308">                    LocalText.getText(&quot;TreasuryOverHoldLimit&quot;,</span>
<span class="nc" id="L309">                            String.valueOf(treasuryShareLimit));</span>
<span class="nc" id="L310">                break;</span>
            }

<span class="fc" id="L313">            price = company.getMarketPrice();</span>

            // Check if the Player has the money.
<span class="pc bpc" id="L316" title="1 of 2 branches missed.">            if (operatingCompany.getCash() &lt; shares * price) {</span>
<span class="nc" id="L317">                errMsg = LocalText.getText(&quot;NoMoney&quot;);</span>
<span class="nc" id="L318">                break;</span>
            }

            break;
        }

<span class="pc bpc" id="L324" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L325">            DisplayBuffer.add(this, LocalText.getText(&quot;CantBuy&quot;,</span>
                    companyName,
<span class="nc" id="L327">                    shares,</span>
                    companyName,
<span class="nc" id="L329">                    from.getId(),</span>
                    errMsg ));
<span class="nc" id="L331">            return false;</span>
        }

        // All seems OK, now buy the shares.


<span class="fc" id="L337">        int cashAmount = shares * price;</span>
<span class="fc" id="L338">        String cashText = Currency.toBank(company, cashAmount);</span>
<span class="pc bpc" id="L339" title="1 of 2 branches missed.">        if (number == 1) {</span>
<span class="fc" id="L340">            ReportBuffer.add(this, LocalText.getText(&quot;BUY_SHARE_LOG&quot;,</span>
                    companyName,
<span class="fc" id="L342">                    shareUnit,</span>
                    companyName,
<span class="fc" id="L344">                    from.getName(),</span>
                    cashText ));
        } else {
<span class="nc" id="L347">            ReportBuffer.add(this, LocalText.getText(&quot;BUY_SHARES_LOG&quot;,</span>
                    companyName,
<span class="nc" id="L349">                    number,</span>
<span class="nc" id="L350">                    shareUnit,</span>
<span class="nc" id="L351">                    number * shareUnit,</span>
                    companyName,
<span class="nc" id="L353">                    from.getName(),</span>
                    cashText ));
        }

        PublicCertificate cert2;
<span class="fc bfc" id="L358" title="All 2 branches covered.">        for (int i = 0; i &lt; number; i++) {</span>
<span class="fc" id="L359">            cert2 = from.findCertificate(company, sharePerCert/shareUnit, false);</span>
<span class="fc" id="L360">            cert2.moveTo(company);</span>
        }

<span class="fc" id="L363">        hasBought.set(true);</span>

<span class="fc" id="L365">        return true;</span>
    }

    @Override
    public boolean sellShares(SellShares action) {
<span class="fc" id="L370">        PortfolioModel portfolio = operatingCompany.getPortfolioModel();</span>
<span class="fc" id="L371">        String errMsg = null;</span>
<span class="fc" id="L372">        String companyName = action.getCompanyName();</span>
<span class="fc" id="L373">        PublicCompany company = companyManager.getPublicCompany(companyName);</span>
<span class="fc" id="L374">        PublicCertificate cert = null;</span>
<span class="fc" id="L375">        List&lt;PublicCertificate&gt; certsToSell =</span>
                new ArrayList&lt;PublicCertificate&gt;();
<span class="fc" id="L377">        int numberToSell = action.getNumber();</span>
<span class="fc" id="L378">        int shareUnits = action.getShareUnits();</span>

        // Dummy loop to allow a quick jump out
        while (true) {

            // Check everything
<span class="pc bpc" id="L384" title="1 of 2 branches missed.">            if (numberToSell &lt;= 0) {</span>
<span class="nc" id="L385">                errMsg = LocalText.getText(&quot;NoSellZero&quot;);</span>
<span class="nc" id="L386">                break;</span>
            }

            // Check company
<span class="pc bpc" id="L390" title="1 of 2 branches missed.">            if (company == null) {</span>
<span class="nc" id="L391">                errMsg = LocalText.getText(&quot;NoCompany&quot;);</span>
<span class="nc" id="L392">                break;</span>
            }
<span class="pc bpc" id="L394" title="1 of 2 branches missed.">            if (company != operatingCompany) {</span>
<span class="nc" id="L395">                errMsg =</span>
<span class="nc" id="L396">                    LocalText.getText(&quot;WrongCompany&quot;,</span>
                            companyName,
<span class="nc" id="L398">                                operatingCompany.getId() );</span>
<span class="nc" id="L399">                break;</span>
            }

            // The company must have floated
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">            if (!company.hasFloated()) {</span>
<span class="nc" id="L404">                errMsg = LocalText.getText(&quot;NotYetFloated&quot;, companyName);</span>
<span class="nc" id="L405">                break;</span>
            }
<span class="pc bpc" id="L407" title="1 of 2 branches missed.">            if (company.mustHaveOperatedToTradeShares()</span>
<span class="pc bpc" id="L408" title="1 of 2 branches missed.">                    &amp;&amp; !company.hasOperated()) {</span>
<span class="nc" id="L409">                errMsg = LocalText.getText(&quot;NotYetOperated&quot;, companyName);</span>
<span class="nc" id="L410">                break;</span>
            }

            // Company may not sell after buying
<span class="pc bpc" id="L414" title="1 of 2 branches missed.">            if (hasBought.value()) {</span>
<span class="nc" id="L415">                errMsg = LocalText.getText(&quot;MayNotBuyAndSell&quot;, companyName);</span>
<span class="nc" id="L416">                break;</span>
            }

            // The company must have the share(s)
<span class="pc bpc" id="L420" title="1 of 2 branches missed.">            if (portfolio.getShare(company) &lt; numberToSell) {</span>
<span class="nc" id="L421">                errMsg = LocalText.getText(&quot;NoShareOwned&quot;);</span>
<span class="nc" id="L422">                break;</span>
            }

            // The pool may not get over its limit.
<span class="fc" id="L426">            if (pool.getShare(company) + numberToSell * company.getShareUnit()</span>
<span class="pc bpc" id="L427" title="1 of 2 branches missed.">                    &gt; GameDef.getGameParameterAsInt(this, GameDef.Parm.POOL_SHARE_LIMIT)) {</span>
<span class="nc" id="L428">                errMsg = LocalText.getText(&quot;PoolOverHoldLimit&quot;);</span>
<span class="nc" id="L429">                break;</span>
            }

            // Find the certificates to sell
<span class="fc" id="L433">            Iterator&lt;PublicCertificate&gt; it =</span>
<span class="fc" id="L434">                    portfolio.getCertificates(company).iterator();</span>
<span class="pc bpc" id="L435" title="1 of 4 branches missed.">            while (numberToSell &gt; 0 &amp;&amp; it.hasNext()) {</span>
<span class="fc" id="L436">                cert = it.next();</span>
<span class="pc bpc" id="L437" title="1 of 2 branches missed.">                if (shareUnits != cert.getShares()) {</span>
                    // Wrong number of share units
<span class="nc" id="L439">                    continue;</span>
                }
                // OK, we will sell this one
<span class="fc" id="L442">                certsToSell.add(cert);</span>
<span class="fc" id="L443">                numberToSell--;</span>
            }

            // Check if we could sell them all
<span class="pc bpc" id="L447" title="1 of 2 branches missed.">            if (numberToSell &gt; 0) {</span>
<span class="nc" id="L448">                errMsg = LocalText.getText(&quot;NotEnoughShares&quot;);</span>
<span class="nc" id="L449">                break;</span>
            }

            break;
        }

<span class="fc" id="L455">        int numberSold = action.getNumber();</span>
<span class="pc bpc" id="L456" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L457">            DisplayBuffer.add(this, LocalText.getText(&quot;CantSell&quot;,</span>
                    companyName,
<span class="nc" id="L459">                    numberSold,</span>
                    companyName,
                    errMsg ));
<span class="nc" id="L462">            return false;</span>
        }

        // All seems OK, now do the selling.
        StockSpace sellPrice;
        int price;

        // Get the sell price (does not change within a turn)
<span class="fc bfc" id="L470" title="All 2 branches covered.">        if (sellPrices.containsKey(company)) {</span>
<span class="fc" id="L471">            price = (sellPrices.get(company)).getPrice();</span>
        } else {
<span class="fc" id="L473">            sellPrice = company.getCurrentSpace();</span>
<span class="fc" id="L474">            price = sellPrice.getPrice();</span>
<span class="fc" id="L475">            sellPrices.put(company, sellPrice);</span>
        }



<span class="fc" id="L480">        int cashAmount = numberSold * price;</span>
<span class="fc" id="L481">        String cashText = Currency.fromBank(cashAmount, company);</span>
<span class="fc" id="L482">        ReportBuffer.add(this, LocalText.getText(&quot;SELL_SHARES_LOG&quot;,</span>
                companyName,
<span class="fc" id="L484">                numberSold,</span>
<span class="fc" id="L485">                company.getShareUnit(),</span>
<span class="fc" id="L486">                (numberSold * company.getShareUnit()),</span>
                companyName,
                cashText ));

        // Transfer the sold certificates
<span class="fc" id="L491">        Portfolio.moveAll(certsToSell, pool.getParent());</span>
        /*
        for (PublicCertificate cert2 : certsToSell) {
            if (cert2 != null) {
                 transferCertificate (cert2, pool, cert2.getShares() * price);
            }
        }
         */
<span class="fc" id="L499">        stockMarket.sell(company, numberSold);</span>

<span class="fc" id="L501">        hasSold.set(true);</span>

<span class="fc" id="L503">        return true;</span>
    }

    /**
     * The current Player passes or is done.
     * @param player Name of the passing player.
     *
     * @return False if an error is found.
     */
    @Override
    // Autopassing does not apply here
    public boolean done(NullAction action, String playerName, boolean hasAutopassed) {

<span class="fc" id="L516">        currentPlayer = playerManager.getCurrentPlayer();</span>

<span class="pc bpc" id="L518" title="1 of 2 branches missed.">        if (!playerName.equals(currentPlayer.getId())) {</span>
<span class="nc" id="L519">            DisplayBuffer.add(this, LocalText.getText(&quot;WrongPlayer&quot;, playerName, currentPlayer.getId()));</span>
<span class="nc" id="L520">            return false;</span>
        }



        // Inform GameManager
<span class="fc" id="L526">        gameManager.finishTreasuryShareRound();</span>

<span class="fc" id="L528">        return true;</span>
    }

    public PublicCompany getOperatingCompany() {
<span class="nc" id="L532">        return this.operatingCompany;</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L537">        return &quot;TreasuryShareRound&quot;;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>