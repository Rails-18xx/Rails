<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StartRound_1837_Coal.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._1837</a> &gt; <span class="el_source">StartRound_1837_Coal.java</span></div><h1>StartRound_1837_Coal.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.specific._1837;

import java.util.ArrayList;
import java.util.List;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import net.sf.rails.common.DisplayBuffer;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.Player;
import net.sf.rails.game.StartItem;
import net.sf.rails.game.StartRound;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.Certificate;
import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.GenericState;
import net.sf.rails.game.state.IntegerState;
import rails.game.action.BidStartItem;
import rails.game.action.BuyStartItem;
import rails.game.action.NullAction;
import rails.game.action.PossibleAction;
import rails.game.action.StartItemAction;
import rails.game.specific._1837.SetHomeHexLocation;

/**
 * Implements an 1837-style startpacket sale.
 */
public class StartRound_1837_Coal extends StartRound {
<span class="nc" id="L33">    private static final Logger log = LoggerFactory.getLogger(StartRound_1837_Coal.class);</span>

    protected final int bidIncrement;

<span class="nc" id="L37">    private final GenericState&lt;SetHomeHexLocation&gt; pendingAction =</span>
<span class="nc" id="L38">            GenericState.create(this, &quot;pendingAction&quot;);</span>
<span class="nc" id="L39">    private final GenericState&lt;Player&gt; pendingPlayer = GenericState.create(</span>
            this, &quot;pendingPlayer&quot;);
<span class="nc" id="L41">    private final GenericState&lt;PublicCertificate&gt; pendingCertificate =</span>
<span class="nc" id="L42">            GenericState.create(this, &quot;pendingCertificate&quot;);</span>

<span class="nc" id="L44">    protected IntegerState numRoundsPassed = IntegerState.create(this,</span>
            &quot;StartRoundRoundsPassed&quot;);


    /**
     * Constructor, only to be used in dynamic instantiation.
     */
    public StartRound_1837_Coal(GameManager gameManager, String id) {
<span class="nc" id="L52">        super(gameManager, id, false, true, true);</span>
<span class="nc" id="L53">        bidIncrement = startPacket.getModulus();</span>
<span class="nc" id="L54">        this.setStartRoundName(&quot;Initial Minor StartRound (Coal and Privates including Suedbahn)&quot;);</span>
<span class="nc" id="L55">    }</span>

    @Override
    public void start() {


<span class="nc bnc" id="L61" title="All 2 branches missed.">        for (StartItem item : startPacket.getItems()) {</span>
            // New: we only include items that have not yet been sold
            // at the start of the current StartRound
<span class="nc bnc" id="L64" title="All 2 branches missed.">            if (!item.isSold()) {</span>
<span class="nc" id="L65">                itemsToSell.add(item);</span>
            }
<span class="nc" id="L67">        }</span>
<span class="nc" id="L68">        numPasses.set(0);</span>

        // init current with priority player
<span class="nc" id="L71">        startPlayer = playerManager.setCurrentToPriorityPlayer();</span>

<span class="nc" id="L73">        ReportBuffer.add(this, LocalText.getText(&quot;StartOfStartRound&quot;,getStartRoundName()));</span>
<span class="nc" id="L74">        ReportBuffer.add(this, LocalText.getText(&quot;HasPriority&quot;,</span>
<span class="nc" id="L75">                startPlayer.getId()));</span>

<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (!setPossibleActions()) {</span>
            /*
             * If nobody can do anything, keep executing Operating and Start
             * rounds until someone has got enough money to buy one of the
             * remaining items. The game mechanism ensures that this will
             * ultimately be possible.
             */
<span class="nc" id="L84">            finishRound();</span>
        }

<span class="nc" id="L87">    }</span>

    @Override
    public boolean setPossibleActions() {

<span class="nc" id="L92">        List&lt;StartItem&gt; startItems = startPacket.getItems();</span>
<span class="nc" id="L93">        List&lt;StartItem&gt; buyableItems = new ArrayList&lt;StartItem&gt;();</span>
        int row;
        int column;
        boolean buyable;
<span class="nc" id="L97">        int minRow = 0;</span>
<span class="nc" id="L98">        boolean[][] soldStartItems = new boolean[3][6];</span>

<span class="nc bnc" id="L100" title="All 2 branches missed.">        if (pendingAction.value() != null) {</span>
<span class="nc" id="L101">            playerManager.setCurrentPlayer(pendingPlayer.value());</span>
<span class="nc" id="L102">            possibleActions.add(pendingAction.value());</span>
<span class="nc" id="L103">            return true;</span>
        }
        /*
         * First, mark which items are buyable. Once buyable, they always remain
         * so until bought, so there is no need to check if an item is still
         * buyable.
         */
<span class="nc bnc" id="L110" title="All 2 branches missed.">        if ((!startPacket.areAllSold())) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            for (StartItem item : startItems) {</span>
<span class="nc" id="L112">                buyable = false;</span>

<span class="nc" id="L114">                column = item.getColumn();</span>
<span class="nc" id="L115">                row = item.getRow();</span>

<span class="nc bnc" id="L117" title="All 2 branches missed.">                if (item.isSold()) {</span>
                    // Already sold: skip but set watermarks

<span class="nc bnc" id="L120" title="All 2 branches missed.">                    if (column == 1) {</span>
<span class="nc" id="L121">                        soldStartItems[0][row - 1] = true;</span>
                    } else {
<span class="nc bnc" id="L123" title="All 2 branches missed.">                        if (column == 2) {</span>
<span class="nc" id="L124">                            soldStartItems[1][row - 1] = true;</span>
                        } else {
<span class="nc" id="L126">                            soldStartItems[2][row - 1] = true;</span>
                        }
                    }

                } else {
<span class="nc bnc" id="L131" title="All 2 branches missed.">                    if (minRow == 0) {</span>
<span class="nc" id="L132">                        minRow = row;</span>
                    }
<span class="nc bnc" id="L134" title="All 2 branches missed.">                    if (row == minRow) {</span>
                        // Allow all items in the top row.
<span class="nc" id="L136">                        buyable = true;</span>
                    } else {
                        // Allow the first item in the next row of a column
                        // where the items in higher
                        // rows have been bought.
<span class="nc bnc" id="L141" title="All 2 branches missed.">                        if (soldStartItems[column - 1][row - 2] == true) {</span>
<span class="nc" id="L142">                            buyable = true;</span>
                        }
                    }
                }
<span class="nc bnc" id="L146" title="All 2 branches missed.">                if (buyable) {</span>
<span class="nc" id="L147">                    item.setStatus(StartItem.BUYABLE);</span>
<span class="nc" id="L148">                    buyableItems.add(item);</span>
                }
<span class="nc" id="L150">            } // startItems</span>
<span class="nc" id="L151">            possibleActions.clear();</span>
        } else { // Are all Sold
<span class="nc" id="L153">            possibleActions.clear();</span>
<span class="nc" id="L154">            return true;</span>
        }

        /*
         * Repeat until we have found a player with enough money to buy some
         * item
         */
<span class="nc bnc" id="L161" title="All 2 branches missed.">        while (possibleActions.isEmpty()) {</span>

<span class="nc" id="L163">            Player currentPlayer = playerManager.getCurrentPlayer();</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (currentPlayer == startPlayer) ReportBuffer.add(this, &quot;&quot;);</span>

<span class="nc" id="L166">            int cashToSpend = currentPlayer.getCash();</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">            for (StartItem item : buyableItems) {</span>
<span class="nc bnc" id="L169" title="All 2 branches missed.">                if (item.getBasePrice() &lt;= cashToSpend) {</span>
                    /* Player does have the cash */
<span class="nc" id="L171">                    possibleActions.add(new BuyStartItem(item,</span>
<span class="nc" id="L172">                            item.getBasePrice(), false));</span>
                }

<span class="nc" id="L175">            } /* Pass is always allowed */</span>
            // No its not if there is a startItem with a price of zero the player has to buy that.
<span class="nc bnc" id="L177" title="All 2 branches missed.">            for (StartItem item : buyableItems) {</span>
<span class="nc bnc" id="L178" title="All 2 branches missed.">                if (item.getBasePrice() == 0) {</span>
<span class="nc" id="L179">                    return true;</span>
                }
<span class="nc" id="L181">            }</span>
<span class="nc" id="L182">            possibleActions.add(new NullAction(NullAction.Mode.PASS));</span>

<span class="nc" id="L184">        }</span>

<span class="nc" id="L186">        return true;</span>
    }

    /*----- moveStack methods -----*/

    @Override
    public boolean bid(String playerName, BidStartItem item) {

<span class="nc" id="L194">        DisplayBuffer.add(this, LocalText.getText(&quot;InvalidAction&quot;));</span>
<span class="nc" id="L195">        return false;</span>
    }

    /**
     * Process a player's pass.
     *
     * @param playerName The name of the current player (for checking purposes).
     */
    @Override
    protected boolean pass(NullAction action, String playerName) {

<span class="nc" id="L206">        String errMsg = null;</span>
<span class="nc" id="L207">        Player player = playerManager.getCurrentPlayer();</span>

        while (true) {

            // Check player
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (!playerName.equals(player.getId())) {</span>
<span class="nc" id="L213">                errMsg =</span>
<span class="nc" id="L214">                        LocalText.getText(&quot;WrongPlayer&quot;, playerName,</span>
<span class="nc" id="L215">                                player.getId());</span>
                break;
            }
            break;
        }

<span class="nc bnc" id="L221" title="All 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L222">            DisplayBuffer.add(this,</span>
<span class="nc" id="L223">                    LocalText.getText(&quot;InvalidPass&quot;, playerName, errMsg));</span>
<span class="nc" id="L224">            return false;</span>
        }

<span class="nc" id="L227">        ReportBuffer.add(this, LocalText.getText(&quot;PASSES&quot;, playerName));</span>

<span class="nc" id="L229">        numPasses.add(1);</span>

<span class="nc bnc" id="L231" title="All 2 branches missed.">        if (numPasses.value() &gt;= playerManager.getNumberOfPlayers()) {</span>
            // All players have passed.
            // The next open top row papers in either column will be reduced by
            // price
            // TBD
<span class="nc" id="L236">            ReportBuffer.add(this, LocalText.getText(&quot;ALL_PASSED&quot;));</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">            for (StartItem item : startPacket.getItems()) {</span>
<span class="nc bnc" id="L238" title="All 4 branches missed.">                if ((item.getStatus() == 2) &amp;&amp; (item.getBasePrice() != 0)) {</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">                    if (item.getBasePrice() &gt;=10) {</span>
<span class="nc" id="L240">                    item.reduceBasePriceBy(10);</span>
                    } else { //Assumption only 5 G remain
<span class="nc" id="L242">                        item.reduceBasePriceBy(5);</span>
                    }
<span class="nc" id="L244">                    ReportBuffer.add(</span>
                            this,
<span class="nc" id="L246">                            LocalText.getText(&quot;ITEM_PRICE_REDUCED&quot;,</span>
<span class="nc" id="L247">                                    item.getId(),</span>
<span class="nc" id="L248">                                    Bank.format(this, item.getBasePrice())));</span>
                }
<span class="nc" id="L250">            }</span>

<span class="nc" id="L252">            numPasses.set(0);</span>
<span class="nc" id="L253">            numRoundsPassed.add(1);</span>
<span class="nc" id="L254">            playerManager.setCurrentToNextPlayer();</span>
       } else {
<span class="nc" id="L256">            playerManager.setCurrentToNextPlayer();</span>
        }

<span class="nc" id="L259">        return true;</span>
    }

    /*
     * (non-Javadoc)
     *
     * @see rails.game.StartRound#buy(java.lang.String,
     * rails.game.action.BuyStartItem)
     */
    @Override
    protected boolean buy(String playerName, BuyStartItem boughtItem) {

<span class="nc" id="L271">        StartItem item = boughtItem.getStartItem();</span>
<span class="nc" id="L272">        int lastBid = item.getBid();</span>
<span class="nc" id="L273">        String errMsg = null;</span>
<span class="nc" id="L274">        Player player = playerManager.getCurrentPlayer();</span>
<span class="nc" id="L275">        int price = 0;</span>
<span class="nc" id="L276">        int sharePrice = 0;</span>

        while (true) {
<span class="nc bnc" id="L279" title="All 2 branches missed.">            if (item.getStatus() != StartItem.BUYABLE) {</span>
<span class="nc" id="L280">                errMsg = LocalText.getText(&quot;NotForSale&quot;);</span>
<span class="nc" id="L281">                break;</span>
            }

<span class="nc" id="L284">            price = item.getBasePrice();</span>

<span class="nc bnc" id="L286" title="All 2 branches missed.">            if (player.getFreeCash() &lt; price) {</span>
<span class="nc" id="L287">                errMsg = LocalText.getText(&quot;NoMoney&quot;);</span>
                break;
            }

            break;
        }

<span class="nc bnc" id="L294" title="All 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L295">            DisplayBuffer.add(this, LocalText.getText(&quot;CantBuyItem&quot;,</span>
<span class="nc" id="L296">                    playerName, item.getId(), errMsg));</span>
<span class="nc" id="L297">            return false;</span>
        }

<span class="nc" id="L300">        assignItem(player, item, price, sharePrice);</span>

        // Set priority (only if the item was not auctioned)
<span class="nc bnc" id="L303" title="All 2 branches missed.">        if (lastBid == 0) {</span>
<span class="nc" id="L304">            getRoot().getPlayerManager().setPriorityPlayerToNext();</span>
        }
<span class="nc" id="L306">        playerManager.setCurrentToNextPlayer();</span>
<span class="nc" id="L307">        resetStartPacketPrices(numRoundsPassed.value());</span>
<span class="nc" id="L308">        numPasses.set(0);</span>
<span class="nc" id="L309">        numRoundsPassed.set(0);</span>

<span class="nc bnc" id="L311" title="All 2 branches missed.">        if (item.getId().equals(&quot;KB&quot;)) {</span>
<span class="nc" id="L312">            return true;</span>

        }

<span class="nc" id="L316">        return true;</span>

    }

    private void resetStartPacketPrices(int i) {
<span class="nc" id="L321">        List&lt;StartItem&gt; startItems = startPacket.getItems();</span>
<span class="nc bnc" id="L322" title="All 2 branches missed.">        for (StartItem item : startItems) {</span>
<span class="nc bnc" id="L323" title="All 4 branches missed.">            if ((!item.isSold()) &amp;&amp; (item.getStatus() == StartItem.BUYABLE)) {</span>
<span class="nc" id="L324">                item.reduceBasePriceBy(-(i * 10));// Attention there is at least one certificate that has a price not based on 10G.</span>
<span class="nc bnc" id="L325" title="All 2 branches missed.">             if (item.getId() ==&quot;AB&quot;) {</span>
<span class="nc" id="L326">                 item.reduceBasePriceBy(5);</span>
             }
            }
<span class="nc" id="L329">        }</span>

<span class="nc" id="L331">    }</span>

    /*
     * (non-Javadoc)
     *
     * @see net.sf.rails.game.StartRound#assignItem(net.sf.rails.game.Player,
     * net.sf.rails.game.StartItem, int, int)
     */
    @Override
    protected void assignItem(Player player, StartItem item, int price,
            int sharePrice) {
<span class="nc bnc" id="L342" title="All 2 branches missed.">        if ((item.hasSecondary())</span>
<span class="nc bnc" id="L343" title="All 2 branches missed.">            &amp;&amp; (item.getSecondary().getParent().getId().equals(&quot;S5&quot;))) {</span>
<span class="nc" id="L344">            Certificate primary = item.getPrimary();</span>
<span class="nc" id="L345">            Currency.toBank(player, price);</span>
<span class="nc" id="L346">            primary.moveTo(player);</span>
<span class="nc" id="L347">            ReportBuffer.add(</span>
                    this,
<span class="nc" id="L349">                    LocalText.getText(&quot;BuysItemFor&quot;, player.getId(),</span>
<span class="nc" id="L350">                            primary.toText(), Bank.format(this, price)));</span>
<span class="nc" id="L351">            PublicCertificate secondary =</span>
<span class="nc" id="L352">                    (PublicCertificate) item.getSecondary();</span>
<span class="nc" id="L353">            playerManager.setCurrentPlayer(player);</span>
<span class="nc" id="L354">            pendingAction.set(new SetHomeHexLocation(item,</span>
<span class="nc" id="L355">                    secondary.getCompany(), player, price));</span>
<span class="nc" id="L356">            pendingPlayer.set(player);</span>
<span class="nc" id="L357">            pendingCertificate.set(secondary);</span>
<span class="nc" id="L358">        } else {</span>
<span class="nc" id="L359">            super.assignItem(player, item, price, sharePrice);</span>
        }
<span class="nc" id="L361">    }</span>

    @Override
    public boolean process(PossibleAction action) {
<span class="nc" id="L365">        boolean result = false;</span>

<span class="nc" id="L367">        log.debug(&quot;Processing action &quot; + action);</span>

<span class="nc bnc" id="L369" title="All 2 branches missed.">        if (action instanceof NullAction</span>
<span class="nc bnc" id="L370" title="All 2 branches missed.">            &amp;&amp; ((NullAction) action).getMode() == NullAction.Mode.PASS) {</span>
<span class="nc" id="L371">            String playerName = action.getPlayerName();</span>
<span class="nc" id="L372">            NullAction nullAction = (NullAction) action;</span>
<span class="nc" id="L373">            result = pass(nullAction, playerName);</span>

<span class="nc bnc" id="L375" title="All 2 branches missed.">        } else if (action instanceof StartItemAction) {</span>

<span class="nc" id="L377">            StartItemAction startItemAction = (StartItemAction) action;</span>
<span class="nc" id="L378">            String playerName = action.getPlayerName();</span>

<span class="nc" id="L380">            log.debug(&quot;Item details: &quot; + startItemAction.toString());</span>

<span class="nc bnc" id="L382" title="All 2 branches missed.">            if (startItemAction instanceof BuyStartItem) {</span>

<span class="nc" id="L384">                BuyStartItem buyAction = (BuyStartItem) startItemAction;</span>
<span class="nc" id="L385">                result = buy(playerName, buyAction);</span>
<span class="nc bnc" id="L386" title="All 2 branches missed.">            } else if (startItemAction instanceof SetHomeHexLocation) {</span>

<span class="nc" id="L388">                SetHomeHexLocation castAction = (SetHomeHexLocation) action;</span>
<span class="nc" id="L389">                Player player = playerManager.getCurrentPlayer();</span>

<span class="nc" id="L391">                pendingCertificate.value().moveTo(player);</span>
<span class="nc" id="L392">                ReportBuffer.add(this, LocalText.getText(&quot;ALSO_GETS&quot;,</span>
<span class="nc" id="L393">                        player.getId(), pendingCertificate.value().toText()));</span>

<span class="nc" id="L395">                PublicCompany_1837 company =</span>
<span class="nc" id="L396">                        (PublicCompany_1837) castAction.getCompany();</span>
<span class="nc" id="L397">                company.setHomeHex(castAction.getSelectedHomeHex());</span>
<span class="nc" id="L398">                ReportBuffer.add(this, LocalText.getText(&quot;SetsHomeHexS5&quot;,</span>
<span class="nc" id="L399">                        company.getId(),</span>
<span class="nc" id="L400">                        castAction.getSelectedHomeHex().getId()));</span>
<span class="nc" id="L401">                company.start();</span>
<span class="nc" id="L402">                floatCompany(company);</span>

<span class="nc" id="L404">                pendingAction.set(null);</span>

<span class="nc bnc" id="L406" title="All 2 branches missed.">                if ((startPacket.areAllSold())</span>
<span class="nc bnc" id="L407" title="All 2 branches missed.">                    &amp;&amp; (pendingAction.value() == null)) {</span>
                    /*
                     * If the complete start packet has been sold, start a Stock
                     * round,
                     */
<span class="nc" id="L412">                    possibleActions.clear();</span>
<span class="nc" id="L413">                    finishRound();</span>
                }
<span class="nc" id="L415">                result = true;</span>
<span class="nc" id="L416">            } else {</span>

<span class="nc" id="L418">                DisplayBuffer.add(</span>
                        this,
<span class="nc" id="L420">                        LocalText.getText(&quot;UnexpectedAction&quot;, action.toString()));</span>
            }
        }
<span class="nc bnc" id="L423" title="All 2 branches missed.">        if ((startPacket.areAllSold())</span>
<span class="nc bnc" id="L424" title="All 2 branches missed.">                &amp;&amp; (pendingAction.value() == null)) {</span>
                /*
                 * If the complete start packet has been sold, start a Stock
                 * round,
                 */
<span class="nc" id="L429">                possibleActions.clear();</span>
<span class="nc" id="L430">                finishRound();</span>
            }
<span class="nc" id="L432">        return result;</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>