<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OperatingRound_1837.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._1837</a> &gt; <span class="el_source">OperatingRound_1837.java</span></div><h1>OperatingRound_1837.java</h1><pre class="source lang-java linenums">/**
 *
 */
package net.sf.rails.game.specific._1837;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Set;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import net.sf.rails.common.DisplayBuffer;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.GameDef;
import net.sf.rails.game.GameManager;
import net.sf.rails.game.MapHex;
import net.sf.rails.game.OperatingRound;
import net.sf.rails.game.Phase;
import net.sf.rails.game.Player;
import net.sf.rails.game.PrivateCompany;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.NationalFormationRound;
import net.sf.rails.game.special.ExchangeForShare;
import net.sf.rails.game.special.SpecialProperty;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.MoneyOwner;
import net.sf.rails.util.SequenceUtil;
import rails.game.action.BuyTrain;
import rails.game.action.SetDividend;

import com.google.common.collect.HashBasedTable;
import com.google.common.collect.Iterables;
import com.google.common.collect.Table;


/**
 * @author Martin
 *
 */
public class OperatingRound_1837 extends OperatingRound {
<span class="nc" id="L47">    private static final Logger log = LoggerFactory.getLogger(OperatingRound_1837.class);</span>

<span class="nc" id="L49">    private final BooleanState needSuedBahnFormationCall = BooleanState.create(this, &quot;NeedSuedBahnFormationCall&quot;);</span>
<span class="nc" id="L50">    private final BooleanState needHungaryFormationCall = BooleanState.create(this, &quot;NeedHungaryFormationCall&quot;);</span>
<span class="nc" id="L51">    private final BooleanState needKuKFormationCall = BooleanState.create(this, &quot;NeedKuKFormationCall&quot;);</span>



    /**
     * Registry of percentage of nationals revenue to be denied per player
     * because of having produced revenue in the same OR.
     */
<span class="nc" id="L59">    private final Table&lt;Player, PublicCompany, Integer&gt; deniedIncomeShare = HashBasedTable.create();</span>
    /**
     * @param parent
     * @param id
     */
    public OperatingRound_1837(GameManager parent, String id) {
<span class="nc" id="L65">        super(parent, id);</span>
<span class="nc" id="L66">    }</span>


    @Override
    protected void newPhaseChecks() {
<span class="nc" id="L71">        Phase phase = Phase.getCurrent(this);</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">        if (phase.getId().equals(&quot;3&quot;)) {</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            for(PrivateCompany comp:gameManager.getAllPrivateCompanies())  {</span>
<span class="nc" id="L74">                comp.unblockHexes();</span>
<span class="nc" id="L75">            }</span>
        }
<span class="nc bnc" id="L77" title="All 2 branches missed.">        if (phase.getId().equals(&quot;4&quot;)</span>
<span class="nc bnc" id="L78" title="All 2 branches missed.">                &amp;&amp; !companyManager.getPublicCompany(&quot;Sd&quot;).hasStarted()</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">                &amp;&amp; !NationalFormationRound.nationalIsComplete(gameManager, &quot;Sd&quot;)) {</span>
<span class="nc bnc" id="L80" title="All 2 branches missed.">            if (getStep() == GameDef.OrStep.DISCARD_TRAINS) {</span>
                // Postpone until trains are discarded
<span class="nc" id="L82">                needSuedBahnFormationCall.set(true);</span>
            } else {
                // Do it immediately
<span class="nc" id="L85">                ((GameManager_1837)gameManager).startSuedBahnFormationRound (this);</span>
            }
        }
<span class="nc bnc" id="L88" title="All 2 branches missed.">        if (phase.getId().equals(&quot;4+1&quot;)</span>
<span class="nc bnc" id="L89" title="All 2 branches missed.">                &amp;&amp; !companyManager.getPublicCompany(&quot;KK&quot;).hasStarted()</span>
<span class="nc bnc" id="L90" title="All 2 branches missed.">                &amp;&amp; !NationalFormationRound.nationalIsComplete(gameManager,&quot;KK&quot;)) {</span>
<span class="nc bnc" id="L91" title="All 2 branches missed.">            if (getStep() == GameDef.OrStep.DISCARD_TRAINS) {</span>
                // Postpone until trains are discarded
<span class="nc" id="L93">                needKuKFormationCall.set(true);</span>
            } else {
                // Do it immediately
<span class="nc" id="L96">                ((GameManager_1837)gameManager).startKuKFormationRound (this);</span>
            }
<span class="nc bnc" id="L98" title="All 2 branches missed.">            if (phase.getId().equals(&quot;4E&quot;)</span>
<span class="nc bnc" id="L99" title="All 2 branches missed.">                    &amp;&amp; !companyManager.getPublicCompany(&quot;Ug&quot;).hasStarted()</span>
<span class="nc bnc" id="L100" title="All 2 branches missed.">                    &amp;&amp; !NationalFormationRound.nationalIsComplete(gameManager, &quot;Ug&quot;)) {</span>
<span class="nc bnc" id="L101" title="All 2 branches missed.">                if (getStep() == GameDef.OrStep.DISCARD_TRAINS) {</span>
                    // Postpone until trains are discarded
<span class="nc" id="L103">                    needHungaryFormationCall.set(true);</span>
                } else {
                    // Do it immediately
<span class="nc" id="L106">                    ((GameManager_1837)gameManager).startHungaryFormationRound (this);</span>
                }
            }

        }

<span class="nc" id="L112">    }</span>

    private void addIncomeDenialShare (Player player, PublicCompany company, int share) {

<span class="nc bnc" id="L116" title="All 2 branches missed.">        if (!deniedIncomeShare.contains(player, company)) {</span>
<span class="nc" id="L117">            deniedIncomeShare.put(player, company, share);</span>
        } else {
<span class="nc" id="L119">            deniedIncomeShare.put(player, company, share + deniedIncomeShare.get(player, company));</span>
        }
        //log.debug(&quot;+++ Denied &quot;+share+&quot;% share of PR income to &quot;+player.getName());
<span class="nc" id="L122">    }</span>

    /** Count the number of shares per revenue recipient&lt;p&gt;
     * A special rule applies to 1835 to prevent black privates and minors providing
     * income twice during an OR.
     */
    @Override
    protected  Map&lt;MoneyOwner, Integer&gt;  countSharesPerRecipient () {

<span class="nc" id="L131">        Map&lt;MoneyOwner, Integer&gt; sharesPerRecipient = super.countSharesPerRecipient();</span>

<span class="nc bnc" id="L133" title="All 2 branches missed.">        if (operatingCompany.value().getId().equalsIgnoreCase(&quot;Sd&quot;)) {</span>
<span class="nc bnc" id="L134" title="All 2 branches missed.">            for (Player player : deniedIncomeShare.rowKeySet()) {</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (!sharesPerRecipient.containsKey(player)) continue;</span>
<span class="nc" id="L136">                int share = deniedIncomeShare.get(player,operatingCompany.value());</span>
<span class="nc" id="L137">                int shares = share / operatingCompany.value().getShareUnit();</span>
<span class="nc" id="L138">                sharesPerRecipient.put (player, sharesPerRecipient.get(player) - shares);</span>
<span class="nc" id="L139">                ReportBuffer.add(this, LocalText.getText(&quot;NoIncomeForPreviousOperation&quot;,</span>
<span class="nc" id="L140">                        player.getId(),</span>
<span class="nc" id="L141">                        share,</span>
                        &quot;Sd&quot;));
<span class="nc" id="L143">            }</span>
        }


<span class="nc" id="L147">        return sharesPerRecipient;</span>
    }
    /**
     * Register black minors as having operated
     * for the purpose of denying income after conversion to a PR share
     */
    @Override
    protected void initTurn() {

<span class="nc" id="L156">        super.initTurn();</span>

<span class="nc" id="L158">        Set&lt;SpecialProperty&gt; sps = operatingCompany.value().getSpecialProperties();</span>
<span class="nc bnc" id="L159" title="All 4 branches missed.">        if (sps != null &amp;&amp; !sps.isEmpty()) {</span>
<span class="nc" id="L160">            ExchangeForShare efs = (ExchangeForShare) Iterables.get(sps, 0);</span>
<span class="nc" id="L161">            addIncomeDenialShare (operatingCompany.value().getPresident(), operatingCompany.value(), efs.getShare());</span>
        }
<span class="nc" id="L163">    }</span>

    @Override
    public void resume() {
<span class="nc" id="L167">        PublicCompany suedbahn = companyManager.getPublicCompany(&quot;Sd&quot;);</span>
        //        PublicCompany hungary = companyManager.getPublicCompany(&quot;Ug&quot;);
        //       PublicCompany kuk = companyManager.getPublicCompany(&quot;KK&quot;);

<span class="nc bnc" id="L171" title="All 4 branches missed.">        if ((suedbahn.hasFloated()) &amp;&amp; (!suedbahn.hasOperated())</span>
                // Suedbahn has just started. Check if it can operate this round
                // That's only the case if another Pre Suedbahn S2-S5 still hasnt
                // operated. Trains that have run this OR cant run again, shares that have
                // been exchanged cant get their income distributed again.
<span class="nc bnc" id="L176" title="All 2 branches missed.">                &amp;&amp; (operatingCompany.value().getType().getId().equals(&quot;Minor1&quot;)) ) {</span>
<span class="nc" id="L177">            log.debug(&quot;a Pre Suedbahn has not operated: Suedbahn can operate&quot;);</span>

            // Insert the Suedbahn before the first major company
            // with a lower current price that has not yet operated
            // and isn't currently operating

<span class="nc" id="L183">            int index = 0;</span>
<span class="nc" id="L184">            int operatingCompanyndex = getOperatingCompanyndex();</span>
<span class="nc bnc" id="L185" title="All 2 branches missed.">            for (PublicCompany company : setOperatingCompanies()) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">                if (index &gt; operatingCompanyndex</span>
<span class="nc bnc" id="L187" title="All 2 branches missed.">                        &amp;&amp; company.hasStockPrice()</span>
<span class="nc bnc" id="L188" title="All 2 branches missed.">                        &amp;&amp; company.hasFloated()</span>
<span class="nc bnc" id="L189" title="All 2 branches missed.">                        &amp;&amp; !company.isClosed()</span>
<span class="nc bnc" id="L190" title="All 2 branches missed.">                        &amp;&amp; company != operatingCompany.value()</span>
<span class="nc" id="L191">                        &amp;&amp; company.getCurrentSpace().getPrice()</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">                        &lt; suedbahn.getCurrentSpace().getPrice()) {</span>
<span class="nc" id="L193">                    log.debug(&quot;Suedbahn will operate before &quot;+company.getId());</span>
<span class="nc" id="L194">                    break;</span>
                }
<span class="nc" id="L196">                index++;</span>
<span class="nc" id="L197">            }</span>
            // Insert SB at the found index (possibly at the end)
<span class="nc" id="L199">            operatingCompanies.add(index, suedbahn);</span>
<span class="nc" id="L200">            log.debug(&quot;SU will operate at order position &quot;+index);</span>

<span class="nc" id="L202">        } else {</span>

<span class="nc" id="L204">            log.debug(&quot;S1 has operated: SU cannot operate&quot;);</span>

        }

<span class="nc" id="L208">        guiHints.setCurrentRoundType(getClass());</span>
<span class="nc" id="L209">        super.resume();</span>
<span class="nc" id="L210">    }</span>

    /* (non-Javadoc)
     * @see net.sf.rails.game.OperatingRound#validateSetRevenueAndDividend(rails.game.action.SetDividend)
     */
    @Override
    protected String validateSetRevenueAndDividend(SetDividend action) {
<span class="nc" id="L217">        String errMsg = null;</span>
        PublicCompany company;
        String companyName;
<span class="nc" id="L220">        int amount = 0;</span>
<span class="nc" id="L221">        int revenueAllocation = -1;</span>

        // Dummy loop to enable a quick jump out.
        while (true) {

            // Checks
            // Must be correct company.
<span class="nc" id="L228">            company = action.getCompany();</span>
<span class="nc" id="L229">            companyName = company.getId();</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">            if (company != operatingCompany.value()) {</span>
<span class="nc" id="L231">                errMsg =</span>
<span class="nc" id="L232">                        LocalText.getText(&quot;WrongCompany&quot;,</span>
                                companyName,
<span class="nc" id="L234">                                operatingCompany.value().getId() );</span>
<span class="nc" id="L235">                break;</span>
            }
            // Must be correct step
<span class="nc bnc" id="L238" title="All 2 branches missed.">            if (getStep() != GameDef.OrStep.CALC_REVENUE) {</span>
<span class="nc" id="L239">                errMsg = LocalText.getText(&quot;WrongActionNoRevenue&quot;);</span>
<span class="nc" id="L240">                break;</span>
            }

            // Amount must be non-negative multiple of 5
<span class="nc" id="L244">            amount = action.getActualRevenue();</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">            if (amount &lt; 0) {</span>
<span class="nc" id="L246">                errMsg =</span>
<span class="nc" id="L247">                        LocalText.getText(&quot;NegativeAmountNotAllowed&quot;,</span>
<span class="nc" id="L248">                                String.valueOf(amount));</span>
<span class="nc" id="L249">                break;</span>
            }
<span class="nc bnc" id="L251" title="All 2 branches missed.">            if (amount % 5 != 0) {</span>
<span class="nc" id="L252">                errMsg =</span>
<span class="nc" id="L253">                        LocalText.getText(&quot;AmountMustBeMultipleOf5&quot;,</span>
<span class="nc" id="L254">                                String.valueOf(amount));</span>
<span class="nc" id="L255">                break;</span>
            }

            // Check chosen revenue distribution
<span class="nc bnc" id="L259" title="All 2 branches missed.">            if (amount &gt; 0) {</span>
                // Check the allocation type index (see SetDividend for values)
<span class="nc" id="L261">                revenueAllocation = action.getRevenueAllocation();</span>
<span class="nc bnc" id="L262" title="All 4 branches missed.">                if (revenueAllocation &lt; 0</span>
                        || revenueAllocation &gt;= SetDividend.NUM_OPTIONS) {
<span class="nc" id="L264">                    errMsg =</span>
<span class="nc" id="L265">                            LocalText.getText(&quot;InvalidAllocationTypeIndex&quot;,</span>
<span class="nc" id="L266">                                    String.valueOf(revenueAllocation));</span>
<span class="nc" id="L267">                    break;</span>
                }

                // Validate the chosen allocation type
<span class="nc" id="L271">                int[] allowedAllocations =</span>
<span class="nc" id="L272">                        ((SetDividend) selectedAction).getAllowedAllocations();</span>
<span class="nc" id="L273">                boolean valid = false;</span>
<span class="nc bnc" id="L274" title="All 2 branches missed.">                for (int aa : allowedAllocations) {</span>
<span class="nc bnc" id="L275" title="All 2 branches missed.">                    if (revenueAllocation == aa) {</span>
<span class="nc" id="L276">                        valid = true;</span>
<span class="nc" id="L277">                        break;</span>
                    }
                }
<span class="nc bnc" id="L280" title="All 2 branches missed.">                if (!valid) {</span>
<span class="nc" id="L281">                    errMsg =</span>
<span class="nc" id="L282">                            LocalText.getText(SetDividend.getAllocationNameKey(revenueAllocation));</span>
<span class="nc" id="L283">                    break;</span>
                }
<span class="nc" id="L285">            } else {</span>
                // If there is no revenue, use withhold.
<span class="nc" id="L287">                action.setRevenueAllocation(SetDividend.WITHHOLD);</span>
            }

<span class="nc bnc" id="L290" title="All 4 branches missed.">            if (amount == 0 &amp;&amp; operatingCompany.value().getNumberOfTrains() == 0) {</span>
<span class="nc" id="L291">                DisplayBuffer.add(this, LocalText.getText(&quot;RevenueWithNoTrains&quot;,</span>
<span class="nc" id="L292">                        operatingCompany.value().getId(),</span>
<span class="nc" id="L293">                        Bank.format(this, 0) ));</span>
            }

            break;
        }

<span class="nc" id="L299">        return errMsg;</span>
    }

    /* (non-Javadoc)
     * @see net.sf.rails.game.OperatingRound#splitRevenue(int)
     */

    public void splitRevenue(int amount, boolean roundUp) {
<span class="nc" id="L307">        int withheld = 0;</span>
<span class="nc bnc" id="L308" title="All 2 branches missed.">        if (amount &gt; 0) {</span>
<span class="nc" id="L309">            int numberOfShares = operatingCompany.value().getNumberOfShares();</span>
<span class="nc bnc" id="L310" title="All 2 branches missed.">            if (roundUp) {</span>
                // Withhold half of it
<span class="nc" id="L312">                withheld =</span>
                        (amount / (2 * numberOfShares)) * numberOfShares;

            } else {
                //withhold half of it and make sure the bank gets any remaining rounding victims
<span class="nc" id="L317">                withheld =</span>
<span class="nc" id="L318">                        (int) Math.ceil(amount * 0.5);</span>
            }
<span class="nc" id="L320">            String withheldText = Currency.fromBank(withheld, operatingCompany.value());</span>

<span class="nc" id="L322">            ReportBuffer.add(this, operatingCompany.value().getId() + LocalText.getText(&quot;Receives&quot;) + withheldText);</span>
            // Payout the remainder
<span class="nc" id="L324">            int payed = amount - withheld;</span>
<span class="nc" id="L325">            payout(payed, roundUp, true);</span>
        }

<span class="nc" id="L328">    }</span>


    /*
     * Rounds up or down the individual payments based on the boolean value
     */
    public void payout(int amount, boolean roundUp, boolean b) {
<span class="nc bnc" id="L335" title="All 2 branches missed.">        if (amount == 0) return;</span>

        int part;
        int shares;

<span class="nc" id="L340">        Map&lt;MoneyOwner, Integer&gt; sharesPerRecipient = countSharesPerRecipient();</span>

        // Calculate, round up or down, report and add the cash

        // Define a precise sequence for the reporting
<span class="nc" id="L345">        Set&lt;MoneyOwner&gt; recipientSet = sharesPerRecipient.keySet();</span>
<span class="nc bnc" id="L346" title="All 2 branches missed.">        for (MoneyOwner recipient : SequenceUtil.sortCashHolders(recipientSet)) {</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">            if (recipient instanceof Bank) continue;</span>

<span class="nc" id="L349">            shares = (sharesPerRecipient.get(recipient));</span>
<span class="nc bnc" id="L350" title="All 2 branches missed.">            if (shares == 0) continue;</span>
<span class="nc bnc" id="L351" title="All 2 branches missed.">            if (roundUp)  {</span>
<span class="nc" id="L352">                part = (int) Math.ceil(amount * shares * operatingCompany.value().getShareUnit() / 100.0);</span>
            }
            else {
<span class="nc" id="L355">                part = (int) Math.floor(amount * shares * operatingCompany.value().getShareUnit() / 100.0);</span>
            }

<span class="nc" id="L358">            String partText = Currency.fromBank(part, recipient);</span>
<span class="nc" id="L359">            ReportBuffer.add(this, LocalText.getText(&quot;Payout&quot;,</span>
<span class="nc" id="L360">                    recipient.getId(),</span>
                    partText,
<span class="nc" id="L362">                    shares,</span>
<span class="nc" id="L363">                    operatingCompany.value().getShareUnit()));</span>
<span class="nc" id="L364">        }</span>
        /**
         *  payout the direct Income from the Coal Mine if any
         */
<span class="nc" id="L368">        String partText = Currency.fromBank( operatingCompany.value().getDirectIncomeRevenue(), operatingCompany.value());</span>
<span class="nc" id="L369">        ReportBuffer.add(this, LocalText.getText(&quot;Payout&quot;,</span>
<span class="nc" id="L370">                operatingCompany.getId(),</span>
                partText,
                &quot; companies treasury.&quot;
                ));



        // Move the token
<span class="nc" id="L378">        ((PublicCompany_1837) operatingCompany.value()).payout(amount, b);</span>

<span class="nc" id="L380">    }</span>



    /* (non-Javadoc)
     * @see net.sf.rails.game.OperatingRound#executeSetRevenueAndDividend(rails.game.action.SetDividend)
     */
    @Override
    protected void executeSetRevenueAndDividend(SetDividend action) {

<span class="nc" id="L390">        int amount = action.getActualRevenue();</span>
<span class="nc" id="L391">        int revenueAllocation = action.getRevenueAllocation();</span>
<span class="nc" id="L392">        int directIncome = action.getActualCompanyTreasuryRevenue();</span>

<span class="nc" id="L394">        operatingCompany.value().setLastRevenue(amount);</span>
<span class="nc" id="L395">        operatingCompany.value().setLastRevenueAllocation(revenueAllocation);</span>
<span class="nc" id="L396">        operatingCompany.value().setLastDirectIncome(directIncome);</span>
<span class="nc" id="L397">        operatingCompany.value().setDirectIncomeRevenue(directIncome);</span>

        // Pay any debts from treasury, revenue and/or president's cash
        // The remaining dividend may be less that the original income
<span class="nc" id="L401">        amount = executeDeductions (action);</span>

<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (amount == 0) {</span>

<span class="nc" id="L405">            ReportBuffer.add(this, LocalText.getText(&quot;CompanyDoesNotPayDividend&quot;,</span>
<span class="nc" id="L406">                    operatingCompany.value().getId()));</span>
<span class="nc" id="L407">            withhold(amount);</span>

<span class="nc bnc" id="L409" title="All 2 branches missed.">        } else if (revenueAllocation == SetDividend.PAYOUT) {</span>

<span class="nc" id="L411">            ReportBuffer.add(this, LocalText.getText(&quot;CompanyPaysOutFull&quot;,</span>
<span class="nc" id="L412">                    operatingCompany.value().getId(), Bank.format(this, amount) ));</span>

<span class="nc" id="L414">            payout(amount, false, false); //1837 is paying out the rounded down amount except to the bank..</span>

<span class="nc bnc" id="L416" title="All 2 branches missed.">        } else if (revenueAllocation == SetDividend.SPLIT) {</span>

<span class="nc" id="L418">            ReportBuffer.add(this, LocalText.getText(&quot;CompanySplits&quot;,</span>
<span class="nc" id="L419">                    operatingCompany.value().getId(), Bank.format(this, amount) ));</span>

<span class="nc" id="L421">            splitRevenue(amount, false);</span>

<span class="nc bnc" id="L423" title="All 2 branches missed.">        } else if (revenueAllocation == SetDividend.WITHHOLD) {</span>

<span class="nc" id="L425">            ReportBuffer.add(this, LocalText.getText(&quot;CompanyWithholds&quot;,</span>
<span class="nc" id="L426">                    operatingCompany.value().getId(),</span>
<span class="nc" id="L427">                    Bank.format(this, amount) ));</span>

<span class="nc" id="L429">            withhold(amount);</span>

        }

        // Rust any obsolete trains
<span class="nc" id="L434">        operatingCompany.value().getPortfolioModel().rustObsoleteTrains();</span>

        // We have done the payout step, so continue from there
<span class="nc" id="L437">        nextStep(GameDef.OrStep.PAYOUT);</span>
<span class="nc" id="L438">    }</span>


    /* (non-Javadoc)
     * @see net.sf.rails.game.OperatingRound#gameSpecificTileLayAllowed(net.sf.rails.game.PublicCompany, net.sf.rails.game.MapHex, int)
     */

    @Override
    protected boolean gameSpecificTileLayAllowed(PublicCompany company,
            MapHex hex, int orientation) {
<span class="nc" id="L448">        RailsRoot root = RailsRoot.getInstance();</span>
<span class="nc" id="L449">        List&lt;MapHex&gt; italyMapHexes = new ArrayList&lt;MapHex&gt; ();</span>
        // 1. check Phase

<span class="nc" id="L452">        int phaseIndex = root.getPhaseManager().getCurrentPhase().getIndex();</span>
<span class="nc bnc" id="L453" title="All 2 branches missed.">        if (phaseIndex &lt; 3) {</span>
            // Check if the Hex is blocked by a private ?
<span class="nc bnc" id="L455" title="All 2 branches missed.">            if (hex.isBlockedByPrivateCompany()) {</span>
<span class="nc bnc" id="L456" title="All 2 branches missed.">                if (company.getPresident().getPortfolioModel().getPrivateCompanies().contains(hex.getBlockingPrivateCompany())) {</span>
                    // Check if the Owner of the PublicCompany is owner of the Private Company that blocks
                    // the hex (1837)
<span class="nc" id="L459">                    return true;</span>
                }
<span class="nc" id="L461">                return false;</span>
            }
        }
<span class="nc bnc" id="L464" title="All 2 branches missed.">        if (phaseIndex &gt;= 4 ) {</span>
<span class="nc" id="L465">            log.debug(&quot;Italy inactive, index of phase = &quot; + phaseIndex);</span>

            // 2. retrieve Italy vertices ...
<span class="nc" id="L468">            String [] italyHexes = {&quot;K1&quot;,&quot;K3&quot;,&quot;K7&quot;,&quot;K9&quot;,&quot;L2&quot;,&quot;L4&quot;,&quot;L6&quot;,&quot;L8&quot;,&quot;M3&quot;,&quot;M5&quot;,&quot;M7&quot;};</span>
<span class="nc bnc" id="L469" title="All 2 branches missed.">            for (String italyHex:italyHexes){</span>
<span class="nc" id="L470">                italyMapHexes.add(root.getMapManager().getHex(italyHex));</span>
            }
<span class="nc bnc" id="L472" title="All 2 branches missed.">            if (italyMapHexes.contains(hex)) {</span>
<span class="nc" id="L473">                return false;</span>
            }
        }
<span class="nc" id="L476">        return true;</span>
    }


    protected void prepareRevenueAndDividendAction() {

        // There is only revenue if there are any trains
<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (operatingCompany.value().canRunTrains()) {</span>
            int[] allowedRevenueActions =
<span class="nc bnc" id="L485" title="All 2 branches missed.">                    operatingCompany.value().isSplitAlways()</span>
<span class="nc" id="L486">                    ? new int[] { SetDividend.SPLIT }</span>
<span class="nc bnc" id="L487" title="All 2 branches missed.">            : operatingCompany.value().isSplitAllowed()</span>
<span class="nc" id="L488">            ? new int[] { SetDividend.PAYOUT,</span>
                    SetDividend.SPLIT,
<span class="nc" id="L490">                    SetDividend.WITHHOLD } : new int[] {</span>
                            SetDividend.PAYOUT,
                            SetDividend.WITHHOLD };

<span class="nc" id="L494">            possibleActions.add(new SetDividend(</span>
<span class="nc" id="L495">                    operatingCompany.value().getLastRevenue(), operatingCompany.value().getLastDirectIncome(), true,</span>
                    allowedRevenueActions,0));
        }
<span class="nc" id="L498">    }</span>


    /* (non-Javadoc)
     * @see net.sf.rails.game.OperatingRound#buyTrain(rails.game.action.BuyTrain)
     */
    @Override
    public boolean buyTrain(BuyTrain action) {
<span class="nc" id="L506">        boolean result = super.buyTrain(action);</span>
        // Check if we have just started Phase 5 and
        // if we still have at least one Minor operating.
        // If so, record the current player as the first
        // one to act in the Final Minor Exchange Round.
<span class="nc bnc" id="L511" title="All 4 branches missed.">        if ((result) &amp;&amp; getRoot().getPhaseManager().hasReachedPhase(&quot;5&quot;)</span>
<span class="nc bnc" id="L512" title="All 2 branches missed.">                &amp;&amp; operatingCompanies.get(0).getType().getId().equalsIgnoreCase(&quot;Minor&quot;)</span>
<span class="nc bnc" id="L513" title="All 2 branches missed.">                &amp;&amp; ((GameManager_1837)gameManager).getPlayerToStartFCERound() == null) {</span>
<span class="nc" id="L514">            ((GameManager_1837)gameManager).setPlayerToStartFCERound(operatingCompany.value().getPresident());</span>
        }
<span class="nc" id="L516">        return result;</span>
    }

    @Override
    protected void finishRound() {
<span class="nc" id="L521">        ReportBuffer.add(this, &quot; &quot;);</span>
<span class="nc" id="L522">        ReportBuffer.add(</span>
                this,
<span class="nc" id="L524">                LocalText.getText(&quot;END_OR&quot;,</span>
<span class="nc" id="L525">                        String.valueOf(getRoundName())));</span>

<span class="nc bnc" id="L527" title="All 2 branches missed.">        for (PublicCompany company : gameManager.getCompaniesInRunningOrder()) {</span>
<span class="nc bnc" id="L528" title="All 4 branches missed.">            if ((company.hasStockPrice()) &amp;&amp; (company.hasFloated())){</span>
//                if (findStartingPlayerForCoalExchange(company)) exchangedCoalCompanies.set(true);
//                {}

        }
        else {
<span class="nc" id="L534">            ((GameManager_1837) gameManager).setPlayerToStartCERound(null);</span>
        }


<span class="nc" id="L538">    }</span>
<span class="nc" id="L539">        super.finishRound();</span>

<span class="nc" id="L541">    }</span>

    private boolean findStartingPlayerForCoalExchange(PublicCompany company) {
<span class="nc" id="L544">        List&lt;PublicCompany&gt; comps = companyManager.getAllPublicCompanies();</span>
<span class="nc" id="L545">        List&lt;PublicCompany&gt; minors = new ArrayList&lt;PublicCompany&gt;();</span>
        String type;

<span class="nc bnc" id="L548" title="All 2 branches missed.">        for (PublicCompany comp : comps) {</span>
<span class="nc" id="L549">            type = comp.getType().getId();</span>
<span class="nc bnc" id="L550" title="All 2 branches missed.">            if (type.equals(&quot;Coal&quot;)) {</span>
<span class="nc bnc" id="L551" title="All 2 branches missed.">                if (comp.isClosed()) continue;</span>
<span class="nc bnc" id="L552" title="All 2 branches missed.">                if (comp.getRelatedNationalCompany().equals(company.getId())) {</span>
<span class="nc" id="L553">                    minors.add(comp);</span>
                    //The president of a Major Company is the first one to get the chance to exchange a share.
<span class="nc bnc" id="L555" title="All 2 branches missed.">                    if (((GameManager_1837) gameManager).getPlayerToStartCERound()== null) {</span>
<span class="nc" id="L556">                        ((GameManager_1837) gameManager).setPlayerToStartCERound(company.getPresident());</span>
<span class="nc" id="L557">                        return true;</span>
                        //We found a victim lets move on.
                    }
                } // Coal Company &amp; Major Found
            } //Coal Company Found

<span class="nc" id="L563">        } //Check if we have a minor that has a started Major</span>
<span class="nc bnc" id="L564" title="All 2 branches missed.">        while (!minors.isEmpty()) {</span>
            //The first minors president will start the CoalExchangeRound
<span class="nc bnc" id="L566" title="All 2 branches missed.">            if (((GameManager_1837) gameManager).getPlayerToStartCERound()== null) {</span>
<span class="nc" id="L567">                ((GameManager_1837) gameManager).setPlayerToStartCERound(minors.get(0).getPresident());</span>
<span class="nc" id="L568">                return true;</span>
            }
        }
<span class="nc" id="L571">        return false;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>