<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SoundPlayer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.sound</a> &gt; <span class="el_source">SoundPlayer.java</span></div><h1>SoundPlayer.java</h1><pre class="source lang-java linenums">/**
 *
 */
package net.sf.rails.sound;

import java.io.BufferedInputStream;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.io.FileInputStream;
import java.io.InputStream;
import java.nio.file.Files;
import java.nio.file.Paths;
import java.util.HashMap;
import java.util.Map;

import javazoom.jl.decoder.JavaLayerException;
import javazoom.jl.player.Player;
import javazoom.jl.player.advanced.AdvancedPlayer;

/**
 * Handles play requests for music and sfx.
 *
 * Some specific requirements:
 * - At most one SFX should be played at the same time (necessiting queuing sfx play requests)
 *
 * @author Frederick Weld
 *
 */
<span class="nc" id="L29">public class SoundPlayer {</span>

<span class="nc" id="L31">    private static class SoundFileBuffer {</span>
<span class="nc" id="L32">        private Map&lt;String,byte[]&gt; fileBuffer = new HashMap&lt;&gt;();</span>
        synchronized public BufferedInputStream getFileInputStream(String fileName) {
<span class="nc bnc" id="L34" title="All 2 branches missed.">            if (!fileBuffer.containsKey(fileName)) {</span>
<span class="nc" id="L35">                try (InputStream fis = Files.newInputStream(Paths.get(fileName))) {</span>
<span class="nc" id="L36">                    long length = new File(fileName).length();</span>
<span class="nc" id="L37">                    byte[] fileContent = new byte[(int)length];</span>
<span class="nc" id="L38">                    fis.read(fileContent);</span>
<span class="nc" id="L39">                    fileBuffer.put(fileName, fileContent);</span>
<span class="nc" id="L40">                } catch (Exception e) {return null;}</span>
            }
<span class="nc" id="L42">            return new BufferedInputStream(new ByteArrayInputStream(fileBuffer.get(fileName)));</span>
        }
    }

    private class PlayerThread extends Thread {
        protected String fileName;
        private PlayerThread priorThread;
        private boolean playingDone;
<span class="nc" id="L50">        public PlayerThread(String fileName) {</span>
<span class="nc" id="L51">            this.fileName = fileName;</span>
<span class="nc" id="L52">            priorThread = null;</span>
<span class="nc" id="L53">            playingDone = false;</span>
<span class="nc" id="L54">        }</span>
        public void setPriorThread(PlayerThread priorThread) {
<span class="nc" id="L56">            this.priorThread = priorThread;</span>
<span class="nc" id="L57">        }</span>
        //returns once playing is done
        synchronized public void waitForPlayingDone() {
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (!playingDone) {</span>
                try {
<span class="nc" id="L62">                    wait();</span>
<span class="nc" id="L63">                } catch (InterruptedException e) {}</span>
            }
<span class="nc" id="L65">        }</span>
        public void run() {
            //wait until prior thread has finished playing
<span class="nc bnc" id="L68" title="All 2 branches missed.">            if (priorThread != null) priorThread.waitForPlayingDone();</span>
<span class="nc" id="L69">            priorThread = null; //release handle</span>

<span class="nc" id="L71">            play();</span>

            //wake the subsequent thread if there is one waiting
<span class="nc" id="L74">            synchronized (this) {</span>
<span class="nc" id="L75">                notifyAll();</span>
<span class="nc" id="L76">                playingDone = true;</span>
<span class="nc" id="L77">            }</span>
<span class="nc" id="L78">        }</span>
        public void play() {
            try {
<span class="nc" id="L81">                Player player = new Player(soundFileBuffer.getFileInputStream(fileName));</span>
<span class="nc" id="L82">                player.play();</span>
<span class="nc" id="L83">                player.close();</span>
            }
<span class="nc" id="L85">            catch (Exception e) {</span>
                //if anything goes wrong, don't play anything
<span class="nc" id="L87">            }</span>
<span class="nc" id="L88">        }</span>
    }
    private class PortionPlayerThread extends PlayerThread {
        private double startPos;
        private double endPos;
        /**
         * @param startPos Relative offset [0..1] - first mp3 frame played
         * @param endPos Relative offset [0..1] - last mp3 frame played
         */
<span class="nc" id="L97">        public PortionPlayerThread(String fileName, double startPos, double endPos) {</span>
<span class="nc" id="L98">            super(fileName);</span>
<span class="nc" id="L99">            this.startPos = startPos;</span>
<span class="nc" id="L100">            this.endPos = endPos;</span>
<span class="nc" id="L101">        }</span>
        @Override
        public void play() {
            try {
<span class="nc" id="L105">                PortionPlayer player = new PortionPlayer(</span>
<span class="nc" id="L106">                        soundFileBuffer.getFileInputStream(fileName));</span>
<span class="nc" id="L107">                player.play(startPos, endPos);</span>
<span class="nc" id="L108">                player.close();</span>
            }
<span class="nc" id="L110">            catch (Exception e) {</span>
                //if anything goes wrong, don't play anything
<span class="nc" id="L112">            }</span>
<span class="nc" id="L113">        }</span>
    }
    private static class PortionPlayer extends AdvancedPlayer {
        private BufferedInputStream bis;
        public PortionPlayer(BufferedInputStream bis) throws JavaLayerException {
<span class="nc" id="L118">            super(bis);</span>
<span class="nc" id="L119">            this.bis = bis;</span>
<span class="nc" id="L120">        }</span>
        /**
         * @param startPos Relative offset [0..1] - first mp3 frame played
         * @param endPos Relative offset [0..1] - last mp3 frame played
         */
        public void play(double startPos, double endPos) {
            try {
                //first get number of frames
<span class="nc" id="L128">                bis.mark(Integer.MAX_VALUE);</span>
<span class="nc" id="L129">                int frameNum = 0;</span>
<span class="nc bnc" id="L130" title="All 2 branches missed.">                while (skipFrame()) {</span>
<span class="nc" id="L131">                    frameNum++;</span>
                }
<span class="nc" id="L133">                int startFrame = (int)Math.floor(startPos * frameNum);</span>
<span class="nc" id="L134">                int endFrame = (int)Math.ceil(endPos * frameNum);</span>
<span class="nc bnc" id="L135" title="All 2 branches missed.">                if (startFrame &lt; endFrame) {</span>
<span class="nc" id="L136">                    bis.reset();</span>
<span class="nc" id="L137">                    play(startFrame, endFrame);</span>
                }
<span class="nc" id="L139">            } catch (Exception e) {</span>
                //if anything goes wrong, don't play anything
<span class="nc" id="L141">            }</span>
<span class="nc" id="L142">        }</span>
    }
    private class LoopPlayerThread extends PlayerThread {
<span class="nc" id="L145">        private boolean isStopped = false;</span>
<span class="nc" id="L146">        private Player player = null;</span>
<span class="nc" id="L147">        private LoopPlayerThread previousLoopPlayerThread = null;</span>
<span class="nc" id="L148">        public LoopPlayerThread(String fileName) {</span>
<span class="nc" id="L149">            super(fileName);</span>
<span class="nc" id="L150">        }</span>
        public void play() {
            try {
                //stop prior BGM music
<span class="nc bnc" id="L154" title="All 2 branches missed.">                if (previousLoopPlayerThread != null) {</span>
<span class="nc" id="L155">                    previousLoopPlayerThread.interrupt();</span>
                }

<span class="nc bnc" id="L158" title="All 2 branches missed.">                while (!isStopped) {</span>
<span class="nc" id="L159">                    player = new Player(soundFileBuffer.getFileInputStream(fileName));</span>
<span class="nc" id="L160">                    player.play();</span>
<span class="nc" id="L161">                    player.close();</span>
                }
            }
<span class="nc" id="L164">            catch (Exception e) {</span>
                //if anything goes wrong, don't play anything
<span class="nc" id="L166">            }</span>
<span class="nc" id="L167">        }</span>
        @Override
        public void interrupt() {
<span class="nc" id="L170">            super.interrupt();</span>
<span class="nc" id="L171">            isStopped = true;</span>
<span class="nc bnc" id="L172" title="All 2 branches missed.">            if (player!=null) player.close();</span>
<span class="nc" id="L173">        }</span>
        public void setPreviousLoopPlayer(LoopPlayerThread previousLoopPlayerThread) {
<span class="nc" id="L175">            this.previousLoopPlayerThread = previousLoopPlayerThread;</span>
<span class="nc" id="L176">        }</span>
    }

<span class="nc" id="L179">    private PlayerThread lastSFXThread = null;</span>

<span class="nc" id="L181">    private LoopPlayerThread lastBGMThread = null;</span>

<span class="nc" id="L183">    private SoundFileBuffer soundFileBuffer = new SoundFileBuffer();</span>

    /**
     * atomic switching of the pointer to the last thread which played an sfx.
     * @param newThread Player thread for the new sfx
     * @return Player thread which was the last to play a sfx
     */
    synchronized private PlayerThread adjustLastSFXThread(PlayerThread newThread) {
<span class="nc" id="L191">        PlayerThread pt = lastSFXThread;</span>
<span class="nc" id="L192">        lastSFXThread = newThread;</span>
<span class="nc" id="L193">        return pt;</span>
    }

    /**
     * atomic switching of the pointer to the last thread which played music.
     * @param newThread Player thread for the new music
     * @return Player thread which was the last to play music
     */
    synchronized private LoopPlayerThread adjustLastBGMThread(LoopPlayerThread newThread) {
<span class="nc" id="L202">        LoopPlayerThread pt = lastBGMThread;</span>
<span class="nc" id="L203">        lastBGMThread = newThread;</span>
<span class="nc" id="L204">        return pt;</span>
    }

    private void playSFX(PlayerThread newPlayerThread,boolean playImmediately) {
<span class="nc" id="L208">        PlayerThread oldPlayerThread = adjustLastSFXThread(newPlayerThread);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">        if (!playImmediately) {</span>
<span class="nc" id="L210">            newPlayerThread.setPriorThread(oldPlayerThread);</span>
        }
<span class="nc" id="L212">        newPlayerThread.start();</span>
<span class="nc" id="L213">    }</span>

    private void playSFX(String fileName, boolean playImmediately) {
<span class="nc" id="L216">        playSFX(new PlayerThread (fileName),playImmediately);</span>
<span class="nc" id="L217">    }</span>

    private void playSFX(String fileName, double playSoundProportion, boolean playImmediately) {
<span class="nc" id="L220">        playSFX(new PortionPlayerThread (fileName, 1 - playSoundProportion, 1)</span>
                ,playImmediately);
<span class="nc" id="L222">    }</span>

    /**
     * SFX played after prior SFX playing has been completed
     */
    public void playSFXByConfigKey(String configKey) {
<span class="nc" id="L228">        playSFX(SoundConfig.get(configKey),</span>
<span class="nc" id="L229">                SoundConfig.KEYS_SFX_IMMEDIATE_PLAYING.contains(configKey));</span>
<span class="nc" id="L230">    }</span>
    public void playSFXByConfigKey(String configKey,String parameter) {
<span class="nc" id="L232">        playSFX(SoundConfig.get(configKey,parameter),</span>
<span class="nc" id="L233">                SoundConfig.KEYS_SFX_IMMEDIATE_PLAYING.contains(configKey));</span>
<span class="nc" id="L234">    }</span>

    /**
     * The latter part of the sfx is played.
     * @param playSoundProportion The length of this part relatively to the overall sound duration.
     */
    public void playSFXByConfigKey(String configKey, double playSoundProportion) {
<span class="nc" id="L241">        playSFX(SoundConfig.get(configKey), playSoundProportion,</span>
<span class="nc" id="L242">                SoundConfig.KEYS_SFX_IMMEDIATE_PLAYING.contains(configKey));</span>
<span class="nc" id="L243">    }</span>

    /**
     * Plays new background music and stops old BGM only after all currently playing
     * sfx are finished.
     */
    public void playBGM(String backgroundMusicFileName) {
<span class="nc" id="L250">        LoopPlayerThread newPlayerThread = new LoopPlayerThread(backgroundMusicFileName);</span>
<span class="nc" id="L251">        LoopPlayerThread oldPlayerThread = adjustLastBGMThread(newPlayerThread);</span>

        //interrupt old bgm when starting the new bgm
<span class="nc" id="L254">        newPlayerThread.setPreviousLoopPlayer(oldPlayerThread);</span>

        //wait for playing new bgm until all sfx have finished playing
<span class="nc" id="L257">        newPlayerThread.setPriorThread(lastSFXThread);</span>

<span class="nc" id="L259">        newPlayerThread.start();</span>
<span class="nc" id="L260">    }</span>

    public void playBGMByConfigKey(String configKey) {
<span class="nc" id="L263">        playBGM(SoundConfig.get(configKey));</span>
<span class="nc" id="L264">    }</span>

    public void stopBGM() {
<span class="nc" id="L267">        LoopPlayerThread oldPlayerThread = adjustLastBGMThread(null);</span>
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (oldPlayerThread != null) oldPlayerThread.interrupt();</span>
<span class="nc" id="L269">    }</span>

    public boolean isBGMPlaying() {
<span class="nc bnc" id="L272" title="All 2 branches missed.">        return (lastBGMThread != null);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>