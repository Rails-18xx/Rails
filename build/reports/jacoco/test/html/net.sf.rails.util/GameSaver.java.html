<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GameSaver.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.util</a> &gt; <span class="el_source">GameSaver.java</span></div><h1>GameSaver.java</h1><pre class="source lang-java linenums">package net.sf.rails.util;

import java.io.File;
import java.io.IOException;
import java.io.ObjectOutputStream;
import java.nio.file.Files;
import java.text.SimpleDateFormat;
import java.util.Date;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import net.sf.rails.common.Config;
import net.sf.rails.common.ConfigItem;
import net.sf.rails.common.ConfigManager;
import net.sf.rails.common.GameData;
import net.sf.rails.common.LocalText;
import rails.game.action.PossibleAction;


/**
 * GameLoader is responsible to load a saved Rails game
 */
public class GameSaver {

<span class="nc" id="L30">    private static final Logger log = LoggerFactory.getLogger(GameSaver.class);</span>

    /** Version ID of the Save file header, as written in save() */
    private static final long SAVE_FILE_HEADER_VERSION_ID = 3L;
    /**
     * Overall save file version ID, taking into account the version ID of the
     * action package.
     */
    public static final long saveFileVersionID = SAVE_FILE_HEADER_VERSION_ID * PossibleAction.serialVersionUID;

    // static data for autosave
    public static final String AUTOSAVE_FOLDER = &quot;autosave&quot;;
    public static final String AUTOSAVE_FILE = &quot;18xx_autosave.rails&quot;;

    // game data
<span class="nc" id="L45">    private final GameIOData gameIOData = new GameIOData();</span>

    /**
     * Creates a new game saver
     * @param gameData of the game to save
     * @param actions to save
     */
<span class="nc" id="L52">    public GameSaver(GameData gameData, List&lt;PossibleAction&gt; actions) {</span>
<span class="nc" id="L53">        gameIOData.setGameData(gameData);</span>
<span class="nc" id="L54">        gameIOData.setVersion(Config.getVersion());</span>
<span class="nc" id="L55">        gameIOData.setDate(new SimpleDateFormat(&quot;yyyy-MM-dd HH:mm:ss&quot;).format(new Date()));</span>
<span class="nc" id="L56">        gameIOData.setActions(actions);</span>
<span class="nc" id="L57">        gameIOData.setFileVersionID(saveFileVersionID);</span>
<span class="nc" id="L58">    }</span>

    /**
     * Creates a new game saver based on a gameLoader
     * @param gameLoader to use
     */
    public GameSaver(GameLoader gameLoader) {
<span class="nc" id="L65">        this(gameLoader.getRoot().getGameData(), gameLoader.getActions());</span>
<span class="nc" id="L66">    }</span>

    /**
     * Stores the game to a file
     * @param file to save game to
     */
    public void saveGame(File file) throws IOException {
<span class="nc" id="L73">        log.info(&quot;Trying to save file to {}&quot;, file.getAbsoluteFile());</span>

<span class="nc" id="L75">        try (ObjectOutputStream oos = new ObjectOutputStream(Files.newOutputStream(file.toPath()))) {</span>
<span class="nc" id="L76">            oos.writeObject(gameIOData.getVersion());</span>
<span class="nc" id="L77">            oos.writeObject(gameIOData.getDate());</span>
<span class="nc" id="L78">            oos.writeObject(gameIOData.getFileVersionID());</span>
<span class="nc" id="L79">            oos.writeObject(gameIOData.getGameData().getGameName());</span>
<span class="nc" id="L80">            oos.writeObject(gameIOData.getGameData().getGameOptions().getOptions());</span>
            // save game play related options
<span class="nc" id="L82">            Map&lt;String, String&gt; gameOptions = new HashMap&lt;&gt;();</span>
<span class="nc bnc" id="L83" title="All 2 branches missed.">            for ( Map.Entry&lt;String, List&lt;ConfigItem&gt;&gt; entry : ConfigManager.getInstance().getConfigSections().entrySet() ) {</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">                for ( ConfigItem config : entry.getValue() ) {</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">                    if ( config.isGameRelated ) {</span>
<span class="nc" id="L86">                        String value = Config.get(config.name);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">                        if ( StringUtils.isNotBlank(value) ) {</span>
<span class="nc" id="L88">                            gameOptions.put(config.name, Config.get(config.name));</span>
                        }
                    }
<span class="nc" id="L91">                }</span>
<span class="nc" id="L92">            }</span>
<span class="nc bnc" id="L93" title="All 2 branches missed.">            if ( !gameOptions.isEmpty() ) {</span>
<span class="nc" id="L94">                oos.writeObject(gameOptions);</span>
            }

<span class="nc" id="L97">            oos.writeObject(gameIOData.getGameData().getPlayers());</span>
<span class="nc bnc" id="L98" title="All 2 branches missed.">            for ( PossibleAction action : gameIOData.getActions() ) {</span>
<span class="nc" id="L99">                oos.writeObject(action);</span>
<span class="nc" id="L100">            }</span>
<span class="nc" id="L101">            log.info(&quot;File save successful&quot;);</span>
        }
<span class="nc" id="L103">    }</span>

    /**
     * stores game to autosave file
     * @throws IOException
     */
    public void autoSave() throws IOException  {
<span class="nc" id="L110">        File directory = SystemOS.get().getConfigurationFolder(AUTOSAVE_FOLDER, true);</span>
<span class="nc" id="L111">        String fileName = AUTOSAVE_FILE;</span>

        // create temporary new save file
<span class="nc" id="L114">        File tempFile = new File(directory, fileName + &quot;.tmp&quot;);</span>
<span class="nc" id="L115">        saveGame(tempFile);</span>
<span class="nc" id="L116">        log.debug(&quot;Created temporary recovery file, path = {}&quot;, tempFile.getPath());</span>

        // rename the temp file to the recover file
<span class="nc" id="L119">        File recoveryFile = new File(directory, fileName);</span>
<span class="nc" id="L120">        log.debug(&quot;Potential recovery at {}&quot;, recoveryFile.getPath());</span>
        // check if previous save file exists
        boolean renameResult;
<span class="nc bnc" id="L123" title="All 2 branches missed.">        if (recoveryFile.exists()) {</span>
<span class="nc" id="L124">            log.debug(&quot;Recovery file exists&quot;);</span>
<span class="nc" id="L125">            File backupFile = new File(directory, fileName + &quot;.bak&quot;);</span>
            //delete backup file if existing
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (backupFile.exists()) {</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">                if ( ! backupFile.delete() ) {</span>
<span class="nc" id="L129">                    log.warn(&quot;Unable to delete file {}&quot;, backupFile);</span>
                }
            }
            //old recovery file becomes new backup file
<span class="nc bnc" id="L133" title="All 2 branches missed.">            if ( ! recoveryFile.renameTo(backupFile) ) {</span>
<span class="nc" id="L134">                log.warn(&quot;Unable to rename recovery file {}&quot;, recoveryFile);</span>
            } else {
<span class="nc" id="L136">                log.debug(&quot;Recovery file renamed to {}&quot;, backupFile.getPath());</span>
            }
            //temp file becomes new recoveryFile
<span class="nc" id="L139">            renameResult = tempFile.renameTo(recoveryFile);</span>
<span class="nc" id="L140">        } else {</span>
<span class="nc" id="L141">            log.debug(&quot;Recovery file does not exist&quot;);</span>
<span class="nc" id="L142">            renameResult = tempFile.renameTo(recoveryFile);</span>
        }

<span class="nc bnc" id="L145" title="All 2 branches missed.">        if (!renameResult) {</span>
<span class="nc" id="L146">            String message = LocalText.getText(&quot;RecoveryRenameFailed&quot;);</span>
<span class="nc" id="L147">            throw new IOException(message);</span>
        }
<span class="nc" id="L149">        log.debug(&quot;Renamed to recovery file, path = {}&quot;, recoveryFile.getPath());</span>
<span class="nc" id="L150">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>