<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportBuffer.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.common</a> &gt; <span class="el_source">ReportBuffer.java</span></div><h1>ReportBuffer.java</h1><pre class="source lang-java linenums">package net.sf.rails.common;

import java.util.Deque;
import java.util.Queue;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import net.sf.rails.game.RailsAbstractItem;
import net.sf.rails.game.RailsItem;
import net.sf.rails.game.state.ChangeReporter;
import net.sf.rails.game.state.ChangeSet;
import net.sf.rails.game.state.ChangeStack;
import net.sf.rails.util.Util;

import com.google.common.collect.ImmutableList;
import com.google.common.collect.Iterables;
import com.google.common.collect.Lists;


/**
 * ReportBuffer stores messages of the game progress.
 *
 * Also used for regression testing comparing the output of the report buffer.
 */

public class ReportBuffer extends RailsAbstractItem implements ChangeReporter {

<span class="fc" id="L29">    private static final Logger log = LoggerFactory.getLogger(ReportBuffer.class);</span>

    /** Indicator string to find the active message position in the parsed html document */
    public static final String ACTIVE_MESSAGE_INDICATOR = &quot;(**)&quot;;

    // static data
<span class="fc" id="L35">    private final Deque&lt;ReportSet&gt; pastReports = Lists.newLinkedList();</span>
<span class="fc" id="L36">    private final Deque&lt;ReportSet&gt; futureReports = Lists.newLinkedList();</span>

    // TODO: Remove waitQueue, see functions below
<span class="fc" id="L39">    private final Queue&lt;String&gt; waitQueue = Lists.newLinkedList();</span>

    private ChangeStack changeStack; // initialized via init()

    // dynamic data
    private ReportSet.Builder currentReportBuilder;
    private ReportBuffer.Observer observer;


    private ReportBuffer(ReportManager parent, String id) {
<span class="fc" id="L49">        super(parent, id);</span>
<span class="fc" id="L50">        currentReportBuilder = ReportSet.builder();</span>
<span class="fc" id="L51">    }</span>

    public static ReportBuffer create(ReportManager parent, String id) {
<span class="fc" id="L54">        ReportBuffer buffer = new ReportBuffer(parent, id);</span>
<span class="fc" id="L55">        return buffer;</span>
    }

    public void addObserver(ReportBuffer.Observer observer) {
<span class="nc" id="L59">        this.observer = observer;</span>
<span class="nc" id="L60">    }</span>

    public void removeObserver() {
<span class="nc" id="L63">        this.observer = null;</span>
<span class="nc" id="L64">    }</span>

    /**
     * Returns a list of all messages (of the past)
     * @return list of messages
     */
    public ImmutableList&lt;String&gt; getAsList() {
<span class="fc" id="L71">        ImmutableList.Builder&lt;String&gt; list = ImmutableList.builder();</span>
<span class="fc bfc" id="L72" title="All 2 branches covered.">        for (ReportSet rs:pastReports) {</span>
<span class="fc" id="L73">            list.addAll(rs.getAsList());</span>
<span class="fc" id="L74">        }</span>
<span class="fc" id="L75">        return list.build();</span>
    }

    private String getAsHtml(ChangeSet currentChangeSet) {

        // FIXME (Rails2.0): Add comments back
        //     s.append(&quot;&lt;span style='color:green;font-size:80%;font-style:italic;'&gt;&quot;);

<span class="nc" id="L83">        StringBuilder s = new StringBuilder();</span>
<span class="nc" id="L84">        s.append(&quot;&lt;html&gt;&quot;);</span>
<span class="nc bnc" id="L85" title="All 2 branches missed.">        for (ReportSet rs:Iterables.concat(pastReports, futureReports)) {</span>
<span class="nc" id="L86">            String text = rs.getAsHtml(currentChangeSet);</span>
<span class="nc bnc" id="L87" title="All 2 branches missed.">            if (text == null) continue;</span>
<span class="nc" id="L88">            s.append(&quot;&lt;p&gt;&quot;);</span>
<span class="nc" id="L89">            s.append(text);</span>
<span class="nc" id="L90">            s.append(&quot;&lt;/p&gt;&quot;);</span>
<span class="nc" id="L91">        }</span>
<span class="nc" id="L92">        s.append(&quot;&lt;/html&gt;&quot;);</span>

<span class="nc" id="L94">        return s.toString();</span>
    }

    /**
     * Returns all messages for the recent active player
     * @return full text
     */
    // FIXME (Rails2.0): Add implementation for this
    public String getRecentPlayer() {
<span class="nc" id="L103">        return null;</span>
    }

    public String getCurrentText() {
<span class="nc" id="L107">        return getAsHtml(changeStack.getClosedChangeSet());</span>
    }

    private void addMessage(String message) {
<span class="fc bfc" id="L111" title="All 2 branches covered.">        if (!Util.hasValue(message)) return;</span>
<span class="fc" id="L112">        currentReportBuilder.addMessage(message);</span>
<span class="fc" id="L113">        log.debug(&quot;ReportBuffer: {}&quot;, message);</span>
<span class="fc" id="L114">    }</span>

    private void updateObserver() {
<span class="pc bpc" id="L117" title="1 of 2 branches missed.">        if (observer != null) {</span>
<span class="nc" id="L118">            observer.update(getCurrentText());</span>
        }
<span class="fc" id="L120">    }</span>

    // ChangeReport methods
    @Override
    public void init(ChangeStack changeStack) {
<span class="fc" id="L125">        this.changeStack = changeStack;</span>
<span class="fc" id="L126">    }</span>

    @Override
    public void updateOnClose() {
<span class="fc" id="L130">        ChangeSet current = changeStack.getClosedChangeSet();</span>
<span class="fc" id="L131">        ReportSet currentSet = currentReportBuilder.build(current);</span>
<span class="fc" id="L132">        pastReports.addLast(currentSet);</span>
<span class="fc" id="L133">        futureReports.clear();</span>

        // a new builder
<span class="fc" id="L136">        currentReportBuilder = ReportSet.builder();</span>

        // update observer (ReportWindow)
<span class="fc" id="L139">        updateObserver();</span>
<span class="fc" id="L140">    }</span>

    @Override
    public void informOnUndo() {
<span class="nc" id="L144">        ReportSet undoSet = pastReports.pollLast();</span>
<span class="nc" id="L145">        futureReports.addFirst(undoSet);</span>
<span class="nc" id="L146">    }</span>

    @Override
    public void informOnRedo() {
<span class="nc" id="L150">        ReportSet redoSet = futureReports.pollFirst();</span>
<span class="nc" id="L151">        pastReports.addLast(redoSet);</span>
<span class="nc" id="L152">    }</span>

    @Override
    public void updateAfterUndoRedo() {
<span class="nc" id="L156">        updateObserver();</span>
<span class="nc" id="L157">    }</span>

    /**
     * Shortcut to add a message to DisplayBuffer
     */
    public static void add(RailsItem item, String message) {
<span class="fc" id="L163">        item.getRoot().getReportManager().getReportBuffer().addMessage(message);</span>
<span class="fc" id="L164">    }</span>

    // FIXME: Rails 2.0 Is it possible to remove the only usecase for 1856 escrow money?
    @Deprecated
    public static void addWaiting (RailsItem item, String message) {
<span class="nc" id="L169">        item.getRoot().getReportManager().getReportBuffer().waitQueue.add(message);</span>
<span class="nc" id="L170">    }</span>

    @Deprecated
    public static void getAllWaiting (RailsItem item) {
<span class="fc" id="L174">        ReportBuffer reportBuffer = item.getRoot().getReportManager().getReportBuffer();</span>
<span class="pc bpc" id="L175" title="1 of 2 branches missed.">        for (String message : reportBuffer.waitQueue) {</span>
<span class="nc" id="L176">            reportBuffer.addMessage(message);</span>
<span class="nc" id="L177">        }</span>
<span class="fc" id="L178">        reportBuffer.waitQueue.clear();</span>
<span class="fc" id="L179">    }</span>

    public static interface Observer {

        void append(String text);

        void update(String newText);

    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>