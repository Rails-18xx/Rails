<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ConvertTilesXML.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.tools</a> &gt; <span class="el_source">ConvertTilesXML.java</span></div><h1>ConvertTilesXML.java</h1><pre class="source lang-java linenums">package net.sf.rails.tools;

import java.io.File;
import java.io.FileOutputStream;
import java.util.*;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import javax.xml.parsers.DocumentBuilder;
import javax.xml.parsers.DocumentBuilderFactory;
import javax.xml.transform.OutputKeys;
import javax.xml.transform.Transformer;
import javax.xml.transform.TransformerFactory;
import javax.xml.transform.dom.DOMSource;
import javax.xml.transform.stream.StreamResult;

import net.sf.rails.common.parser.ConfigurationException;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.util.Util;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.w3c.dom.*;


/**
 * Convert an XML tile dictionary, as created by Marco Rocci's Tile Designer, to
 * an XML file for use in Rails 18xx. &lt;p&gt; The default names are:
 */
public class ConvertTilesXML {
<span class="nc" id="L31">    private static final Logger log = LoggerFactory.getLogger(ConvertTilesXML.class);</span>

<span class="nc" id="L33">    private static String inputFilePath = &quot;src/main/resources/tiles/TileDictionary.xml&quot;;</span>

<span class="nc" id="L35">    private static String outputFilePath = &quot;src/main/resources/tiles/Tiles.xml&quot;;</span>

    private static final Map&lt;String, String&gt; colourMap;
    private static final Map&lt;String, String&gt; gaugeMap;
    private static final Map&lt;String, String&gt; sidesMap;
    private static final Map&lt;String, String&gt; cityMap;
    private static final Map&lt;String, String[]&gt; stationMap;
    private static Map&lt;String, String&gt; junctionPosition;

    /** Maps non-edge non-station junctions to tracks ending there. */
    private static Map&lt;String, List&lt;Element&gt;&gt; unresolvedTrack;
    /** Maps tracks to edge/station junctions */
    private static Map&lt;Element, String&gt; resolvedTrack;

<span class="nc" id="L49">    private static final Pattern namePattern = Pattern.compile(&quot;^(\\d+)(/.*)?&quot;);</span>

    private final Document outputDoc;
    private Element outputJunction;
    private String colour;

    static {
<span class="nc" id="L56">        colourMap = new HashMap&lt;&gt;();</span>
<span class="nc" id="L57">        colourMap.put(&quot;tlYellow&quot;, &quot;yellow&quot;);</span>
<span class="nc" id="L58">        colourMap.put(&quot;tlGreen&quot;, &quot;green&quot;);</span>
<span class="nc" id="L59">        colourMap.put(&quot;tlBrown&quot;, &quot;brown&quot;);</span>
<span class="nc" id="L60">        colourMap.put(&quot;tlGray&quot;, &quot;gray&quot;);</span>
<span class="nc" id="L61">        colourMap.put(&quot;tlOffMap&quot;, &quot;red&quot;);</span>
<span class="nc" id="L62">        colourMap.put(&quot;tlMapFixed&quot;, &quot;fixed&quot;);</span>
<span class="nc" id="L63">        colourMap.put(&quot;tlMapUpgradableToYellow&quot;, &quot;white&quot;);</span>
<span class="nc" id="L64">        colourMap.put(&quot;tlMapUpgradableToGreen&quot;, &quot;yellow&quot;);</span>
<span class="nc" id="L65">        colourMap.put(&quot;tlMapUpgradableToBrown&quot;, &quot;green&quot;);</span>
<span class="nc" id="L66">        colourMap.put(&quot;tlMapUpgradableToGray&quot;, &quot;brown&quot;);</span>

<span class="nc" id="L68">        stationMap = new HashMap&lt;String, String[]&gt;();</span>
<span class="nc" id="L69">        stationMap.put(&quot;jtWhistlestop&quot;, new String[] { &quot;Town&quot;, &quot;0&quot; });</span>
<span class="nc" id="L70">        stationMap.put(&quot;jtCity&quot;, new String[] { &quot;City&quot;, &quot;1&quot; });</span>
<span class="nc" id="L71">        stationMap.put(&quot;jtDoubleCity&quot;, new String[] { &quot;City&quot;, &quot;2&quot; });</span>
<span class="nc" id="L72">        stationMap.put(&quot;jtTripleCity&quot;, new String[] { &quot;City&quot;, &quot;3&quot; });</span>
<span class="nc" id="L73">        stationMap.put(&quot;jtQuadrupleCity&quot;, new String[] { &quot;City&quot;, &quot;4&quot; });</span>
<span class="nc" id="L74">        stationMap.put(&quot;jtHextupleCity&quot;, new String[] { &quot;City&quot;, &quot;6&quot; });</span>
<span class="nc" id="L75">        stationMap.put(&quot;jtNone&quot;, new String[] { &quot;&quot;, &quot;0&quot; });</span>
        // Note: an additional station type is &quot;Pass&quot;.

<span class="nc" id="L78">        gaugeMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L79">        gaugeMap.put(&quot;ctNormal&quot;, &quot;normal&quot;);</span>
<span class="nc" id="L80">        gaugeMap.put(&quot;ctSmall&quot;, &quot;narrow&quot;);</span>
<span class="nc" id="L81">        gaugeMap.put(&quot;ctUniversal&quot;, &quot;dual&quot;);</span>
<span class="nc" id="L82">        gaugeMap.put(&quot;ctTunnel&quot;, &quot;normal&quot;);</span>
<span class="nc" id="L83">        gaugeMap.put(&quot;ctMountain&quot;, &quot;normal&quot;);</span>
        // 1841 Pass: Station type is changed to Pass.

<span class="nc" id="L86">        sidesMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L87">        sidesMap.put(&quot;tp4SideA&quot;, &quot;side0&quot;);</span>
<span class="nc" id="L88">        sidesMap.put(&quot;tp4SideB&quot;, &quot;side1&quot;);</span>
<span class="nc" id="L89">        sidesMap.put(&quot;tp4SideC&quot;, &quot;side2&quot;);</span>
<span class="nc" id="L90">        sidesMap.put(&quot;tp4SideD&quot;, &quot;side3&quot;);</span>
<span class="nc" id="L91">        sidesMap.put(&quot;tp4SideE&quot;, &quot;side4&quot;);</span>
<span class="nc" id="L92">        sidesMap.put(&quot;tp4SideF&quot;, &quot;side5&quot;);</span>

<span class="nc" id="L94">        cityMap = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L95">        cityMap.put(&quot;tpCenter&quot;, &quot;0&quot;);</span>
<span class="nc" id="L96">        cityMap.put(&quot;tp1SideA&quot;, &quot;001&quot;);</span>
<span class="nc" id="L97">        cityMap.put(&quot;tp1CornerB&quot;, &quot;051&quot;);</span>
<span class="nc" id="L98">        cityMap.put(&quot;tp1SideB&quot;, &quot;101&quot;);</span>
<span class="nc" id="L99">        cityMap.put(&quot;tp1CornerC&quot;, &quot;151&quot;);</span>
<span class="nc" id="L100">        cityMap.put(&quot;tp1SideC&quot;, &quot;201&quot;);</span>
<span class="nc" id="L101">        cityMap.put(&quot;tp1CornerD&quot;, &quot;251&quot;);</span>
<span class="nc" id="L102">        cityMap.put(&quot;tp1SideD&quot;, &quot;301&quot;);</span>
<span class="nc" id="L103">        cityMap.put(&quot;tp1CornerE&quot;, &quot;351&quot;);</span>
<span class="nc" id="L104">        cityMap.put(&quot;tp1SideE&quot;, &quot;401&quot;);</span>
<span class="nc" id="L105">        cityMap.put(&quot;tp1CornerF&quot;, &quot;451&quot;);</span>
<span class="nc" id="L106">        cityMap.put(&quot;tp1SideF&quot;, &quot;501&quot;);</span>
<span class="nc" id="L107">        cityMap.put(&quot;tp1CornerA&quot;, &quot;551&quot;);</span>
<span class="nc" id="L108">        cityMap.put(&quot;tp2SideA&quot;, &quot;002&quot;);</span>
<span class="nc" id="L109">        cityMap.put(&quot;tp2CornerB&quot;, &quot;052&quot;);</span>
<span class="nc" id="L110">        cityMap.put(&quot;tp2SideB&quot;, &quot;102&quot;);</span>
<span class="nc" id="L111">        cityMap.put(&quot;tp2CornerC&quot;, &quot;152&quot;);</span>
<span class="nc" id="L112">        cityMap.put(&quot;tp2SideC&quot;, &quot;202&quot;);</span>
<span class="nc" id="L113">        cityMap.put(&quot;tp2CornerD&quot;, &quot;252&quot;);</span>
<span class="nc" id="L114">        cityMap.put(&quot;tp2SideD&quot;, &quot;302&quot;);</span>
<span class="nc" id="L115">        cityMap.put(&quot;tp2CornerE&quot;, &quot;352&quot;);</span>
<span class="nc" id="L116">        cityMap.put(&quot;tp2SideE&quot;, &quot;402&quot;);</span>
<span class="nc" id="L117">        cityMap.put(&quot;tp2CornerF&quot;, &quot;452&quot;);</span>
<span class="nc" id="L118">        cityMap.put(&quot;tp2SideF&quot;, &quot;502&quot;);</span>
<span class="nc" id="L119">        cityMap.put(&quot;tp2CornerA&quot;, &quot;552&quot;);</span>
<span class="nc" id="L120">        cityMap.put(&quot;tp3SideA&quot;, &quot;003&quot;);</span>
<span class="nc" id="L121">        cityMap.put(&quot;tp3CornerB&quot;, &quot;053&quot;);</span>
<span class="nc" id="L122">        cityMap.put(&quot;tp3SideB&quot;, &quot;103&quot;);</span>
<span class="nc" id="L123">        cityMap.put(&quot;tp3CornerC&quot;, &quot;153&quot;);</span>
<span class="nc" id="L124">        cityMap.put(&quot;tp3SideC&quot;, &quot;203&quot;);</span>
<span class="nc" id="L125">        cityMap.put(&quot;tp3CornerD&quot;, &quot;253&quot;);</span>
<span class="nc" id="L126">        cityMap.put(&quot;tp3SideD&quot;, &quot;303&quot;);</span>
<span class="nc" id="L127">        cityMap.put(&quot;tp3CornerE&quot;, &quot;353&quot;);</span>
<span class="nc" id="L128">        cityMap.put(&quot;tp3SideE&quot;, &quot;403&quot;);</span>
<span class="nc" id="L129">        cityMap.put(&quot;tp3CornerF&quot;, &quot;453&quot;);</span>
<span class="nc" id="L130">        cityMap.put(&quot;tp3SideF&quot;, &quot;503&quot;);</span>
<span class="nc" id="L131">        cityMap.put(&quot;tp3CornerA&quot;, &quot;553&quot;);</span>
<span class="nc" id="L132">        cityMap.put(&quot;tpCurve1RightA&quot;, &quot;006&quot;);</span>
<span class="nc" id="L133">        cityMap.put(&quot;tpCurve2RightA&quot;, &quot;007&quot;);</span>
<span class="nc" id="L134">        cityMap.put(&quot;tpCurve2LeftA&quot;, &quot;008&quot;);</span>
<span class="nc" id="L135">        cityMap.put(&quot;tpCurve1LeftA&quot;, &quot;009&quot;);</span>
<span class="nc" id="L136">        cityMap.put(&quot;tpCurve1RightB&quot;, &quot;106&quot;);</span>
<span class="nc" id="L137">        cityMap.put(&quot;tpCurve2RightB&quot;, &quot;107&quot;);</span>
<span class="nc" id="L138">        cityMap.put(&quot;tpCurve2LeftB&quot;, &quot;108&quot;);</span>
<span class="nc" id="L139">        cityMap.put(&quot;tpCurve1LeftB&quot;, &quot;109&quot;);</span>
<span class="nc" id="L140">        cityMap.put(&quot;tpCurve1RightC&quot;, &quot;206&quot;);</span>
<span class="nc" id="L141">        cityMap.put(&quot;tpCurve2RightC&quot;, &quot;207&quot;);</span>
<span class="nc" id="L142">        cityMap.put(&quot;tpCurve2LeftC&quot;, &quot;208&quot;);</span>
<span class="nc" id="L143">        cityMap.put(&quot;tpCurve1LeftC&quot;, &quot;209&quot;);</span>
<span class="nc" id="L144">        cityMap.put(&quot;tpCurve1RightD&quot;, &quot;306&quot;);</span>
<span class="nc" id="L145">        cityMap.put(&quot;tpCurve2RightD&quot;, &quot;307&quot;);</span>
<span class="nc" id="L146">        cityMap.put(&quot;tpCurve2LeftD&quot;, &quot;308&quot;);</span>
<span class="nc" id="L147">        cityMap.put(&quot;tpCurve1LeftD&quot;, &quot;309&quot;);</span>
<span class="nc" id="L148">        cityMap.put(&quot;tpCurve1RightE&quot;, &quot;406&quot;);</span>
<span class="nc" id="L149">        cityMap.put(&quot;tpCurve2RightE&quot;, &quot;407&quot;);</span>
<span class="nc" id="L150">        cityMap.put(&quot;tpCurve2LeftE&quot;, &quot;408&quot;);</span>
<span class="nc" id="L151">        cityMap.put(&quot;tpCurve1LeftE&quot;, &quot;409&quot;);</span>
<span class="nc" id="L152">        cityMap.put(&quot;tpCurve1RightF&quot;, &quot;506&quot;);</span>
<span class="nc" id="L153">        cityMap.put(&quot;tpCurve2RightF&quot;, &quot;507&quot;);</span>
<span class="nc" id="L154">        cityMap.put(&quot;tpCurve2LeftF&quot;, &quot;508&quot;);</span>
<span class="nc" id="L155">        cityMap.put(&quot;tpCurve1LeftF&quot;, &quot;509&quot;);</span>
<span class="nc" id="L156">    }</span>

    public static void main(String[] args) {
<span class="nc bnc" id="L159" title="All 2 branches missed.">        if (args != null) {</span>
<span class="nc bnc" id="L160" title="All 2 branches missed.">            if (args.length &gt; 0) inputFilePath = args[0];</span>
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (args.length &gt; 1) outputFilePath = args[1];</span>
        }

        try {
<span class="nc" id="L165">            new ConvertTilesXML();</span>
<span class="nc" id="L166">        } catch (ConfigurationException e) {</span>
<span class="nc" id="L167">            log.warn(&quot;caught exception&quot;, e);</span>
<span class="nc" id="L168">        }</span>
<span class="nc" id="L169">    }</span>

<span class="nc" id="L171">    private ConvertTilesXML() throws ConfigurationException {</span>

<span class="nc" id="L173">        log.warn(&quot;Input file path: {}&quot;, new File(inputFilePath).getAbsolutePath());</span>
<span class="nc" id="L174">        log.warn(&quot;Output file path: {}&quot;, new File(outputFilePath).getAbsolutePath());</span>
<span class="nc" id="L175">        Element inputTopElement =</span>
<span class="nc" id="L176">            XmlUtils.findElementInFile(inputFilePath, &quot;tiles&quot;);</span>

        try {
            DocumentBuilderFactory factory =
<span class="nc" id="L180">                DocumentBuilderFactory.newInstance();</span>
<span class="nc" id="L181">            DocumentBuilder builder = factory.newDocumentBuilder();</span>
<span class="nc" id="L182">            DOMImplementation impl = builder.getDOMImplementation();</span>
<span class="nc" id="L183">            outputDoc = impl.createDocument(null, &quot;Tiles&quot;, null);</span>

<span class="nc" id="L185">            convertXML(inputTopElement, outputDoc);</span>

<span class="nc" id="L187">            TransformerFactory transformerFactory = TransformerFactory.newInstance();</span>
<span class="nc" id="L188">            transformerFactory.setAttribute(&quot;indent-number&quot;, 5);</span>
<span class="nc" id="L189">            Transformer transformer = transformerFactory.newTransformer();</span>
<span class="nc" id="L190">            transformer.setOutputProperty(OutputKeys.INDENT, &quot;yes&quot;);</span>
<span class="nc" id="L191">            transformer.transform(new DOMSource(outputDoc),</span>
                    new StreamResult(new FileOutputStream(new File(outputFilePath))));

<span class="nc" id="L194">        } catch (Exception e) {</span>
<span class="nc" id="L195">            throw new ConfigurationException(&quot;Document build error&quot;, e);</span>
<span class="nc" id="L196">        }</span>

<span class="nc" id="L198">    }</span>

    private void convertXML(Element inputElement, Document outputDoc)
    throws ConfigurationException {

<span class="nc" id="L203">        NodeList children = inputElement.getElementsByTagName(&quot;tile&quot;);</span>
<span class="nc bnc" id="L204" title="All 2 branches missed.">        for (int i = 0; i &lt; children.getLength(); i++) {</span>
<span class="nc" id="L205">            Element inputTile = (Element) children.item(i);</span>
<span class="nc" id="L206">            Element outputTile = outputDoc.createElement(&quot;Tile&quot;);</span>
<span class="nc" id="L207">            outputDoc.getDocumentElement().appendChild(outputTile);</span>
<span class="nc" id="L208">            convertTile(inputTile, outputTile);</span>
        }

<span class="nc" id="L211">    }</span>

    private void convertTile(Element inputTile, Element outputTile)
    throws ConfigurationException {

<span class="nc" id="L216">        String id =</span>
<span class="nc" id="L217">            inputTile.getElementsByTagName(&quot;ID&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L218">        log.debug(&quot;id: {}&quot;, id);</span>
<span class="nc" id="L219">        outputTile.setAttribute(&quot;id&quot;, id);</span>
        // int intId;
        try {
<span class="nc" id="L222">            Integer.parseInt(id);</span>
<span class="nc" id="L223">        } catch (NumberFormatException e) {</span>
<span class="nc" id="L224">            throw new ConfigurationException(&quot;Non-numeric ID: &quot; + id, e);</span>
<span class="nc" id="L225">        }</span>

<span class="nc" id="L227">        String level =</span>
<span class="nc" id="L228">            inputTile.getElementsByTagName(&quot;level&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L229">        colour = colourMap.get(level);</span>
<span class="nc bnc" id="L230" title="All 2 branches missed.">        if (colour == null) {</span>
<span class="nc" id="L231">            throw new ConfigurationException(&quot;Unknown level: &quot; + level);</span>
        } else {
<span class="nc" id="L233">            outputTile.setAttribute(&quot;colour&quot;, colour);</span>
        }

<span class="nc" id="L236">        String name =</span>
<span class="nc" id="L237">            inputTile.getElementsByTagName(&quot;name&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L238">        Matcher m = namePattern.matcher(name);</span>
<span class="nc bnc" id="L239" title="All 2 branches missed.">        if (m.matches()) {</span>
<span class="nc" id="L240">            outputTile.setAttribute(&quot;name&quot;, m.group(1));</span>
        } else
<span class="nc" id="L242">            outputTile.setAttribute(&quot;name&quot;, name);</span>
        // The below does not work for &quot;B+&quot;
        /*
         * if (intId &gt; 0) { throw new ConfigurationException(&quot;Tile with ID=&quot; +
         * id + &quot; has a name not starting with a number: &quot; + name); }
         */

        /*
         * Create map to hold the station 'identifiers', which are referred to
         * in the track definitions.
         */
<span class="nc" id="L253">        junctionPosition = new HashMap&lt;String, String&gt;();</span>
<span class="nc" id="L254">        outputJunction = null;</span>

<span class="nc" id="L256">        Element junctions =</span>
<span class="nc" id="L257">            (Element) inputTile.getElementsByTagName(&quot;junctions&quot;).item(0);</span>
<span class="nc" id="L258">        NodeList children = junctions.getElementsByTagName(&quot;junction&quot;);</span>
<span class="nc bnc" id="L259" title="All 2 branches missed.">        for (int i = 0; i &lt; children.getLength(); i++) {</span>
<span class="nc" id="L260">            Element inputJunction = (Element) children.item(i);</span>
<span class="nc" id="L261">            outputJunction = outputDoc.createElement(&quot;Station&quot;);</span>
<span class="nc" id="L262">            outputTile.appendChild(outputJunction);</span>

<span class="nc" id="L264">            convertJunction(i, inputJunction, outputJunction);</span>
        }

<span class="nc" id="L267">        unresolvedTrack = new HashMap&lt;&gt;();</span>
<span class="nc" id="L268">        resolvedTrack = new HashMap&lt;&gt;();</span>

<span class="nc" id="L270">        Element connections =</span>
<span class="nc" id="L271">            (Element) inputTile.getElementsByTagName(&quot;connections&quot;).item(0);</span>
<span class="nc" id="L272">        children = connections.getElementsByTagName(&quot;connection&quot;);</span>
<span class="nc bnc" id="L273" title="All 2 branches missed.">        for (int i = 0; i &lt; children.getLength(); i++) {</span>
<span class="nc" id="L274">            Element inputConnection = (Element) children.item(i);</span>
<span class="nc" id="L275">            convertConnection(inputConnection, outputTile);</span>
        }

        // Iterator it = unresolvedTrack.keySet().iterator();
        String end1, end2;
        // while (it.hasNext())
<span class="nc bnc" id="L281" title="All 2 branches missed.">        for (String key : unresolvedTrack.keySet()) {</span>
            // String key = (String) it.next();
<span class="nc" id="L283">            List&lt;Element&gt; list = unresolvedTrack.get(key);</span>
<span class="nc" id="L284">            Element[] ends = list.toArray(new Element[0]);</span>
<span class="nc bnc" id="L285" title="All 2 branches missed.">            if (ends.length &lt;= 1) {</span>
<span class="nc" id="L286">                throw new ConfigurationException(&quot;Loose end &quot; + ends[0]</span>
                        + &quot; in tile &quot; + id);
            }
<span class="nc bnc" id="L289" title="All 2 branches missed.">            for (int i = 1; i &lt; ends.length; i++) {</span>
<span class="nc" id="L290">                end1 = resolvedTrack.get(ends[i]);</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                if (end1 == null) {</span>
<span class="nc" id="L292">                    throw new ConfigurationException(&quot;Loose end &quot; + ends[i]</span>
                                                                         + &quot; in tile &quot; + id);
                }
<span class="nc bnc" id="L295" title="All 2 branches missed.">                for (int j = 0; j &lt; i; j++) {</span>
<span class="nc" id="L296">                    end2 = resolvedTrack.get(ends[j]);</span>
<span class="nc bnc" id="L297" title="All 2 branches missed.">                    if (end2 == null) {</span>
<span class="nc" id="L298">                        throw new ConfigurationException(&quot;Loose end &quot; + ends[j]</span>
                                                                             + &quot; in tile &quot; + id);
                    }
<span class="nc" id="L301">                    Element outputConnection = outputDoc.createElement(&quot;Track&quot;);</span>
<span class="nc" id="L302">                    outputConnection.setAttribute(&quot;gauge&quot;,</span>
<span class="nc" id="L303">                            ends[i].getAttribute(&quot;gauge&quot;));</span>
<span class="nc" id="L304">                    outputConnection.setAttribute(&quot;from&quot;, end1);</span>
<span class="nc" id="L305">                    outputConnection.setAttribute(&quot;to&quot;, end2);</span>
<span class="nc" id="L306">                    outputTile.appendChild(outputConnection);</span>

                }
            }
<span class="nc" id="L310">        }</span>
<span class="nc" id="L311">    }</span>

    private void convertJunction(int i, Element inputJunction,
            Element outputJunction) throws ConfigurationException {

<span class="nc" id="L316">        String cityId = &quot;city&quot; + (i + 1);</span>
<span class="nc" id="L317">        outputJunction.setAttribute(&quot;id&quot;, cityId);</span>

<span class="nc" id="L319">        String type =</span>
<span class="nc" id="L320">            inputJunction.getElementsByTagName(&quot;junType&quot;).item(0).getFirstChild().getNodeValue();</span>

<span class="nc" id="L322">        String[] station = stationMap.get(type);</span>
<span class="nc bnc" id="L323" title="All 2 branches missed.">        if (station == null) {</span>
<span class="nc" id="L324">            throw new ConfigurationException(&quot;Unknown junction type: &quot; + type);</span>
        } else {
<span class="nc" id="L326">            station = station.clone();</span>
        }

        /*
         * Off-map cities have the special type &quot;OffMapCity&quot; which does not
         * allow driving through. Original type &quot;town&quot; indicates that no token
         * can be placed.
         */
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (colour.equals(&quot;red&quot;)) {</span>
<span class="nc bnc" id="L335" title="All 2 branches missed.">            if (station[0].equals(&quot;Town&quot;)) station[1] = &quot;0&quot;;</span>
<span class="nc" id="L336">            station[0] = &quot;OffMapCity&quot;;</span>
        }

<span class="nc" id="L339">        outputJunction.setAttribute(&quot;type&quot;, station[0]);</span>
<span class="nc bnc" id="L340" title="All 2 branches missed.">        if (!station[1].equals(&quot;0&quot;)) {</span>
<span class="nc" id="L341">            outputJunction.setAttribute(&quot;slots&quot;, station[1]);</span>
        }

        // Junction revenue
<span class="nc" id="L345">        Element revenue =</span>
<span class="nc" id="L346">            (Element) inputJunction.getElementsByTagName(&quot;revenue&quot;).item(0);</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">        if (revenue != null) {</span>
<span class="nc" id="L348">            String value =</span>
<span class="nc" id="L349">                revenue.getElementsByTagName(&quot;value&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L350">            outputJunction.setAttribute(&quot;value&quot;, value);</span>
        }

        // Junction position
<span class="nc" id="L354">        String junctionPos =</span>
<span class="nc" id="L355">            inputJunction.getElementsByTagName(&quot;position&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L356">        junctionPosition.put(junctionPos, cityId);</span>
<span class="nc" id="L357">        String jName = cityMap.get(junctionPos);</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">        if (Util.hasValue(jName)) {</span>
<span class="nc" id="L359">            outputJunction.setAttribute(&quot;position&quot;, jName);</span>
        } else {
<span class="nc" id="L361">            throw new ConfigurationException(&quot;Unknown position: &quot; + junctionPos);</span>
        }
<span class="nc" id="L363">    }</span>

    private void convertConnection(Element inputConnection, Element outputTile)
    throws ConfigurationException {

<span class="nc" id="L368">        String type =</span>
<span class="nc" id="L369">            inputConnection.getElementsByTagName(&quot;conType&quot;).item(0).getFirstChild().getNodeValue();</span>
<span class="nc" id="L370">        String gauge = gaugeMap.get(type);</span>
        Element outputConnection;
<span class="nc bnc" id="L372" title="All 2 branches missed.">        if (gauge == null) {</span>
<span class="nc" id="L373">            throw new ConfigurationException(&quot;Unknown gauge type: &quot; + type);</span>
        } else {
<span class="nc" id="L375">            outputConnection = outputDoc.createElement(&quot;Track&quot;);</span>
<span class="nc" id="L376">            outputConnection.setAttribute(&quot;gauge&quot;, gauge);</span>
        }

        // 1841 special: A pass is not a track type but a station type.
<span class="nc bnc" id="L380" title="All 2 branches missed.">        if (type.equals(&quot;ctMountain&quot;))</span>
<span class="nc" id="L381">            outputJunction.setAttribute(&quot;type&quot;, &quot;pass&quot;);</span>

<span class="nc" id="L383">        boolean fromOK =</span>
<span class="nc" id="L384">            convertTrackEnd(inputConnection, outputConnection, &quot;position1&quot;,</span>
            &quot;from&quot;);
<span class="nc" id="L386">        boolean toOK =</span>
<span class="nc" id="L387">            convertTrackEnd(inputConnection, outputConnection, &quot;position2&quot;,</span>
            &quot;to&quot;);

<span class="nc bnc" id="L390" title="All 4 branches missed.">        if (fromOK &amp;&amp; toOK) outputTile.appendChild(outputConnection);</span>

<span class="nc" id="L392">    }</span>

    private boolean convertTrackEnd(Element inputConnection,
            Element outputConnection, String inputName, String outputName)
    throws ConfigurationException {

<span class="nc" id="L398">        String position =</span>
<span class="nc" id="L399">            inputConnection.getElementsByTagName(inputName).item(0).getFirstChild().getNodeValue();</span>

<span class="nc" id="L401">        String end = sidesMap.get(position);</span>
<span class="nc bnc" id="L402" title="All 2 branches missed.">        if (end == null) end = junctionPosition.get(position);</span>
<span class="nc bnc" id="L403" title="All 2 branches missed.">        if (end != null) {</span>
<span class="nc" id="L404">            outputConnection.setAttribute(outputName, end);</span>
<span class="nc" id="L405">            resolvedTrack.put(outputConnection, end);</span>
<span class="nc" id="L406">            return true;</span>
        } else {
<span class="nc bnc" id="L408" title="All 2 branches missed.">            if (!unresolvedTrack.containsKey(position)) {</span>
<span class="nc" id="L409">                unresolvedTrack.put(position, new ArrayList&lt;Element&gt;());</span>
            }
<span class="nc" id="L411">            unresolvedTrack.get(position).add(outputConnection);</span>
<span class="nc" id="L412">            return false;</span>
        }
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>