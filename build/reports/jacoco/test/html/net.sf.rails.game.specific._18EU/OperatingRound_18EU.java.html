<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OperatingRound_18EU.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._18EU</a> &gt; <span class="el_source">OperatingRound_18EU.java</span></div><h1>OperatingRound_18EU.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.specific._18EU;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Set;

import rails.game.action.BuyTrain;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.*;
import net.sf.rails.game.model.PortfolioModel;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Owner;


/**
 * Implements a basic Operating Round. &lt;p&gt; A new instance must be created for
 * each new Operating Round. At the end of a round, the current instance should
 * be discarded. &lt;p&gt; Permanent memory is formed by static attributes.
 */
public class OperatingRound_18EU extends OperatingRound {

    protected final TrainCertificateType pullmannType;

<span class="fc" id="L26">    protected final BooleanState hasPullmannAtStart = BooleanState.create(this, &quot;ORCompanyHasPullmannAtStart&quot;);</span>

    /**
     * Constructed via Configure
     */
    public OperatingRound_18EU (GameManager parent, String id) {
<span class="fc" id="L32">        super(parent, id);</span>
<span class="fc" id="L33">        pullmannType = trainManager.getCertTypeByName(&quot;P&quot;);</span>
<span class="fc" id="L34">    }</span>
    
    @Override
    protected void initTurn() {
<span class="fc" id="L38">        super.initTurn();</span>
<span class="fc" id="L39">        hasPullmannAtStart.set(operatingCompany.value().getPortfolioModel()</span>
<span class="fc bfc" id="L40" title="All 2 branches covered.">                .getTrainOfType(pullmannType) != null);</span>
<span class="fc" id="L41">    }</span>

    /**
     * Modify possibleActions to follow the Pullmann train trading rules.
     */
    @Override
    public void setBuyableTrains() {

<span class="pc bpc" id="L49" title="1 of 2 branches missed.">        if (operatingCompany.value() == null) return;</span>

<span class="fc" id="L51">        int cash = operatingCompany.value().getCash();</span>

        int cost;
        Set&lt;Train&gt; trains;
        BuyTrain bt;

<span class="fc" id="L57">        boolean hasTrains =</span>
<span class="fc bfc" id="L58" title="All 2 branches covered.">                operatingCompany.value().getPortfolioModel().getNumberOfTrains() &gt; 0;</span>

        // Cannot buy a train without any cash, unless you have to
<span class="pc bpc" id="L61" title="1 of 4 branches missed.">        if (cash == 0 &amp;&amp; hasTrains) return;</span>

<span class="fc" id="L63">        boolean canBuyTrainNow = canBuyTrainNow();</span>
<span class="fc bfc" id="L64" title="All 2 branches covered.">        if (!canBuyTrainNow) return;</span>

<span class="fc" id="L66">        boolean presidentMayHelp = operatingCompany.value().mustOwnATrain();</span>
<span class="fc" id="L67">        Train cheapestTrain = null;</span>
<span class="fc" id="L68">        int costOfCheapestTrain = 0;</span>

<span class="fc" id="L70">        String extraMessage = null;</span>
<span class="fc bfc" id="L71" title="All 2 branches covered.">        boolean mustExchangePullmann = !isBelowTrainLimit()</span>
<span class="pc bpc" id="L72" title="1 of 2 branches missed.">                &amp;&amp; hasPullmannAtStart.value()</span>
<span class="pc bpc" id="L73" title="1 of 2 branches missed.">                &amp;&amp; !possibleActions.contains(BuyTrain.class);</span>
<span class="fc bfc" id="L74" title="All 2 branches covered.">        if (mustExchangePullmann) {</span>
<span class="fc" id="L75">            extraMessage = LocalText.getText(&quot;AutodiscardTrain&quot;,</span>
<span class="fc" id="L76">                    pullmannType.toText());</span>
        }
         /* New trains */
<span class="fc" id="L79">        trains = trainManager.getAvailableNewTrains();</span>
<span class="fc bfc" id="L80" title="All 2 branches covered.">        for (Train train : trains) {</span>
<span class="fc" id="L81">            cost = train.getCost();</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">            if (cost &lt;= cash) {</span>
<span class="pc bpc" id="L83" title="1 of 2 branches missed.">                if (canBuyTrainNow) {</span>
<span class="fc" id="L84">                    bt = new BuyTrain(train, ipo.getParent(), cost);</span>
<span class="fc bfc" id="L85" title="All 2 branches covered.">                    if (mustExchangePullmann) bt.setExtraMessage(extraMessage);</span>
<span class="fc" id="L86">                    possibleActions.add(bt);</span>
                }
<span class="pc bpc" id="L88" title="3 of 4 branches missed.">            } else if (costOfCheapestTrain == 0 || cost &lt; costOfCheapestTrain) {</span>
<span class="fc" id="L89">                cheapestTrain = train;</span>
<span class="fc" id="L90">                costOfCheapestTrain = cost;</span>
            }

<span class="fc" id="L93">        }</span>

        /* Used trains */
<span class="fc" id="L96">        trains = pool.getUniqueTrains();</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        for (Train train : trains) {</span>
            // May not buy Pullmann if one is already owned,
            // or if no train is owned at all
<span class="fc bfc" id="L100" title="All 2 branches covered.">            if (train.getCertType() == pullmannType</span>
<span class="fc bfc" id="L101" title="All 4 branches covered.">                    &amp;&amp;(operatingCompany.value().getPortfolioModel().getTrainOfType(pullmannType) != null</span>
                            || !hasTrains)) {
<span class="fc" id="L103">                continue;</span>
            }
<span class="fc" id="L105">            cost = train.getCost();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">            if (cost &lt;= cash) {</span>
<span class="fc" id="L107">                bt = new BuyTrain(train, pool.getParent(), cost);</span>
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">                if (mustExchangePullmann) bt.setExtraMessage(extraMessage);</span>
<span class="fc" id="L109">                possibleActions.add(bt);</span>
<span class="pc bpc" id="L110" title="2 of 4 branches missed.">            } else if (costOfCheapestTrain == 0 || cost &lt; costOfCheapestTrain) {</span>
<span class="fc" id="L111">                cheapestTrain = train;</span>
<span class="fc" id="L112">                costOfCheapestTrain = cost;</span>
            }
<span class="fc" id="L114">        }</span>
<span class="fc bfc" id="L115" title="All 4 branches covered.">        if (!hasTrains &amp;&amp; presidentMayHelp</span>
<span class="pc bpc" id="L116" title="1 of 4 branches missed.">                &amp;&amp; possibleActions.getType(BuyTrain.class).isEmpty()</span>
                &amp;&amp; cheapestTrain != null) {
<span class="fc" id="L118">            bt = new BuyTrain(cheapestTrain, cheapestTrain.getOwner(), costOfCheapestTrain);</span>
<span class="fc" id="L119">            bt.setPresidentMustAddCash(costOfCheapestTrain - cash);</span>
<span class="pc bpc" id="L120" title="1 of 2 branches missed.">            if (mustExchangePullmann) bt.setExtraMessage(extraMessage);</span>
<span class="fc" id="L121">            possibleActions.add(bt);</span>
        }

        /* Other company trains, sorted by president (current player first) */
<span class="pc bpc" id="L125" title="1 of 2 branches missed.">        if (Phase.getCurrent(this).isTrainTradingAllowed()) {</span>
            Player p;
            PortfolioModel pf;
            int index;
<span class="fc" id="L129">            int numberOfPlayers = playerManager.getNumberOfPlayers();</span>

            // Set up a list per player of presided companies
<span class="fc" id="L132">            List&lt;List&lt;PublicCompany&gt;&gt; companiesPerPlayer =</span>
                    new ArrayList&lt;List&lt;PublicCompany&gt;&gt;(numberOfPlayers);
<span class="fc bfc" id="L134" title="All 2 branches covered.">            for (int i = 0; i &lt; numberOfPlayers; i++)</span>
<span class="fc" id="L135">                companiesPerPlayer.add(new ArrayList&lt;PublicCompany&gt;(4));</span>
            List&lt;PublicCompany&gt; companies;
            // Sort out which players preside over wich companies.
<span class="fc bfc" id="L138" title="All 2 branches covered.">            for (PublicCompany c : operatingCompanies.view()) {</span>
<span class="pc bpc" id="L139" title="1 of 4 branches missed.">                if (c == operatingCompany.value() || c.isClosed()) continue;</span>
<span class="fc" id="L140">                p = c.getPresident();</span>
<span class="fc" id="L141">                index = p.getIndex();</span>
<span class="fc" id="L142">                companiesPerPlayer.get(index).add(c);</span>
<span class="fc" id="L143">            }</span>
            // Scan trains per company per player, operating company president
            // first
<span class="fc" id="L146">            int currentPlayerIndex = operatingCompany.value().getPresident().getIndex();</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">            for (int i = currentPlayerIndex; i &lt; currentPlayerIndex</span>
<span class="fc" id="L148">                                                 + numberOfPlayers; i++) {</span>
<span class="fc" id="L149">                companies = companiesPerPlayer.get(i % numberOfPlayers);</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">                for (PublicCompany company : companies) {</span>
<span class="fc" id="L151">                    pf = company.getPortfolioModel();</span>
<span class="fc" id="L152">                    trains = pf.getUniqueTrains();</span>

<span class="fc bfc" id="L154" title="All 2 branches covered.">                    for (Train train : trains) {</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">                        if (train.getCertType() == pullmannType) continue;</span>
<span class="fc" id="L156">                        bt = new BuyTrain(train, pf.getParent(), 0);</span>
<span class="fc bfc" id="L157" title="All 2 branches covered.">                        if (mustExchangePullmann) bt.setExtraMessage(extraMessage);</span>
<span class="fc" id="L158">                        possibleActions.add(bt);</span>
<span class="fc" id="L159">                    }</span>
<span class="fc" id="L160">                }</span>
            }
        }

<span class="fc" id="L164">    }</span>

    /** In 18EU, a company can (effectively) exchange a Pullmann */
    @Override
    protected boolean canBuyTrainNow() {
<span class="fc bfc" id="L169" title="All 4 branches covered.">        return super.canBuyTrainNow() || hasPullmann ()</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">               &amp;&amp; hasPullmannAtStart.value();</span>
    }

    @Override
    public boolean buyTrain(BuyTrain action) {

<span class="pc bpc" id="L176" title="1 of 4 branches missed.">        boolean mustDiscardPullmann = !super.isBelowTrainLimit() &amp;&amp; hasPullmann ();</span>

<span class="fc" id="L178">        boolean result = super.buyTrain(action);</span>

        // If we are at train limit and have a Pullmann, discard it
<span class="fc bfc" id="L181" title="All 2 branches covered.">        if (mustDiscardPullmann) {</span>
<span class="fc" id="L182">            Train pullmann = operatingCompany.value().getPortfolioModel().getTrainOfType(pullmannType);</span>
<span class="pc bpc" id="L183" title="1 of 2 branches missed.">            if (pullmann != null) {  // must be non-null</span>
<span class="fc" id="L184">                pullmann.discard();</span>
            }
        }

        // If train was bought from another company, check for a lone Pullmann
<span class="fc" id="L189">        Owner seller = action.getFromOwner();</span>
<span class="fc bfc" id="L190" title="All 2 branches covered.">        if (seller instanceof PublicCompany</span>
<span class="pc bpc" id="L191" title="1 of 2 branches missed.">                &amp;&amp; !(action.getTrain().getCertType() == pullmannType)) {</span>
<span class="fc" id="L192">            boolean hasPullmann = false;</span>
<span class="fc" id="L193">            boolean hasNonPullmann = false;</span>
<span class="fc" id="L194">            Train pullmann = null;</span>
<span class="fc bfc" id="L195" title="All 2 branches covered.">            for (Train sellerTrain : ((PublicCompany)seller).getPortfolioModel().getTrainList()) {</span>
<span class="pc bpc" id="L196" title="1 of 2 branches missed.">                if (sellerTrain.getCertType() == pullmannType) {</span>
<span class="nc" id="L197">                    hasPullmann = true;</span>
<span class="nc" id="L198">                    pullmann = sellerTrain;</span>
<span class="pc bpc" id="L199" title="1 of 2 branches missed.">                } else if (sellerTrain != null){</span>
<span class="fc" id="L200">                    hasNonPullmann = true;</span>
                }
<span class="fc" id="L202">            }</span>
<span class="pc bpc" id="L203" title="3 of 4 branches missed.">            if (hasPullmann &amp;&amp; !hasNonPullmann) {</span>
<span class="nc" id="L204">                pullmann.discard();</span>
            }
        }

        // Check if we have just started Phase 5 and
        // if we still have at least one Minor operating.
        // If so, record the current player as the first
        // one to act in the Final Minor Exchange Round.
<span class="pc bpc" id="L212" title="1 of 4 branches missed.">        if (result &amp;&amp; getRoot().getPhaseManager().hasReachedPhase(&quot;5&quot;)</span>
<span class="fc bfc" id="L213" title="All 2 branches covered.">            &amp;&amp; operatingCompanies.get(0).getType().getId().equalsIgnoreCase(&quot;Minor&quot;)</span>
<span class="fc bfc" id="L214" title="All 2 branches covered.">            &amp;&amp; ((GameManager_18EU)gameManager).getPlayerToStartFMERound() == null) {</span>
<span class="fc" id="L215">            ((GameManager_18EU)gameManager).setPlayerToStartFMERound(operatingCompany.value().getPresident());</span>
        }

<span class="fc" id="L218">        return result;</span>

    }

    /** Special rules for Pullmann trains */
    @Override
    public boolean checkForExcessTrains() {

<span class="fc" id="L226">        excessTrainCompanies = new HashMap&lt;Player, List&lt;PublicCompany&gt;&gt;();</span>
        Player player;
        Train pullmann;
        PortfolioModel portfolio;
        int numberOfTrains;

<span class="fc bfc" id="L232" title="All 2 branches covered.">        for (PublicCompany comp : operatingCompanies.view()) {</span>
<span class="fc" id="L233">            portfolio = comp.getPortfolioModel();</span>
<span class="fc" id="L234">            numberOfTrains = portfolio.getNumberOfTrains();</span>

            // Check if the company has a Pullmann
<span class="fc" id="L237">            pullmann = portfolio.getTrainOfType(pullmannType);</span>

            // A Pullmann always goes first, and automatically.
            // If the last train is a Pullmann, discard it.
<span class="pc bpc" id="L241" title="1 of 6 branches missed.">            if ((numberOfTrains &gt; comp.getCurrentTrainLimit() || numberOfTrains == 1)</span>
                &amp;&amp; pullmann != null) {
<span class="nc" id="L243">                pool.addTrain(pullmann);</span>
<span class="nc" id="L244">                numberOfTrains--;</span>
            }

            // If we are still above the limit, make the list
            // of trains to select the discarded one from
<span class="fc bfc" id="L249" title="All 2 branches covered.">            if (numberOfTrains &gt; comp.getCurrentTrainLimit()) {</span>
<span class="fc" id="L250">                player = comp.getPresident();</span>
<span class="pc bpc" id="L251" title="1 of 2 branches missed.">                if (!excessTrainCompanies.containsKey(player)) {</span>
<span class="fc" id="L252">                    excessTrainCompanies.put(player,</span>
                            new ArrayList&lt;PublicCompany&gt;(2));
                }
<span class="fc" id="L255">                excessTrainCompanies.get(player).add(comp);</span>
            }
<span class="fc" id="L257">        }</span>
<span class="fc bfc" id="L258" title="All 2 branches covered.">        return !excessTrainCompanies.isEmpty();</span>
    }

    private boolean hasPullmann () {
<span class="fc bfc" id="L262" title="All 2 branches covered.">        return operatingCompany.value().getPortfolioModel().getTrainOfType(pullmannType) != null;</span>
    }

    @Override
    public void resume() {
<span class="nc bnc" id="L267" title="All 2 branches missed.">        if (playerManager.getCurrentPlayer().isBankrupt()) {</span>
            // Do not complete the train buying action
<span class="nc" id="L269">            savedAction = null;</span>
<span class="nc" id="L270">            finishTurn();</span>
        }
<span class="nc bnc" id="L272" title="All 2 branches missed.">        if (gameManager.getCurrentRound() == this) {</span>
<span class="nc" id="L273">            super.resume();</span>
        }
<span class="nc" id="L275">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>