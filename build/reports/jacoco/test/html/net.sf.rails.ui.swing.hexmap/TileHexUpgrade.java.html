<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>TileHexUpgrade.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.ui.swing.hexmap</a> &gt; <span class="el_source">TileHexUpgrade.java</span></div><h1>TileHexUpgrade.java</h1><pre class="source lang-java linenums">package net.sf.rails.ui.swing.hexmap;

import com.google.common.base.MoreObjects;
import com.google.common.collect.ComparisonChain;
import com.google.common.collect.ImmutableSet;
import net.sf.rails.common.LocalText;
import net.sf.rails.game.*;
import net.sf.rails.game.special.SpecialTileLay;
import rails.game.action.LayTile;

import java.awt.*;
import java.awt.image.BufferedImage;
import java.util.*;

/**
 * A HexTileUpgrade combines a TileUpgrade with a MapHex and valid Rotations
 */
public class TileHexUpgrade extends HexUpgrade implements Iterable&lt;HexSide&gt; {

<span class="nc" id="L20">    public enum Invalids implements HexUpgrade.Invalids {</span>
<span class="nc" id="L21">        NO_VALID_ORIENTATION, HEX_BLOCKED, HEX_RESERVED, NO_TILES_LEFT,</span>
<span class="nc" id="L22">        NOT_ALLOWED_FOR_HEX, NOT_ALLOWED_FOR_PHASE, COLOUR_NOT_ALLOWED,</span>
<span class="nc" id="L23">        COLOUR_RIGHT_MISSING, NO_ROUTE_TO_NEW_TRACK, NOT_ENOUGH_CASH;</span>

        @Override
        public String toString() {
<span class="nc" id="L27">            return LocalText.getText(&quot;TILE_UPGRADE_INVALID_&quot; + this.name());</span>
        }

    }

    // static fields
    private final TileUpgrade upgrade;
    private final LayTile action;

    // validation fields
    private HexSidesSet rotations;
    private boolean permissiveRoutePossible;
<span class="nc" id="L39">    private final EnumSet&lt;Invalids&gt; invalids = EnumSet.noneOf(Invalids.class);</span>

    // ui fields
    private HexSide selectedRotation;

    private TileHexUpgrade(GUIHex hex, TileUpgrade upgrade, LayTile action) {
<span class="nc" id="L45">        super(hex);</span>
<span class="nc" id="L46">        this.upgrade = upgrade;</span>
<span class="nc" id="L47">        this.action = action;</span>
<span class="nc" id="L48">    }</span>

    public static Set&lt;TileHexUpgrade&gt; create(GUIHex hex, HexSidesSet connected, Collection&lt;Station&gt; stations,
                                             LayTile action, String routeAlgorithm) {

        // use that to define available upgrades
<span class="nc" id="L54">        ImmutableSet.Builder&lt;TileHexUpgrade&gt; upgrades = ImmutableSet.builder();</span>
<span class="nc bnc" id="L55" title="All 2 branches missed.">        for (TileUpgrade upgrade : hex.getHex().getCurrentTile().getTileUpgrades()) {</span>
<span class="nc" id="L56">            TileHexUpgrade hexUpgrade = new TileHexUpgrade(hex, upgrade, action);</span>
<span class="nc bnc" id="L57" title="All 2 branches missed.">            if (routeAlgorithm.equalsIgnoreCase(&quot;PERMISSIVE&quot;)) {</span>
<span class="nc" id="L58">                hexUpgrade.findValidRotations(connected, stations, false);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">            } else if (routeAlgorithm.equalsIgnoreCase(&quot;RESTRICTIVE&quot;)) {</span>
<span class="nc" id="L60">                hexUpgrade.findValidRotations(connected, stations, true);</span>
<span class="nc bnc" id="L61" title="All 2 branches missed.">            } else if (routeAlgorithm.equalsIgnoreCase(&quot;SEMI-RESTRICTIVE&quot;)) {</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">                if (upgrade.getTargetTile().hasStations()) {</span>
<span class="nc" id="L63">                    hexUpgrade.findValidRotations(connected, stations, false);</span>
                } else {
<span class="nc" id="L65">                    hexUpgrade.findValidRotations(connected, stations, true);</span>
                }
            }
<span class="nc" id="L68">            upgrades.add(hexUpgrade);</span>
<span class="nc" id="L69">        }</span>
<span class="nc" id="L70">        return upgrades.build();</span>
    }

    public static Set&lt;TileHexUpgrade&gt; createLocated(GUIHex hex, LayTile action) {
<span class="nc" id="L74">        ImmutableSet.Builder&lt;TileHexUpgrade&gt; upgrades = ImmutableSet.builder();</span>

<span class="nc bnc" id="L76" title="All 4 branches missed.">        if (action.getTiles() == null || action.getTiles().isEmpty()) {</span>
<span class="nc bnc" id="L77" title="All 2 branches missed.">            for (TileUpgrade upgrade : hex.getHex().getCurrentTile().getTileUpgrades()) {</span>
<span class="nc" id="L78">                TileHexUpgrade hexUpgrade = new TileHexUpgrade(hex, upgrade, action);</span>
<span class="nc" id="L79">                hexUpgrade.findValidRotations(null, null, true);</span>
<span class="nc" id="L80">                upgrades.add(hexUpgrade);</span>
<span class="nc" id="L81">            }</span>
        } else {
<span class="nc bnc" id="L83" title="All 2 branches missed.">            for (Tile targetTile : action.getTiles()) {</span>
<span class="nc" id="L84">                TileUpgrade upgrade = hex.getHex().getCurrentTile().getSpecificUpgrade(targetTile);</span>
<span class="nc" id="L85">                TileHexUpgrade hexUpgrade = new TileHexUpgrade(hex, upgrade, action);</span>
<span class="nc" id="L86">                hexUpgrade.findValidRotations(null, null, true);</span>
<span class="nc" id="L87">                upgrades.add(hexUpgrade);</span>
<span class="nc" id="L88">            }</span>
        }
<span class="nc" id="L90">        return upgrades.build();</span>
    }

    public static Set&lt;TileHexUpgrade&gt; createCorrection(GUIHex hex, LayTile action) {
<span class="nc" id="L94">        ImmutableSet.Builder&lt;TileHexUpgrade&gt; upgrades = ImmutableSet.builder();</span>

<span class="nc bnc" id="L96" title="All 2 branches missed.">        for (TileUpgrade upgrade : hex.getHex().getCurrentTile().getTileUpgrades()) {</span>
<span class="nc" id="L97">            TileHexUpgrade hexUpgrade = new TileHexUpgrade(hex, upgrade, action);</span>
<span class="nc" id="L98">            hexUpgrade.findValidRotations(null, null, true);</span>
<span class="nc" id="L99">            upgrades.add(hexUpgrade);</span>
<span class="nc" id="L100">        }</span>
<span class="nc" id="L101">        return upgrades.build();</span>
    }

    private void findValidRotations(HexSidesSet connectedSides, Collection&lt;Station&gt; stations, boolean restrictive) {
<span class="nc" id="L105">        MapHex modelHex = hex.getHex();</span>

        // encode HexSides according to the tile current orientation
<span class="nc bnc" id="L108" title="All 2 branches missed.">        if (connectedSides != null) {</span>
<span class="nc" id="L109">            connectedSides = HexSidesSet.rotated(connectedSides, modelHex.getCurrentTileRotation());</span>
        }
        // check invalid sides
<span class="nc" id="L112">        HexSidesSet invalidSides = null;</span>
<span class="nc bnc" id="L113" title="All 2 branches missed.">        if (modelHex.getInvalidSides() != null) {</span>
<span class="nc" id="L114">            invalidSides = HexSidesSet.rotated(modelHex.getInvalidSides(), modelHex.getCurrentTileRotation());</span>
        }

<span class="nc bnc" id="L117" title="All 2 branches missed.">        if (requiresConnection()) {</span>
<span class="nc" id="L118">            HexSidesSet permissive = upgrade.getAllowedRotations(connectedSides, invalidSides,</span>
<span class="nc" id="L119">                    modelHex.getCurrentTileRotation(), stations, false);</span>
<span class="nc bnc" id="L120" title="All 2 branches missed.">            if (restrictive) {</span>
<span class="nc" id="L121">                rotations = upgrade.getAllowedRotations(connectedSides, invalidSides,</span>
<span class="nc" id="L122">                        modelHex.getCurrentTileRotation(), stations, true);</span>
<span class="nc bnc" id="L123" title="All 2 branches missed.">                permissiveRoutePossible = !permissive.isEmpty();</span>
            } else {
<span class="nc" id="L125">                rotations = permissive;</span>
            }
<span class="nc" id="L127">        } else {</span>
<span class="nc" id="L128">            rotations = upgrade.getAllowedRotations(null, invalidSides,</span>
<span class="nc" id="L129">                    modelHex.getCurrentTileRotation(), stations, restrictive);</span>
        }
        // initialize selected Rotation
<span class="nc" id="L132">        selectedRotation = rotations.getNext(HexSide.defaultRotation());</span>
<span class="nc" id="L133">    }</span>

    private boolean validate(Phase phase) {
<span class="nc" id="L136">        invalids.clear();</span>
        
        /*MBR 25.11.2018
        Check if the action causes this Validation is a Special Tile Lay
        If that is the case the current support special action modifications need to be 
        excluded from the validation:
        As of the time of this writing, the following actions are supported.
        A private blocking hex might be unblocked by laying a tile
        The tilelay might be free of cost, or carry a discount
        Future Powers consist of Tile lays in a different Colour than the current Phase (1822)
        */
<span class="nc bnc" id="L147" title="All 2 branches missed.">        if (action.getType()== action.SPECIAL_PROPERTY) {</span>
            
<span class="nc" id="L149">            SpecialTileLay sp = (SpecialTileLay)action.getSpecialProperty();</span>
<span class="nc bnc" id="L150" title="All 2 branches missed.">            if (!sp.isFree()) {</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">                if (notEnoughCash(0)) {</span>
<span class="nc" id="L152">                    invalids.add(Invalids.NOT_ENOUGH_CASH);</span>
                }
            }
<span class="nc bnc" id="L155" title="All 2 branches missed.">            if (!(action.getSpecialProperty().getLocations().contains(hex.getHex()))) {</span>
<span class="nc bnc" id="L156" title="All 2 branches missed.">                if (hexIsBlocked()) {</span>
<span class="nc" id="L157">                    invalids.add(Invalids.HEX_BLOCKED);</span>
                }
<span class="nc bnc" id="L159" title="All 2 branches missed.">                if (hexIsReserved()) {</span>
<span class="nc" id="L160">                    invalids.add(Invalids.HEX_RESERVED);</span>
                }    
            }
<span class="nc" id="L163">        } else {</span>
<span class="nc bnc" id="L164" title="All 2 branches missed.">            if (hexIsBlocked()) {</span>
<span class="nc" id="L165">                invalids.add(Invalids.HEX_BLOCKED);</span>
            }
<span class="nc bnc" id="L167" title="All 2 branches missed.">            if (hexIsReserved()) {</span>
<span class="nc" id="L168">                invalids.add(Invalids.HEX_RESERVED);</span>
            }
<span class="nc bnc" id="L170" title="All 2 branches missed.">            if (notEnoughCash(0)) {</span>
<span class="nc" id="L171">                invalids.add(Invalids.NOT_ENOUGH_CASH);</span>
            }
        }
<span class="nc bnc" id="L174" title="All 2 branches missed.">        if (noTileAvailable()) {</span>
<span class="nc" id="L175">            invalids.add(Invalids.NO_TILES_LEFT);</span>
        }
      //TODO: Add 1822 Private Powers to remove a small station with a private power
<span class="nc bnc" id="L178" title="All 2 branches missed.">        if (notAllowedForHex()) {</span>
<span class="nc" id="L179">            invalids.add(Invalids.NOT_ALLOWED_FOR_HEX);</span>
        }
        //TODO: Add 1822 Private Powers to upgrade a Tile one phase ahead
<span class="nc bnc" id="L182" title="All 2 branches missed.">        if (notAllowedForPhase(phase)) {</span>
<span class="nc" id="L183">            invalids.add(Invalids.NOT_ALLOWED_FOR_PHASE);</span>
        }
<span class="nc bnc" id="L185" title="All 2 branches missed.">        if (tileColourNotAllowed(phase)) {</span>
<span class="nc" id="L186">            invalids.add(Invalids.COLOUR_NOT_ALLOWED);</span>
        }
<span class="nc bnc" id="L188" title="All 2 branches missed.">        if (tileColourRightMissing()) {</span>
<span class="nc" id="L189">            invalids.add(Invalids.COLOUR_RIGHT_MISSING);</span>
        }
<span class="nc bnc" id="L191" title="All 2 branches missed.">        if (noRouteToNewTrack()) {</span>
<span class="nc" id="L192">            invalids.add(Invalids.NO_ROUTE_TO_NEW_TRACK);</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        } else if (noValidRotation()) {</span>
<span class="nc" id="L194">            invalids.add(Invalids.NO_VALID_ORIENTATION);</span>
        }
 
<span class="nc" id="L197">        return invalids.isEmpty();</span>
    }

    public boolean noValidRotation() {
<span class="nc" id="L201">        return rotations.isEmpty();</span>
    }

    public boolean hexIsBlocked() {
<span class="nc" id="L205">        return hex.getHex().isBlockedByPrivateCompany();</span>
    }

    public boolean hexIsReserved() {
<span class="nc bnc" id="L209" title="All 4 branches missed.">        if ( hex.getHex().isReservedForCompany() &amp;&amp; hex.getHex().getReservedForCompany() != action.getCompany()) {</span>
            //check that the hex has not been upgraded already...
<span class="nc bnc" id="L211" title="All 2 branches missed.">            if (hex.getHex().isPreprintedTileCurrent()) {</span>
<span class="nc" id="L212">            return true;</span>
            }
        }
<span class="nc" id="L215">        return false;</span>
        
    }

    public boolean noTileAvailable() {
<span class="nc bnc" id="L220" title="All 2 branches missed.">        return upgrade.getTargetTile().getFreeCount() == 0;</span>
    }

    public boolean notAllowedForHex() {
<span class="nc bnc" id="L224" title="All 2 branches missed.">        return !upgrade.isAllowedForHex(hex.getHex());</span>
    }

    public boolean notAllowedForPhase(Phase phase) {
<span class="nc bnc" id="L228" title="All 2 branches missed.">        return !upgrade.isAllowedForPhase(phase);</span>
    }

    public boolean tileColourNotAllowed(Phase phase) {
<span class="nc bnc" id="L232" title="All 2 branches missed.">        return !phase.isTileColourAllowed(upgrade.getTargetTile().getColourText());</span>
    }

    public boolean tileColourRightMissing() {
<span class="nc bnc" id="L236" title="All 2 branches missed.">        if (action.getTileColours() == null) {</span>
<span class="nc" id="L237">            return false;</span>
        }
<span class="nc" id="L239">        Integer tileLays = action.getTileColours().get(upgrade.getTargetTile().getColourText());</span>
<span class="nc bnc" id="L240" title="All 4 branches missed.">        return (tileLays == null || tileLays == 0);</span>
    }

    public boolean noRouteToNewTrack() {
<span class="nc bnc" id="L244" title="All 4 branches missed.">        return noValidRotation() &amp;&amp; permissiveRoutePossible;</span>
    }

    public boolean notEnoughCash() {
        // correction action does not require cash 
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (action.getType() == LayTile.CORRECTION) {</span>
<span class="nc" id="L250">            return false;</span>
        }
<span class="nc bnc" id="L252" title="All 2 branches missed.">        return action.getCompany().getCash() &lt; this.getCost();</span>
    }
   
    public boolean notEnoughCash(int discount) {
        // correction action does not require cash 
<span class="nc bnc" id="L257" title="All 2 branches missed.">        if (action.getType() == LayTile.CORRECTION) {</span>
<span class="nc" id="L258">            return false;</span>
        }
<span class="nc bnc" id="L260" title="All 2 branches missed.">        return action.getCompany().getCash() &lt; (this.getCost()-discount); </span>
    }
    
    public boolean requiresConnection() {
        // Yellow Tile on Company Home
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (upgrade.getTargetTile().getColourText().equalsIgnoreCase(TileColour.YELLOW.name())</span>
<span class="nc bnc" id="L266" title="All 2 branches missed.">                &amp;&amp; hex.getHex().isHomeFor(action.getCompany())) {</span>
<span class="nc" id="L267">            return false;</span>
            // Special Property with specified hexes and require connection
            // TODO: Do we require the second test
<span class="nc bnc" id="L270" title="All 2 branches missed.">        } else if (action.getType() == LayTile.SPECIAL_PROPERTY</span>
<span class="nc bnc" id="L271" title="All 2 branches missed.">                &amp;&amp; action.getSpecialProperty().getLocations().contains(hex)) {</span>
<span class="nc" id="L272">            return action.getSpecialProperty().requiresConnection();</span>
        }
<span class="nc" id="L274">        return true;</span>

    }

    public LayTile getAction() {
<span class="nc" id="L279">        return action;</span>
    }

    /**
     * @return the upgrade
     */
    public TileUpgrade getUpgrade() {
<span class="nc" id="L286">        return upgrade;</span>
    }

    /**
     * @return the rotations
     */
    public HexSidesSet getRotations() {
<span class="nc" id="L293">        return rotations;</span>
    }

    public HexSide getCurrentRotation() {
<span class="nc" id="L297">        return selectedRotation;</span>
    }

    public Iterator&lt;HexSide&gt; iterator() {
<span class="nc" id="L301">        return rotations.iterator();</span>
    }

    // HexUpgrade interface method

    @Override
    public boolean hasSingleSelection() {
<span class="nc" id="L308">        return rotations.onlySingle();</span>
    }

    @Override
    public void firstSelection() {
<span class="nc" id="L313">        selectedRotation = rotations.getNext(HexSide.defaultRotation());</span>
<span class="nc" id="L314">    }</span>

    @Override
    public void nextSelection() {
<span class="nc" id="L318">        selectedRotation = rotations.getNext(selectedRotation.next());</span>
<span class="nc" id="L319">    }</span>

    @Override
    public Set&lt;HexUpgrade.Invalids&gt; getInvalids() {
<span class="nc" id="L323">        return ImmutableSet.&lt;HexUpgrade.Invalids&gt;copyOf(invalids);</span>
    }

    @Override
    public boolean isValid() {
<span class="nc" id="L328">        return invalids.isEmpty();</span>
    }

    @Override
    public int getCost() {
<span class="nc" id="L333">        return action.getPotentialCost(hex.getHex());</span>
    }

    @Override
    public Image getUpgradeImage(int zoomStep) {
        HexSide imageRotation;
<span class="nc bnc" id="L339" title="All 2 branches missed.">        if (selectedRotation == null) {</span>
<span class="nc" id="L340">            imageRotation = HexSide.defaultRotation();</span>
        } else {
<span class="nc" id="L342">            imageRotation = selectedRotation;</span>
        }

        // get unscaled image for this orientation
<span class="nc" id="L346">        BufferedImage hexImage = GUITile.getTileImage(upgrade.getTargetTile(), imageRotation, zoomStep);</span>

<span class="nc" id="L348">        return hexImage;</span>
    }

    @Override
    public String getUpgradeText() {
<span class="nc" id="L353">        Tile tile = upgrade.getTargetTile();</span>

<span class="nc" id="L355">        StringBuilder text = new StringBuilder();</span>
<span class="nc" id="L356">        text.append(&quot;&lt;HTML&gt;&quot; + tile.toText());</span>
<span class="nc bnc" id="L357" title="All 2 branches missed.">        if (!tile.isUnlimited()) {</span>
            // line break before # of available tiles
<span class="nc" id="L359">            text.append(&quot;&lt;BR&gt;&quot;);</span>
<span class="nc" id="L360">            text.append(&quot; (&quot; + tile.getFreeCount() + &quot;)&quot;);</span>
        }
        // text for special property
<span class="nc bnc" id="L363" title="All 2 branches missed.">        if (action.getSpecialProperty() != null) {</span>
<span class="nc" id="L364">            text.append(</span>
                    &quot;&lt;BR&gt; &lt;font color=red&gt; [&quot;
<span class="nc" id="L366">                            + action.getSpecialProperty().getOriginalCompany().getId()</span>
                            + &quot;] &lt;/font&gt;&quot;);
        }
<span class="nc" id="L369">        text.append(&quot;&lt;/HTML&gt;&quot;);</span>
<span class="nc" id="L370">        return text.toString();</span>
    }

    @Override
    public String getUpgradeToolTip() {

<span class="nc" id="L376">        StringBuilder tt = new StringBuilder(&quot;&lt;html&gt;&quot;);</span>

<span class="nc bnc" id="L378" title="All 2 branches missed.">        if (!isValid()) {</span>
<span class="nc" id="L379">            tt.append(invalidToolTip());</span>
        }

<span class="nc" id="L382">        Tile tile = upgrade.getTargetTile();</span>
<span class="nc" id="L383">        tt.append(&quot;&lt;b&gt;Tile&lt;/b&gt;: &quot;).append(tile.toText());</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">        if (tile.hasStations()) {</span>
<span class="nc" id="L385">            int cityNumber = 0;</span>
            // Tile has stations, but
<span class="nc bnc" id="L387" title="All 2 branches missed.">            for (Station st : tile.getStations()) {</span>
<span class="nc" id="L388">                cityNumber++; // = city.getNumber();</span>
<span class="nc" id="L389">                tt.append(&quot;&lt;br&gt;  &quot;).append(st.toText()).append(</span>
                        cityNumber) // .append(&quot;/&quot;).append(st.getNumber())
<span class="nc" id="L391">                        .append(&quot;: value &quot;);</span>
<span class="nc" id="L392">                tt.append(st.getValue());</span>
<span class="nc bnc" id="L393" title="All 2 branches missed.">                if (st.getBaseSlots() &gt; 0) {</span>
<span class="nc" id="L394">                    tt.append(&quot;, &quot;).append(st.getBaseSlots()).append(</span>
                            &quot; slots&quot;);
                }
<span class="nc" id="L397">            }</span>
        }
<span class="nc" id="L399">        tt.append(&quot;&lt;/html&gt;&quot;);</span>
<span class="nc" id="L400">        return tt.toString();</span>
    }

    private String invalidToolTip() {
<span class="nc" id="L404">        StringBuilder tt = new StringBuilder();</span>

<span class="nc" id="L406">        tt.append(&quot;&lt;b&gt;&lt;u&gt;&quot;);</span>
<span class="nc" id="L407">        tt.append(LocalText.getText(&quot;TILE_UPGRADE_TT_INVALID&quot;));</span>
<span class="nc" id="L408">        tt.append(&quot;&lt;/u&gt;&lt;/b&gt;&lt;br&gt;&quot;);</span>

<span class="nc" id="L410">        tt.append(&quot;&lt;b&gt;&quot;);</span>
<span class="nc bnc" id="L411" title="All 2 branches missed.">        for (Invalids invalid : invalids) {</span>
<span class="nc" id="L412">            tt.append(invalid.toString() + &quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L413">        }</span>
<span class="nc" id="L414">        tt.append(&quot;&lt;/b&gt;&quot;);</span>

<span class="nc" id="L416">        return tt.toString();</span>
    }

    @Override
    public int getCompareId() {
<span class="nc" id="L421">        return 2;</span>
    }

    @Override
    public Comparator&lt;HexUpgrade&gt; getComparator() {
<span class="nc" id="L426">        return new Comparator&lt;HexUpgrade&gt;() {</span>
            @Override
            public int compare(HexUpgrade u1, HexUpgrade u2) {
<span class="nc bnc" id="L429" title="All 4 branches missed.">                if (u1 instanceof TileHexUpgrade &amp;&amp; u2 instanceof TileHexUpgrade) {</span>
<span class="nc" id="L430">                    TileHexUpgrade tu1 = (TileHexUpgrade) u1;</span>
<span class="nc" id="L431">                    TileHexUpgrade tu2 = (TileHexUpgrade) u2;</span>
<span class="nc" id="L432">                    return ComparisonChain.start()</span>
<span class="nc" id="L433">                            .compare(tu1.getAction(), tu2.getAction())</span>
<span class="nc" id="L434">                            .compare(tu1.getUpgrade().getTargetTile(), tu2.getUpgrade().getTargetTile())</span>
<span class="nc" id="L435">                            .compare(tu1.getHex().getHex().getId(), tu2.getHex().getHex().getId())</span>
<span class="nc" id="L436">                            .result()</span>
                            ;
                }
<span class="nc" id="L439">                return 0;</span>
            }
        };
    }

    @Override
    public String toString() {
<span class="nc" id="L446">        return MoreObjects.toStringHelper(this)</span>
<span class="nc" id="L447">                .add(&quot;Hex&quot;, hex.toString())</span>
<span class="nc" id="L448">                .add(&quot;Upgrade&quot;, upgrade)</span>
<span class="nc" id="L449">                .add(&quot;rotations&quot;, rotations)</span>
<span class="nc" id="L450">                .toString();</span>
    }

    /**
     * sets both validation and visibility for upgrades
     */
    public static void validates(Iterable&lt;TileHexUpgrade&gt; upgrades, Phase current) {
<span class="nc bnc" id="L457" title="All 2 branches missed.">        for (TileHexUpgrade upgrade : upgrades) {</span>
<span class="nc bnc" id="L458" title="All 2 branches missed.">            if (upgrade.validate(current)) {</span>
<span class="nc" id="L459">                upgrade.setVisible(true);</span>
<span class="nc bnc" id="L460" title="All 2 branches missed.">            } else if (upgrade.tileColourNotAllowed(current)) {</span>
<span class="nc" id="L461">                upgrade.setVisible(false);</span>
            } else {
<span class="nc" id="L463">                upgrade.setVisible(true);</span>
            }
<span class="nc" id="L465">        }</span>
<span class="nc" id="L466">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>