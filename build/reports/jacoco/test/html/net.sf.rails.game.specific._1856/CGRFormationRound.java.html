<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CGRFormationRound.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.specific._1856</a> &gt; <span class="el_source">CGRFormationRound.java</span></div><h1>CGRFormationRound.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.specific._1856;

import java.util.*;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.common.collect.Lists;

import rails.game.action.*;
import net.sf.rails.common.*;
import net.sf.rails.game.*;
import net.sf.rails.game.financial.Bank;
import net.sf.rails.game.financial.PublicCertificate;
import net.sf.rails.game.financial.StockSpace;
import net.sf.rails.game.special.SellBonusToken;
import net.sf.rails.game.state.ArrayListMultimapState;
import net.sf.rails.game.state.ArrayListState;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Currency;
import net.sf.rails.game.state.GenericState;
import net.sf.rails.game.state.Portfolio;

// Rails 2.0 refactoring

public class CGRFormationRound extends SwitchableUIRound {

<span class="fc" id="L28">    private static final Logger log = LoggerFactory.getLogger(CGRFormationRound.class);</span>

    // static variables
    private final PublicCompany_CGR cgr;

    // initialized in start() method only
    private Player startingPlayer;
<span class="fc" id="L35">    private int maxLoansToRepayByPresident = 0;</span>

    /*
     * effects from the merger, processed at the end
     * thus no need for state variables
     */
<span class="fc" id="L41">    private Set&lt;Train&gt; trainsToDiscardFrom = null;</span>
<span class="fc" id="L42">    private boolean forcedTrainDiscard = true;</span>
<span class="fc" id="L43">    private List&lt;ExchangeableToken&gt; tokensToExchangeFrom = null;</span>

    // dynamic variables
<span class="fc" id="L46">    private final GenericState&lt;Steps&gt; step = GenericState.create(this, &quot;step&quot;);</span>

<span class="fc" id="L48">    private final ArrayListMultimapState&lt;Player, PublicCompany&gt; companiesToRepayLoans = ArrayListMultimapState.create(this, &quot;companiesToRepayLoans&quot;);</span>

<span class="fc" id="L50">    private final GenericState&lt;PublicCompany&gt; currentCompany = GenericState.create(this, &quot;currentCompany&quot;);</span>

<span class="fc" id="L52">    private final ArrayListState&lt;PublicCompany&gt; mergingCompanies = ArrayListState.create(this, &quot;mergingCompanies&quot;);</span>

<span class="fc" id="L54">    private final BooleanState cgrHasDiscardedTrains = BooleanState.create(this, &quot;cgrHasDiscardedTrains&quot;);</span>


    /**
     * Constructed via Configure
     */
    public CGRFormationRound(GameManager parent, String id) {
<span class="fc" id="L61">        super(parent, id);</span>

<span class="fc" id="L63">        guiHints.setVisibilityHint(GuiDef.Panel.MAP, true);</span>
<span class="fc" id="L64">        guiHints.setVisibilityHint(GuiDef.Panel.STATUS, true);</span>

<span class="fc" id="L66">        cgr = (PublicCompany_CGR) getRoot().getCompanyManager().getPublicCompany(PublicCompany_CGR.NAME);</span>
<span class="fc" id="L67">    }</span>

    public void start (Player startingPlayer) {

        // store starting player
<span class="fc" id="L72">        this.startingPlayer = startingPlayer;</span>

<span class="fc" id="L74">        ReportBuffer.add(this, LocalText.getText(&quot;StartFormationRound&quot;,</span>
                PublicCompany_CGR.NAME));
<span class="fc" id="L76">        ReportBuffer.add(this, LocalText.getText(&quot;StartingPlayer&quot;,</span>
<span class="fc" id="L77">                startingPlayer.getId()));</span>

<span class="fc" id="L79">        guiHints.setCurrentRoundType(getClass());</span>

        // Collect companies having loans
<span class="fc bfc" id="L82" title="All 2 branches covered.">        for (PublicCompany company : setOperatingCompanies()) {</span>
<span class="fc bfc" id="L83" title="All 2 branches covered.">            if (company.getCurrentNumberOfLoans() &gt; 0) {</span>
<span class="fc" id="L84">                companiesToRepayLoans.put(company.getPresident(), company);</span>
            }
<span class="fc" id="L86">        }</span>

<span class="pc bpc" id="L88" title="1 of 2 branches missed.">        if (companiesToRepayLoans.isEmpty()) {</span>
<span class="nc" id="L89">            ReportBuffer.add(this, LocalText.getText(&quot;DoesNotForm&quot;, cgr.toText()));</span>
<span class="nc" id="L90">            finishRound();</span>
<span class="nc" id="L91">            return;</span>
        }

<span class="fc" id="L94">        step.set(Steps.STEP_REPAY_LOANS);</span>
<span class="fc" id="L95">        playerManager.setCurrentPlayer(startingPlayer);</span>

<span class="fc" id="L97">        process (null);</span>
<span class="fc" id="L98">    }</span>

    private boolean setNextCompanyNeedingPresidentIntervention () {

        while (true) {

<span class="fc bfc" id="L104" title="All 2 branches covered.">            while (!companiesToRepayLoans.containsKey(playerManager.getCurrentPlayer())) {</span>
<span class="fc" id="L105">                playerManager.setCurrentToNextPlayer();</span>
<span class="fc bfc" id="L106" title="All 2 branches covered.">                if (playerManager.getCurrentPlayer().equals(startingPlayer)) {</span>
<span class="fc" id="L107">                    return false;</span>
                }
            }
            // select player and company to act and remove them from the list
<span class="fc" id="L111">            Player player = playerManager.getCurrentPlayer();</span>
<span class="fc" id="L112">            PublicCompany company = companiesToRepayLoans.get(player).get(0);</span>
<span class="fc" id="L113">            companiesToRepayLoans.remove(player, company);</span>
            // set current company for further actions
<span class="fc" id="L115">            currentCompany.set(company);</span>

<span class="fc" id="L117">            int numberOfLoans = company.getCurrentNumberOfLoans();</span>
<span class="pc bpc" id="L118" title="1 of 2 branches missed.">            if (numberOfLoans == 0) continue;</span>

<span class="fc" id="L120">            int compCash = company.getCash();</span>
<span class="fc" id="L121">            int presCash = player.getCash();</span>
<span class="fc" id="L122">            int valuePerLoan = company.getValuePerLoan();</span>

<span class="fc" id="L124">            String message = LocalText.getText(&quot;CompanyHasLoans&quot;,</span>
<span class="fc" id="L125">                    currentCompany.value().getId(),</span>
<span class="fc" id="L126">                    player.getId(),</span>
<span class="fc" id="L127">                    numberOfLoans,</span>
<span class="fc" id="L128">                    Bank.format(this, valuePerLoan),</span>
<span class="fc" id="L129">                    Bank.format(this, numberOfLoans * valuePerLoan));</span>
<span class="fc" id="L130">            ReportBuffer.add(this, &quot; &quot;);</span>
<span class="fc" id="L131">            DisplayBuffer.add(this, &quot; &quot;, false);</span>
<span class="fc" id="L132">            ReportBuffer.add(this, message);</span>
<span class="fc" id="L133">            DisplayBuffer.add(this, message, false);</span>

            // Let company repay all loans for which it has the cash
<span class="fc" id="L136">            int numberToRepay = Math.min(numberOfLoans,</span>
                    compCash / valuePerLoan);
<span class="fc bfc" id="L138" title="All 2 branches covered.">            if (numberToRepay &gt; 0) {</span>
<span class="fc" id="L139">                int payment = numberToRepay * valuePerLoan;</span>
<span class="fc" id="L140">                String paymentText = Currency.toBank(company, payment);</span>
<span class="fc" id="L141">                company.addLoans(-numberToRepay);</span>

<span class="fc" id="L143">                message = LocalText.getText(&quot;CompanyRepaysLoans&quot;,</span>
<span class="fc" id="L144">                        currentCompany.value().getId(),</span>
                        paymentText,
<span class="fc" id="L146">                        Bank.format(this, numberOfLoans * valuePerLoan),</span>
<span class="fc" id="L147">                        numberToRepay,</span>
<span class="fc" id="L148">                        Bank.format(this, valuePerLoan));</span>
<span class="fc" id="L149">                ReportBuffer.add(this, message);</span>
<span class="fc" id="L150">                DisplayBuffer.add(this, message, false);</span>
            }

            // If that was all, we're done with this company
<span class="fc" id="L154">            numberOfLoans = company.getCurrentNumberOfLoans();</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">            if (numberOfLoans == 0) {</span>
<span class="fc" id="L156">                continue;</span>
            }

            // Check the president's cash
            // He should be involved if at least one extra loan could be repaid
<span class="fc" id="L161">            compCash = company.getCash();</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">            if ((compCash + presCash) / valuePerLoan &gt; 0) {</span>
<span class="fc" id="L163">                int maxNumber = Math.min((compCash + presCash)/valuePerLoan, numberOfLoans);</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">                if (maxNumber == numberOfLoans) {</span>
<span class="fc" id="L165">                    DisplayBuffer.add(this, LocalText.getText(&quot;YouCanRepayAllLoans&quot;,</span>
<span class="fc" id="L166">                            player.getId(),</span>
<span class="fc" id="L167">                            maxNumber,</span>
<span class="fc" id="L168">                            company.getId()),</span>
                            false);
                } else {
<span class="fc" id="L171">                    DisplayBuffer.add(this, LocalText.getText(&quot;YouCannotRepayAllLoans&quot;,</span>
<span class="fc" id="L172">                            player.getId(),</span>
<span class="fc" id="L173">                            maxNumber,</span>
<span class="fc" id="L174">                            numberOfLoans,</span>
<span class="fc" id="L175">                            company.getId()),</span>
                            false);
                    // FIXME: Rails 2.0 adapt LoanValue to be able to store this information
                    //                    currentCompany.getLoanValueModel().setText(LocalText.getText(&quot;MERGE&quot;));
                }
<span class="fc" id="L180">                maxLoansToRepayByPresident = maxNumber;</span>
<span class="fc" id="L181">                break;</span>
            } else {
                // President cannot help, this company will merge into CGR anyway
<span class="fc" id="L184">                mergingCompanies.add(company);</span>
                // FIXME: see above
                // currentCompany.getLoanValueModel().setText(LocalText.getText(&quot;MERGE&quot;));
<span class="fc" id="L187">                message = LocalText.getText(&quot;WillMergeInto&quot;,</span>
<span class="fc" id="L188">                        company.getId(),</span>
                        PublicCompany_CGR.NAME);
<span class="fc" id="L190">                DisplayBuffer.add(this, message, false);</span>
<span class="fc" id="L191">                ReportBuffer.add(this, message);</span>
<span class="fc" id="L192">                continue;</span>
            }
        }
<span class="fc" id="L195">        return true;</span>
    }

    @Override
    public boolean setPossibleActions() {

<span class="fc bfc" id="L201" title="All 2 branches covered.">        if (step.value() == Steps.STEP_REPAY_LOANS) {</span>
<span class="fc" id="L202">            RepayLoans action = new RepayLoans (currentCompany.value(), 0,</span>
                    maxLoansToRepayByPresident,
<span class="fc" id="L204">                    currentCompany.value().getValuePerLoan());</span>
<span class="fc" id="L205">            possibleActions.add(action);</span>
<span class="fc" id="L206">            guiHints.setActivePanel(GuiDef.Panel.STATUS);</span>
<span class="pc bpc" id="L207" title="1 of 2 branches missed.">        } else if (step.value() == Steps.STEP_EXCHANGE_TOKENS) {</span>
<span class="nc" id="L208">            int numberToExchange = cgr.getNumberOfFreeBaseTokens();</span>
<span class="nc" id="L209">            ExchangeTokens action = new ExchangeTokens (tokensToExchangeFrom,</span>
                    numberToExchange, numberToExchange);
<span class="nc" id="L211">            action.setCompany(cgr);</span>
<span class="nc" id="L212">            possibleActions.add(action);</span>
<span class="nc" id="L213">            guiHints.setActivePanel(GuiDef.Panel.STATUS);</span>
<span class="pc bpc" id="L214" title="1 of 2 branches missed.">        } else if (step.value() == Steps.STEP_DISCARD_TRAINS) {</span>
<span class="fc" id="L215">            DiscardTrain action = new DiscardTrain (cgr,</span>
                    trainsToDiscardFrom, forcedTrainDiscard);
<span class="fc" id="L217">            possibleActions.add(action);</span>
<span class="fc" id="L218">            guiHints.setActivePanel(GuiDef.Panel.STATUS);</span>
        }
<span class="fc" id="L220">        return true;</span>

    }

    protected boolean repayLoans (RepayLoans action) {
        // TODO Validation skipped for now...

<span class="fc" id="L227">        PublicCompany company = action.getCompany();</span>
<span class="fc" id="L228">        int numberRepaid = action.getNumberRepaid();</span>
<span class="fc" id="L229">        int repayment = numberRepaid * company.getValuePerLoan();</span>

<span class="fc bfc" id="L231" title="All 2 branches covered.">        if (repayment &gt; 0) {</span>

<span class="fc" id="L233">            int repaymentByCompany = Math.min (repayment, company.getCash());</span>
<span class="fc" id="L234">            int repaymentByPresident = repayment - repaymentByCompany;</span>

<span class="fc" id="L236">            company.addLoans(-numberRepaid);</span>
<span class="pc bpc" id="L237" title="1 of 2 branches missed.">            if (repaymentByCompany &gt; 0) {</span>
<span class="fc" id="L238">                String repayCompanyText = Currency.toBank(company, repaymentByCompany);</span>
<span class="fc" id="L239">                ReportBuffer.add(this, LocalText.getText(&quot;CompanyRepaysLoans&quot;,</span>
<span class="fc" id="L240">                        company.getId(),</span>
                    repayCompanyText,
<span class="fc" id="L242">                        numberRepaid,</span>
<span class="fc" id="L243">                    Bank.format(this, company.getValuePerLoan()))); // TODO: Make this nicer</span>
            }
<span class="pc bpc" id="L245" title="1 of 2 branches missed.">            if (repaymentByPresident &gt; 0) {</span>
<span class="fc" id="L246">                Player president = company.getPresident();</span>
<span class="fc" id="L247">                String repayPresidentText =  Currency.toBank(president, repaymentByPresident);</span>
<span class="fc" id="L248">                ReportBuffer.add(this, LocalText.getText(&quot;CompanyRepaysLoansWithPresCash&quot;,</span>
<span class="fc" id="L249">                        company.getId(),</span>
                        repayPresidentText,
<span class="fc" id="L251">                        Bank.format(this, repayment),</span>
<span class="fc" id="L252">                        numberRepaid,</span>
<span class="fc" id="L253">                        Bank.format(this, company.getValuePerLoan()),</span>
<span class="fc" id="L254">                        president.getId()));</span>
            }
        }

<span class="fc bfc" id="L258" title="All 2 branches covered.">        if (company.getCurrentNumberOfLoans() &gt; 0) {</span>
<span class="fc" id="L259">            mergingCompanies.add(company);</span>
            // FIXME: see above
            //            currentCompany.getLoanValueModel().setText(LocalText.getText(&quot;MERGE&quot;));
<span class="fc" id="L262">            String message = LocalText.getText(&quot;WillMergeInto&quot;,</span>
<span class="fc" id="L263">                    company.getId(),</span>
                    PublicCompany_CGR.NAME);
<span class="fc" id="L265">            DisplayBuffer.add(this, message, true);</span>
<span class="fc" id="L266">            ReportBuffer.add(this, message);</span>

        }

<span class="fc" id="L270">        return true;</span>

    }

    private void formCGR () {
<span class="fc" id="L275">        ReportBuffer.add(this, &quot;&quot;);</span>

<span class="fc" id="L277">        Player temporaryPresident = null;</span>
<span class="fc" id="L278">        Player newPresident = null;</span>
<span class="fc" id="L279">        Player firstCGRowner = null;</span>
<span class="fc" id="L280">        int maxShares = 0;</span>
<span class="fc" id="L281">        int cgrSharesUsed = 0;</span>

        // Exchange the player shares
<span class="fc bfc" id="L284" title="All 2 branches covered.">        for (Player player:playerManager.getNextPlayersAfter(startingPlayer, true, false)) {</span>
<span class="fc" id="L285">            int oldShares = 0, newShares = 0;</span>
<span class="fc" id="L286">            List&lt;PublicCertificate&gt; certs = Lists.newArrayList();</span>
<span class="fc" id="L287">            PublicCertificate poolCert = null;</span>

            // count number of shares for the players in oldShares
<span class="fc" id="L290">            log.debug(player.getPortfolioModel().getCertificates().toString());</span>
<span class="fc bfc" id="L291" title="All 2 branches covered.">            for (PublicCertificate cert : player.getPortfolioModel().getCertificates()) {</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">                if (mergingCompanies.contains(cert.getCompany())) {</span>
<span class="fc" id="L293">                    log.debug(&quot;merge cert= &quot; + cert);</span>
<span class="fc" id="L294">                    certs.add((cert));</span>
<span class="fc" id="L295">                    oldShares++;</span>
<span class="fc bfc" id="L296" title="All 2 branches covered.">                    if (cert.isPresidentShare()) {</span>
<span class="fc" id="L297">                        oldShares++;</span>
                    }
                }
<span class="fc" id="L300">            }</span>

<span class="fc bfc" id="L302" title="All 2 branches covered.">            if (oldShares &gt; 0) {</span>

<span class="fc" id="L304">                int count = oldShares;</span>
                // no president assigned so far, assign president if there are enough oldShares
<span class="pc bpc" id="L306" title="1 of 6 branches missed.">                if (count &gt;= 4 &amp;&amp; temporaryPresident == null &amp;&amp; cgrSharesUsed &lt;= 18) {</span>
<span class="fc" id="L307">                    PublicCertificate cgrCert = cgr.getPresidentsShare();</span>
<span class="fc" id="L308">                    cgrCert.moveTo(player);</span>
<span class="fc" id="L309">                    count -= 4;</span>
<span class="fc" id="L310">                    cgrSharesUsed += 2;</span>
<span class="fc" id="L311">                    newShares += 2;</span>
<span class="fc" id="L312">                    temporaryPresident = player;</span>
                }

                // now convert the remaining shares
<span class="pc bpc" id="L316" title="1 of 4 branches missed.">                while (count &gt;= 2 &amp;&amp; cgrSharesUsed &lt;= 19) {</span>
<span class="fc" id="L317">                    PublicCertificate cgrCert = unavailable.findCertificate(cgr, false);</span>
<span class="fc" id="L318">                    cgrCert.moveTo(player);</span>
<span class="fc" id="L319">                    count -= 2;</span>
<span class="fc" id="L320">                    cgrSharesUsed++;</span>
<span class="fc" id="L321">                    newShares++;</span>
<span class="fc" id="L322">                }</span>

<span class="fc" id="L324">                String message = LocalText.getText(&quot;HasMergedShares&quot;,</span>
<span class="fc" id="L325">                        player.getId(),</span>
<span class="fc" id="L326">                        oldShares,</span>
<span class="fc" id="L327">                        newShares,</span>
                        PublicCompany_CGR.NAME);
<span class="fc" id="L329">                DisplayBuffer.add(this, message, false);</span>
<span class="fc" id="L330">                ReportBuffer.add(this, message);</span>

<span class="fc bfc" id="L332" title="All 2 branches covered.">                if (count == 1) {</span>
                    // Should work OK even if this is a president's share.
                    // In the pool we will treat all certs equally.
<span class="fc" id="L335">                    poolCert = certs.get(certs.size()-1);</span>
<span class="fc" id="L336">                    poolCert.moveTo(pool.getParent());</span>
<span class="fc" id="L337">                    certs.remove(poolCert);</span>

<span class="fc" id="L339">                    message = LocalText.getText(&quot;HasPutShareInPool&quot;,</span>
<span class="fc" id="L340">                            player.getId());</span>
<span class="fc" id="L341">                    DisplayBuffer.add(this, message, false);</span>
<span class="fc" id="L342">                    ReportBuffer.add(this, message);</span>

                }
                // Note: old shares are removed when company is closed

<span class="fc bfc" id="L347" title="All 2 branches covered.">                if (firstCGRowner == null) firstCGRowner = player;</span>

                // Check for presidency
<span class="fc bfc" id="L350" title="All 2 branches covered.">                if (newShares &gt; maxShares) {</span>
<span class="fc" id="L351">                    maxShares = newShares;</span>
<span class="fc" id="L352">                    newPresident = player;</span>
                }
            }
<span class="fc" id="L355">        }</span>

        // Exchange the pool shares
<span class="fc" id="L358">        int oldShares = 0, newShares = 0;</span>
<span class="fc" id="L359">        List&lt;PublicCertificate&gt; certs = Lists.newArrayList();</span>
<span class="fc bfc" id="L360" title="All 2 branches covered.">        for (PublicCertificate cert : pool.getCertificates()) {</span>
<span class="fc bfc" id="L361" title="All 2 branches covered.">            if (mergingCompanies.contains(cert.getCompany())) {</span>
<span class="fc" id="L362">                certs.add((cert));</span>
<span class="fc" id="L363">                oldShares++;</span>
            }
<span class="fc" id="L365">        }</span>
<span class="fc" id="L366">        int count = oldShares;</span>
<span class="fc bfc" id="L367" title="All 4 branches covered.">        while (count &gt;= 2 &amp;&amp; cgrSharesUsed &lt;= 19) {</span>
<span class="fc" id="L368">            PublicCertificate cgrCert = unavailable.findCertificate(cgr, false);</span>
<span class="fc" id="L369">            cgrCert.moveTo(pool.getParent());</span>
<span class="fc" id="L370">            count -= 2;</span>
<span class="fc" id="L371">            cgrSharesUsed++;</span>
<span class="fc" id="L372">            newShares++;</span>
<span class="fc" id="L373">        }</span>

<span class="fc" id="L375">        String message = LocalText.getText(&quot;HasMergedShares&quot;,</span>
<span class="fc" id="L376">                LocalText.getText(&quot;POOL&quot;),</span>
<span class="fc" id="L377">                oldShares,</span>
<span class="fc" id="L378">                newShares,</span>
                PublicCompany_CGR.NAME);
<span class="fc" id="L380">        DisplayBuffer.add(this, message);</span>
<span class="fc" id="L381">        ReportBuffer.add(this, message);</span>

<span class="fc" id="L383">        Portfolio.moveAll(certs, scrapHeap.getParent());</span>
<span class="fc" id="L384">        log.info(cgrSharesUsed+&quot; CGR shares are now in play&quot;);</span>

        // If no more than 10 shares are in play, the CGR share
        // unit becomes 10%; otherwise it stays 5%.
<span class="fc bfc" id="L388" title="All 2 branches covered.">        if (cgrSharesUsed &lt;=10) {</span>
<span class="fc" id="L389">            cgr.setShareUnit (10);</span>
            // All superfluous shares have been removed
        }
<span class="fc" id="L392">        message = LocalText.getText(&quot;CompanyHasShares&quot;,</span>
<span class="fc" id="L393">                cgr.toText(), 100/cgr.getShareUnit(), cgr.getShareUnit());</span>
<span class="fc" id="L394">        DisplayBuffer.add(this, &quot; &quot;);</span>
<span class="fc" id="L395">        ReportBuffer.add(this, &quot; &quot;);</span>
<span class="fc" id="L396">        DisplayBuffer.add(this, message);</span>
<span class="fc" id="L397">        ReportBuffer.add(this, message);</span>

        // Move the remaining CGR shares to the ipo.
<span class="fc" id="L400">        Portfolio.moveAll(unavailable.getCertificates(cgr), ipo.getParent());</span>

        // Assign the new president
<span class="pc bpc" id="L403" title="1 of 2 branches missed.">        if (newPresident.getPortfolioModel().getShare(cgr) == cgr.getShareUnit()) {</span>
            // Nobody has 2 shares, then takes the first player who has got one share
<span class="nc" id="L405">            log.debug(&quot;Nobody has two shares, creating a temp.pres.: &quot;+firstCGRowner.getId());</span>
<span class="nc" id="L406">            cgr.setTemporaryPresident(firstCGRowner);</span>
<span class="nc" id="L407">            newPresident = firstCGRowner;</span>
<span class="pc bpc" id="L408" title="1 of 4 branches missed.">        } else if (temporaryPresident != null &amp;&amp; temporaryPresident != newPresident) {</span>
<span class="fc" id="L409">            log.debug(&quot;Moving pres.share from &quot;+temporaryPresident.getId()</span>
<span class="fc" id="L410">                    +&quot; to &quot;+newPresident.getId());</span>
<span class="fc" id="L411">            temporaryPresident.getPortfolioModel().swapPresidentCertificate(cgr,</span>
<span class="fc" id="L412">                        newPresident.getPortfolioModel(), 1);</span>
        }

        // TODO: What does the following command do? I assume only trigger an update, so I uncommented
        // newPresident.getPortfolio().getShareModel(cgr).setShare();
<span class="fc" id="L417">        message = LocalText.getText(&quot;IS_NOW_PRES_OF&quot;,</span>
<span class="fc" id="L418">                newPresident.getId(), cgr.toText());</span>
<span class="fc" id="L419">        ReportBuffer.add(this, message);</span>
<span class="fc" id="L420">        DisplayBuffer.add(this, message);</span>

        // Determine the CGR starting price,
        // and close the absorbed companies.
<span class="fc" id="L424">        int lowestPrice = 999;</span>
<span class="fc" id="L425">        int totalPrice = 0;</span>
        int price;
<span class="fc" id="L427">        int numberMerged = mergingCompanies.size();</span>
<span class="fc bfc" id="L428" title="All 2 branches covered.">        for (PublicCompany comp : mergingCompanies) {</span>
<span class="fc" id="L429">            price = comp.getMarketPrice();</span>
<span class="fc" id="L430">            totalPrice += price;</span>
<span class="fc bfc" id="L431" title="All 2 branches covered.">            if (price &lt; lowestPrice) lowestPrice = price;</span>
<span class="fc" id="L432">        }</span>
<span class="pc bpc" id="L433" title="1 of 2 branches missed.">        if (numberMerged &gt;= 3) {</span>
<span class="fc" id="L434">            totalPrice -= lowestPrice;</span>
<span class="fc" id="L435">            numberMerged--;</span>
        }
<span class="fc" id="L437">        int cgrPrice = Math.max(100, (((totalPrice/numberMerged)/5))*5);</span>

        // Find the correct start space and start the CGR
<span class="pc bpc" id="L440" title="1 of 2 branches missed.">        if (cgrPrice == 100) {</span>
<span class="fc" id="L441">            cgr.start(100);</span>
        } else {
<span class="nc" id="L443">            int prevColPrice = 100;</span>
            int colPrice;
            StockSpace startSpace;
<span class="nc bnc" id="L446" title="All 2 branches missed.">            for (int col=6; col &lt;= stockMarket.getNumberOfColumns(); col++) {</span>
<span class="nc" id="L447">                colPrice = stockMarket.getStockSpace(0, col).getPrice();</span>
<span class="nc bnc" id="L448" title="All 2 branches missed.">                if (cgrPrice &gt; colPrice) continue;</span>
<span class="nc bnc" id="L449" title="All 2 branches missed.">                if (cgrPrice - prevColPrice &lt; colPrice - cgrPrice) {</span>
<span class="nc" id="L450">                    startSpace = stockMarket.getStockSpace(0, col-1);</span>
                } else {
<span class="nc" id="L452">                    startSpace = stockMarket.getStockSpace(0, col);</span>
                }
<span class="nc" id="L454">                cgr.start(startSpace);</span>
<span class="nc" id="L455">                message = LocalText.getText(&quot;START_MERGED_COMPANY&quot;,</span>
                        PublicCompany_CGR.NAME,
<span class="nc" id="L457">                        Bank.format(this, startSpace.getPrice()),</span>
<span class="nc" id="L458">                        startSpace.getId());</span>
<span class="nc" id="L459">                DisplayBuffer.add(this, message);</span>
<span class="nc" id="L460">                ReportBuffer.add(this, message);</span>
<span class="nc" id="L461">                break;</span>
            }
        }
<span class="fc" id="L464">        cgr.setFloated();</span>
<span class="fc" id="L465">        ReportBuffer.add(this, LocalText.getText(&quot;Floats&quot;, PublicCompany_CGR.NAME));</span>

        // Collect the old token spots, and move cash and trains
<span class="fc" id="L468">        List&lt;BaseToken&gt; homeTokens = new ArrayList&lt;BaseToken&gt;();</span>
<span class="fc" id="L469">        List&lt;BaseToken&gt; nonHomeTokens = new ArrayList&lt;BaseToken&gt;();</span>
        BaseToken bt;
        MapHex hex;
        Stop stop;
<span class="fc bfc" id="L473" title="All 2 branches covered.">        for (PublicCompany comp : mergingCompanies) {</span>

            // Exchange home tokens and collect non-home tokens
<span class="fc" id="L476">            List&lt;MapHex&gt; homeHexes = comp.getHomeHexes();</span>
<span class="fc bfc" id="L477" title="All 2 branches covered.">            for (BaseToken token :comp.getAllBaseTokens()) {</span>
<span class="fc" id="L478">                bt = token;</span>
<span class="fc bfc" id="L479" title="All 2 branches covered.">                if (!bt.isPlaced()) continue;</span>
<span class="fc" id="L480">                stop = (Stop) bt.getOwner();</span>
<span class="fc" id="L481">                hex = stop.getParent();</span>
<span class="pc bpc" id="L482" title="1 of 4 branches missed.">                if (homeHexes != null &amp;&amp; homeHexes.contains(hex)) {</span>
<span class="fc" id="L483">                    homeTokens.add(bt);</span>
                } else {
<span class="fc" id="L485">                    nonHomeTokens.add(bt);</span>
                }
<span class="fc" id="L487">            }</span>

            // Move any remaining cash
<span class="fc bfc" id="L490" title="All 2 branches covered.">            if (comp.getCash() &gt; 0) {</span>
<span class="fc" id="L491">                Currency.wireAll(comp, cgr);</span>
            }

            // Move any remaining trains
<span class="fc" id="L495">            Set&lt;Train&gt; trains = comp.getPortfolioModel().getTrainList();</span>
<span class="fc bfc" id="L496" title="All 2 branches covered.">            for (Train train : trains) {</span>
<span class="fc" id="L497">                cgr.getPortfolioModel().addTrain(train);</span>
<span class="fc bfc" id="L498" title="All 2 branches covered.">                if (train.isPermanent()) cgr.setHadPermanentTrain(true);</span>
<span class="fc" id="L499">            }</span>

            // Move any still valid bonuses
<span class="pc bpc" id="L502" title="1 of 2 branches missed.">            if (comp.getBonuses() != null) {</span>
<span class="fc" id="L503">                List&lt;Bonus&gt; bonuses = new ArrayList&lt;Bonus&gt; (comp.getBonuses());</span>
<span class="fc bfc" id="L504" title="All 2 branches covered.">                bonuses:        for (Bonus bonus : bonuses) {</span>
<span class="fc" id="L505">                    comp.removeBonus(bonus);</span>
                    // Only add if the CGR does not already have the same bonus
<span class="pc bpc" id="L507" title="1 of 2 branches missed.">                    if (cgr.getBonuses() != null) {</span>
<span class="fc bfc" id="L508" title="All 2 branches covered.">                        for (Bonus b : cgr.getBonuses()) {</span>
<span class="fc bfc" id="L509" title="All 2 branches covered.">                            if (b.equals(bonus)) {</span>
                                // Remove this duplicate bonus token.
                                // Check if it should be made available again.
<span class="fc" id="L512">                                List&lt;SellBonusToken&gt; commonSP = gameManager.getSpecialProperties(SellBonusToken.class, true);</span>
<span class="pc bpc" id="L513" title="1 of 2 branches missed.">                                if (commonSP != null) {</span>
<span class="pc bpc" id="L514" title="1 of 2 branches missed.">                                    for (SellBonusToken sp : commonSP) {</span>
<span class="fc bfc" id="L515" title="All 2 branches covered.">                                        if (sp.getId().equalsIgnoreCase(b.getName())) {</span>
<span class="fc" id="L516">                                            sp.makeResellable();</span>
<span class="fc" id="L517">                                            log.debug(&quot;BonusToken &quot;+b.getName()+&quot; made sellable again&quot;);</span>
<span class="fc" id="L518">                                            break;</span>
                                        }
<span class="fc" id="L520">                                    }</span>
                                }
<span class="fc" id="L522">                                log.debug(&quot;Duplicate BonusToken &quot;+b.getName()+&quot; not added to &quot;+ cgr.getId());</span>
<span class="fc" id="L523">                                continue bonuses;</span>
                            }
<span class="fc" id="L525">                        }</span>
                    }
<span class="fc" id="L527">                    cgr.addBonus(new Bonus(cgr, bonus.getName(), bonus.getValue(), bonus.getLocations()));</span>
<span class="fc" id="L528">                }</span>
            }
<span class="fc" id="L530">        }</span>

        // Replace the home tokens
<span class="fc" id="L533">        ReportBuffer.add(this, &quot;&quot;);</span>
<span class="fc bfc" id="L534" title="All 2 branches covered.">        for (BaseToken token : homeTokens) {</span>
<span class="fc" id="L535">            stop = (Stop) token.getOwner();</span>
<span class="fc" id="L536">            hex = stop.getParent();</span>
            // return token to home
<span class="fc" id="L538">            token.moveTo(token.getParent());</span>
<span class="pc bpc" id="L539" title="1 of 2 branches missed.">            if (hex.layBaseToken(cgr, stop)) {</span>
                /* TODO: the false return value must be impossible. */
<span class="fc" id="L541">                ReportBuffer.add(this, LocalText.getText(&quot;ExchangesBaseToken&quot;,</span>
<span class="fc" id="L542">                        cgr.toText(), token.getParent().getId(),</span>
<span class="fc" id="L543">                        stop.getSpecificId()));</span>
<span class="fc" id="L544">                cgr.layBaseToken(hex, 0);</span>
            }
<span class="fc" id="L546">        }</span>

        // Clean up any non-home tokens on cities now having a CGR token
<span class="fc bfc" id="L549" title="All 2 branches covered.">        for (BaseToken token : new ArrayList&lt;BaseToken&gt;(nonHomeTokens)) {</span>
<span class="fc" id="L550">            stop = (Stop) token.getOwner();</span>
<span class="fc" id="L551">            hex = stop.getParent();</span>
<span class="fc" id="L552">            Set&lt;BaseToken&gt; otherTokens = hex.getBaseTokens();</span>
<span class="pc bpc" id="L553" title="1 of 2 branches missed.">            if (otherTokens != null) {</span>
<span class="fc bfc" id="L554" title="All 2 branches covered.">                for (BaseToken token2 : otherTokens) {</span>
<span class="fc bfc" id="L555" title="All 2 branches covered.">                    if (token2.getParent() == cgr</span>
<span class="fc bfc" id="L556" title="All 4 branches covered.">                            || nonHomeTokens.contains(token2) &amp;&amp; token2 != token) {</span>
<span class="fc" id="L557">                        ReportBuffer.add(this, LocalText.getText(&quot;DiscardsBaseToken&quot;,</span>
<span class="fc" id="L558">                                cgr.toText(), token.getParent().getId(),</span>
<span class="fc" id="L559">                                stop.getSpecificId()));</span>
                        // return token to home
<span class="fc" id="L561">                        token.moveTo(token.getParent());</span>
<span class="fc" id="L562">                        nonHomeTokens.remove(token);</span>
<span class="fc" id="L563">                        break;</span>
                    }
<span class="fc" id="L565">                }</span>
            }
<span class="fc" id="L567">        }</span>

        // Prepare replacing the other tokens, if possible
<span class="pc bpc" id="L570" title="1 of 2 branches missed.">        if (homeTokens.size() + nonHomeTokens.size() &gt; cgr.getNumberOfBaseTokens()) {</span>
            // CGR cannot replace all tokens, must choose
            // First collect old names per city
<span class="nc" id="L573">            Map&lt;String, String&gt; oldTokens = new HashMap&lt;String, String&gt;();</span>
            String cityName;
<span class="nc bnc" id="L575" title="All 2 branches missed.">            for (BaseToken token : nonHomeTokens) {</span>
<span class="nc bnc" id="L576" title="All 2 branches missed.">                if (token.getOwner() instanceof Stop) {</span>
<span class="nc" id="L577">                    cityName = ((Stop)token.getOwner()).getSpecificId();</span>
<span class="nc bnc" id="L578" title="All 2 branches missed.">                    if (oldTokens.containsKey(cityName)) {</span>
<span class="nc" id="L579">                        oldTokens.put(cityName,</span>
<span class="nc" id="L580">                                oldTokens.get(cityName)+&quot;,&quot;+token.getParent().getId());</span>
                    } else {
<span class="nc" id="L582">                        oldTokens.put(cityName, token.getParent().getId());</span>
                    }
                }
<span class="nc" id="L585">            }</span>
            // Then create list of exchange spots. Sort it on hexname/city number
<span class="nc" id="L587">            tokensToExchangeFrom = new ArrayList&lt;ExchangeableToken&gt;();</span>
<span class="nc bnc" id="L588" title="All 2 branches missed.">            for (String key : new TreeSet&lt;String&gt; (oldTokens.keySet())) {</span>
<span class="nc" id="L589">                tokensToExchangeFrom.add(new ExchangeableToken(</span>
<span class="nc" id="L590">                        key, oldTokens.get(key)));</span>
<span class="nc" id="L591">            }</span>
<span class="nc" id="L592">        } else {</span>
<span class="fc" id="L593">            executeExchangeTokens(nonHomeTokens);</span>
        }

        // Close the merged companies
<span class="fc bfc" id="L597" title="All 2 branches covered.">        for (PublicCompany comp : mergingCompanies) {</span>
<span class="fc" id="L598">            comp.setClosed();</span>
<span class="fc" id="L599">        }</span>

        // Check the trains, autodiscard any excess non-permanent trains
        //        int trainLimit = cgr.getTrainLimit(gameManager.getCurrentPlayerIndex());
<span class="fc" id="L603">        int trainLimit = cgr.getCurrentTrainLimit();</span>
<span class="fc" id="L604">        Set&lt;Train&gt; trains = cgr.getPortfolioModel().getTrainList();</span>
<span class="pc bpc" id="L605" title="1 of 2 branches missed.">        if (cgr.getNumberOfTrains() &gt; trainLimit) {</span>
<span class="nc" id="L606">            ReportBuffer.add(this, &quot;&quot;);</span>
<span class="nc" id="L607">            int numberToDiscard = cgr.getNumberOfTrains() - trainLimit;</span>
<span class="nc" id="L608">            List&lt;Train&gt; trainsToDiscard = new ArrayList&lt;Train&gt;(4);</span>
<span class="nc bnc" id="L609" title="All 2 branches missed.">            for (Train train : trains) {</span>
<span class="nc bnc" id="L610" title="All 2 branches missed.">                if (!train.isPermanent()) {</span>
<span class="nc" id="L611">                    trainsToDiscard.add(train);</span>
<span class="nc bnc" id="L612" title="All 2 branches missed.">                    if (--numberToDiscard == 0) break;</span>
                }
<span class="nc" id="L614">            }</span>
<span class="nc bnc" id="L615" title="All 2 branches missed.">            for (Train train : trainsToDiscard) {</span>
<span class="nc" id="L616">                train.discard();</span>
<span class="nc" id="L617">            }</span>
        }

<span class="fc" id="L620">    }</span>

    private void executeExchangeTokens (List&lt;BaseToken&gt; exchangedTokens) {
        Stop stop;
        MapHex hex;
<span class="fc" id="L625">        ReportBuffer.add(this, &quot;&quot;);</span>
<span class="fc bfc" id="L626" title="All 2 branches covered.">        for (BaseToken token : exchangedTokens) {</span>
            // Remove old token
<span class="fc" id="L628">            stop = (Stop) token.getOwner();</span>
<span class="fc" id="L629">            hex = stop.getParent();</span>
            // return token to Company
<span class="fc" id="L631">            token.moveTo(token.getParent());</span>
            // Replace it with a CGR token
<span class="pc bpc" id="L633" title="1 of 2 branches missed.">            if (hex.layBaseToken(cgr, stop)) {</span>
<span class="fc" id="L634">                cgr.layBaseToken(hex, 0);</span>
            } else {
<span class="nc" id="L636">                log.error(&quot;Error in laying CGR token on &quot;+hex.getId()+&quot; &quot;+hex.getStopName());</span>
            }
<span class="fc" id="L638">        }</span>
<span class="fc" id="L639">    }</span>

    @Override
    public boolean process (PossibleAction action) {

<span class="fc" id="L644">        boolean result = true;</span>

<span class="fc bfc" id="L646" title="All 2 branches covered.">        if (action instanceof RepayLoans) {</span>
<span class="fc" id="L647">            result = repayLoans((RepayLoans)action);</span>
<span class="fc bfc" id="L648" title="All 2 branches covered.">        } else if (action instanceof DiscardTrain) {</span>
<span class="fc" id="L649">            result = discardTrain((DiscardTrain)action);</span>
<span class="pc bpc" id="L650" title="1 of 2 branches missed.">        } else if (action instanceof ExchangeTokens) {</span>
<span class="nc" id="L651">            result = exchangeTokens((ExchangeTokens)action, true); // 2nd parameter: linked moveset</span>
        }
<span class="pc bpc" id="L653" title="1 of 2 branches missed.">        if (!result) return false;</span>

<span class="fc bfc" id="L655" title="All 2 branches covered.">        if (step.value() == Steps.STEP_REPAY_LOANS) {</span>

<span class="fc bfc" id="L657" title="All 2 branches covered.">            if (setNextCompanyNeedingPresidentIntervention()) {</span>
<span class="fc" id="L658">                return true;</span>
            }

<span class="pc bpc" id="L661" title="1 of 2 branches missed.">            if (!mergingCompanies.isEmpty()) {</span>
<span class="fc" id="L662">                formCGR();</span>
<span class="fc" id="L663">                step.set(Steps.STEP_EXCHANGE_TOKENS);</span>
            } else {
<span class="nc" id="L665">                finishRound();</span>
            }
        }

<span class="fc bfc" id="L669" title="All 2 branches covered.">        if (step.value() == Steps.STEP_EXCHANGE_TOKENS) {</span>

<span class="pc bpc" id="L671" title="1 of 2 branches missed.">            if (action instanceof ExchangeTokens) {</span>
<span class="nc" id="L672">                tokensToExchangeFrom = null;</span>
<span class="pc bpc" id="L673" title="1 of 2 branches missed.">            } else if (tokensToExchangeFrom != null</span>
<span class="nc bnc" id="L674" title="All 2 branches missed.">                    &amp;&amp; !tokensToExchangeFrom.isEmpty()) {</span>
<span class="nc" id="L675">                return true;</span>
            }
<span class="fc" id="L677">            step.set(Steps.STEP_DISCARD_TRAINS);</span>
        }

<span class="pc bpc" id="L680" title="1 of 2 branches missed.">        if (step.value() == Steps.STEP_DISCARD_TRAINS) {</span>

<span class="fc bfc" id="L682" title="All 2 branches covered.">            if (checkForTrainsToDiscard()) return true;</span>
<span class="fc" id="L683">            finishRound();</span>
        }

<span class="fc" id="L686">        return true;</span>
    }


    private boolean checkForTrainsToDiscard () {

        // Check if CGR must discard trains
<span class="pc bpc" id="L693" title="1 of 2 branches missed.">        if (cgr.getNumberOfTrains() &gt; cgr.getCurrentTrainLimit()) {</span>
<span class="nc" id="L694">            log.debug(&quot;CGR must discard trains&quot;);</span>
<span class="nc" id="L695">            trainsToDiscardFrom = cgr.getPortfolioModel().getTrainList();</span>
<span class="nc" id="L696">            forcedTrainDiscard = true;</span>
<span class="nc" id="L697">            return true;</span>
<span class="fc bfc" id="L698" title="All 2 branches covered.">        } else if (!this.cgrHasDiscardedTrains.value()) {</span>
            // Check if CGR still has non-permanent trains
            // these may be discarded voluntarily
<span class="fc" id="L701">            trainsToDiscardFrom = new HashSet&lt;Train&gt;();</span>
<span class="fc bfc" id="L702" title="All 2 branches covered.">            for (Train train : cgr.getPortfolioModel().getTrainList()) {</span>
<span class="fc bfc" id="L703" title="All 2 branches covered.">                if (!train.isPermanent()) {</span>
<span class="fc" id="L704">                    trainsToDiscardFrom.add(train);</span>
                }
<span class="fc" id="L706">            }</span>
<span class="fc bfc" id="L707" title="All 2 branches covered.">            if (!trainsToDiscardFrom.isEmpty()) {</span>
<span class="fc" id="L708">                forcedTrainDiscard = false;</span>
<span class="fc" id="L709">                return true;</span>
            }
        }
<span class="fc" id="L712">        return false;</span>
    }

    public boolean discardTrain(DiscardTrain action) {

<span class="fc" id="L717">        Train train = action.getDiscardedTrain();</span>
<span class="fc" id="L718">        PublicCompany company = action.getCompany();</span>
<span class="fc" id="L719">        String companyName = company.getId();</span>

<span class="fc" id="L721">        String errMsg = null;</span>

        // Dummy loop to enable a quick jump out.
        while (true) {
            // Checks
            // Must be CGR
<span class="pc bpc" id="L727" title="1 of 2 branches missed.">            if (company != cgr) {</span>
<span class="nc" id="L728">                errMsg = LocalText.getText(&quot;WrongCompany&quot;,</span>
<span class="nc" id="L729">                        company.getId(),</span>
<span class="nc" id="L730">                        cgr.toText());</span>
<span class="nc" id="L731">                break;</span>
            }
            // Must be correct step
<span class="pc bpc" id="L734" title="1 of 2 branches missed.">            if (step.value() != Steps.STEP_DISCARD_TRAINS) {</span>
<span class="nc" id="L735">                errMsg = LocalText.getText(&quot;WrongActionNoDiscardTrain&quot;);</span>
<span class="nc" id="L736">                break;</span>
            }

<span class="pc bpc" id="L739" title="1 of 4 branches missed.">            if (train == null &amp;&amp; action.isForced()) {</span>
<span class="nc" id="L740">                errMsg = LocalText.getText(&quot;NoTrainSpecified&quot;);</span>
<span class="nc" id="L741">                break;</span>
            }

            // Does the company own such a train?

<span class="pc bpc" id="L746" title="1 of 4 branches missed.">            if (train != null &amp;&amp; !company.getPortfolioModel().getTrainList().contains(train)) {</span>
<span class="nc" id="L747">                errMsg =</span>
<span class="nc" id="L748">                    LocalText.getText(&quot;CompanyDoesNotOwnTrain&quot;,</span>
<span class="nc" id="L749">                                company.getId(),</span>
<span class="nc" id="L750">                                train.toText() );</span>
                break;
            }

            break;
        }
<span class="pc bpc" id="L756" title="1 of 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L757">            DisplayBuffer.add(this, LocalText.getText(&quot;CannotDiscardTrain&quot;,</span>
                    companyName,
<span class="nc" id="L759">                    train.toText(),</span>
                    errMsg ));
<span class="nc" id="L761">            return false;</span>
        }

        /* End of validation, start of execution */
        // new: link always, see below commented

<span class="fc bfc" id="L767" title="All 2 branches covered.">        if (train != null) {</span>
<span class="fc" id="L768">            train.discard();</span>
        } else {
<span class="fc" id="L770">            cgrHasDiscardedTrains.set(true);</span>
        }

<span class="fc" id="L773">        return true;</span>
    }

    protected boolean exchangeTokens(ExchangeTokens action, boolean linkedMoveSet) {

<span class="nc" id="L778">        String errMsg = null;</span>

<span class="nc" id="L780">        List&lt;ExchangeableToken&gt; tokens = action.getTokensToExchange();</span>
<span class="nc" id="L781">        int min = action.getMinNumberToExchange();</span>
<span class="nc" id="L782">        int max = action.getMaxNumberToExchange();</span>
<span class="nc" id="L783">        int exchanged = 0;</span>

        checks: {

<span class="nc bnc" id="L787" title="All 2 branches missed.">            for (ExchangeableToken token : tokens) {</span>
<span class="nc bnc" id="L788" title="All 2 branches missed.">                if (token.isSelected()) exchanged++;</span>
<span class="nc" id="L789">            }</span>
<span class="nc bnc" id="L790" title="All 4 branches missed.">            if (exchanged &lt; min || exchanged &gt; max) {</span>
<span class="nc" id="L791">                errMsg = LocalText.getText(&quot;WrongNumberOfTokensExchanged&quot;,</span>
<span class="nc" id="L792">                        action.getCompany(),</span>
<span class="nc" id="L793">                        min, max, exchanged);</span>
                break checks;
            }
        }

<span class="nc bnc" id="L798" title="All 2 branches missed.">        if (errMsg != null) {</span>
<span class="nc" id="L799">            DisplayBuffer.add(this, LocalText.getText(&quot;CannotExchangeTokens&quot;,</span>
<span class="nc" id="L800">                    action.getCompany(),</span>
<span class="nc" id="L801">                    action.toString(),</span>
                    errMsg));

<span class="nc" id="L804">            return false;</span>
        }


        // FIMXE: if (linkedMoveSet) changeStack.linkToPreviousMoveSet();

<span class="nc bnc" id="L810" title="All 2 branches missed.">        if (exchanged &gt; 0) {</span>
            MapHex hex;
            Stop stop;
            String stopName, hexName;
            int stationNumber;
            String[] ct;
<span class="nc" id="L816">            PublicCompany comp = action.getCompany();</span>

<span class="nc" id="L818">            ReportBuffer.add(this, &quot;&quot;);</span>

<span class="nc bnc" id="L820" title="All 2 branches missed.">            for (ExchangeableToken token : tokens) {</span>
<span class="nc" id="L821">                stopName = token.getCityName();</span>
<span class="nc" id="L822">                ct = stopName.split(&quot;/&quot;);</span>
<span class="nc" id="L823">                hexName = ct[0];</span>
                try {
<span class="nc" id="L825">                    stationNumber = Integer.parseInt(ct[1]);</span>
<span class="nc" id="L826">                } catch (NumberFormatException e) {</span>
<span class="nc" id="L827">                    stationNumber = 1;</span>
<span class="nc" id="L828">                }</span>
<span class="nc" id="L829">                hex = mapManager.getHex(hexName);</span>
<span class="nc" id="L830">                stop = hex.getRelatedStop(stationNumber);</span>

<span class="nc bnc" id="L832" title="All 2 branches missed.">                if (token.isSelected()) {</span>

                    // For now we'll assume that the old token(s) have already been removed.
                    // This is true in the 1856 CGR formation.
<span class="nc bnc" id="L836" title="All 2 branches missed.">                    if (hex.layBaseToken(comp, stop)) {</span>
                        /* TODO: the false return value must be impossible. */
<span class="nc" id="L838">                        ReportBuffer.add(this, LocalText.getText(&quot;ExchangesBaseToken&quot;,</span>
<span class="nc" id="L839">                                comp.getId(),</span>
<span class="nc" id="L840">                                token.getOldCompanyName(),</span>
<span class="nc" id="L841">                                stop.getSpecificId()));</span>
<span class="nc" id="L842">                        comp.layBaseToken(hex, 0);</span>
                    }
                } else {
<span class="nc" id="L845">                    ReportBuffer.add(this, LocalText.getText(&quot;NoBaseTokenExchange&quot;,</span>
<span class="nc" id="L846">                            comp.getId(),</span>
<span class="nc" id="L847">                            token.getOldCompanyName(),</span>
<span class="nc" id="L848">                            stop.getSpecificId()));</span>
                }
<span class="nc" id="L850">            }</span>
        }

<span class="nc" id="L853">        return true;</span>
    }


    public List&lt;PublicCompany&gt; getMergingCompanies() {
<span class="fc" id="L858">        return mergingCompanies.view();</span>
    }

    @Override
    public String toString() {
<span class="fc" id="L863">        return &quot;1856 CGRFormationRound&quot;;</span>
    }

    @Override
    protected void finishRound() {

<span class="fc" id="L869">        super.finishRound();</span>

        //In any case we must recalculate the certificate limit
<span class="fc" id="L872">        ((GameManager_1856)gameManager).resetCertificateLimit(true);</span>
<span class="fc" id="L873">    }</span>

    // Step Objects to control progress
<span class="fc" id="L876">    private enum Steps {STEP_REPAY_LOANS, STEP_DISCARD_TRAINS, STEP_EXCHANGE_TOKENS };</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>