<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>SpecialProperty.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.game.special</a> &gt; <span class="el_source">SpecialProperty.java</span></div><h1>SpecialProperty.java</h1><pre class="source lang-java linenums">package net.sf.rails.game.special;

import java.util.List;

import net.sf.rails.common.LocalText;
import net.sf.rails.common.parser.Configurable;
import net.sf.rails.common.parser.ConfigurationException;
import net.sf.rails.common.parser.Configure;
import net.sf.rails.common.parser.Tag;
import net.sf.rails.game.Company;
import net.sf.rails.game.GameDef;
import net.sf.rails.game.PrivateCompany;
import net.sf.rails.game.RailsItem;
import net.sf.rails.game.RailsOwnableItem;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.util.Util;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import com.google.common.base.Preconditions;

public abstract class SpecialProperty extends RailsOwnableItem&lt;SpecialProperty&gt; implements Configurable {

<span class="fc" id="L26">    private static final Logger log = LoggerFactory.getLogger(SpecialProperty.class);</span>

    protected static final String STORAGE_NAME = &quot;SpecialProperty&quot;;

<span class="fc" id="L30">    protected final BooleanState exercised = BooleanState.create(this, &quot;exercised&quot;);</span>
    protected Company originalCompany;

    /* Usability conditions. Not all of these are already being used. */
<span class="fc" id="L34">    protected boolean usableIfOwnedByPlayer = false;</span>
<span class="fc" id="L35">    protected boolean usableIfOwnedByCompany = false;</span>
<span class="fc" id="L36">    protected boolean usableDuringSR = false;</span>
<span class="fc" id="L37">    protected boolean usableDuringOR = false;</span>
<span class="fc" id="L38">    protected boolean usableDuringTileLayingStep = false;</span>
<span class="fc" id="L39">    protected boolean usableDuringTokenLayingStep = false;</span>

<span class="fc" id="L41">    protected String conditionText = &quot;&quot;;</span>
<span class="fc" id="L42">    protected String whenText = &quot;&quot;;</span>
<span class="fc" id="L43">    protected String transferText = &quot;&quot;;</span>
<span class="fc" id="L44">    protected boolean permanent = false;</span>
    // if exercising contributes to closing, if private has the closing conditions set, thus default is true
    // allows to exclude special properties that do not close privates that are closeable
<span class="fc" id="L47">    protected boolean closesPrivate = true;</span>


<span class="fc" id="L50">    protected boolean isORProperty = false;</span>
<span class="fc" id="L51">    protected boolean isSRProperty = false;</span>

    /** Optional descriptive text, for display in menus and info text.
     * Subclasses may put real text in it.
     */
<span class="fc" id="L56">    protected String description = &quot;&quot;;</span>

    protected int uniqueId;

    protected SpecialProperty(RailsItem parent, String id) {
<span class="fc" id="L61">        super(parent, convertId(id) , SpecialProperty.class);</span>
<span class="fc" id="L62">        uniqueId = Integer.valueOf(id);</span>
<span class="fc" id="L63">        getRoot().getGameManager().storeObject(STORAGE_NAME, this);</span>
<span class="fc" id="L64">    }</span>

   public void configureFromXML(Tag tag) throws ConfigurationException {

<span class="fc" id="L68">        conditionText = tag.getAttributeAsString(&quot;condition&quot;);</span>
<span class="pc bpc" id="L69" title="1 of 2 branches missed.">        if (!Util.hasValue(conditionText))</span>
<span class="nc" id="L70">            throw new ConfigurationException(</span>
                    &quot;Missing condition in private special property&quot;);
<span class="fc" id="L72">        setUsableIfOwnedByPlayer(conditionText.matches(&quot;(?i).*ifOwnedByPlayer.*&quot;));</span>
<span class="fc" id="L73">        setUsableIfOwnedByCompany(conditionText.matches(&quot;(?i).*ifOwnedByCompany.*&quot;));</span>

<span class="fc" id="L75">        whenText = tag.getAttributeAsString(&quot;when&quot;);</span>
<span class="pc bpc" id="L76" title="1 of 2 branches missed.">        if (!Util.hasValue(whenText))</span>
<span class="nc" id="L77">            throw new ConfigurationException(</span>
                    &quot;Missing condition in private special property&quot;);
<span class="fc bfc" id="L79" title="All 2 branches covered.">        setUsableDuringSR(whenText.equalsIgnoreCase(&quot;anyTurn&quot;)</span>
<span class="pc bpc" id="L80" title="1 of 2 branches missed.">                || whenText.equalsIgnoreCase(&quot;srTurn&quot;));</span>
<span class="fc bfc" id="L81" title="All 2 branches covered.">        setUsableDuringOR(whenText.equalsIgnoreCase(&quot;anyTurn&quot;)</span>
<span class="fc bfc" id="L82" title="All 2 branches covered.">                || whenText.equalsIgnoreCase(&quot;orTurn&quot;));</span>

<span class="fc" id="L84">        setUsableDuringTileLayingStep(whenText.equalsIgnoreCase(&quot;tileLayingStep&quot;));</span>
<span class="fc" id="L85">        setUsableDuringTileLayingStep(whenText.equalsIgnoreCase(&quot;tileAndTokenLayingStep&quot;));</span>
<span class="fc" id="L86">        setUsableDuringTokenLayingStep(whenText.equalsIgnoreCase(&quot;tokenLayingStep&quot;));</span>
<span class="fc" id="L87">        setUsableDuringTokenLayingStep(whenText.equalsIgnoreCase(&quot;tileAndTokenLayingStep&quot;));</span>

<span class="fc" id="L89">        transferText = tag.getAttributeAsString(&quot;transfer&quot;, &quot;&quot;);</span>

<span class="fc" id="L91">        permanent = tag.getAttributeAsBoolean(&quot;permanent&quot;, permanent);</span>

<span class="fc" id="L93">        closesPrivate = tag.getAttributeAsBoolean(&quot;closesPrivate&quot;, closesPrivate);</span>

<span class="fc" id="L95">    }</span>

    public void finishConfiguration (RailsRoot root) throws ConfigurationException {
        // do nothing specific
<span class="fc" id="L99">    }</span>

    public int getUniqueId() {
<span class="fc" id="L102">        return uniqueId;</span>
    }

    // Sets the first (time) owner
    public void setOriginalCompany(Company company) {
<span class="pc bpc" id="L107" title="1 of 2 branches missed.">        Preconditions.checkState(originalCompany == null, &quot;OriginalCompany can only set once&quot;);</span>
<span class="fc" id="L108">        originalCompany = company;</span>
<span class="fc" id="L109">    }</span>

    public Company getOriginalCompany() {
<span class="fc" id="L112">        return originalCompany;</span>
    }

    /**
     * @return Returns the usableIfOwnedByCompany.
     */
    public boolean isUsableIfOwnedByCompany() {
<span class="fc" id="L119">        return usableIfOwnedByCompany;</span>
    }

    /**
     * @param usableIfOwnedByCompany The usableIfOwnedByCompany to set.
     */
    public void setUsableIfOwnedByCompany(boolean usableIfOwnedByCompany) {
<span class="fc" id="L126">        this.usableIfOwnedByCompany = usableIfOwnedByCompany;</span>
<span class="fc" id="L127">    }</span>

    /**
     * @return Returns the usableIfOwnedByPlayer.
     */
    public boolean isUsableIfOwnedByPlayer() {
<span class="fc" id="L133">        return usableIfOwnedByPlayer;</span>
    }

    /**
     * @param usableIfOwnedByPlayer The usableIfOwnedByPlayer to set.
     */
    public void setUsableIfOwnedByPlayer(boolean usableIfOwnedByPlayer) {
<span class="fc" id="L140">        this.usableIfOwnedByPlayer = usableIfOwnedByPlayer;</span>
<span class="fc" id="L141">    }</span>


    public boolean isUsableDuringOR(GameDef.OrStep step) {

<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (usableDuringOR) return true;</span>

<span class="fc bfc" id="L148" title="All 3 branches covered.">        switch (step) {</span>
        case LAY_TRACK:
<span class="fc" id="L150">            return usableDuringTileLayingStep;</span>
        case LAY_TOKEN:
<span class="fc" id="L152">            return usableDuringTokenLayingStep;</span>
        default:
<span class="fc" id="L154">            return false;</span>
        }
    }

    public void setUsableDuringOR(boolean usableDuringOR) {
<span class="fc" id="L159">        this.usableDuringOR = usableDuringOR;</span>
<span class="fc" id="L160">    }</span>

    public boolean isUsableDuringSR() {
<span class="fc" id="L163">        return usableDuringSR;</span>
    }

    public void setUsableDuringSR(boolean usableDuringSR) {
<span class="fc" id="L167">        this.usableDuringSR = usableDuringSR;</span>
<span class="fc" id="L168">    }</span>

    public boolean isUsableDuringTileLayingStep() {
<span class="nc" id="L171">        return usableDuringTileLayingStep;</span>
    }

    public void setUsableDuringTileLayingStep(boolean usableDuringTileLayingStep) {
<span class="fc" id="L175">        this.usableDuringTileLayingStep = usableDuringTileLayingStep;</span>
<span class="fc" id="L176">    }</span>

    public boolean isUsableDuringTokenLayingStep() {
<span class="nc" id="L179">        return usableDuringTokenLayingStep;</span>
    }

    public void setUsableDuringTokenLayingStep(boolean usableDuringTokenLayingStep) {
<span class="fc" id="L183">        this.usableDuringTokenLayingStep = usableDuringTokenLayingStep;</span>
<span class="fc" id="L184">    }</span>

    public void setExercised() {
<span class="fc" id="L187">        setExercised(true);</span>
<span class="fc" id="L188">    }</span>

    public void setExercised (boolean value) {
<span class="fc bfc" id="L191" title="All 2 branches covered.">        if (permanent) return; // sfy 1889</span>
<span class="fc" id="L192">        exercised.set(value);</span>
<span class="pc bpc" id="L193" title="1 of 6 branches missed.">        if (value &amp;&amp; closesPrivate &amp;&amp; originalCompany instanceof PrivateCompany) {</span>
<span class="fc" id="L194">            ((PrivateCompany)originalCompany).checkClosingIfExercised(false);</span>
        }
<span class="fc" id="L196">    }</span>

    public boolean isExercised() {
<span class="fc" id="L199">        return exercised.value();</span>
    }

    public abstract boolean isExecutionable();


    public boolean isSRProperty() {
<span class="nc" id="L206">        return isSRProperty;</span>
    }

    public boolean isORProperty() {
<span class="nc" id="L210">        return isORProperty;</span>
    }

    public String getTransferText() {
<span class="fc" id="L214">        return transferText;</span>
    }

    /**
     * Default menu item text, should be by all special properties that can
     * appear as a menu item
     */
    public String toMenu() {
<span class="nc" id="L222">        return toString();</span>
    }

    /** Default Info text. To be overridden where useful. */
    public String getInfo() {
<span class="fc" id="L227">        return toString();</span>
    }

    /** Default Help text: &quot;You can &quot; + the menu description */
    public String getHelp() {
<span class="nc" id="L232">        return LocalText.getText (&quot;YouCan&quot;, Util.lowerCaseFirst(toMenu()));</span>

    }


    // TODO: Rails 2.0: Move this to a new SpecialPropertyManager

    // convert to the full id used
    private static String convertId(String id) {
<span class="fc" id="L241">        return STORAGE_NAME + &quot;_&quot; + id;</span>
    }

    // return new storage id
    private static String createUniqueId(RailsItem item) {
<span class="fc" id="L246">        return String.valueOf(item.getRoot().getGameManager().getStorageId(STORAGE_NAME) + 1);</span>
        // increase unique id to allow loading old save files (which increase by 1)
        // TODO: remove that legacy issue
    }

    // return special property by unique id
    public static SpecialProperty getByUniqueId(RailsItem item, int id) {
<span class="fc" id="L253">        id -= 1;</span>
        // decrease retrieval id to allow loading old save files (which increase by 1)
        // TODO: remove that legacy issue
<span class="fc" id="L256">        return (SpecialProperty)item.getRoot().getGameManager().retrieveObject(STORAGE_NAME, id);</span>
    }

    /**
     * @param company the company that owns the SpecialProperties
     * @param tag with XML to create SpecialProperties
     * @return additional InfoText
     * @throws ConfigurationException
     */
    public static String configure(Company company, Tag tag) throws ConfigurationException {

<span class="fc" id="L267">      StringBuilder text = new StringBuilder();</span>

      // Special properties
<span class="fc" id="L270">      Tag spsTag = tag.getChild(&quot;SpecialProperties&quot;);</span>
<span class="fc bfc" id="L271" title="All 2 branches covered.">      if (spsTag != null) {</span>

<span class="fc" id="L273">          List&lt;Tag&gt; spTags = spsTag.getChildren(&quot;SpecialProperty&quot;);</span>
          String className;
<span class="fc bfc" id="L275" title="All 2 branches covered.">          for (Tag spTag : spTags) {</span>
<span class="fc" id="L276">              className = spTag.getAttributeAsString(&quot;class&quot;);</span>
<span class="pc bpc" id="L277" title="1 of 2 branches missed.">              if (!Util.hasValue(className))</span>
<span class="nc" id="L278">                  throw new ConfigurationException(</span>
                  &quot;Missing class in private special property&quot;);
<span class="fc" id="L280">              String uniqueId = SpecialProperty.createUniqueId(company);</span>
<span class="fc" id="L281">              SpecialProperty sp = Configure.create(SpecialProperty.class, className, company, uniqueId);</span>
<span class="fc" id="L282">              sp.setOriginalCompany(company);</span>
<span class="fc" id="L283">              sp.configureFromXML(spTag);</span>
<span class="fc" id="L284">              sp.moveTo(company);</span>
<span class="fc" id="L285">              text.append(&quot;&lt;br&gt;&quot; + sp.getInfo());</span>
<span class="fc" id="L286">          }</span>
      }
<span class="fc" id="L288">      return text.toString();</span>
  }


}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>