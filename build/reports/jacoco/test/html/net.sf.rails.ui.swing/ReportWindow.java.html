<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ReportWindow.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.ui.swing</a> &gt; <span class="el_source">ReportWindow.java</span></div><h1>ReportWindow.java</h1><pre class="source lang-java linenums">package net.sf.rails.ui.swing;

import java.awt.BorderLayout;
import java.awt.Font;
import java.awt.event.ActionEvent;
import java.awt.event.ActionListener;
import java.awt.event.ComponentAdapter;
import java.awt.event.ComponentEvent;
import java.awt.event.WindowAdapter;
import java.awt.event.WindowEvent;
import java.net.URL;
import java.util.List;

import javax.swing.*;
import javax.swing.event.HyperlinkEvent;
import javax.swing.event.HyperlinkListener;
import javax.swing.text.BadLocationException;
import javax.swing.text.html.HTMLDocument;

import net.sf.rails.common.Config;
import net.sf.rails.common.LocalText;
import net.sf.rails.common.ReportBuffer;
import net.sf.rails.game.state.ChangeStack;
import net.sf.rails.sound.SoundManager;
import net.sf.rails.ui.swing.elements.ActionButton;
import net.sf.rails.ui.swing.elements.RailsIcon;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.GameAction;


/**
 * ReportWindow displays the game history
 */
public class ReportWindow extends JFrame implements
    ActionListener, HyperlinkListener, ReportBuffer.Observer {

    private static final long serialVersionUID = 1L;

<span class="nc" id="L42">    private static final Logger log = LoggerFactory.getLogger(ReportWindow.class);</span>

    private final GameUIManager gameUIManager;
    private final ReportBuffer reportBuffer;
    private final ChangeStack changeStack;

    private JLabel message;

    private JScrollPane reportPane;
    private JEditorPane editorPane;

    private JPanel buttonPanel;
    private ActionButton forwardButton;
    private ActionButton backwardButton;
    private JButton returnButton;
    private JButton playFromHereButton;
    // private JButton commentButton;

    private boolean timeWarpMode;


<span class="nc" id="L63">    public ReportWindow(GameUIManager gameUIManager) {</span>
<span class="nc" id="L64">        this.gameUIManager = gameUIManager;</span>
<span class="nc" id="L65">        timeWarpMode = false;</span>

<span class="nc" id="L67">        reportBuffer = gameUIManager.getRoot().getReportManager().getReportBuffer();</span>
<span class="nc" id="L68">        reportBuffer.addObserver(this);</span>
<span class="nc" id="L69">        changeStack = gameUIManager.getRoot().getStateManager().getChangeStack();</span>

<span class="nc" id="L71">        init();</span>

        // set initial text
<span class="nc" id="L74">        editorPane.setText(reportBuffer.getCurrentText());</span>
<span class="nc" id="L75">    }</span>

    public void init() {
<span class="nc" id="L78">        setLayout(new BorderLayout());</span>

<span class="nc" id="L80">        JPanel messagePanel = new JPanel();</span>
<span class="nc" id="L81">        messagePanel.setLayout(new BorderLayout());</span>

<span class="nc" id="L83">        message = new JLabel();</span>
<span class="nc" id="L84">        message.setText( LocalText.getText(&quot;REPORT_TIMEWARP_ACTIVE&quot;));</span>
<span class="nc" id="L85">        message.setHorizontalAlignment(JLabel.CENTER);</span>
<span class="nc" id="L86">        messagePanel.add(message, &quot;North&quot;);</span>

<span class="nc" id="L88">        JPanel timeWarpButtons = new JPanel();</span>
<span class="nc" id="L89">        returnButton = new JButton(LocalText.getText(&quot;REPORT_LEAVE_TIMEWARP&quot;));</span>
<span class="nc" id="L90">        returnButton.addActionListener(arg0 -&gt; gotoLastIndex());</span>
<span class="nc" id="L91">        timeWarpButtons.add(returnButton);</span>

<span class="nc" id="L93">        playFromHereButton = new JButton(LocalText.getText(&quot;REPORT_PLAY_FROM_HERE&quot;));</span>
<span class="nc" id="L94">        playFromHereButton.addActionListener(arg0 -&gt; deactivateTimeWarp());</span>
<span class="nc" id="L95">        timeWarpButtons.add(playFromHereButton);</span>
<span class="nc" id="L96">        messagePanel.add(timeWarpButtons, &quot;South&quot;);</span>
<span class="nc" id="L97">        add(messagePanel, &quot;North&quot;);</span>

<span class="nc" id="L99">        editorPane = new JEditorPane();</span>
<span class="nc" id="L100">        editorPane.setEditable(false);</span>
<span class="nc" id="L101">        editorPane.setContentType(&quot;text/html&quot;);</span>
<span class="nc" id="L102">        editorPane.addHyperlinkListener(this);</span>
<span class="nc" id="L103">        editorPane.setOpaque(false);</span>
<span class="nc" id="L104">        editorPane.setBorder(null);</span>

        // add a CSS rule to force body tags to use the default label font
        // instead of the value in javax.swing.text.html.default.csss
<span class="nc" id="L108">        Font font = UIManager.getFont(&quot;Label.font&quot;);</span>
<span class="nc" id="L109">        String bodyRule = &quot;body { font-family: &quot; + font.getFamily() + &quot;; &quot; +</span>
<span class="nc" id="L110">                &quot;font-size: &quot; + font.getSize() + &quot;pt; }&quot;;</span>
<span class="nc" id="L111">        ((HTMLDocument)editorPane.getDocument()).getStyleSheet().addRule(bodyRule);</span>

<span class="nc" id="L113">        reportPane = new JScrollPane(editorPane);</span>
<span class="nc" id="L114">        add(reportPane, &quot;Center&quot;);</span>

<span class="nc" id="L116">        buttonPanel = new JPanel();</span>
<span class="nc" id="L117">        add(buttonPanel, &quot;South&quot;);</span>

<span class="nc" id="L119">        backwardButton = new ActionButton(RailsIcon.REPORT_MOVE_BACKWARD);</span>
<span class="nc" id="L120">        backwardButton.addActionListener(this);</span>
<span class="nc" id="L121">        buttonPanel.add(backwardButton);</span>

<span class="nc" id="L123">        forwardButton = new ActionButton(RailsIcon.REPORT_MOVE_FORWARD);</span>
<span class="nc" id="L124">        forwardButton.addActionListener(this);</span>
<span class="nc" id="L125">        buttonPanel.add(forwardButton);</span>

        // TODO: Add new command button functionality
//        commentButton = new JButton(LocalText.getText(&quot;REPORT_COMMENT&quot;));
//        commentButton.addActionListener(
//                new ActionListener() {
//                    public void actionPerformed(ActionEvent arg0) {
//                        String newComment = (String)JOptionPane.showInputDialog(
//                                ReportWindowDynamic.this,
//                                LocalText.getText(&quot;REPORT_COMMENT_ASK&quot;),
//                                LocalText.getText(&quot;REPORT_COMMENT_TITLE&quot;),
//                                JOptionPane.PLAIN_MESSAGE,
//                                null,
//                                null,
//                                ReportBuffer.getComment()
//                        );
//                        if (newComment != null) {
//                            ReportBuffer.addComment(newComment);
//                            updateLog();
//                            scrollDown();
//                        }
//                    }
//                }
//        );
//        buttonPanel.add(commentButton);

        // remaining code from AbstractReportWindow

<span class="nc" id="L153">        setSize(400, 400);</span>
<span class="nc" id="L154">        setLocation(600, 400);</span>
<span class="nc" id="L155">        setTitle(LocalText.getText(&quot;GameReportTitle&quot;));</span>

<span class="nc" id="L157">        final JFrame frame = this;</span>
<span class="nc" id="L158">        this.setDefaultCloseOperation(DO_NOTHING_ON_CLOSE);</span>
<span class="nc" id="L159">        addWindowListener(new WindowAdapter() {</span>
            @Override
            public void windowClosing(WindowEvent e) {
<span class="nc bnc" id="L162" title="All 2 branches missed.">                if (timeWarpMode) return;</span>
<span class="nc" id="L163">                StatusWindow.uncheckMenuItemBox(StatusWindow.REPORT_CMD);</span>
<span class="nc" id="L164">                frame.dispose();</span>
<span class="nc" id="L165">            }</span>
        });
<span class="nc" id="L167">        final GameUIManager guiMgr = gameUIManager;</span>
<span class="nc" id="L168">        addComponentListener(new ComponentAdapter() {</span>
            @Override
            public void componentMoved(ComponentEvent e) {
<span class="nc" id="L171">                guiMgr.getWindowSettings().set(frame);</span>
<span class="nc" id="L172">            }</span>
            @Override
            public void componentResized(ComponentEvent e) {
<span class="nc" id="L175">                guiMgr.getWindowSettings().set(frame);</span>
<span class="nc" id="L176">            }</span>
        });

<span class="nc" id="L179">        gameUIManager.packAndApplySizing(this);</span>

<span class="nc" id="L181">        gameUIManager.setMeVisible(this, &quot;yes&quot;.equalsIgnoreCase(Config.get(&quot;report.window.open&quot;)));</span>

<span class="nc" id="L183">    }</span>

    // FIXME (Rails2.0): Replace this by toTe
    public void setActions() {
<span class="nc" id="L187">        forwardButton.setEnabled(false);</span>
<span class="nc" id="L188">        backwardButton.setEnabled(false);</span>

<span class="nc" id="L190">        boolean haveRedo = false;</span>
<span class="nc" id="L191">        List&lt;GameAction&gt; gameActions = gameUIManager.getGameManager().getPossibleActions().getType(GameAction.class);</span>
<span class="nc" id="L192">        boolean undoFlag = false;</span>
<span class="nc bnc" id="L193" title="All 2 branches missed.">        for (GameAction action:gameActions) {</span>
<span class="nc bnc" id="L194" title="All 4 branches missed.">            switch (action.getMode()) {</span>
            case UNDO:
<span class="nc" id="L196">                undoFlag = true;</span>
<span class="nc" id="L197">                backwardButton.setPossibleAction(action);</span>
<span class="nc" id="L198">                backwardButton.setEnabled(true);</span>
<span class="nc" id="L199">                break;</span>
            case FORCED_UNDO:
<span class="nc bnc" id="L201" title="All 2 branches missed.">                if (undoFlag) break; // only activate forced undo, if no other undo available</span>
<span class="nc" id="L202">                backwardButton.setPossibleAction(action);</span>
<span class="nc" id="L203">                backwardButton.setEnabled(true);</span>
<span class="nc" id="L204">                break;</span>
            case REDO:
<span class="nc" id="L206">                forwardButton.setPossibleAction(action);</span>
<span class="nc" id="L207">                forwardButton.setEnabled(true);</span>
<span class="nc" id="L208">                haveRedo = true;</span>
<span class="nc" id="L209">                break;</span>
            default:
                break;
            }
<span class="nc" id="L213">        }</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">        if (!haveRedo) deactivateTimeWarp();</span>
<span class="nc" id="L215">    }</span>

    public void scrollDown() {
        // only set caret if visible
        //if (!this.isVisible()) return;

        // find the active message in the parsed html code (not identical to the position in the html string)
        // thus the message indicator is used
<span class="nc" id="L223">        SwingUtilities.invokeLater(() -&gt; {</span>
            int caretPosition;
            try{
<span class="nc" id="L226">                String docText = editorPane.getDocument().getText(0, editorPane.getDocument().getLength());</span>
<span class="nc" id="L227">                caretPosition = docText.indexOf(ReportBuffer.ACTIVE_MESSAGE_INDICATOR);</span>
<span class="nc" id="L228">            } catch (BadLocationException e){</span>
<span class="nc" id="L229">                caretPosition = -1;</span>
<span class="nc" id="L230">            };</span>
<span class="nc" id="L231">            final int caretPositionStore = caretPosition;</span>
<span class="nc bnc" id="L232" title="All 2 branches missed.">            if (caretPosition != -1) {</span>
<span class="nc" id="L233">                editorPane.setCaretPosition(caretPositionStore);</span>
            }
<span class="nc" id="L235">        });</span>
<span class="nc" id="L236">    }</span>

    public void actionPerformed(ActionEvent e) {
<span class="nc" id="L239">        ActionButton button = (ActionButton)e.getSource();</span>
<span class="nc" id="L240">        GameAction action = (GameAction)button.getPossibleActions().get(0);</span>
<span class="nc bnc" id="L241" title="All 4 branches missed.">        if ( action != null &amp;&amp; (action.getMode() == GameAction.Mode.FORCED_UNDO)) {</span>
<span class="nc" id="L242">            activateTimeWarp();</span>
        }

<span class="nc" id="L245">        gameUIManager.processAction(action);</span>
<span class="nc" id="L246">    }</span>

    public void hyperlinkUpdate(HyperlinkEvent e) {
<span class="nc bnc" id="L249" title="All 2 branches missed.">        if (e.getEventType() == HyperlinkEvent.EventType.ACTIVATED) {</span>
<span class="nc" id="L250">            activateTimeWarp();</span>
<span class="nc" id="L251">            URL url = e.getURL();</span>
//          String protocol = e.getURL().getProtocol();
<span class="nc" id="L253">            int index = url.getPort();</span>
<span class="nc" id="L254">            gotoIndex(index);</span>
<span class="nc" id="L255">            toFront();</span>
        }
<span class="nc" id="L257">    }</span>

    private void gotoLastIndex() {
<span class="nc" id="L260">        gotoIndex(changeStack.getMaximumIndex());</span>
<span class="nc" id="L261">    }</span>

    private void gotoIndex(int index) {
<span class="nc" id="L264">        int currentIndex = changeStack.getCurrentIndex();</span>
<span class="nc bnc" id="L265" title="All 2 branches missed.">        if (index &gt; currentIndex) { // move forward</span>
<span class="nc" id="L266">            GameAction action = new GameAction(GameAction.Mode.REDO);</span>
<span class="nc" id="L267">            action.setmoveStackIndex(index);</span>
<span class="nc" id="L268">            gameUIManager.processAction(action);</span>
<span class="nc bnc" id="L269" title="All 2 branches missed.">        } else if (index &lt; currentIndex) { // move backward</span>
<span class="nc" id="L270">            GameAction action = new GameAction(GameAction.Mode.FORCED_UNDO);</span>
<span class="nc" id="L271">            action.setmoveStackIndex(index);</span>
<span class="nc" id="L272">            gameUIManager.processAction(action);</span>
        }
<span class="nc" id="L274">    }</span>

    private void activateTimeWarp() {
<span class="nc bnc" id="L277" title="All 2 branches missed.">        if (!timeWarpMode) {</span>
<span class="nc" id="L278">            message.setVisible(true);</span>
<span class="nc" id="L279">            playFromHereButton.setVisible(true);</span>
<span class="nc" id="L280">            returnButton.setVisible(true);</span>
<span class="nc" id="L281">            gameUIManager.setEnabledAllWindows(false, this);</span>
<span class="nc" id="L282">            timeWarpMode = true;</span>
<span class="nc" id="L283">            SoundManager.notifyOfTimeWarp(timeWarpMode);</span>
        }
<span class="nc" id="L285">    }</span>

    private void deactivateTimeWarp() {
<span class="nc" id="L288">        gameUIManager.setEnabledAllWindows(true, this);</span>
<span class="nc" id="L289">        message.setVisible(false);</span>
<span class="nc" id="L290">        playFromHereButton.setVisible(false);</span>
<span class="nc" id="L291">        returnButton.setVisible(false);</span>
<span class="nc" id="L292">        timeWarpMode = false;</span>
<span class="nc" id="L293">        SoundManager.notifyOfTimeWarp(timeWarpMode);</span>
<span class="nc" id="L294">    }</span>

    // ReportBuffer.Observer methods

    // FIXME: Rails 2.0 Not used so far
    public void append(String text) {
        // do nothing
<span class="nc" id="L301">    }</span>

    public void update(String text) {
<span class="nc" id="L304">        log.debug(&quot;Update dynamic report window&quot;);</span>
        // set the content of the pane to the current
<span class="nc" id="L306">        editorPane.setText(text);</span>
<span class="nc" id="L307">        scrollDown();</span>
<span class="nc" id="L308">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>