<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GridPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.ui.swing</a> &gt; <span class="el_source">GridPanel.java</span></div><h1>GridPanel.java</h1><pre class="source lang-java linenums">package net.sf.rails.ui.swing;

import java.awt.BasicStroke;
import java.awt.Color;
import java.awt.Component;
import java.awt.Graphics;
import java.awt.Graphics2D;
import java.awt.GridBagConstraints;
import java.awt.GridBagLayout;
import java.awt.Insets;
import java.awt.Stroke;
import java.awt.event.ActionListener;
import java.awt.event.KeyEvent;
import java.awt.event.KeyListener;
import java.util.ArrayList;
import java.util.List;

import javax.swing.BorderFactory;
import javax.swing.JComponent;
import javax.swing.JFrame;
import javax.swing.JLabel;
import javax.swing.JMenuItem;
import javax.swing.JPanel;
import javax.swing.border.AbstractBorder;
import javax.swing.border.Border;
import javax.swing.border.CompoundBorder;

import net.sf.rails.common.Config;
import net.sf.rails.game.Player;
import net.sf.rails.game.PublicCompany;
import net.sf.rails.game.RailsRoot;
import net.sf.rails.game.round.RoundFacade;
import net.sf.rails.game.state.BooleanState;
import net.sf.rails.game.state.Observable;
import net.sf.rails.game.state.Observer;
import net.sf.rails.ui.swing.elements.ClickField;
import net.sf.rails.ui.swing.elements.Field;
import net.sf.rails.util.Util;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;


public abstract class GridPanel extends JPanel
implements ActionListener, KeyListener {

    // TODO: Check if adding the field is compatible
    private static final long serialVersionUID = 1L;

    protected static final int NARROW_GAP = 1;
    protected static final int WIDE_GAP = 3;
    protected static final int WIDE_LEFT = 1;
    protected static final int WIDE_RIGHT = 2;
    protected static final int WIDE_TOP = 4;
    protected static final int WIDE_BOTTOM = 8;

    protected JPanel gridPanel;
    protected JFrame parentFrame;

    protected GridBagLayout gb;
    protected GridBagConstraints gbc;

<span class="fc" id="L63">    protected static Color buttonHighlight = new Color(255, 160, 80);</span>

    protected int np;
    protected Player[] players;
    protected int nc;
    protected PublicCompany[] companies;
    protected RoundFacade round;
    protected PublicCompany c;
    protected JComponent f;

<span class="nc" id="L73">    protected List&lt;Observer&gt; observers = new ArrayList&lt;Observer&gt;();</span>

    /** 2D-array of fields to enable show/hide per row or column */
    protected JComponent[][] fields;
    /** Array of Observer objects to set row visibility */
    protected RowVisibility[] rowVisibilityObservers;

<span class="nc" id="L80">    protected List&lt;JMenuItem&gt; menuItemsToReset = new ArrayList&lt;JMenuItem&gt;();</span>

<span class="fc" id="L82">    protected static final Logger log = LoggerFactory.getLogger(GridPanel.class);</span>

<span class="nc" id="L84">    private List&lt;JComponent&gt; highlightedComps = new ArrayList&lt;JComponent&gt;();</span>
    protected Color tableBorderColor;
    protected Color cellOutlineColor;
    protected Color highlightedBorderColor;

<span class="nc" id="L89">    public GridPanel() {</span>
        //initialize border colors according to the configuration
<span class="nc bnc" id="L91" title="All 2 branches missed.">        if (&quot;enabled&quot;.equals(Config.get(&quot;gridPanel.tableBorders&quot;))) {</span>
<span class="nc" id="L92">            tableBorderColor = Color.DARK_GRAY;</span>
<span class="nc" id="L93">            cellOutlineColor = Color.GRAY;</span>
<span class="nc" id="L94">            highlightedBorderColor = Color.RED;</span>
        } else {
<span class="nc" id="L96">            tableBorderColor = getBackground();</span>
<span class="nc" id="L97">            cellOutlineColor = getBackground();</span>
<span class="nc" id="L98">            highlightedBorderColor = Color.RED;</span>
        }
<span class="nc" id="L100">    }</span>

    public void redisplay() {
<span class="nc" id="L103">        revalidate();</span>
<span class="nc" id="L104">    }</span>

    protected void deRegisterObservers() {
<span class="nc" id="L107">        log.debug(&quot;Deregistering observers&quot;);</span>
<span class="nc bnc" id="L108" title="All 2 branches missed.">        for (Observer o : observers) {</span>
<span class="nc" id="L109">            Observable observable = o.getObservable();</span>
<span class="nc bnc" id="L110" title="All 2 branches missed.">            if (observable != null) {</span>
<span class="nc" id="L111">                observable.removeObserver(o);</span>
            }
<span class="nc" id="L113">        }</span>
<span class="nc" id="L114">    }</span>

    protected void addField(JComponent comp, int x, int y, int width, int height,
            int wideGapPositions) {
<span class="nc" id="L118">        addField (comp, x, y, width, height, wideGapPositions, true);</span>
<span class="nc" id="L119">    }</span>

    protected void addField(JComponent comp, int x, int y, int width, int height,
            int wideGapPositions, boolean visible) {

<span class="nc" id="L124">        gbc.gridx = x;</span>
<span class="nc" id="L125">        gbc.gridy = y;</span>
<span class="nc" id="L126">        gbc.gridwidth = width;</span>
<span class="nc" id="L127">        gbc.gridheight = height;</span>
<span class="nc" id="L128">        gbc.weightx = gbc.weighty = 0.5;</span>
<span class="nc" id="L129">        gbc.fill = GridBagConstraints.BOTH;</span>
<span class="nc" id="L130">        gbc.insets = new Insets(0,0,0,0);</span>

        //special handling of clickfields as their compound border does not fit
        //to this field border logic
<span class="nc bnc" id="L134" title="All 2 branches missed.">        if ((comp instanceof ClickField)) {</span>
<span class="nc" id="L135">            comp.setBorder(BorderFactory.createLineBorder(new Color(0,0,0,0),1));</span>
        }

        int padTop, padLeft, padBottom, padRight;
<span class="nc bnc" id="L139" title="All 2 branches missed.">        padTop = (wideGapPositions &amp; WIDE_TOP) &gt; 0 ? WIDE_GAP - NARROW_GAP : 0;</span>
<span class="nc bnc" id="L140" title="All 2 branches missed.">        padLeft = (wideGapPositions &amp; WIDE_LEFT) &gt; 0 ? WIDE_GAP - NARROW_GAP : 0;</span>
        padBottom =
<span class="nc bnc" id="L142" title="All 2 branches missed.">                (wideGapPositions &amp; WIDE_BOTTOM) &gt; 0 ? WIDE_GAP - NARROW_GAP : 0;</span>
<span class="nc bnc" id="L143" title="All 2 branches missed.">        padRight = (wideGapPositions &amp; WIDE_RIGHT) &gt; 0 ? WIDE_GAP - NARROW_GAP : 0;</span>

        //set field borders
        //- inner border: the field's native border
        //- outline border: the field's outline (in narrow_gap thickness)
        //- outer border: grid table lines (in wide_gap - narrow_gap thickness)

<span class="nc" id="L150">        comp.setBorder(new FieldBorder(comp.getBorder(),</span>
                new DynamicBorder(cellOutlineColor,NARROW_GAP),
                new DynamicBorder(tableBorderColor,padTop,padLeft,padBottom,padRight)));

<span class="nc" id="L154">        gridPanel.add(comp, gbc);</span>

<span class="nc bnc" id="L156" title="All 2 branches missed.">        if (comp instanceof Observer) {</span>
<span class="nc" id="L157">            observers.add((Observer) comp);</span>
        }

<span class="nc bnc" id="L160" title="All 4 branches missed.">        if (fields != null &amp;&amp; fields[x][y] == null) fields[x][y] = comp;</span>
<span class="nc" id="L161">        comp.setVisible(visible);</span>
<span class="nc" id="L162">    }</span>

    /**
     * highlights given component by altering its border's attributes
     */
    protected void setHighlight(JComponent comp,boolean isToBeHighlighted) {
        //quit if nothing is to be done
<span class="nc bnc" id="L169" title="All 4 branches missed.">        if (isToBeHighlighted &amp;&amp; highlightedComps.contains(comp)) return;</span>
<span class="nc bnc" id="L170" title="All 4 branches missed.">        if (!isToBeHighlighted &amp;&amp; !highlightedComps.contains(comp)) return;</span>

<span class="nc bnc" id="L172" title="All 2 branches missed.">        if (comp.getBorder() instanceof FieldBorder) {</span>
<span class="nc" id="L173">            FieldBorder fb = (FieldBorder)comp.getBorder();</span>
<span class="nc" id="L174">            fb.setHighlight(isToBeHighlighted);</span>
<span class="nc" id="L175">            comp.repaint();</span>
<span class="nc bnc" id="L176" title="All 2 branches missed.">            if (isToBeHighlighted) {</span>
<span class="nc" id="L177">                highlightedComps.add(comp);</span>
            } else {
<span class="nc" id="L179">                highlightedComps.remove(comp);</span>
            }
        }
<span class="nc" id="L182">    }</span>

    protected void removeAllHighlights() {
<span class="nc bnc" id="L185" title="All 2 branches missed.">        for (JComponent c : highlightedComps) {</span>
<span class="nc bnc" id="L186" title="All 2 branches missed.">            if (c.getBorder() instanceof FieldBorder) {</span>
<span class="nc" id="L187">                FieldBorder fb = (FieldBorder)c.getBorder();</span>
<span class="nc" id="L188">                fb.setHighlight(false);</span>
<span class="nc" id="L189">                c.repaint();</span>
            }
<span class="nc" id="L191">        }</span>
<span class="nc" id="L192">        highlightedComps.clear();</span>
<span class="nc" id="L193">    }</span>

    /** Returns a string array, each element of which contains the text contents
     * of one row, separated by semicolons.
     */
    public List&lt;String&gt; getTextContents () {

<span class="nc" id="L200">        List&lt;String&gt; result = new ArrayList&lt;String&gt;(32);</span>
        StringBuilder b;
        String text, tip;
<span class="nc bnc" id="L203" title="All 4 branches missed.">        if (fields == null || fields.length == 0) return result;</span>

<span class="nc bnc" id="L205" title="All 2 branches missed.">        for (int i=0; i&lt;fields.length; i++) {</span>
<span class="nc" id="L206">            b = new StringBuilder();</span>
<span class="nc bnc" id="L207" title="All 2 branches missed.">            for (int j=0; j&lt;fields[i].length; j++) {</span>
<span class="nc bnc" id="L208" title="All 2 branches missed.">                if (j &gt; 0) b.append(&quot;;&quot;);</span>
<span class="nc bnc" id="L209" title="All 2 branches missed.">                if (fields[i][j] instanceof JLabel) {</span>
<span class="nc" id="L210">                    text = ((JLabel)fields[i][j]).getText();</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">                    b.append (text == null ? &quot;&quot; : text);</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">                    if (fields[i][j] instanceof Field) {</span>
<span class="nc" id="L213">                        tip = fields[i][j].getToolTipText();</span>
<span class="nc bnc" id="L214" title="All 2 branches missed.">                        if (Util.hasValue(tip)) {</span>
<span class="nc" id="L215">                            b.append(&quot;{&quot;).append(tip).append(&quot;}&quot;);</span>
                        }
                    }
                }
            }
<span class="nc" id="L220">            result.add(b.toString().replaceAll(&quot;&lt;/?html&gt;&quot;, &quot;&quot;).replaceAll(&quot;&lt;br&gt;&quot;,&quot;,&quot;).replaceAll(&quot; x &quot;, &quot;x&quot;));</span>
        }

<span class="nc" id="L223">        return result;</span>
    }

<span class="nc" id="L226">    public void keyPressed(KeyEvent e) {}</span>

<span class="nc" id="L228">    public void keyReleased(KeyEvent e) {}</span>

<span class="nc" id="L230">    public void keyTyped(KeyEvent e) {}</span>

    public void setRowVisibility (int rowIndex, boolean value) {

<span class="nc bnc" id="L234" title="All 2 branches missed.">        for (int j=0; j &lt; fields.length; j++) {</span>
<span class="nc bnc" id="L235" title="All 2 branches missed.">            if (fields[j][rowIndex] != null) {</span>
<span class="nc" id="L236">                fields[j][rowIndex].setVisible(value);</span>
            }
        }
<span class="nc" id="L239">    }</span>


    /**
     * An observer object that receives the updates
     * if the Company is closed
     *
     * TODO: It is unclear to me what the reverseValue really does?
     */
    public static class RowVisibility implements Observer {

        private final GridPanel parent;
        private final int rowIndex;
        private final BooleanState observable;

<span class="nc" id="L254">        public RowVisibility (GridPanel parent, int rowIndex, BooleanState observable, boolean reverseValue) {</span>
<span class="nc" id="L255">            this.parent = parent;</span>
<span class="nc" id="L256">            this.rowIndex = rowIndex;</span>
<span class="nc" id="L257">            this.observable = observable;</span>
            // TODO: This was the previous setup
//            lastValue = ((BooleanState)observable).value() != reverseValue;

<span class="nc" id="L261">        }</span>

        public boolean lastValue () {
<span class="nc" id="L264">            return observable.value();</span>
        }

        public void update(String text) {
<span class="nc" id="L268">            parent.setRowVisibility(rowIndex, lastValue());</span>
<span class="nc" id="L269">        }</span>

        public Observable getObservable() {
<span class="nc" id="L272">            return observable;</span>
        }

    }

    /**
     * Wrapper for three level compound borders and directly accessing border constituents
     * @author Frederick Weld
     *
     */
    private class FieldBorder extends CompoundBorder {
        private static final long serialVersionUID = 1L;
        private Border nativeInnerBorder;
        /**
         * remains null if nativeInnerBorder is null or broken
         */
<span class="nc" id="L288">        private DynamicBorder highlightedInnerBorder = null;</span>
        private DynamicBorder outlineBorder;
        private DynamicBorder outerBorder;
<span class="nc" id="L291">        public FieldBorder(Border innerBorder,DynamicBorder outlineBorder,DynamicBorder outerBorder) {</span>
<span class="nc" id="L292">            super(new CompoundBorder(outerBorder,outlineBorder),innerBorder);</span>
<span class="nc" id="L293">            nativeInnerBorder = innerBorder;</span>
<span class="nc" id="L294">            this.outlineBorder = outlineBorder;</span>
<span class="nc" id="L295">            this.outerBorder = outerBorder;</span>

            //prepare highlighted inner border
<span class="nc bnc" id="L298" title="All 2 branches missed.">            if (nativeInnerBorder != null) {</span>
<span class="nc" id="L299">                Insets nativeInnerBorderInsets = nativeInnerBorder.getBorderInsets(null);</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">                if (nativeInnerBorderInsets != null) {</span>
<span class="nc" id="L301">                    highlightedInnerBorder = new DynamicBorder(</span>
                            highlightedBorderColor,
                            nativeInnerBorderInsets.top,
                            nativeInnerBorderInsets.left,
                            nativeInnerBorderInsets.bottom,
                            nativeInnerBorderInsets.right);
                }
            }
<span class="nc" id="L309">        }</span>
        public void setHighlight(boolean isToBeHighlighted) {
<span class="nc" id="L311">            outlineBorder.setHighlight(isToBeHighlighted);</span>
<span class="nc bnc" id="L312" title="All 2 branches missed.">            this.insideBorder = isToBeHighlighted ?</span>
<span class="nc" id="L313">                    highlightedInnerBorder : nativeInnerBorder;</span>
<span class="nc" id="L314">        }</span>
    }

    /**
     * A potentially asymmetric line border providing methods for changing the look
     * @author Frederick Weld
     *
     */
    private class DynamicBorder extends AbstractBorder {
        private static final long serialVersionUID = 1L;
        private int padTop, padLeft, padBottom, padRight;
        private Color borderColor;
<span class="nc" id="L326">        private boolean isHighlighted = false;</span>

<span class="nc" id="L328">        public DynamicBorder (Color borderColor,int symmetricPad) {</span>
<span class="nc" id="L329">            this.padTop = symmetricPad;</span>
<span class="nc" id="L330">            this.padLeft = symmetricPad;</span>
<span class="nc" id="L331">            this.padBottom = symmetricPad;</span>
<span class="nc" id="L332">            this.padRight = symmetricPad;</span>
<span class="nc" id="L333">            this.borderColor = borderColor;</span>
<span class="nc" id="L334">        }</span>

<span class="nc" id="L336">        public DynamicBorder (Color borderColor,int padTop, int padLeft, int padBottom, int padRight) {</span>
<span class="nc" id="L337">            this.padTop = padTop;</span>
<span class="nc" id="L338">            this.padLeft = padLeft;</span>
<span class="nc" id="L339">            this.padBottom = padBottom;</span>
<span class="nc" id="L340">            this.padRight = padRight;</span>
<span class="nc" id="L341">            this.borderColor = borderColor;</span>
<span class="nc" id="L342">        }</span>

        public void setHighlight(boolean isToBeHighlighted) {
<span class="nc bnc" id="L345" title="All 2 branches missed.">            if (isHighlighted != isToBeHighlighted) {</span>
<span class="nc" id="L346">                isHighlighted = isToBeHighlighted;</span>
            }
<span class="nc" id="L348">        }</span>

        public void paintBorder(Component c,Graphics g, int x, int y, int width,int height) {
<span class="nc" id="L351">            Graphics2D g2d = (Graphics2D)g;</span>
<span class="nc bnc" id="L352" title="All 2 branches missed.">            if (isHighlighted) {</span>
<span class="nc" id="L353">                g2d.setColor(highlightedBorderColor);</span>
            } else {
<span class="nc" id="L355">                g2d.setColor(borderColor);</span>
            }
<span class="nc" id="L357">            Stroke oldStroke = g2d.getStroke();</span>
<span class="nc bnc" id="L358" title="All 2 branches missed.">            if (padTop &gt; 0) {</span>
<span class="nc" id="L359">                g2d.setStroke(new BasicStroke(padTop));</span>
<span class="nc" id="L360">                g2d.fillRect(x, y, width, padTop);</span>
            }
<span class="nc bnc" id="L362" title="All 2 branches missed.">            if (padLeft &gt; 0) {</span>
<span class="nc" id="L363">                g2d.setStroke(new BasicStroke(padLeft));</span>
<span class="nc" id="L364">                g2d.fillRect(x, y, padLeft, height);</span>
            }
<span class="nc bnc" id="L366" title="All 2 branches missed.">            if (padBottom &gt; 0) {</span>
<span class="nc" id="L367">                g2d.setStroke(new BasicStroke(padBottom));</span>
<span class="nc" id="L368">                g2d.fillRect(x, y+height-padBottom, width, padBottom);</span>
            }
<span class="nc bnc" id="L370" title="All 2 branches missed.">            if (padRight &gt; 0) {</span>
<span class="nc" id="L371">                g2d.setStroke(new BasicStroke(padRight));</span>
<span class="nc" id="L372">                g2d.fillRect(x+width-padRight, y, padRight, height);</span>
            }
<span class="nc" id="L374">            g2d.setStroke(oldStroke);</span>
<span class="nc" id="L375">        }</span>

        public Insets getBorderInsets (Component c) {
<span class="nc" id="L378">            return new Insets(padTop,padLeft,padBottom,padRight);</span>
        }

        public boolean isBorderOpaque() {
<span class="nc" id="L382">            return true;</span>
        }
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>