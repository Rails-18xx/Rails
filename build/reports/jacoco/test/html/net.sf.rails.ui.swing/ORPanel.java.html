<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ORPanel.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.ui.swing</a> &gt; <span class="el_source">ORPanel.java</span></div><h1>ORPanel.java</h1><pre class="source lang-java linenums">package net.sf.rails.ui.swing;

import java.awt.*;
import java.awt.event.*;
import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

import javax.swing.*;

import net.sf.rails.algorithms.*;
import net.sf.rails.common.Config;
import net.sf.rails.common.GuiDef;
import net.sf.rails.common.LocalText;
import net.sf.rails.game.*;
import net.sf.rails.ui.swing.elements.*;
import net.sf.rails.ui.swing.hexmap.HexHighlightMouseListener;
import net.sf.rails.util.Util;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import rails.game.action.*;

import com.google.common.collect.Lists;


public class ORPanel extends GridPanel
implements ActionListener, KeyListener, RevenueListener {

    private static final long serialVersionUID = 1L;

    public static final String OPERATING_COST_CMD = &quot;OperatingCost&quot;;
    public static final String BUY_PRIVATE_CMD = &quot;BuyPrivate&quot;;
    public static final String BUY_TRAIN_CMD = &quot;BuyTrain&quot;;
    private static final String WITHHOLD_CMD = &quot;Withhold&quot;;
    private static final String SPLIT_CMD = &quot;Split&quot;;
    public static final String PAYOUT_CMD = &quot;Payout&quot;;
    public static final String SET_REVENUE_CMD = &quot;SetRevenue&quot;;
    private static final String DONE_CMD = &quot;Done&quot;;
    private static final String UNDO_CMD = &quot;Undo&quot;;
    private static final String REDO_CMD = &quot;Redo&quot;;
    public static final String REM_TILES_CMD = &quot;RemainingTiles&quot;;
    private static final String NETWORK_INFO_CMD = &quot;NetworkInfo&quot;;
    public static final String TAKE_LOANS_CMD = &quot;TakeLoans&quot;;
    public static final String REPAY_LOANS_CMD = &quot;RepayLoans&quot;;

    private ORWindow orWindow;
    private ORUIManager orUIManager;

    private JPanel statusPanel;
    private JPanel buttonPanel;

    private JMenuBar menuBar;
    private JMenu infoMenu;
    private JMenuItem remainingTilesMenuItem;
    private JMenu trainsInfoMenu;
    private JMenu phasesInfoMenu;
    private JMenu networkInfoMenu;
    private JMenu specialMenu;
    private JMenu loansMenu;
    private JMenu zoomMenu;
    private JMenuItem zoomIn, zoomOut, fitToWindow, fitToWidth, fitToHeight, calibrateMap;
    private ActionMenuItem takeLoans;
    private ActionMenuItem repayLoans;

    // Grid elements per function
    private Caption leftCompName[];
    private int leftCompNameXOffset, leftCompNameYOffset;
    private Caption rightCompName[];
    private int rightCompNameXOffset, rightCompNameYOffset;
    private Field president[];
    private int presidentXOffset, presidentYOffset;
    private Field sharePrice[];
    private int sharePriceXOffset, sharePriceYOffset;
    private Field cash[];
    private int cashXOffset, cashYOffset;
    private Field privates[];
    private int privatesXOffset, privatesYOffset;
    private Field newPrivatesCost[];
    private Field[] compLoans;
    private int loansXOffset, loansYOffset;
    private Field tiles[];
    private int tilesXOffset, tilesYOffset;
    private Field tileCost[];
    private Field tokens[];
    private Field tokenCost[];
    private Field tokensLeft[];
    private Field tokenBonus[];
    private int tokensXOffset, tokensYOffset;
    private Field revenue[];
    private Spinner revenueSelect[];
    private Field decision[];
    private int revXOffset, revYOffset;
    private Field trains[];
    private int trainsXOffset, trainsYOffset;
    private Field newTrainCost[];
    private int rightsXOffset, rightsYOffset;
    private Field rights[];
    /**
     * For the direct Income to be entered during the OR Phase
     */
    private Spinner directIncomeSelect[];
    private Field directIncomeRevenue[];
    private int bonusRevXOffset, bonusRevYOffset;

<span class="nc" id="L107">    private boolean privatesCanBeBought = false;</span>
<span class="nc" id="L108">    private boolean bonusTokensExist = false;</span>
<span class="nc" id="L109">    private boolean hasCompanyLoans = false;</span>
<span class="nc" id="L110">    private boolean hasRights = false;</span>
<span class="nc" id="L111">    private boolean hasDirectCompanyIncomeInOr = false;</span>

    private Caption tileCaption, tokenCaption, revenueCaption, trainCaption,
    privatesCaption, loansCaption, directIncomeCaption;

    private ActionButton buttonOC; // sfy: button for operating costs
    private ActionButton button1;
    private ActionButton button2;
    private ActionButton button3;
    private ActionButton undoButton;
    private ActionButton redoButton;

    // Current state
<span class="nc" id="L124">    private int playerIndex = -1;</span>
<span class="nc" id="L125">    private int orCompIndex = -1;</span>

<span class="nc" id="L127">    private PublicCompany orComp = null;</span>

<span class="nc" id="L129">    private boolean isRevenueValueToBeSet = false;</span>
<span class="nc" id="L130">    private RevenueAdapter revenueAdapter = null;</span>
<span class="nc" id="L131">    private Thread revenueThread = null;</span>

<span class="nc" id="L133">    protected static final Logger log = LoggerFactory.getLogger(ORPanel.class);</span>

    public ORPanel(ORWindow parent, ORUIManager orUIManager) {
<span class="nc" id="L136">        super();</span>

<span class="nc" id="L138">        orWindow = parent;</span>
<span class="nc" id="L139">        this.orUIManager = orUIManager;</span>
<span class="nc" id="L140">        GameUIManager gameUIManager = parent.gameUIManager;</span>

<span class="nc" id="L142">        statusPanel = new JPanel();</span>
<span class="nc" id="L143">        gb = new GridBagLayout();</span>
<span class="nc" id="L144">        statusPanel.setLayout(gb);</span>
<span class="nc" id="L145">        statusPanel.setBorder(BorderFactory.createEtchedBorder());</span>
<span class="nc" id="L146">        statusPanel.setOpaque(true);</span>

<span class="nc" id="L148">        gridPanel = statusPanel;</span>
<span class="nc" id="L149">        parentFrame = parent;</span>

<span class="nc" id="L151">        round = gameUIManager.getCurrentRound();</span>
        //        noMapMode = gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.NO_MAP_MODE);
<span class="nc" id="L153">        privatesCanBeBought = gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.CAN_ANY_COMPANY_BUY_PRIVATES);</span>
<span class="nc" id="L154">        bonusTokensExist = gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.DO_BONUS_TOKENS_EXIST);</span>
<span class="nc" id="L155">        hasCompanyLoans = gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.HAS_ANY_COMPANY_LOANS);</span>
<span class="nc" id="L156">        hasRights = gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.HAS_ANY_RIGHTS);</span>
<span class="nc" id="L157">        hasDirectCompanyIncomeInOr= gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.HAS_SPECIAL_COMPANY_INCOME);</span>

<span class="nc" id="L159">        initButtonPanel();</span>
<span class="nc" id="L160">        gbc = new GridBagConstraints();</span>

<span class="nc" id="L162">        players = gameUIManager.getPlayers().toArray(new Player[0]);</span>

<span class="nc bnc" id="L164" title="All 2 branches missed.">        if (round instanceof OperatingRound) {</span>
<span class="nc" id="L165">            companies = ((OperatingRound) round).getOperatingCompanies().toArray(new PublicCompany[0]);</span>
<span class="nc" id="L166">            nc = companies.length;</span>
        }

<span class="nc" id="L169">        initFields();</span>

<span class="nc" id="L171">        setLayout(new BorderLayout());</span>
<span class="nc" id="L172">        add(statusPanel, BorderLayout.CENTER);</span>

        //only add button panel directly for conventional layout
<span class="nc bnc" id="L175" title="All 2 branches missed.">        if (!parent.isDockingFrameworkEnabled()) {</span>
<span class="nc" id="L176">            add(buttonPanel, BorderLayout.SOUTH);</span>
        }

<span class="nc" id="L179">        menuBar = new JMenuBar();</span>

<span class="nc" id="L181">        infoMenu = new JMenu(LocalText.getText(&quot;Info&quot;));</span>
<span class="nc" id="L182">        infoMenu.setEnabled(true);</span>

        //only add remaining tiles display option for conventional layout
        //as this is always included as a dockable panel in the docking frame layout
<span class="nc bnc" id="L186" title="All 2 branches missed.">        if (!parent.isDockingFrameworkEnabled()) {</span>
<span class="nc" id="L187">            remainingTilesMenuItem =</span>
<span class="nc" id="L188">                new JMenuItem(LocalText.getText(&quot;RemainingTiles&quot;));</span>
<span class="nc" id="L189">            remainingTilesMenuItem.addActionListener(this);</span>
<span class="nc" id="L190">            remainingTilesMenuItem.setActionCommand(REM_TILES_CMD);</span>
<span class="nc" id="L191">            infoMenu.add(remainingTilesMenuItem);</span>
        }

<span class="nc" id="L194">        menuBar.add(infoMenu);</span>

<span class="nc" id="L196">        addCompanyInfo();</span>
<span class="nc" id="L197">        addTrainsInfo();</span>
<span class="nc" id="L198">        addPhasesInfo();</span>
<span class="nc" id="L199">        addNetworkInfo();</span>

<span class="nc" id="L201">        specialMenu = new JMenu(LocalText.getText(&quot;SPECIAL&quot;));</span>
<span class="nc" id="L202">        specialMenu.setBackground(Color.YELLOW);</span>
        // Normally not seen because menu is not opaque
<span class="nc" id="L204">        specialMenu.setEnabled(false);</span>
<span class="nc" id="L205">        menuBar.add(specialMenu);</span>

<span class="nc bnc" id="L207" title="All 2 branches missed.">        if (hasCompanyLoans) {</span>
<span class="nc" id="L208">            loansMenu = new JMenu (LocalText.getText(&quot;LOANS&quot;));</span>
<span class="nc" id="L209">            loansMenu.setEnabled(true);</span>

<span class="nc" id="L211">            takeLoans = new ActionMenuItem (LocalText.getText(&quot;TakeLoans&quot;));</span>
<span class="nc" id="L212">            takeLoans.addActionListener(this);</span>
<span class="nc" id="L213">            takeLoans.setEnabled(false);</span>
<span class="nc" id="L214">            loansMenu.add(takeLoans);</span>
<span class="nc" id="L215">            menuItemsToReset.add(takeLoans);</span>

<span class="nc" id="L217">            repayLoans = new ActionMenuItem (LocalText.getText(&quot;RepayLoans&quot;));</span>
<span class="nc" id="L218">            repayLoans.addActionListener(this);</span>
<span class="nc" id="L219">            repayLoans.setEnabled(false);</span>
<span class="nc" id="L220">            loansMenu.add(repayLoans);</span>
<span class="nc" id="L221">            menuItemsToReset.add(repayLoans);</span>

<span class="nc" id="L223">            menuBar.add(loansMenu);</span>
        }

<span class="nc" id="L226">        zoomMenu = new JMenu(&quot;Zoom&quot;);</span>
<span class="nc" id="L227">        zoomMenu.setEnabled(true);</span>
<span class="nc" id="L228">        zoomIn = new JMenuItem(&quot;In&quot;);</span>
<span class="nc" id="L229">        zoomIn.addActionListener(this);</span>
<span class="nc" id="L230">        zoomIn.setEnabled(true);</span>
<span class="nc" id="L231">        zoomMenu.add(zoomIn);</span>
<span class="nc" id="L232">        zoomOut = new JMenuItem(&quot;Out&quot;);</span>
<span class="nc" id="L233">        zoomOut.addActionListener(this);</span>
<span class="nc" id="L234">        zoomOut.setEnabled(true);</span>
<span class="nc" id="L235">        zoomMenu.add(zoomOut);</span>
<span class="nc" id="L236">        fitToWindow = createFitToMenuItem(&quot;Fit to window&quot;);</span>
<span class="nc bnc" id="L237" title="All 2 branches missed.">        if (fitToWindow.isSelected()) orWindow.getMapPanel().fitToWindow();</span>
<span class="nc" id="L238">        zoomMenu.add(fitToWindow);</span>
<span class="nc" id="L239">        fitToWidth = createFitToMenuItem(&quot;Fit to width&quot;);</span>
<span class="nc bnc" id="L240" title="All 2 branches missed.">        if (fitToWidth.isSelected()) orWindow.getMapPanel().fitToWidth();</span>
<span class="nc" id="L241">        zoomMenu.add(fitToWidth);</span>
<span class="nc" id="L242">        fitToHeight = createFitToMenuItem(&quot;Fit to height&quot;);</span>
<span class="nc bnc" id="L243" title="All 2 branches missed.">        if (fitToHeight.isSelected()) orWindow.getMapPanel().fitToHeight();</span>
<span class="nc" id="L244">        zoomMenu.add(fitToHeight);</span>
<span class="nc" id="L245">        calibrateMap = new JMenuItem(&quot;CalibrateMap&quot;);</span>
<span class="nc" id="L246">        calibrateMap.addActionListener(this);</span>
<span class="nc" id="L247">        calibrateMap.setEnabled(Config.getDevelop());</span>
<span class="nc" id="L248">        zoomMenu.add(calibrateMap);</span>
<span class="nc" id="L249">        menuBar.add(zoomMenu);</span>

        // only add menu bar for conventional layout
        // (otherwise part of DockingFrame)
<span class="nc bnc" id="L253" title="All 2 branches missed.">        if (!parent.isDockingFrameworkEnabled()) {</span>
<span class="nc" id="L254">            add(menuBar, BorderLayout.NORTH);</span>
        }

<span class="nc" id="L257">        setVisible(true);</span>

<span class="nc" id="L259">        addKeyListener(this);</span>
<span class="nc" id="L260">    }</span>

    private JCheckBoxMenuItem createFitToMenuItem(String name) {
<span class="nc" id="L263">        JCheckBoxMenuItem menuItem = new JCheckBoxMenuItem(name);</span>
<span class="nc" id="L264">        menuItem.addActionListener(this);</span>
<span class="nc" id="L265">        menuItem.setEnabled(true);</span>

        //check whether this is the default fit to option
<span class="nc bnc" id="L268" title="All 2 branches missed.">        if (name.equalsIgnoreCase(Config.get(&quot;map.defaultZoomFitOption&quot;))) {</span>
<span class="nc" id="L269">            menuItem.setSelected(true);</span>
        }
<span class="nc" id="L271">        return menuItem;</span>
    }

    public void recreate(OperatingRound or) {
<span class="nc" id="L275">        log.debug(&quot;ORPanel.recreate() called&quot;);</span>

<span class="nc" id="L277">        companies = or.getOperatingCompanies().toArray(new PublicCompany[0]);</span>
<span class="nc" id="L278">        nc = companies.length;</span>

        // Remove old fields. Don't forget to deregister the Observers
<span class="nc" id="L281">        deRegisterObservers();</span>
<span class="nc" id="L282">        statusPanel.removeAll();</span>

        // Create new fields
<span class="nc" id="L285">        initFields();</span>

        // update the networkInfo menu
        // TODO: This relies on a recreate as soon as companies have changed
<span class="nc" id="L289">        addNetworkInfo();</span>

<span class="nc" id="L291">        repaint();</span>
<span class="nc" id="L292">    }</span>

    private void initButtonPanel() {

        // sfy: operatingcosts button
<span class="nc" id="L297">        buttonOC = new ActionButton(RailsIcon.OPERATING_COST);</span>
<span class="nc" id="L298">        buttonOC.setActionCommand(OPERATING_COST_CMD);</span>
<span class="nc" id="L299">        buttonOC.setMnemonic(KeyEvent.VK_O);</span>
<span class="nc" id="L300">        buttonOC.addActionListener(this);</span>
<span class="nc" id="L301">        buttonOC.setEnabled(false);</span>
<span class="nc" id="L302">        buttonOC.setVisible(false);</span>

<span class="nc" id="L304">        button1 = new ActionButton(null);</span>
<span class="nc" id="L305">        button1.addActionListener(this);</span>
<span class="nc" id="L306">        button1.setEnabled(false);</span>

<span class="nc" id="L308">        button2 = new ActionButton(RailsIcon.BUY_PRIVATE);</span>
<span class="nc" id="L309">        button2.setActionCommand(BUY_PRIVATE_CMD);</span>
<span class="nc" id="L310">        button2.setMnemonic(KeyEvent.VK_V);</span>
<span class="nc" id="L311">        button2.addActionListener(this);</span>
<span class="nc" id="L312">        button2.setEnabled(false);</span>
<span class="nc" id="L313">        button2.setVisible(false);</span>

<span class="nc" id="L315">        button3 = new ActionButton(RailsIcon.DONE);</span>
<span class="nc" id="L316">        button3.setActionCommand(DONE_CMD);</span>
<span class="nc" id="L317">        button3.setMnemonic(KeyEvent.VK_D);</span>
<span class="nc" id="L318">        button3.addActionListener(this);</span>
<span class="nc" id="L319">        button3.setEnabled(false);</span>

<span class="nc" id="L321">        undoButton = new ActionButton(RailsIcon.UNDO);</span>
<span class="nc" id="L322">        undoButton.setActionCommand(UNDO_CMD);</span>
<span class="nc" id="L323">        undoButton.setMnemonic(KeyEvent.VK_U);</span>
<span class="nc" id="L324">        undoButton.addActionListener(this);</span>
<span class="nc" id="L325">        undoButton.setEnabled(false);</span>

<span class="nc" id="L327">        redoButton = new ActionButton(RailsIcon.REDO);</span>
<span class="nc" id="L328">        redoButton.setActionCommand(REDO_CMD);</span>
<span class="nc" id="L329">        redoButton.setMnemonic(KeyEvent.VK_R);</span>
<span class="nc" id="L330">        redoButton.addActionListener(this);</span>
<span class="nc" id="L331">        redoButton.setEnabled(false);</span>

        //choose button panel layout depending on whether panel becomes a dockable
<span class="nc bnc" id="L334" title="All 2 branches missed.">        if (orWindow.isDockingFrameworkEnabled()) {</span>

            //customized panel for dockable layout
            //the minimal size is defined by the size of one button
            //(aim here: user can choose whether buttons are laid out
            //           vertically or horizontally or in a grid, since
            //           the minimal size's restriction is minimal indeed.)
<span class="nc" id="L341">            buttonPanel = new JPanel() {</span>
                private static final long serialVersionUID = 1L;
                @Override
                public Dimension getMinimumSize() {
<span class="nc" id="L345">                    int width = 0;</span>
<span class="nc" id="L346">                    int height = 0;</span>
<span class="nc bnc" id="L347" title="All 2 branches missed.">                    if (getComponents().length != 0) {</span>
                        //getting the first component is sufficient as their
                        //size is all the same
<span class="nc" id="L350">                        width = getComponents()[0].getPreferredSize().width;</span>
<span class="nc" id="L351">                        height = getComponents()[0].getPreferredSize().height;</span>
                    }
                    //add a margin
<span class="nc" id="L354">                    width += 10;</span>
<span class="nc" id="L355">                    height += 10;</span>
<span class="nc" id="L356">                    return new Dimension(width,height);</span>
                }
                public Dimension getPreferredSize() {
<span class="nc" id="L359">                    return getMinimumSize();</span>
                }
            };

        } else {
            //plain panel for conventional layout
<span class="nc" id="L365">            buttonPanel = new JPanel();</span>
        }

<span class="nc" id="L368">        buttonPanel.add(buttonOC);</span>
<span class="nc" id="L369">        buttonPanel.add(button1);</span>
<span class="nc" id="L370">        buttonPanel.add(button2);</span>
<span class="nc" id="L371">        buttonPanel.add(button3);</span>
<span class="nc" id="L372">        buttonPanel.add(undoButton);</span>
<span class="nc" id="L373">        buttonPanel.add(redoButton);</span>

        //for dockable button panel, ensure that all buttons have the same size
        //(necessary, otherwise vertical/box layout will look ugly)
<span class="nc bnc" id="L377" title="All 2 branches missed.">        if (orWindow.isDockingFrameworkEnabled()) {</span>

            //get maximum size
<span class="nc" id="L380">            Dimension maxSize = new Dimension();</span>
<span class="nc bnc" id="L381" title="All 2 branches missed.">            for (Component c : Arrays.asList( buttonPanel.getComponents() )) {</span>
<span class="nc bnc" id="L382" title="All 2 branches missed.">                if (c.getPreferredSize().width &gt; maxSize.width)</span>
<span class="nc" id="L383">                    maxSize.width = c.getPreferredSize().width;</span>
<span class="nc bnc" id="L384" title="All 2 branches missed.">                if (c.getPreferredSize().height &gt; maxSize.height)</span>
<span class="nc" id="L385">                    maxSize.height = c.getPreferredSize().height;</span>
<span class="nc" id="L386">            }</span>
            //apply maximum size to all buttons
<span class="nc bnc" id="L388" title="All 2 branches missed.">            for (Component c : Arrays.asList( buttonPanel.getComponents() )) {</span>
<span class="nc" id="L389">                c.setPreferredSize(maxSize);</span>
<span class="nc" id="L390">            }</span>

        }

<span class="nc" id="L394">        buttonPanel.setOpaque(true);</span>

<span class="nc" id="L396">    }</span>

    public MouseListener getCompanyCaptionMouseClickListener() {
<span class="nc" id="L399">        return new MouseListener() {</span>
            public void mouseClicked(MouseEvent e) {
<span class="nc bnc" id="L401" title="All 2 branches missed.">                if (e.getComponent() instanceof Caption) {</span>
<span class="nc" id="L402">                    Caption c = (Caption)e.getComponent();</span>
<span class="nc" id="L403">                    executeNetworkInfo(c.getText());</span>
                }
<span class="nc" id="L405">            }</span>
<span class="nc" id="L406">            public void mouseExited(MouseEvent e) {}</span>
<span class="nc" id="L407">            public void mouseEntered(MouseEvent e) {}</span>
<span class="nc" id="L408">            public void mousePressed(MouseEvent e) {}</span>
<span class="nc" id="L409">            public void mouseReleased(MouseEvent e) {}</span>
        };
    }

    private void initFields() {
<span class="nc" id="L414">        leftCompName = new Caption[nc];</span>
<span class="nc" id="L415">        rightCompName = new Caption[nc];</span>
<span class="nc" id="L416">        president = new Field[nc];</span>
<span class="nc" id="L417">        sharePrice = new Field[nc];</span>
<span class="nc" id="L418">        cash = new Field[nc];</span>
<span class="nc" id="L419">        trains = new Field[nc];</span>
<span class="nc" id="L420">        privates = new Field[nc];</span>
<span class="nc" id="L421">        tiles = new Field[nc];</span>
<span class="nc" id="L422">        tileCost = new Field[nc];</span>
<span class="nc" id="L423">        tokens = new Field[nc];</span>
<span class="nc" id="L424">        tokenCost = new Field[nc];</span>
<span class="nc" id="L425">        tokensLeft = new Field[nc];</span>
<span class="nc bnc" id="L426" title="All 2 branches missed.">        if (bonusTokensExist) tokenBonus = new Field[nc];</span>
<span class="nc bnc" id="L427" title="All 2 branches missed.">        if (hasCompanyLoans) compLoans = new Field[nc];</span>
<span class="nc bnc" id="L428" title="All 2 branches missed.">        if (hasRights) rights = new Field[nc];</span>
<span class="nc" id="L429">        revenue = new Field[nc];</span>
<span class="nc" id="L430">        revenueSelect = new Spinner[nc];</span>
<span class="nc bnc" id="L431" title="All 2 branches missed.">        if (hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L432">            directIncomeRevenue = new Field[nc];</span>
<span class="nc" id="L433">            directIncomeSelect = new Spinner[nc];</span>
        }
<span class="nc" id="L435">        decision = new Field[nc];</span>
<span class="nc" id="L436">        newTrainCost = new Field[nc];</span>
<span class="nc" id="L437">        newPrivatesCost = new Field[nc];</span>

<span class="nc" id="L439">        leftCompNameXOffset = 0;</span>
<span class="nc" id="L440">        leftCompNameYOffset = 2;</span>
<span class="nc" id="L441">        int currentXOffset = leftCompNameXOffset;</span>
<span class="nc" id="L442">        int lastXWidth = 0;</span>

<span class="nc" id="L444">        MouseListener companyCaptionMouseClickListener = getCompanyCaptionMouseClickListener();</span>

        /* Top titles */
<span class="nc" id="L447">        addField(new Caption(&quot;Company&quot;), 0, 0, lastXWidth = 1, 2,</span>
                WIDE_BOTTOM + WIDE_RIGHT);

<span class="nc" id="L450">        presidentXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L451">        presidentYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L452">        addField(new Caption(&quot;President&quot;), presidentXOffset, 0, lastXWidth = 1,</span>
                2, WIDE_BOTTOM);

<span class="nc" id="L455">        sharePriceXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L456">        sharePriceYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L457">        addField(new Caption(&quot;&lt;html&gt;Share&lt;br&gt;value&lt;/html&gt;&quot;), sharePriceXOffset,</span>
                0, lastXWidth = 1, 2, WIDE_BOTTOM);

<span class="nc" id="L460">        cashXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L461">        cashYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L462">        addField(new Caption(&quot;Treasury&quot;), cashXOffset, 0, lastXWidth = 1, 2,</span>
                WIDE_BOTTOM + WIDE_RIGHT);

<span class="nc bnc" id="L465" title="All 2 branches missed.">        if (privatesCanBeBought) {</span>
<span class="nc" id="L466">            privatesXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L467">            privatesYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L468">            addField(privatesCaption = new Caption(&quot;Privates&quot;),</span>
                    privatesXOffset, 0, lastXWidth = 2, 1, WIDE_RIGHT);
<span class="nc" id="L470">            addField(new Caption(&quot;owned&quot;), privatesXOffset, 1, 1, 1,</span>
                    WIDE_BOTTOM);
<span class="nc" id="L472">            addField(new Caption(&quot;cost&quot;), privatesXOffset + 1, 1, 1, 1,</span>
                    WIDE_BOTTOM + WIDE_RIGHT);
        }

<span class="nc bnc" id="L476" title="All 2 branches missed.">        if (hasCompanyLoans) {</span>
<span class="nc" id="L477">            loansXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L478">            loansYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L479">            addField (loansCaption = new Caption(LocalText.getText(&quot;LOANS&quot;)),</span>
                    loansXOffset, 0, lastXWidth = 1, 2, WIDE_BOTTOM + WIDE_RIGHT);
        }

<span class="nc bnc" id="L483" title="All 2 branches missed.">        if (hasRights) {</span>
<span class="nc" id="L484">            rightsXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L485">            rightsYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L486">            addField (new Caption(LocalText.getText(&quot;RIGHTS&quot;)),</span>
                    rightsXOffset, 0, lastXWidth = 1, 2, WIDE_RIGHT);
        }

<span class="nc" id="L490">        tilesXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L491">        tilesYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L492">        addField(tileCaption = new Caption(&quot;Tiles&quot;), tilesXOffset, 0,</span>
                lastXWidth = 2, 1, WIDE_RIGHT);
<span class="nc" id="L494">        addField(new Caption(&quot;laid&quot;), tilesXOffset, 1, 1, 1, WIDE_BOTTOM);</span>
<span class="nc" id="L495">        addField(new Caption(&quot;cost&quot;), tilesXOffset + 1, 1, 1, 1, WIDE_BOTTOM</span>
                + WIDE_RIGHT);

<span class="nc" id="L498">        tokensXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L499">        tokensYOffset = leftCompNameYOffset;</span>
<span class="nc bnc" id="L500" title="All 2 branches missed.">        lastXWidth = bonusTokensExist ? 4 : 3;</span>
<span class="nc" id="L501">        addField(tokenCaption = new Caption(&quot;Tokens&quot;), tokensXOffset, 0,</span>
                lastXWidth, 1, WIDE_RIGHT);
<span class="nc" id="L503">        addField(new Caption(&quot;laid&quot;), tokensXOffset, 1, 1, 1, WIDE_BOTTOM);</span>
<span class="nc" id="L504">        addField(new Caption(&quot;cost&quot;), tokensXOffset + 1, 1, 1, 1, WIDE_BOTTOM);</span>
<span class="nc" id="L505">        addField(new Caption(&quot;left&quot;), tokensXOffset + 2, 1, 1, 1,</span>
<span class="nc bnc" id="L506" title="All 2 branches missed.">                WIDE_BOTTOM + (bonusTokensExist ? 0 : WIDE_RIGHT));</span>
<span class="nc bnc" id="L507" title="All 2 branches missed.">        if (bonusTokensExist) {</span>
<span class="nc" id="L508">            addField(new Caption(&quot;bonus&quot;), tokensXOffset + 3, 1, 1, 1,</span>
                    WIDE_BOTTOM + WIDE_RIGHT);
        }

<span class="nc" id="L512">        revXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L513">        revYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L514">        addField(revenueCaption = new Caption(&quot;Revenue&quot;), revXOffset, 0,</span>
                lastXWidth = 2, 1, WIDE_RIGHT);
<span class="nc" id="L516">        addField(new Caption(&quot;earned&quot;), revXOffset, 1, 1, 1, WIDE_BOTTOM);</span>
<span class="nc" id="L517">        addField(new Caption(&quot;payout&quot;), revXOffset + 1, 1, 1, 1, WIDE_BOTTOM</span>
                + WIDE_RIGHT);

<span class="nc bnc" id="L520" title="All 2 branches missed.">        if (hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L521">            bonusRevXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L522">            bonusRevYOffset =leftCompNameYOffset;</span>
<span class="nc" id="L523">            addField(directIncomeCaption = new Caption(&quot;CompanyIncome&quot;), bonusRevXOffset, 0,</span>
                    lastXWidth = 3, 1, WIDE_RIGHT);
<span class="nc" id="L525">            addField(new Caption(&quot;income&quot;), revXOffset, 1, 1, 1, WIDE_BOTTOM + WIDE_RIGHT);</span>
        }

<span class="nc" id="L528">        trainsXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L529">        trainsYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L530">        addField(trainCaption = new Caption(&quot;Trains&quot;), trainsXOffset, 0,</span>
                lastXWidth = 2, 1, WIDE_RIGHT);
<span class="nc" id="L532">        addField(new Caption(&quot;owned&quot;), trainsXOffset, 1, 1, 1, WIDE_BOTTOM);</span>
<span class="nc" id="L533">        addField(new Caption(&quot;cost&quot;), trainsXOffset + 1, 1, 1, 1, WIDE_BOTTOM</span>
                + WIDE_RIGHT);

<span class="nc" id="L536">        rightCompNameXOffset = currentXOffset += lastXWidth;</span>
<span class="nc" id="L537">        rightCompNameYOffset = leftCompNameYOffset;</span>
<span class="nc" id="L538">        addField(new Caption(&quot;Company&quot;), rightCompNameXOffset, 0, 1, 2,</span>
                WIDE_BOTTOM);

<span class="nc" id="L541">        fields = new JComponent[1+currentXOffset][2+nc];</span>
<span class="nc" id="L542">        rowVisibilityObservers = new RowVisibility[nc];</span>

<span class="nc bnc" id="L544" title="All 2 branches missed.">        for (int i = 0; i &lt; nc; i++) {</span>
<span class="nc" id="L545">            c = companies[i];</span>
<span class="nc" id="L546">            rowVisibilityObservers[i]</span>
<span class="nc" id="L547">                                   = new RowVisibility(this, leftCompNameYOffset + i, c.getInGameModel(), true);</span>
<span class="nc" id="L548">            observers.add(rowVisibilityObservers[i]);</span>

<span class="nc bnc" id="L550" title="All 2 branches missed.">            boolean visible = !c.isClosed();</span>

<span class="nc" id="L552">            f = leftCompName[i] = new Caption(c.getId());</span>
<span class="nc" id="L553">            f.setBackground(c.getBgColour());</span>
<span class="nc" id="L554">            f.setForeground(c.getFgColour());</span>
<span class="nc" id="L555">            HexHighlightMouseListener.addMouseListener(f,</span>
                    orUIManager,c,false);
<span class="nc" id="L557">            f.addMouseListener(companyCaptionMouseClickListener);</span>
<span class="nc" id="L558">            f.setToolTipText(LocalText.getText(&quot;NetworkInfoDialogTitle&quot;,c.getId()));</span>
<span class="nc" id="L559">            addField(f, leftCompNameXOffset, leftCompNameYOffset + i, 1, 1,</span>
                    WIDE_RIGHT, visible);

<span class="nc" id="L562">            f =</span>
                president[i] =
                    //                            new Field(c.hasStarted() &amp;&amp; !c.isClosed()
                    //                                    ? c.getPresident().getNameAndPriority() : &quot;&quot;);
<span class="nc" id="L566">                    new Field(c.getPresidentModel());</span>
<span class="nc" id="L567">            addField(f, presidentXOffset, presidentYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L569">            f = sharePrice[i] = new Field(c.getCurrentPriceModel());</span>
<span class="nc" id="L570">            ((Field) f).setColorModel(c.getCurrentPriceModel());</span>
<span class="nc" id="L571">            addField(f, sharePriceXOffset, sharePriceYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L573">            f = cash[i] = new Field(c.getPurseMoneyModel());</span>
<span class="nc" id="L574">            addField(f, cashXOffset, cashYOffset + i, 1, 1, WIDE_RIGHT, visible);</span>

<span class="nc bnc" id="L576" title="All 2 branches missed.">            if (privatesCanBeBought) {</span>
<span class="nc" id="L577">                f =</span>
                    privates[i] =
                        new Field(
<span class="nc" id="L580">                                        c.getPortfolioModel().getPrivatesOwnedModel());</span>
<span class="nc" id="L581">                HexHighlightMouseListener.addMouseListener(f,</span>
<span class="nc" id="L582">                        orUIManager,c.getPortfolioModel());</span>
<span class="nc" id="L583">                addField(f, privatesXOffset, privatesYOffset + i, 1, 1,</span>
                        0, visible);

<span class="nc" id="L586">                f =</span>
                    newPrivatesCost[i] =
<span class="nc" id="L588">                        new Field(c.getPrivatesSpentThisTurnModel());</span>
<span class="nc" id="L589">                addField(f, privatesXOffset + 1, privatesYOffset + i, 1, 1,</span>
                        WIDE_RIGHT, visible);
            }

<span class="nc bnc" id="L593" title="All 2 branches missed.">            if (hasCompanyLoans) {</span>
                //if (c.canLoan()) {
<span class="nc bnc" id="L595" title="All 2 branches missed.">                if (c.getLoanValueModel() != null) {</span>
<span class="nc" id="L596">                    f = compLoans[i] = new Field (c.getLoanValueModel());</span>
                } else {
<span class="nc" id="L598">                    f = compLoans[i] = new Field (&quot;&quot;);</span>
                }
<span class="nc" id="L600">                addField (f, loansXOffset, loansYOffset + i, 1, 1, WIDE_RIGHT, visible);</span>
            }

<span class="nc bnc" id="L603" title="All 2 branches missed.">            if (hasRights) {</span>
<span class="nc" id="L604">                f = rights[i] = new Field (c.getRightsModel());</span>
<span class="nc" id="L605">                addField (f, rightsXOffset, rightsYOffset + i, 1, 1, WIDE_RIGHT, visible);</span>
            }

<span class="nc" id="L608">            f = tiles[i] = new Field(c.getTilesLaidThisTurnModel());</span>
<span class="nc" id="L609">            addField(f, tilesXOffset, tilesYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L611">            f = tileCost[i] = new Field(c.getTilesCostThisTurnModel());</span>
<span class="nc" id="L612">            addField(f, tilesXOffset + 1, tilesYOffset + i, 1, 1, WIDE_RIGHT, visible);</span>

<span class="nc" id="L614">            f = tokens[i] = new Field(c.getTokensLaidThisTurnModel());</span>
<span class="nc" id="L615">            addField(f, tokensXOffset, tokensYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L617">            f = tokenCost[i] = new Field(c.getTokensCostThisTurnModel());</span>
<span class="nc" id="L618">            addField(f, tokensXOffset + 1, tokensYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L620">            f = tokensLeft[i] = new Field(c.getBaseTokensModel());</span>
<span class="nc" id="L621">            addField(f, tokensXOffset + 2, tokensYOffset + i, 1, 1,</span>
<span class="nc bnc" id="L622" title="All 2 branches missed.">                    bonusTokensExist ? 0 : WIDE_RIGHT, visible);</span>

<span class="nc bnc" id="L624" title="All 2 branches missed.">            if (bonusTokensExist) {</span>
<span class="nc" id="L625">                f = tokenBonus[i] = new Field(c.getBonusTokensModel());</span>
<span class="nc" id="L626">                addField(f, tokensXOffset + 3, tokensYOffset + i, 1, 1,</span>
                        WIDE_RIGHT, visible);
            }

<span class="nc" id="L630">            f = revenue[i] = new Field(c.getLastRevenueModel());</span>
<span class="nc" id="L631">            addField(f, revXOffset, revYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L633">            f = revenueSelect[i] = new Spinner(0, 0, 0, GameManager.getRevenueSpinnerIncrement());</span>
            //align spinner size with field size
            //(so that changes to visibility don't affect panel sizing)
<span class="nc" id="L636">            f.setPreferredSize(revenue[i].getPreferredSize());</span>
<span class="nc" id="L637">            addField(f, revXOffset, revYOffset + i, 1, 1, 0,  false);</span>
            // deactived below, as this caused problems by gridpanel rowvisibility function -- sfy
            //            revenue[i].addDependent(revenueSelect[i]);

<span class="nc" id="L641">            f = decision[i] = new Field(c.getLastRevenueAllocationModel());</span>
<span class="nc" id="L642">            addField(f, revXOffset + 1, revYOffset + i, 1, 1, WIDE_RIGHT,  visible);</span>

<span class="nc bnc" id="L644" title="All 2 branches missed.">            if(hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L645">                f = directIncomeRevenue[i] = new Field(c.getLastDirectIncomeModel());</span>
<span class="nc" id="L646">                addField(f, bonusRevXOffset, bonusRevYOffset + i, 1, 1, 0, visible);</span>

<span class="nc" id="L648">                f = directIncomeSelect[i] = new Spinner(0, 0, 0, GameManager.getRevenueSpinnerIncrement());</span>

<span class="nc" id="L650">                f.setPreferredSize(directIncomeRevenue[i].getPreferredSize());</span>
<span class="nc" id="L651">                addField(f, bonusRevXOffset, bonusRevYOffset + i, 1, 1, 0,  false);</span>
}

<span class="nc" id="L654">            f = trains[i] = new Field(c.getPortfolioModel().getTrainsModel());</span>
<span class="nc" id="L655">            addField(f, trainsXOffset, trainsYOffset + i, 1, 1, 0,  visible);</span>

<span class="nc" id="L657">            f = newTrainCost[i] = new Field(c.getTrainsSpentThisTurnModel());</span>
<span class="nc" id="L658">            addField(f, trainsXOffset + 1, trainsYOffset + i, 1, 1, WIDE_RIGHT,  visible);</span>

<span class="nc" id="L660">            f = rightCompName[i] = new Caption(c.getId());</span>
<span class="nc" id="L661">            f.setBackground(companies[i].getBgColour());</span>
<span class="nc" id="L662">            f.setForeground(companies[i].getFgColour());</span>
<span class="nc" id="L663">            HexHighlightMouseListener.addMouseListener(f,</span>
                    orUIManager,c,false);
<span class="nc" id="L665">            f.addMouseListener(companyCaptionMouseClickListener);</span>
<span class="nc" id="L666">            f.setToolTipText(LocalText.getText(&quot;NetworkInfoDialogTitle&quot;,c.getId()));</span>
<span class="nc" id="L667">            addField(f, rightCompNameXOffset, rightCompNameYOffset + i, 1, 1, 0,  visible);</span>

        }

<span class="nc" id="L671">    }</span>

    protected void addCompanyInfo() {

<span class="nc" id="L675">    	CompanyManager cm = orUIManager.getGameUIManager().getGameManager().getRoot().getCompanyManager();</span>
<span class="nc" id="L676">    	List&lt;CompanyType&gt; comps = cm.getCompanyTypes();</span>
        JMenu compMenu, menu, item;

<span class="nc" id="L679">        compMenu = new JMenu(LocalText.getText(&quot;Companies&quot;));</span>
<span class="nc" id="L680">        compMenu.setEnabled(true);</span>
<span class="nc" id="L681">        infoMenu.add(compMenu);</span>

<span class="nc bnc" id="L683" title="All 2 branches missed.">    	for (CompanyType type : comps) {</span>
<span class="nc" id="L684">    		menu = new JMenu (LocalText.getText(type.getId()));</span>
<span class="nc" id="L685">            menu.setEnabled(true);</span>
<span class="nc" id="L686">            compMenu.add(menu);</span>

<span class="nc bnc" id="L688" title="All 2 branches missed.">    		for (Company comp : type.getCompanies()) {</span>
<span class="nc" id="L689">    			item = new JMenu(comp.getId());</span>
<span class="nc" id="L690">                item.setEnabled(true);</span>
<span class="nc" id="L691">                JMenuItem menuItem = new JMenuItem(comp.getInfoText());</span>
<span class="nc bnc" id="L692" title="All 2 branches missed.">    			if (comp instanceof PrivateCompany) {</span>
                    //highlighting on menu items always enabled irrespective of config
<span class="nc" id="L694">                    HexHighlightMouseListener.addMouseListener(menuItem,</span>
                            orUIManager,(PrivateCompany)comp,true);
<span class="nc" id="L696">                    HexHighlightMouseListener.addMouseListener(item,</span>
                            orUIManager,(PrivateCompany)comp,true);
                }
<span class="nc bnc" id="L699" title="All 2 branches missed.">                if (comp instanceof PublicCompany) {</span>
                    //highlighting on menu items always enabled irrespective of config
<span class="nc" id="L701">                    HexHighlightMouseListener.addMouseListener(menuItem,</span>
                            orUIManager,(PublicCompany)comp,true);
<span class="nc" id="L703">                    HexHighlightMouseListener.addMouseListener(item,</span>
                            orUIManager,(PublicCompany)comp,true);
                }
<span class="nc" id="L706">                item.add(menuItem);</span>
<span class="nc" id="L707">                menu.add(item);</span>
<span class="nc" id="L708">            }</span>
<span class="nc" id="L709">        }</span>
<span class="nc" id="L710">    }</span>

    protected void addTrainsInfo() {

<span class="nc" id="L714">        TrainManager tm = orWindow.getGameUIManager().getRoot().getTrainManager();</span>
<span class="nc" id="L715">        List&lt;TrainType&gt; types = tm.getTrainTypes();</span>
        JMenu item;

<span class="nc" id="L718">        trainsInfoMenu = new JMenu(LocalText.getText(&quot;TRAINS&quot;));</span>
<span class="nc" id="L719">        trainsInfoMenu.setEnabled(true);</span>
<span class="nc" id="L720">        infoMenu.add(trainsInfoMenu);</span>

<span class="nc bnc" id="L722" title="All 2 branches missed.">        for (TrainType type : types) {</span>
<span class="nc" id="L723">            item = new JMenu (LocalText.getText(&quot;N_Train&quot;, type.getName()));</span>
<span class="nc" id="L724">            item.setEnabled(true);</span>
<span class="nc" id="L725">            item.add(new JMenuItem(type.getInfo()));</span>
<span class="nc" id="L726">            trainsInfoMenu.add(item);</span>
<span class="nc" id="L727">        }</span>
<span class="nc" id="L728">    }</span>

    protected void addPhasesInfo() {

<span class="nc" id="L732">        PhaseManager pm = orWindow.getGameUIManager().getRoot().getPhaseManager();</span>
<span class="nc" id="L733">        List&lt;Phase&gt; phases = pm.getPhases();</span>
        JMenu item;
        StringBuffer b;
<span class="nc" id="L736">        b = new StringBuffer(&quot;&lt;html&gt;&quot;);</span>

<span class="nc" id="L738">        phasesInfoMenu = new JMenu(LocalText.getText(&quot;Phases&quot;));</span>
<span class="nc" id="L739">        phasesInfoMenu.setEnabled(true);</span>
<span class="nc" id="L740">        infoMenu.add(phasesInfoMenu);</span>

<span class="nc bnc" id="L742" title="All 2 branches missed.">        for (Phase phase : phases) {</span>
<span class="nc" id="L743">            b.setLength(6);</span>
<span class="nc" id="L744">            appendInfoText(b, LocalText.getText(&quot;PhaseTileColours&quot;, phase.getTileColoursString()));</span>
<span class="nc" id="L745">            appendInfoText(b, LocalText.getText(&quot;PhaseNumberOfORs&quot;, phase.getNumberOfOperatingRounds()));</span>
<span class="nc" id="L746">            appendInfoText(b, LocalText.getText(&quot;PhaseOffBoardStep&quot;, phase.getOffBoardRevenueStep()));</span>
<span class="nc" id="L747">            appendInfoText(b, LocalText.getText(&quot;PhaseTrainLimitStep&quot;, phase.getTrainLimitStep()));</span>
<span class="nc bnc" id="L748" title="All 2 branches missed.">            if (phase.doPrivatesClose()) {</span>
<span class="nc" id="L749">                appendInfoText(b, LocalText.getText(&quot;PhaseClosesAllPrivates&quot;));</span>
            }
<span class="nc bnc" id="L751" title="All 2 branches missed.">            if (phase.getClosedObjects() != null) {</span>
<span class="nc bnc" id="L752" title="All 2 branches missed.">                for (Closeable object : phase.getClosedObjects()) {</span>
<span class="nc bnc" id="L753" title="All 2 branches missed.">                    if (Util.hasValue(object.getClosingInfo())) {</span>
<span class="nc" id="L754">                        appendInfoText(b, LocalText.getText(&quot;PhaseRemoves&quot;, Util.lowerCaseFirst(object.getClosingInfo())));</span>
                    }
<span class="nc" id="L756">                }</span>
            }
<span class="nc bnc" id="L758" title="All 2 branches missed.">            if (Util.hasValue(phase.getInfo())) {</span>
<span class="nc" id="L759">                appendInfoText(b, phase.getInfo());</span>
            }
<span class="nc" id="L761">            item = new JMenu (LocalText.getText(&quot;PhaseX&quot;, phase.toText()));</span>
<span class="nc" id="L762">            item.setEnabled(true);</span>
<span class="nc" id="L763">            item.add(new JMenuItem(b.toString()));</span>
<span class="nc" id="L764">            phasesInfoMenu.add(item);</span>
<span class="nc" id="L765">        }</span>
<span class="nc" id="L766">    }</span>

    protected void addNetworkInfo() {
<span class="nc bnc" id="L769" title="All 2 branches missed.">        if (networkInfoMenu != null) infoMenu.remove(networkInfoMenu);</span>
<span class="nc" id="L770">        networkInfoMenu = createNetworkInfo();</span>
<span class="nc bnc" id="L771" title="All 2 branches missed.">        if (networkInfoMenu == null) return;</span>
<span class="nc" id="L772">        networkInfoMenu.setEnabled(true);</span>
<span class="nc" id="L773">        infoMenu.add(networkInfoMenu);</span>
<span class="nc" id="L774">    }</span>

    protected JMenu createNetworkInfo() {

<span class="nc" id="L778">        boolean route_highlight = orUIManager.gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.ROUTE_HIGHLIGHT);</span>
<span class="nc" id="L779">        boolean revenue_suggest = orUIManager.gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.REVENUE_SUGGEST);</span>

<span class="nc bnc" id="L781" title="All 4 branches missed.">        if (!route_highlight &amp;&amp; !revenue_suggest) return null;</span>

<span class="nc" id="L783">        JMenu networkMenu = new JMenu(LocalText.getText(&quot;NetworkInfo&quot;));</span>

        //network graphs only for developers
<span class="nc bnc" id="L786" title="All 4 branches missed.">        if (route_highlight &amp;&amp; Config.getDevelop()) {</span>
<span class="nc" id="L787">            JMenuItem item = new JMenuItem(&quot;Network&quot;);</span>
<span class="nc" id="L788">            item.addActionListener(this);</span>
<span class="nc" id="L789">            item.setActionCommand(NETWORK_INFO_CMD);</span>
<span class="nc" id="L790">            networkMenu.add(item);</span>
        }

<span class="nc bnc" id="L793" title="All 2 branches missed.">        if (revenue_suggest) {</span>
<span class="nc" id="L794">            CompanyManager cm = orUIManager.getGameUIManager().getGameManager().getRoot().getCompanyManager();</span>
<span class="nc bnc" id="L795" title="All 2 branches missed.">            for (PublicCompany comp : cm.getAllPublicCompanies()) {</span>
<span class="nc bnc" id="L796" title="All 4 branches missed.">                if (!comp.hasFloated() || comp.isClosed()) continue;</span>
<span class="nc" id="L797">                JMenuItem item = new JMenuItem(comp.getId());</span>
<span class="nc" id="L798">                item.addActionListener(this);</span>
<span class="nc" id="L799">                item.setActionCommand(NETWORK_INFO_CMD);</span>
<span class="nc" id="L800">                networkMenu.add(item);</span>
<span class="nc" id="L801">            }</span>
        }

<span class="nc" id="L804">        return networkMenu;</span>
    }

    protected void executeNetworkInfo(String companyName) {
<span class="nc" id="L808">        RailsRoot root = orUIManager.getGameUIManager().getRoot();</span>

<span class="nc bnc" id="L810" title="All 2 branches missed.">        if (companyName.equals(&quot;Network&quot;)) {</span>
<span class="nc" id="L811">            NetworkAdapter network = NetworkAdapter.create(root);</span>
<span class="nc" id="L812">            NetworkGraph mapGraph = network.getMapGraph();</span>
<span class="nc" id="L813">            mapGraph.optimizeGraph();</span>
<span class="nc" id="L814">            mapGraph.visualize(&quot;Optimized Map Network&quot;);</span>
<span class="nc" id="L815">        } else {</span>
<span class="nc" id="L816">            CompanyManager cm = root.getCompanyManager();</span>
<span class="nc" id="L817">            PublicCompany company = cm.getPublicCompany(companyName);</span>
            //handle the case of invalid parameters
            //could occur if the method is not invoked by the menu (but by the click listener)
<span class="nc bnc" id="L820" title="All 2 branches missed.">            if (company == null) return;</span>
<span class="nc" id="L821">            NetworkAdapter network = NetworkAdapter.create(root);</span>
<span class="nc" id="L822">            NetworkGraph routeGraph = network.getRevenueGraph(company, Lists.&lt;NetworkVertex&gt;newArrayList());</span>
<span class="nc" id="L823">            routeGraph.visualize(&quot;Route Network for &quot; + company);</span>
<span class="nc" id="L824">            List&lt;String&gt; addTrainList = new ArrayList&lt;String&gt;();</span>
<span class="nc" id="L825">            boolean anotherTrain = true;</span>
<span class="nc" id="L826">            RevenueAdapter ra = null;</span>
<span class="nc bnc" id="L827" title="All 2 branches missed.">            while (anotherTrain) {</span>
                // multi
<span class="nc" id="L829">                ra = RevenueAdapter.createRevenueAdapter(root, company, root.getPhaseManager().getCurrentPhase());</span>
<span class="nc bnc" id="L830" title="All 2 branches missed.">                for (String addTrain:addTrainList) {</span>
<span class="nc" id="L831">                    ra.addTrainByString(addTrain);</span>
<span class="nc" id="L832">                }</span>
<span class="nc" id="L833">                ra.initRevenueCalculator(true); // true =&gt; multigraph, false =&gt; simplegraph</span>
<span class="nc" id="L834">                log.debug(&quot;Revenue Adapter:&quot; + ra);</span>
<span class="nc" id="L835">                int revenueValue = ra.calculateRevenue();</span>
<span class="nc" id="L836">                log.debug(&quot;Revenue Value:&quot; + revenueValue);</span>
<span class="nc" id="L837">                log.debug(&quot;Revenue Run:&quot; + ra.getOptimalRunPrettyPrint(true));</span>
                //try-catch clause temporary workaround as revenue adapter's
                //convertRcRun might erroneously raise exceptions
<span class="nc" id="L840">                try {ra.drawOptimalRunAsPath(orUIManager.getMap());}</span>
<span class="nc" id="L841">                catch (Exception e) {}</span>
                /**
                 * TODO: Here the automatic calculation of the Special Company Income needs to be implemented
                 * 1837: Coal Mines
                 * 1853: Mail Contract
                 * 1822: Mail Contract
                 * 1822CA: Mail Contract
                 * 1854 old/new : Mail Contract ?
                 */


<span class="nc bnc" id="L852" title="All 2 branches missed.">                if (!Config.getDevelop()) {</span>
                    //parent component is ORPanel so that dialog won't hide the routes painted on the map
<span class="nc" id="L854">                    JOptionPane.showMessageDialog(this,</span>
<span class="nc" id="L855">                            LocalText.getText(&quot;NetworkInfoDialogMessage&quot;,company.getId(),</span>
<span class="nc" id="L856">                                    orUIManager.getGameUIManager().format(revenueValue)) ,</span>
<span class="nc" id="L857">                            LocalText.getText(&quot;NetworkInfoDialogTitle&quot;,company.getId()),</span>
                            JOptionPane.INFORMATION_MESSAGE);
                    //train simulation only for developers
<span class="nc" id="L860">                    break;</span>
                }

<span class="nc" id="L863">                JOptionPane.showMessageDialog(orWindow, &quot;RevenueValue = &quot; + revenueValue +</span>
<span class="nc" id="L864">                        &quot;\nRevenueRun = \n&quot; + ra.getOptimalRunPrettyPrint(true));</span>

<span class="nc" id="L866">                String trainString =</span>
<span class="nc" id="L867">                    JOptionPane.showInputDialog(null, &quot;Enter train string (Examples: 5, 3+3, 4D, 6E, D)&quot;,</span>
                            &quot;Add another train to run?&quot;,
                            JOptionPane.QUESTION_MESSAGE);
<span class="nc bnc" id="L870" title="All 4 branches missed.">                if (trainString == null || trainString.equals(&quot;&quot;)) {</span>
<span class="nc" id="L871">                    anotherTrain = false;</span>
                } else {
<span class="nc" id="L873">                    addTrainList.add(trainString);</span>
                }

<span class="nc" id="L876">            }</span>
            //clean up the paths on the map
<span class="nc" id="L878">            orUIManager.getMap().setTrainPaths(null);</span>
            //but retain paths already existing before
<span class="nc bnc" id="L880" title="All 2 branches missed.">            if (revenueAdapter != null) {</span>
                //try-catch clause temporary workaround as revenue adapter's
                //convertRcRun might erroneously raise exceptions
<span class="nc" id="L883">                try {revenueAdapter.drawOptimalRunAsPath(orUIManager.getMap());}</span>
<span class="nc" id="L884">                catch (Exception e) {}</span>
            }
        }
<span class="nc" id="L887">    }</span>

    private void appendInfoText (StringBuffer b, String text) {
<span class="nc bnc" id="L890" title="All 4 branches missed.">        if (text == null || text.length() == 0) return;</span>
<span class="nc bnc" id="L891" title="All 2 branches missed.">        if (b.length() &gt; 6) b.append(&quot;&lt;br&gt;&quot;);</span>
<span class="nc" id="L892">        b.append(text);</span>
<span class="nc" id="L893">    }</span>

    public void finish() {

<span class="nc" id="L897">        buttonOC.setEnabled(false); // operatingcosts sfy</span>
<span class="nc" id="L898">        button1.setEnabled(false);</span>
<span class="nc" id="L899">        button2.setEnabled(false);</span>
<span class="nc" id="L900">        button3.setEnabled(false);</span>
<span class="nc" id="L901">        undoButton.setEnabled(false);</span>
<span class="nc" id="L902">        redoButton.setEnabled(false);</span>

<span class="nc" id="L904">        disableRoutesDisplay();</span>

        //clear all highlighting (president column and beyond)
<span class="nc" id="L907">        resetActions();</span>

<span class="nc" id="L909">    }</span>

    public void redrawRoutes() {
<span class="nc bnc" id="L912" title="All 4 branches missed.">        if (revenueAdapter != null &amp;&amp; isDisplayRoutes()) {</span>
            //try-catch clause temporary workaround as revenue adapter's
            //convertRcRun might erroneously raise exceptions
<span class="nc" id="L915">            try {revenueAdapter.drawOptimalRunAsPath(orUIManager.getMap());}</span>
<span class="nc" id="L916">            catch (Exception e) {}</span>
        }
<span class="nc" id="L918">    }</span>

    public void actionPerformed(ActionEvent actor) {

        // What kind action has been taken?
<span class="nc" id="L923">        JComponent source = (JComponent) actor.getSource();</span>
<span class="nc" id="L924">        String command = actor.getActionCommand();</span>
<span class="nc" id="L925">        List&lt;PossibleAction&gt; executedActions = null;</span>
<span class="nc" id="L926">        PossibleAction executedAction = null;</span>

<span class="nc bnc" id="L928" title="All 2 branches missed.">        if (source instanceof ActionTaker) {</span>
<span class="nc" id="L929">            executedActions = ((ActionTaker) source).getPossibleActions();</span>
            // In most cases we have only one
<span class="nc bnc" id="L931" title="All 2 branches missed.">            if (!executedActions.isEmpty()) {</span>
<span class="nc" id="L932">                executedAction = executedActions.get(0);</span>
                // In all cases, the actions in the list must be
                // instances of the same class
<span class="nc" id="L935">                log.debug(&quot;Action taken is &quot; + executedAction.toString());</span>
            }

<span class="nc bnc" id="L938" title="All 2 branches missed.">            if (executedAction instanceof SetDividend) {</span>
                // Hide the spinner here, because we might not return
                // via InitPayoutStep, where this would otherwise be done.
<span class="nc bnc" id="L941" title="All 2 branches missed.">                if(hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L942">                    setSelect(revenue[orCompIndex], revenueSelect[orCompIndex],</span>
                            directIncomeSelect[orCompIndex], directIncomeRevenue[orCompIndex], false);
                } else {
<span class="nc" id="L945">                setSelect(revenue[orCompIndex], revenueSelect[orCompIndex],</span>
                        false);
                }
            }

<span class="nc" id="L950">            orUIManager.processAction(command, executedActions);</span>
<span class="nc bnc" id="L951" title="All 2 branches missed.">        } else if (source == zoomIn) {</span>
<span class="nc" id="L952">            fitToWindow.setSelected(false);</span>
<span class="nc" id="L953">            fitToWidth.setSelected(false);</span>
<span class="nc" id="L954">            fitToHeight.setSelected(false);</span>
<span class="nc" id="L955">            orWindow.getMapPanel().zoom(true);</span>
<span class="nc bnc" id="L956" title="All 2 branches missed.">        } else if (source == zoomOut) {</span>
<span class="nc" id="L957">            fitToWindow.setSelected(false);</span>
<span class="nc" id="L958">            fitToWidth.setSelected(false);</span>
<span class="nc" id="L959">            fitToHeight.setSelected(false);</span>
<span class="nc" id="L960">            orWindow.getMapPanel().zoom(false);</span>
<span class="nc bnc" id="L961" title="All 2 branches missed.">        } else if (source == fitToWindow) {</span>
<span class="nc bnc" id="L962" title="All 2 branches missed.">            if (fitToWindow.isSelected()) {</span>
<span class="nc" id="L963">                fitToWidth.setSelected(false);</span>
<span class="nc" id="L964">                fitToHeight.setSelected(false);</span>
<span class="nc" id="L965">                orWindow.getMapPanel().fitToWindow();</span>
            } else {
<span class="nc" id="L967">                orWindow.getMapPanel().removeFitToOption();</span>
            }
<span class="nc bnc" id="L969" title="All 2 branches missed.">        } else if (source == fitToWidth) {</span>
<span class="nc bnc" id="L970" title="All 2 branches missed.">            if (fitToWidth.isSelected()) {</span>
<span class="nc" id="L971">                fitToWindow.setSelected(false);</span>
<span class="nc" id="L972">                fitToHeight.setSelected(false);</span>
<span class="nc" id="L973">                orWindow.getMapPanel().fitToWidth();</span>
            } else {
<span class="nc" id="L975">                orWindow.getMapPanel().removeFitToOption();</span>
            }
<span class="nc bnc" id="L977" title="All 2 branches missed.">        } else if (source == fitToHeight) {</span>
<span class="nc bnc" id="L978" title="All 2 branches missed.">            if (fitToHeight.isSelected()) {</span>
<span class="nc" id="L979">                fitToWindow.setSelected(false);</span>
<span class="nc" id="L980">                fitToWidth.setSelected(false);</span>
<span class="nc" id="L981">                orWindow.getMapPanel().fitToHeight();</span>
            } else {
<span class="nc" id="L983">                orWindow.getMapPanel().removeFitToOption();</span>
            }
<span class="nc bnc" id="L985" title="All 2 branches missed.">        } else if (source == calibrateMap) {</span>
<span class="nc" id="L986">            MapManager mapManager = orUIManager.getMap().getMapManager();</span>
<span class="nc" id="L987">            String offsetX = JOptionPane.showInputDialog(this, &quot;Change translation in X-dimension&quot;, mapManager.getMapXOffset());</span>
            try {
<span class="nc" id="L989">                mapManager.setMapXOffset(Integer.parseInt(offsetX));</span>
<span class="nc" id="L990">            } catch (NumberFormatException e) {} // do nothing</span>
<span class="nc" id="L991">            String offsetY = JOptionPane.showInputDialog(this, &quot;Change translation in Y-dimension&quot;, mapManager.getMapYOffset());</span>
            try {
<span class="nc" id="L993">                mapManager.setMapYOffset(Integer.parseInt(offsetY));</span>
<span class="nc" id="L994">            } catch (NumberFormatException e) {} // do nothing</span>
<span class="nc" id="L995">            String scale = JOptionPane.showInputDialog(this, &quot;Change scale&quot;, mapManager.getMapScale());</span>
            try {
<span class="nc" id="L997">                mapManager.setMapScale(Float.parseFloat(scale));</span>
<span class="nc" id="L998">            } catch (NumberFormatException e) {} // do nothing</span>
<span class="nc" id="L999">            orWindow.getMapPanel().zoom(true);</span>
<span class="nc" id="L1000">            orWindow.getMapPanel().zoom(false);</span>
<span class="nc bnc" id="L1001" title="All 2 branches missed.">        } else if (command == NETWORK_INFO_CMD) {</span>
<span class="nc" id="L1002">            JMenuItem item = (JMenuItem)actor.getSource();</span>
<span class="nc" id="L1003">            executeNetworkInfo(item.getText());</span>
<span class="nc" id="L1004">        } else {</span>
<span class="nc" id="L1005">            orUIManager.processAction(command, null);</span>
        }
<span class="nc" id="L1007">    }</span>



    public int getRevenue(int orCompIndex) {
<span class="nc" id="L1012">        return (Integer) revenueSelect[orCompIndex].getValue();</span>
    }

    public void setRevenue(int orCompIndex, int amount) {
        // TODO: the round reference is a workaround
<span class="nc" id="L1017">        revenue[orCompIndex].setText(orUIManager.getGameUIManager().format(amount));</span>
<span class="nc" id="L1018">    }</span>

    public void resetActions() {
<span class="nc" id="L1021">        tileCaption.setHighlight(false);</span>
<span class="nc" id="L1022">        tokenCaption.setHighlight(false);</span>
<span class="nc" id="L1023">        revenueCaption.setHighlight(false);</span>
<span class="nc bnc" id="L1024" title="All 2 branches missed.">        if(hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1025">            directIncomeCaption.setHighlight(false);</span>
        }
<span class="nc" id="L1027">        trainCaption.setHighlight(false);</span>
<span class="nc bnc" id="L1028" title="All 2 branches missed.">        if (privatesCanBeBought) privatesCaption.setHighlight(false);</span>
<span class="nc bnc" id="L1029" title="All 2 branches missed.">        for ( Field field : president ) {</span>
<span class="nc" id="L1030">            field.setHighlight(false);</span>
        }

<span class="nc bnc" id="L1033" title="All 2 branches missed.">        if (hasCompanyLoans) {</span>
<span class="nc" id="L1034">            loansCaption.setHighlight(false);</span>
        }

<span class="nc bnc" id="L1037" title="All 2 branches missed.">        for (JMenuItem item : menuItemsToReset) {</span>
<span class="nc" id="L1038">            item.setEnabled(false);</span>
<span class="nc bnc" id="L1039" title="All 2 branches missed.">            if (item instanceof ActionMenuItem) {</span>
<span class="nc" id="L1040">                ((ActionMenuItem)item).clearPossibleActions();</span>
            }
<span class="nc" id="L1042">        }</span>
<span class="nc" id="L1043">        undoButton.setEnabled(false);</span>

<span class="nc" id="L1045">        removeAllHighlights();</span>
<span class="nc" id="L1046">    }</span>

    public void resetORCompanyTurn(int orCompIndex) {
<span class="nc bnc" id="L1049" title="All 2 branches missed.">        for (int i = 0; i &lt; nc; i++) {</span>
<span class="nc bnc" id="L1050" title="All 2 branches missed.">            if (hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1051">                setSelect(revenue[i], revenueSelect[i], directIncomeSelect[i], directIncomeRevenue[i], false);</span>
            } else {
<span class="nc" id="L1053">            setSelect(revenue[i], revenueSelect[i], false);</span>
            }
        }
<span class="nc" id="L1056">    }</span>

    public void resetCurrentRevenueDisplay() {
<span class="nc bnc" id="L1059" title="All 2 branches missed.">        if (hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1060">            setSelect(revenue[orCompIndex], revenueSelect[orCompIndex],</span>
                    directIncomeSelect[orCompIndex], directIncomeRevenue[orCompIndex], false);
        } else {
<span class="nc" id="L1063">        setSelect(revenue[orCompIndex], revenueSelect[orCompIndex], false);</span>
        }
<span class="nc" id="L1065">    }</span>

    /**
     *
     * @return True if route should be displayed (at least for the set revenue step)
     */
    private boolean isDisplayRoutes() {
<span class="nc" id="L1072">        return (orUIManager.gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.ROUTE_HIGHLIGHT));</span>
    }

    private boolean isSuggestRevenue() {
<span class="nc" id="L1076">        return (orUIManager.gameUIManager.getGameParameterAsBoolean(GuiDef.Parm.REVENUE_SUGGEST));</span>
    }

    /**
     *
     * @return True if the routes of the currently active company should be displayed.
     * As a prerequisite of this feature, route highlighting has to be enabled/supported.
     */
    private boolean isDisplayCurrentRoutes() {
<span class="nc bnc" id="L1085" title="All 2 branches missed.">        return (isDisplayRoutes()</span>
<span class="nc bnc" id="L1086" title="All 2 branches missed.">                &amp;&amp; &quot;yes&quot;.equalsIgnoreCase(Config.get(&quot;map.displayCurrentRoutes&quot;)));</span>
    }

    /**
     * any routes currently displayed on the map are removed
     * In addition, revenue adapter and its thread are interrupted / removed.
     */
    private void disableRoutesDisplay() {
<span class="nc" id="L1094">        clearRevenueAdapter();</span>
<span class="nc" id="L1095">        orUIManager.getMap().setTrainPaths(null);</span>
<span class="nc" id="L1096">    }</span>

    private void clearRevenueAdapter() {
<span class="nc bnc" id="L1099" title="All 2 branches missed.">        if (revenueThread != null) {</span>
<span class="nc" id="L1100">            revenueThread.interrupt();</span>
<span class="nc" id="L1101">            revenueThread = null;</span>
        }
<span class="nc bnc" id="L1103" title="All 2 branches missed.">        if (revenueAdapter != null) {</span>
<span class="nc" id="L1104">            revenueAdapter.removeRevenueListener();</span>
<span class="nc" id="L1105">            revenueAdapter = null;</span>
        }
<span class="nc" id="L1107">    }</span>

    private void updateCurrentRoutes(boolean isSetRevenueStep) {

        // initialize and start the revenue adapter if routes to be displayed
        // or revenue to be suggested in the revenue step
<span class="nc bnc" id="L1113" title="All 6 branches missed.">        if (isDisplayCurrentRoutes() || (isSuggestRevenue() &amp;&amp; isSetRevenueStep)) {</span>

            //only consider revenue quantification for the set revenue step and only
            //if suggest option is on
<span class="nc bnc" id="L1117" title="All 2 branches missed.">            isRevenueValueToBeSet = isSetRevenueStep ? isSuggestRevenue() : false;</span>

<span class="nc" id="L1119">            RailsRoot root = orUIManager.getGameUIManager().getRoot();</span>
<span class="nc" id="L1120">            revenueAdapter = RevenueAdapter.createRevenueAdapter(root, orComp, root.getPhaseManager().getCurrentPhase());</span>
<span class="nc" id="L1121">            revenueAdapter.initRevenueCalculator(true);</span>
<span class="nc" id="L1122">            revenueAdapter.addRevenueListener(this);</span>
<span class="nc" id="L1123">            revenueThread = new Thread(revenueAdapter);</span>
<span class="nc" id="L1124">            revenueThread.start();</span>
<span class="nc" id="L1125">        } else {</span>

            //remove current routes also if display option is not active
            //(as it could have just been turned off)
<span class="nc" id="L1129">            clearRevenueAdapter();</span>
<span class="nc" id="L1130">            disableRoutesDisplay();</span>
        }

<span class="nc" id="L1133">    }</span>

    public void initORCompanyTurn(PublicCompany orComp, int orCompIndex) {

<span class="nc" id="L1137">        this.orComp = orComp;</span>
<span class="nc" id="L1138">        this.orCompIndex = orCompIndex;</span>
<span class="nc" id="L1139">        president[orCompIndex].setHighlight(true);</span>

<span class="nc" id="L1141">        removeAllHighlights();</span>

<span class="nc" id="L1143">        buttonOC.clearPossibleActions();</span>
<span class="nc" id="L1144">        button1.clearPossibleActions();</span>
<span class="nc" id="L1145">        button2.clearPossibleActions();</span>
<span class="nc" id="L1146">        button3.clearPossibleActions();</span>

<span class="nc" id="L1148">        buttonOC.setEnabled(false);</span>
<span class="nc" id="L1149">        button1.setEnabled(false);</span>
<span class="nc" id="L1150">        button2.setEnabled(false);</span>
<span class="nc" id="L1151">        button3.setEnabled(false);</span>

<span class="nc" id="L1153">        updateCurrentRoutes(false);</span>
<span class="nc" id="L1154">    }</span>

    public void initTileLayingStep() {

<span class="nc" id="L1158">        tileCaption.setHighlight(true);</span>
<span class="nc" id="L1159">        setHighlight(tiles[orCompIndex],true);</span>
<span class="nc" id="L1160">        setHighlight(tileCost[orCompIndex],true);</span>
<span class="nc" id="L1161">        button1.setVisible(false);</span>

<span class="nc" id="L1163">        setCompanyVisibility(false);</span>
<span class="nc" id="L1164">    }</span>

    public void initTokenLayingStep() {

<span class="nc" id="L1168">        tokenCaption.setHighlight(true);</span>
<span class="nc" id="L1169">        setHighlight(tokens[orCompIndex],true);</span>
<span class="nc" id="L1170">        setHighlight(tokenCost[orCompIndex],true);</span>
<span class="nc" id="L1171">        setHighlight(tokensLeft[orCompIndex],true);</span>
<span class="nc bnc" id="L1172" title="All 2 branches missed.">        if (tokenBonus != null) setHighlight(tokenBonus[orCompIndex],true);</span>
<span class="nc" id="L1173">        button1.setEnabled(false);</span>
<span class="nc" id="L1174">        button1.setVisible(false);</span>
<span class="nc" id="L1175">        button3.setEnabled(false);</span>

<span class="nc" id="L1177">        setCompanyVisibility(false);</span>
<span class="nc" id="L1178">    }</span>

    public void initRevenueEntryStep(int orCompIndex, SetDividend action) {

<span class="nc" id="L1182">        revenueCaption.setHighlight(true);</span>
<span class="nc" id="L1183">        setHighlight(revenueSelect[orCompIndex],true);</span>
<span class="nc" id="L1184">        revenueSelect[orCompIndex].setValue(action.getPresetRevenue());</span>
<span class="nc bnc" id="L1185" title="All 2 branches missed.">        if ( hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1186">            directIncomeSelect[orCompIndex].setValue(action.getPresetCompanyTreasuryRevenue());</span>
<span class="nc" id="L1187">            setSelect(revenue[orCompIndex], revenueSelect[orCompIndex], directIncomeSelect[orCompIndex], directIncomeRevenue[orCompIndex], true);</span>
        } else {
<span class="nc" id="L1189">        setSelect(revenue[orCompIndex], revenueSelect[orCompIndex],true);</span>
        }
<span class="nc" id="L1191">        button1.setRailsIcon(RailsIcon.SET_REVENUE);</span>
<span class="nc" id="L1192">        button1.setActionCommand(SET_REVENUE_CMD);</span>
<span class="nc" id="L1193">        button1.setPossibleAction(action);</span>
<span class="nc" id="L1194">        button1.setMnemonic(KeyEvent.VK_R);</span>
<span class="nc" id="L1195">        button1.setEnabled(true);</span>
<span class="nc" id="L1196">        button1.setVisible(true);</span>

        //indicate interest in setting revenue values (and not only displaying routes)
<span class="nc" id="L1199">        updateCurrentRoutes(true);</span>

<span class="nc" id="L1201">        setCompanyVisibility(false);</span>

<span class="nc" id="L1203">    }</span>

    public void revenueUpdate(int bestRevenue, boolean finalResult) {
<span class="nc bnc" id="L1206" title="All 2 branches missed.">        if (isRevenueValueToBeSet) {</span>
<span class="nc" id="L1207">            revenueSelect[orCompIndex].setValue(bestRevenue);</span>
            /**
             * This needs to have another value for the automatic setting of a Direct Income for a Company
             */
<span class="nc bnc" id="L1211" title="All 2 branches missed.">            if(hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1212">                directIncomeSelect[orCompIndex].setValue(0);</span>
            }
        }
<span class="nc bnc" id="L1215" title="All 2 branches missed.">        if (finalResult) {</span>
<span class="nc" id="L1216">            orUIManager.getMap().setTrainPaths(null);</span>
            //try-catch clause temporary workaround as revenue adapter's
            //convertRcRun might erroneously raise exceptions
            //leaving on exception is admissible as exception only occur
            //if revenue would be 0.
            try {
<span class="nc" id="L1222">                revenueAdapter.drawOptimalRunAsPath(orUIManager.getMap());</span>

<span class="nc bnc" id="L1224" title="All 2 branches missed.">                if (isRevenueValueToBeSet) {</span>
<span class="nc" id="L1225">                    orUIManager.getMessagePanel().setInformation(&quot;Best Run Value = &quot; + bestRevenue +</span>
<span class="nc" id="L1226">                            &quot; with &quot; + Util.convertToHtml(revenueAdapter.getOptimalRunPrettyPrint(false)));</span>
<span class="nc" id="L1227">                    orUIManager.getMessagePanel().setDetail(</span>
<span class="nc" id="L1228">                            Util.convertToHtml(revenueAdapter.getOptimalRunPrettyPrint(true)));</span>
                }
            }
<span class="nc" id="L1231">            catch (Exception e) {}</span>
        }
<span class="nc" id="L1233">    }</span>

    public void stopRevenueUpdate() {
<span class="nc" id="L1236">        isRevenueValueToBeSet = false;</span>
<span class="nc" id="L1237">    }</span>


    public void initPayoutStep(int orCompIndex, SetDividend action,
            boolean withhold, boolean split, boolean payout) {

<span class="nc" id="L1243">        setHighlight(decision[orCompIndex],true);</span>

        SetDividend clonedAction;
<span class="nc bnc" id="L1246" title="All 2 branches missed.">        if(hasDirectCompanyIncomeInOr) {</span>
<span class="nc" id="L1247">            setSelect(revenue[orCompIndex], revenueSelect[orCompIndex],</span>
                    directIncomeSelect[orCompIndex], directIncomeRevenue[orCompIndex], false);
        } else {
<span class="nc" id="L1250">        setSelect(revenue[orCompIndex], revenueSelect[orCompIndex], false);</span>
        }
<span class="nc bnc" id="L1252" title="All 2 branches missed.">        if (withhold) {</span>
<span class="nc" id="L1253">            button1.setRailsIcon(RailsIcon.WITHHOLD);</span>
<span class="nc" id="L1254">            button1.setActionCommand(WITHHOLD_CMD);</span>
<span class="nc" id="L1255">            clonedAction = (SetDividend) action.clone();</span>
<span class="nc" id="L1256">            clonedAction.setRevenueAllocation(SetDividend.WITHHOLD);</span>
<span class="nc" id="L1257">            button1.setPossibleAction(clonedAction);</span>
<span class="nc" id="L1258">            button1.setMnemonic(KeyEvent.VK_W);</span>
<span class="nc" id="L1259">            button1.setEnabled(true);</span>
<span class="nc" id="L1260">            button1.setVisible(true);</span>
        } else {
<span class="nc" id="L1262">            button1.setVisible(false);</span>
        }

<span class="nc bnc" id="L1265" title="All 2 branches missed.">        if (split) {</span>
<span class="nc" id="L1266">            button2.setRailsIcon(RailsIcon.SPLIT);</span>
<span class="nc" id="L1267">            button2.setActionCommand(SPLIT_CMD);</span>
<span class="nc" id="L1268">            clonedAction = (SetDividend) action.clone();</span>
<span class="nc" id="L1269">            clonedAction.setRevenueAllocation(SetDividend.SPLIT);</span>
<span class="nc" id="L1270">            button2.setPossibleAction(clonedAction);</span>
<span class="nc" id="L1271">            button2.setMnemonic(KeyEvent.VK_S);</span>
<span class="nc" id="L1272">            button2.setEnabled(true);</span>
<span class="nc" id="L1273">            button2.setVisible(true);</span>
        } else {
<span class="nc" id="L1275">            button2.setVisible(false);</span>
        }

<span class="nc bnc" id="L1278" title="All 2 branches missed.">        if (payout) {</span>
<span class="nc" id="L1279">            button3.setRailsIcon(RailsIcon.PAYOUT);</span>
<span class="nc" id="L1280">            button3.setActionCommand(PAYOUT_CMD);</span>
<span class="nc" id="L1281">            clonedAction = (SetDividend) action.clone();</span>
<span class="nc" id="L1282">            clonedAction.setRevenueAllocation(SetDividend.PAYOUT);</span>
<span class="nc" id="L1283">            button3.setPossibleAction(clonedAction);</span>
<span class="nc" id="L1284">            button3.setMnemonic(KeyEvent.VK_P);</span>
<span class="nc" id="L1285">            button3.setEnabled(true);</span>
        } else {
<span class="nc" id="L1287">            button3.setVisible(false);</span>
        }

<span class="nc" id="L1290">        setCompanyVisibility(false);</span>
<span class="nc" id="L1291">    }</span>

    public void initTrainBuying(boolean enabled) {

<span class="nc" id="L1295">        trainCaption.setHighlight(true);</span>
<span class="nc" id="L1296">        setHighlight(trains[orCompIndex],true);</span>
<span class="nc" id="L1297">        setHighlight(newTrainCost[orCompIndex],true);</span>

<span class="nc" id="L1299">        button1.setRailsIcon(RailsIcon.BUY_TRAIN);</span>
<span class="nc" id="L1300">        button1.setActionCommand(BUY_TRAIN_CMD);</span>
<span class="nc" id="L1301">        button1.setMnemonic(KeyEvent.VK_T);</span>
<span class="nc" id="L1302">        button1.setEnabled(enabled);</span>
<span class="nc" id="L1303">        button1.setVisible(true);</span>

<span class="nc" id="L1305">        setCompanyVisibility(true);</span>
<span class="nc" id="L1306">    }</span>

    // operating costs sfy
    public void initOperatingCosts(boolean enabled) {

<span class="nc" id="L1311">        buttonOC.setEnabled(enabled);</span>
<span class="nc" id="L1312">        buttonOC.setVisible(enabled);</span>
<span class="nc" id="L1313">        tileCaption.setHighlight(enabled);</span>
<span class="nc" id="L1314">        tokenCaption.setHighlight(enabled);</span>
<span class="nc" id="L1315">    }</span>


    public void initPrivateBuying(boolean enabled) {

<span class="nc bnc" id="L1320" title="All 2 branches missed.">        if (privatesCanBeBought) {</span>
<span class="nc bnc" id="L1321" title="All 2 branches missed.">            if (enabled) {</span>
<span class="nc" id="L1322">                button2.setRailsIcon(RailsIcon.BUY_PRIVATE);</span>
<span class="nc" id="L1323">                button2.setActionCommand(BUY_PRIVATE_CMD);</span>
<span class="nc" id="L1324">                button2.setMnemonic(KeyEvent.VK_V);</span>
            }
<span class="nc" id="L1326">            button2.setEnabled(enabled);</span>
<span class="nc" id="L1327">            button2.setVisible(enabled);</span>
<span class="nc" id="L1328">            privatesCaption.setHighlight(enabled);</span>
<span class="nc" id="L1329">            setHighlight(privates[orCompIndex],enabled);</span>
        } else {
<span class="nc" id="L1331">            button2.setVisible(false);</span>
        }
<span class="nc" id="L1333">    }</span>

    public void initSpecialActions() {

<span class="nc" id="L1337">        specialMenu.removeAll();</span>
<span class="nc" id="L1338">        specialMenu.setEnabled(false);</span>
<span class="nc" id="L1339">        specialMenu.setOpaque(false);</span>
<span class="nc" id="L1340">    }</span>

    public void addSpecialAction(PossibleAction action, String text) {

<span class="nc" id="L1344">        ActionMenuItem item = new ActionMenuItem(text);</span>
<span class="nc" id="L1345">        item.addActionListener(this);</span>
<span class="nc" id="L1346">        item.addPossibleAction(action);</span>
<span class="nc" id="L1347">        specialMenu.add(item);</span>
<span class="nc" id="L1348">        specialMenu.setEnabled(true);</span>
<span class="nc" id="L1349">        specialMenu.setOpaque(true);</span>
<span class="nc" id="L1350">    }</span>

    public void enableDone(NullAction action) {

<span class="nc" id="L1354">        button3.setRailsIcon(RailsIcon.DONE);</span>
<span class="nc" id="L1355">        button3.setActionCommand(DONE_CMD);</span>
<span class="nc" id="L1356">        button3.setMnemonic(KeyEvent.VK_D);</span>
<span class="nc" id="L1357">        button3.setPossibleAction(action);</span>
<span class="nc" id="L1358">        button3.setEnabled(true);</span>
<span class="nc" id="L1359">    }</span>

    public void enableUndo(GameAction action) {
<span class="nc bnc" id="L1362" title="All 2 branches missed.">        undoButton.setEnabled(action != null);</span>
<span class="nc bnc" id="L1363" title="All 2 branches missed.">        if (action != null) undoButton.setPossibleAction(action);</span>
<span class="nc" id="L1364">    }</span>

    public void enableRedo(GameAction action) {
<span class="nc bnc" id="L1367" title="All 2 branches missed.">        redoButton.setEnabled(action != null);</span>
<span class="nc bnc" id="L1368" title="All 2 branches missed.">        if (action != null) redoButton.setPossibleAction(action);</span>
<span class="nc" id="L1369">    }</span>

    public void enableLoanTaking (TakeLoans action) {
<span class="nc bnc" id="L1372" title="All 2 branches missed.">        if (action != null) takeLoans.addPossibleAction(action);</span>
<span class="nc bnc" id="L1373" title="All 2 branches missed.">        takeLoans.setEnabled(action != null);</span>
<span class="nc" id="L1374">    }</span>

    public void enableLoanRepayment (RepayLoans action) {

<span class="nc" id="L1378">        repayLoans.setPossibleAction(action);</span>
<span class="nc" id="L1379">        repayLoans.setEnabled(true);</span>

<span class="nc" id="L1381">        loansCaption.setHighlight(true);</span>
<span class="nc" id="L1382">        setHighlight(compLoans[orCompIndex],true);</span>

<span class="nc" id="L1384">        button1.setRailsIcon(RailsIcon.REPAY_LOANS);</span>
<span class="nc" id="L1385">        button1.setActionCommand(REPAY_LOANS_CMD);</span>
<span class="nc" id="L1386">        button1.setPossibleAction(action);</span>
<span class="nc" id="L1387">        button1.setMnemonic(KeyEvent.VK_R);</span>
<span class="nc" id="L1388">        button1.setEnabled(true);</span>
<span class="nc" id="L1389">        button1.setVisible(true);</span>
<span class="nc" id="L1390">    }</span>

    public void disableButtons () {
<span class="nc" id="L1393">        button1.setEnabled(false);</span>
<span class="nc" id="L1394">        button2.setEnabled(false);</span>
<span class="nc" id="L1395">        button3.setEnabled(false);</span>
<span class="nc" id="L1396">        undoButton.setEnabled(false);</span>
<span class="nc" id="L1397">        redoButton.setEnabled(false);</span>
<span class="nc" id="L1398">    }</span>

    public void finishORCompanyTurn(int orCompIndex) {
        //clear all highlighting (president column and beyond)
<span class="nc" id="L1402">        resetActions();</span>

<span class="nc" id="L1404">        button1.setEnabled(false);</span>

<span class="nc" id="L1406">        orUIManager.getMap().setTrainPaths(null);</span>
<span class="nc" id="L1407">    }</span>

    // TEMPORARY
    public PublicCompany getORComp() {
<span class="nc" id="L1411">        return orComp;</span>
    }

    public String getORPlayer() {
<span class="nc bnc" id="L1415" title="All 2 branches missed.">        if (playerIndex &gt;= 0)</span>
<span class="nc" id="L1416">            return players[playerIndex].getId();</span>
        else
<span class="nc" id="L1418">            return &quot;&quot;;</span>
    }

    private void setSelect(JComponent f, JComponent s, boolean active) {
<span class="nc bnc" id="L1422" title="All 2 branches missed.">        f.setVisible(!active);</span>
<span class="nc" id="L1423">        s.setVisible(active);</span>
<span class="nc" id="L1424">    }</span>

    private void setSelect(JComponent f, JComponent s, JComponent s2,
            JComponent f2, boolean active) {
<span class="nc bnc" id="L1428" title="All 2 branches missed.">        f.setVisible(!active);</span>
<span class="nc" id="L1429">        s.setVisible(active);</span>
<span class="nc bnc" id="L1430" title="All 2 branches missed.">        f2.setVisible(!active);</span>
<span class="nc" id="L1431">        s2.setVisible(active);</span>

<span class="nc" id="L1433">    }</span>

    public PublicCompany[] getOperatingCompanies() {
<span class="nc" id="L1436">        return companies;</span>
    }

    public JPanel getButtonPanel() {
<span class="nc" id="L1440">        return buttonPanel;</span>
    }

    public JMenuBar getMenuBar() {
<span class="nc" id="L1444">        return menuBar;</span>
    }

    /**
     * Adds buttons to the button panel (adjusting their size to the standard size)
     * @param index The position where to add the buttons
     */
    public void addToButtonPanel(RailsIconButton[] buttons, int index) {
        //get standard size
<span class="nc" id="L1453">        Dimension standardSize = null;</span>
<span class="nc" id="L1454">        Component[] existingButtons = buttonPanel.getComponents();</span>
<span class="nc bnc" id="L1455" title="All 4 branches missed.">        if (existingButtons != null &amp;&amp; existingButtons.length &gt; 0) {</span>
<span class="nc" id="L1456">            standardSize = existingButtons[0].getPreferredSize();</span>
        }

        //apply sizing to new buttons
        //add buttons to the panel
<span class="nc bnc" id="L1461" title="All 2 branches missed.">        for (int i=buttons.length-1 ; i &gt;= 0 ; i--) {</span>
<span class="nc" id="L1462">            buttons[i].setPreferredSize(standardSize);</span>
<span class="nc" id="L1463">            buttonPanel.add(buttons[i],index);</span>
        }
<span class="nc" id="L1465">    }</span>

    private void setCompanyVisibility(boolean showAll) {
<span class="nc bnc" id="L1468" title="All 2 branches missed.">        for (int i = 0; i &lt; nc; i++) {</span>
<span class="nc bnc" id="L1469" title="All 6 branches missed.">            boolean visible = rowVisibilityObservers[i].lastValue() &amp;&amp; (showAll || (i == orCompIndex));</span>
<span class="nc" id="L1470">            setRowVisibility(i + leftCompNameYOffset, visible);</span>
        }
<span class="nc" id="L1472">    }</span>

    public int getCompanyTreasuryBonusRevenue(int orCompIndex) {
<span class="nc" id="L1475">        return ((Integer) directIncomeSelect[orCompIndex].getValue()).intValue();</span>
    }

    public void setTreasuryBonusRevenue(int orCompIndex2, int bonusAmount) {
<span class="nc" id="L1479">        directIncomeRevenue[orCompIndex2].setText(orUIManager.getGameUIManager().format(bonusAmount));</span>

<span class="nc" id="L1481">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>