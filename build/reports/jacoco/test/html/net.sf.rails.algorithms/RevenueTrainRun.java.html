<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>RevenueTrainRun.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.algorithms</a> &gt; <span class="el_source">RevenueTrainRun.java</span></div><h1>RevenueTrainRun.java</h1><pre class="source lang-java linenums">package net.sf.rails.algorithms;

import java.awt.geom.GeneralPath;
import java.awt.geom.Point2D;
import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Map;
import java.util.Set;

import net.sf.rails.algorithms.NetworkVertex.StationType;
import net.sf.rails.algorithms.NetworkVertex.VertexType;
import net.sf.rails.common.LocalText;
import net.sf.rails.ui.swing.hexmap.HexMap;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Links the results from the revenue calculator to the rails program Each
 * object defines the run of one train
 *
 */
public class RevenueTrainRun implements Comparable&lt;RevenueTrainRun&gt; {

    private static final int PRETTY_PRINT_LENGTH = 100;
    private static final int PRETTY_PRINT_INDENT = 10;

<span class="nc" id="L29">    private static final Logger log =</span>
<span class="nc" id="L30">            LoggerFactory.getLogger(RevenueTrainRun.class);</span>

    // definitions
    private RevenueAdapter revenueAdapter;
    private NetworkTrain train;

    // converted data
    private List&lt;NetworkVertex&gt; vertices;
    private List&lt;NetworkEdge&gt; edges;

<span class="nc" id="L40">    RevenueTrainRun(RevenueAdapter revenueAdapter, NetworkTrain train) {</span>
<span class="nc" id="L41">        this.revenueAdapter = revenueAdapter;</span>
<span class="nc" id="L42">        this.train = train;</span>
<span class="nc" id="L43">        vertices = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L44">        edges = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L45">    }</span>

    public List&lt;NetworkVertex&gt; getRunVertices() {
<span class="nc" id="L48">        return vertices;</span>
    }

    /**
     * returns true if train has a valid run (at least two vertices)
     */
    public boolean hasAValidRun() {
<span class="nc bnc" id="L55" title="All 2 branches missed.">        return vertices.size() &gt;= 2;</span>
    }

    /**
     * returns the vertex of the initial base token of the train run
     */
    public NetworkVertex getBaseVertex() {
<span class="nc" id="L62">        return vertices.get(0);</span>
    }

    /**
     * returns the first vertex of a train run
     */
    public NetworkVertex getFirstVertex() {
<span class="nc" id="L69">        NetworkVertex startVertex = null;</span>
<span class="nc" id="L70">        NetworkVertex firstVertex = null;</span>
<span class="nc bnc" id="L71" title="All 2 branches missed.">        for (NetworkVertex vertex : vertices) {</span>
<span class="nc bnc" id="L72" title="All 2 branches missed.">            if (startVertex == vertex) return firstVertex;</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">            if (startVertex == null) startVertex = vertex;</span>
<span class="nc" id="L74">            firstVertex = vertex;</span>
<span class="nc" id="L75">        }</span>
<span class="nc" id="L76">        return startVertex;</span>
    }

    /**
     * returns the last vertex of a train run
     */
    public NetworkVertex getLastVertex() {
<span class="nc" id="L83">        return vertices.get(vertices.size() - 1);</span>
    }

    public Set&lt;NetworkVertex&gt; getUniqueVertices() {
<span class="nc" id="L87">        return new HashSet&lt;NetworkVertex&gt;(vertices);</span>
    }

    public NetworkTrain getTrain() {
<span class="nc" id="L91">        return train;</span>
    }

    /**
     * @param listOfVertices defines a sublist of vertices that are used to calculate the run value
     * @return total value of the vertices in the list
     * This includes all revenue bonuses defined in the calculator
     */
    public int getRunValueForVertices(List&lt;NetworkVertex&gt; listOfVertices) {
<span class="nc" id="L100">        int value = 0;</span>
<span class="nc" id="L101">        NetworkVertex startVertex = null;</span>
<span class="nc bnc" id="L102" title="All 2 branches missed.">        for (NetworkVertex vertex : listOfVertices) {</span>
<span class="nc bnc" id="L103" title="All 2 branches missed.">            if (startVertex == vertex) continue;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">            if (startVertex == null) startVertex = vertex;</span>
<span class="nc" id="L105">            value +=</span>
<span class="nc" id="L106">                    revenueAdapter.getVertexValue(vertex, train,</span>
<span class="nc" id="L107">                            revenueAdapter.getPhase());</span>
<span class="nc" id="L108">        }</span>
        // check revenueBonuses (complex)
<span class="nc bnc" id="L110" title="All 2 branches missed.">        for (RevenueBonus bonus : revenueAdapter.getRevenueBonuses()) {</span>
<span class="nc bnc" id="L111" title="All 2 branches missed.">            if (bonus.checkComplexBonus(listOfVertices, train.getRailsTrain(),</span>
<span class="nc" id="L112">                    revenueAdapter.getPhase())) {</span>
<span class="nc" id="L113">                value += bonus.getValue();</span>
            }
<span class="nc" id="L115">        }</span>
<span class="nc" id="L116">        return value;</span>
    }

    public int getRunValue() {
<span class="nc" id="L120">        return getRunValueForVertices(vertices);</span>
    }

    boolean hasButtomRun() {
<span class="nc" id="L124">        boolean buttomRun = false;</span>
<span class="nc" id="L125">        NetworkVertex startVertex = null;</span>
<span class="nc bnc" id="L126" title="All 2 branches missed.">        for (NetworkVertex vertex : vertices) {</span>
<span class="nc bnc" id="L127" title="All 2 branches missed.">            if (startVertex == vertex) buttomRun = true;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">            if (startVertex == null) startVertex = vertex;</span>
<span class="nc" id="L129">        }</span>
<span class="nc" id="L130">        return buttomRun;</span>
    }

    void addVertex(NetworkVertex vertex) {
<span class="nc" id="L134">        vertices.add(vertex);</span>
<span class="nc" id="L135">    }</span>

    void addEdge(NetworkEdge edge) {
<span class="nc" id="L138">        edges.add(edge);</span>
<span class="nc" id="L139">    }</span>

    /** defines the vertices from the list of edges */
    void convertEdgesToVertices() {
<span class="nc" id="L143">        vertices = new ArrayList&lt;NetworkVertex&gt;();</span>

        // check for empty edges
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (edges.size() == 0) {</span>
<span class="nc" id="L147">            return;</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        } else if (edges.size() == 1) {</span>
            // and for 1-edge routes
<span class="nc" id="L150">            vertices.add(edges.get(0).getSource());</span>
<span class="nc" id="L151">            vertices.add(edges.get(0).getTarget());</span>
<span class="nc" id="L152">            return;</span>
        }

        // figure out, what are the vertices contained
<span class="nc" id="L156">        NetworkEdge previousEdge = null;</span>
<span class="nc" id="L157">        NetworkVertex startVertex = null;</span>
<span class="nc bnc" id="L158" title="All 2 branches missed.">        for (NetworkEdge edge : edges) {</span>
<span class="nc" id="L159">            log.debug(&quot;Processing edge {}&quot;, edge.toFullInfoString());</span>
            // process startEdge
<span class="nc bnc" id="L161" title="All 2 branches missed.">            if (previousEdge == null) {</span>
<span class="nc" id="L162">                previousEdge = edge;</span>
<span class="nc" id="L163">                continue;</span>
            }
            // check if the current edge has a common vertex with the previous
            // one =&gt; continuous route
<span class="nc" id="L167">            NetworkVertex commonVertex = edge.getCommonVertex(previousEdge);</span>
            // identify start vertex first
<span class="nc bnc" id="L169" title="All 2 branches missed.">            if (startVertex == null) {</span>
                // if there is a joint route =&gt; other vertex of previousEdge
<span class="nc bnc" id="L171" title="All 2 branches missed.">                if (commonVertex != null) {</span>
<span class="nc" id="L172">                    log.debug(&quot;Head Run&quot;);</span>
<span class="nc" id="L173">                    startVertex = previousEdge.getOtherVertex(commonVertex);</span>
<span class="nc" id="L174">                    vertices.add(startVertex);</span>
<span class="nc" id="L175">                    vertices.add(commonVertex);</span>
                } else {
                    // otherwise it is a mistake
<span class="nc" id="L178">                    log.error(&quot;Error in revenue train run: cannot identify startVertex&quot;);</span>
                }
            } else { // start vertex is known
                // if there is a common vertex =&gt; continuous route
<span class="nc bnc" id="L182" title="All 2 branches missed.">                if (commonVertex != null) {</span>
<span class="nc" id="L183">                    log.debug(&quot;Added common vertex&quot;);</span>
<span class="nc" id="L184">                    vertices.add(commonVertex);</span>
                } else {
                    // otherwise it is bottom run
                    // add the last vertex of the head train
<span class="nc" id="L188">                    log.debug(&quot;Bottom Run&quot;);</span>
<span class="nc" id="L189">                    vertices.add(previousEdge.getOtherVertex(vertices.get(vertices.size() - 1)));</span>
<span class="nc" id="L190">                    vertices.add(startVertex);</span>
                }
            }
<span class="nc" id="L193">            previousEdge = edge;</span>
<span class="nc" id="L194">        }</span>
        // add the last vertex of the route
<span class="nc" id="L196">        vertices.add(previousEdge.getOtherVertex(vertices.get(vertices.size() - 1)));</span>
<span class="nc" id="L197">        log.debug(&quot;Converted edges to vertices {}&quot;, vertices);</span>
<span class="nc" id="L198">    }</span>

    /** defines the edges from the list of vertices */
    void convertVerticesToEdges() {
<span class="nc" id="L202">        edges = new ArrayList&lt;NetworkEdge&gt;();</span>

        // check for empty or only one vertices
<span class="nc bnc" id="L205" title="All 2 branches missed.">        if (vertices.size() &lt;= 1) {</span>
<span class="nc" id="L206">            return;</span>
        }

<span class="nc" id="L209">        NetworkVertex startVertex = null;</span>
<span class="nc" id="L210">        NetworkVertex previousVertex = null;</span>
<span class="nc bnc" id="L211" title="All 2 branches missed.">        for (NetworkVertex vertex : vertices) {</span>
<span class="nc bnc" id="L212" title="All 2 branches missed.">            if (startVertex == null) {</span>
<span class="nc" id="L213">                startVertex = vertex;</span>
<span class="nc" id="L214">                previousVertex = vertex;</span>
<span class="nc" id="L215">                continue;</span>
            }
            // return to startVertex needs no edge
<span class="nc bnc" id="L218" title="All 2 branches missed.">            if (vertex != startVertex) {</span>
<span class="nc" id="L219">                NetworkEdge edge =</span>
<span class="nc" id="L220">                        revenueAdapter.getRCGraph().getEdge(previousVertex,</span>
                                vertex);
<span class="nc bnc" id="L222" title="All 2 branches missed.">                if (edge != null) {</span>
                    // found edge between vertices
<span class="nc" id="L224">                    edges.add(edge);</span>
                } else {
                    // otherwise it is a mistake
<span class="nc" id="L227">                    log.error(&quot;Error in revenue train run: cannot find according edge&quot;);</span>
                }
            }
<span class="nc" id="L230">            previousVertex = vertex;</span>
<span class="nc" id="L231">        }</span>
<span class="nc" id="L232">    }</span>

    private String prettyPrintHexName(NetworkVertex vertex) {
<span class="nc bnc" id="L235" title="All 2 branches missed.">        if (vertex.isVirtual()) {</span>
<span class="nc" id="L236">            return vertex.getIdentifier();</span>
        } else {
<span class="nc" id="L238">            return vertex.getHex().getId();</span>
        }
    }

    private int prettyPrintNewLine(StringBuilder runPrettyPrint, int multiple,
            int initLength) {
<span class="nc" id="L244">        int length = runPrettyPrint.length() - initLength;</span>
<span class="nc bnc" id="L245" title="All 2 branches missed.">        if (length / PRETTY_PRINT_LENGTH != multiple) {</span>
<span class="nc" id="L246">            multiple = length / PRETTY_PRINT_LENGTH;</span>
<span class="nc" id="L247">            runPrettyPrint.append(&quot;\n&quot;);</span>
<span class="nc bnc" id="L248" title="All 2 branches missed.">            for (int i = 0; i &lt; PRETTY_PRINT_INDENT; i++)</span>
<span class="nc" id="L249">                runPrettyPrint.append(&quot; &quot;);</span>
        }
<span class="nc" id="L251">        return multiple;</span>
    }

    public String prettyPrint(boolean includeDetails) {
<span class="nc" id="L255">        StringBuilder runPrettyPrint = new StringBuilder();</span>
<span class="nc" id="L256">        runPrettyPrint.append(LocalText.getText(&quot;N_Train&quot;, train.toString()));</span>
<span class="nc" id="L257">        runPrettyPrint.append(&quot; = &quot;).append(getRunValue());</span>
<span class="nc bnc" id="L258" title="All 2 branches missed.">        if (includeDetails) {</span>
            // details of the run
<span class="nc" id="L260">            Set&lt;NetworkVertex&gt; uniqueVertices = getUniqueVertices();</span>
<span class="nc" id="L261">            int majors =</span>
<span class="nc" id="L262">                    NetworkVertex.numberOfVertexType(uniqueVertices,</span>
                            VertexType.STATION, StationType.MAJOR);
<span class="nc" id="L264">            int minors =</span>
<span class="nc" id="L265">                    NetworkVertex.numberOfVertexType(uniqueVertices,</span>
                            VertexType.STATION, StationType.MINOR);
<span class="nc bnc" id="L267" title="All 4 branches missed.">            if (train.ignoresMinors() || minors == 0) {</span>
<span class="nc" id="L268">                runPrettyPrint.append(LocalText.getText(</span>
<span class="nc" id="L269">                        &quot;RevenueStationsIgnoreMinors&quot;, majors));</span>
            } else {
<span class="nc" id="L271">                runPrettyPrint.append(LocalText.getText(&quot;RevenueStations&quot;,</span>
<span class="nc" id="L272">                        majors, minors));</span>
            }
<span class="nc" id="L274">            int initLength = runPrettyPrint.length();</span>
<span class="nc" id="L275">            int multiple = prettyPrintNewLine(runPrettyPrint, -1, initLength);</span>
<span class="nc" id="L276">            String currentHexName = null;</span>
<span class="nc" id="L277">            NetworkVertex startVertex = null;</span>
<span class="nc bnc" id="L278" title="All 2 branches missed.">            for (NetworkVertex vertex : vertices) {</span>
<span class="nc bnc" id="L279" title="All 2 branches missed.">                if (startVertex == null) {</span>
<span class="nc" id="L280">                    currentHexName = prettyPrintHexName(vertex);</span>
<span class="nc" id="L281">                    startVertex = vertex;</span>
<span class="nc" id="L282">                    runPrettyPrint.append(prettyPrintHexName(vertex)).append(&quot;(&quot;);</span>
<span class="nc bnc" id="L283" title="All 2 branches missed.">                } else if (startVertex == vertex) {</span>
<span class="nc" id="L284">                    currentHexName = prettyPrintHexName(vertex);</span>
<span class="nc" id="L285">                    runPrettyPrint.append(&quot;) / &quot;);</span>
<span class="nc" id="L286">                    multiple =</span>
<span class="nc" id="L287">                            prettyPrintNewLine(runPrettyPrint, multiple,</span>
                                    initLength);
<span class="nc" id="L289">                    runPrettyPrint.append(prettyPrintHexName(vertex)).append(&quot;(0&quot;);</span>
<span class="nc" id="L290">                    continue;</span>
<span class="nc bnc" id="L291" title="All 2 branches missed.">                } else if (!currentHexName.equals(prettyPrintHexName(vertex))) {</span>
<span class="nc" id="L292">                    currentHexName = prettyPrintHexName(vertex);</span>
<span class="nc" id="L293">                    runPrettyPrint.append(&quot;), &quot;);</span>
<span class="nc" id="L294">                    multiple =</span>
<span class="nc" id="L295">                            prettyPrintNewLine(runPrettyPrint, multiple,</span>
                                    initLength);
<span class="nc" id="L297">                    runPrettyPrint.append(prettyPrintHexName(vertex)).append(&quot;(&quot;);</span>
                } else {
<span class="nc" id="L299">                    runPrettyPrint.append(&quot;,&quot;);</span>
                }
                // TODO: Allow more options for pretty print, depending on route
                // structure etc.
<span class="nc" id="L303">                runPrettyPrint.append(revenueAdapter.getVertexValueAsString(</span>
<span class="nc" id="L304">                        vertex, train, revenueAdapter.getPhase()));</span>
                // if (vertex.isStation()) {
                // runPrettyPrint.append(revenueAdapter.getVertexValueAsString(vertex,
                // train, revenueAdapter.getPhase()));
                // } else {
                // runPrettyPrint.append(vertex.getHex().getOrientationName(vertex.getSide()));
                // }
<span class="nc" id="L311">            }</span>

<span class="nc bnc" id="L313" title="All 2 branches missed.">            if (currentHexName != null) {</span>
<span class="nc" id="L314">                runPrettyPrint.append(&quot;)&quot;);</span>
            }

            // check revenueBonuses (complex)
<span class="nc" id="L318">            List&lt;RevenueBonus&gt; activeBonuses = new ArrayList&lt;RevenueBonus&gt;();</span>
<span class="nc bnc" id="L319" title="All 2 branches missed.">            for (RevenueBonus bonus : revenueAdapter.getRevenueBonuses()) {</span>
<span class="nc bnc" id="L320" title="All 2 branches missed.">                if (bonus.checkComplexBonus(vertices, train.getRailsTrain(),</span>
<span class="nc" id="L321">                        revenueAdapter.getPhase())) {</span>
<span class="nc" id="L322">                    activeBonuses.add(bonus);</span>
                }
<span class="nc" id="L324">            }</span>
<span class="nc" id="L325">            Map&lt;String, Integer&gt; printBonuses =</span>
<span class="nc" id="L326">                    RevenueBonus.combineBonuses(activeBonuses);</span>
<span class="nc bnc" id="L327" title="All 2 branches missed.">            for (String bonusName : printBonuses.keySet()) {</span>
<span class="nc" id="L328">                runPrettyPrint.append(&quot; + &quot;);</span>
<span class="nc" id="L329">                runPrettyPrint.append(bonusName).append(&quot;(&quot;).append(printBonuses.get(bonusName)).append(&quot;)&quot;);</span>
<span class="nc" id="L330">                multiple =</span>
<span class="nc" id="L331">                        prettyPrintNewLine(runPrettyPrint, multiple, initLength);</span>
<span class="nc" id="L332">            }</span>
<span class="nc" id="L333">            runPrettyPrint.append(&quot;\n&quot;);</span>
        }

<span class="nc" id="L336">        return runPrettyPrint.toString();</span>
    }

    GeneralPath getAsPath(HexMap map) {
<span class="nc" id="L340">        GeneralPath path = new GeneralPath();</span>
<span class="nc bnc" id="L341" title="All 2 branches missed.">        for (NetworkEdge edge : edges) {</span>
            // check vertices if they exist as points and start from there
<span class="nc" id="L343">            List&lt;NetworkVertex&gt; edgeVertices = edge.getVertexPath();</span>
<span class="nc" id="L344">            boolean initPath = false;</span>
<span class="nc bnc" id="L345" title="All 2 branches missed.">            for (NetworkVertex edgeVertex : edgeVertices) {</span>
<span class="nc" id="L346">                Point2D edgePoint =</span>
<span class="nc" id="L347">                        NetworkVertex.getVertexPoint2D(map, edgeVertex);</span>
<span class="nc bnc" id="L348" title="All 2 branches missed.">                if (edgePoint == null) continue;</span>
<span class="nc bnc" id="L349" title="All 2 branches missed.">                if (!initPath) {</span>
<span class="nc" id="L350">                    path.moveTo((float) edgePoint.getX(),</span>
<span class="nc" id="L351">                            (float) edgePoint.getY());</span>
<span class="nc" id="L352">                    initPath = true;</span>
                } else {
<span class="nc" id="L354">                    path.lineTo((float) edgePoint.getX(),</span>
<span class="nc" id="L355">                            (float) edgePoint.getY());</span>
                }
<span class="nc" id="L357">            }</span>
<span class="nc" id="L358">        }</span>
<span class="nc" id="L359">        return path;</span>
    }

    public int compareTo(RevenueTrainRun other) {
<span class="nc" id="L363">        return ((Integer) this.getRunValue()).compareTo(other.getRunValue());</span>
    }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>