<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="de"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>NetworkIterator.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Rails</a> &gt; <a href="index.source.html" class="el_package">net.sf.rails.algorithms</a> &gt; <span class="el_source">NetworkIterator.java</span></div><h1>NetworkIterator.java</h1><pre class="source lang-java linenums">package net.sf.rails.algorithms;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.NoSuchElementException;

import net.sf.rails.game.PublicCompany;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.jgrapht.*;
import org.jgrapht.traverse.*;


public class NetworkIterator extends AbstractGraphIterator&lt;NetworkVertex, NetworkEdge&gt; {
<span class="fc" id="L18">    private static final Logger log = LoggerFactory.getLogger(NetworkIterator.class);</span>

<span class="fc" id="L20">    public static enum greedyState {</span>
<span class="fc" id="L21">        SEEN,</span>
<span class="fc" id="L22">        NON_GREEDY,</span>
<span class="fc" id="L23">        GREEDY,</span>
<span class="fc" id="L24">        DONE</span>
    }

    // settings
    private NetworkVertex startVertex;
    private boolean startVertexVisited;
    private boolean routeIterator;

    // internal data
<span class="fc" id="L33">    private List&lt;NetworkVertex&gt; stack = new ArrayList&lt;NetworkVertex&gt;();</span>
<span class="fc" id="L34">    private List&lt;Boolean&gt; greedyStack = new ArrayList&lt;Boolean&gt;();</span>
<span class="fc" id="L35">    private Map&lt;NetworkVertex, greedyState&gt; seen = new HashMap&lt;NetworkVertex, greedyState&gt;();</span>


    private final Graph&lt;NetworkVertex, NetworkEdge&gt; graph;

    public NetworkIterator(Graph&lt;NetworkVertex, NetworkEdge&gt; graph,
            NetworkVertex startVertex) {
<span class="nc" id="L42">        this(graph, startVertex, null);</span>
<span class="nc" id="L43">    }</span>

    /**
     * Returns NetworkIterator for specific company
     */
    public NetworkIterator(Graph&lt;NetworkVertex, NetworkEdge&gt; graph, NetworkVertex startVertex,
            PublicCompany company) {
<span class="fc" id="L50">        super(graph);</span>

<span class="pc bpc" id="L52" title="1 of 2 branches missed.">        if (graph == null)</span>
<span class="nc" id="L53">            throw new IllegalArgumentException(&quot;graph must not be null&quot;);</span>

<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (!graph.containsVertex(startVertex))</span>
<span class="nc" id="L56">            throw new IllegalArgumentException(&quot;graph must contain the start vertex&quot;);</span>

<span class="fc" id="L58">        this.graph = graph;</span>
<span class="fc" id="L59">        this.startVertex = startVertex;</span>
<span class="fc" id="L60">        this.startVertexVisited = false;</span>
<span class="fc" id="L61">        this.routeIterator = false;</span>
<span class="fc" id="L62">    }</span>

    NetworkIterator setRouteIterator(boolean routeIterator) {
<span class="nc" id="L65">        this.routeIterator = routeIterator;</span>
<span class="nc" id="L66">        return this;</span>
    }

    /**
     * @return the graph being traversed
     */
    public Graph&lt;NetworkVertex, NetworkEdge&gt; getGraph() {
<span class="nc" id="L73">        return graph;</span>
    }

    public Map&lt;NetworkVertex, greedyState&gt; getSeenData() {
<span class="nc" id="L77">        return seen;</span>
    }

    public List&lt;NetworkVertex&gt; getCurrentRoute() {
        // extract all networkvertices just before a null
<span class="nc" id="L82">        List&lt;NetworkVertex&gt; route = new ArrayList&lt;NetworkVertex&gt;();</span>
<span class="nc" id="L83">        NetworkVertex previousVertex = null;</span>
<span class="nc bnc" id="L84" title="All 2 branches missed.">        for (NetworkVertex vertex:stack) {</span>
<span class="nc bnc" id="L85" title="All 4 branches missed.">            if (previousVertex != null &amp;&amp; vertex == null) {</span>
<span class="nc" id="L86">                route.add(previousVertex);</span>
            }
<span class="nc" id="L88">            previousVertex = vertex;</span>
<span class="nc" id="L89">        }</span>
<span class="nc" id="L90">        return route;</span>
    }

    /**
     * @see java.util.Iterator#hasNext()
     */
    public boolean hasNext() {
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (!startVertexVisited) {</span>
<span class="fc" id="L98">            encounterStartVertex();</span>
        }

<span class="fc" id="L101">        int i = stack.size() - 1;</span>
<span class="fc bfc" id="L102" title="All 2 branches covered.">        while (i &gt;= 0) {</span>
<span class="fc bfc" id="L103" title="All 2 branches covered.">            if (stack.get(i) != null)</span>
<span class="fc" id="L104">                break;</span>
            else
<span class="fc" id="L106">                i = i - 2;</span>
        }
<span class="fc bfc" id="L108" title="All 2 branches covered.">        return i &gt;=0;</span>
    }

    /**
     * @see java.util.Iterator#next()
     */
    public NetworkVertex next()
    {
<span class="pc bpc" id="L116" title="1 of 2 branches missed.">        if (!startVertexVisited) {</span>
<span class="nc" id="L117">            encounterStartVertex();</span>
        }

<span class="pc bpc" id="L120" title="1 of 2 branches missed.">        if (hasNext()) {</span>
            NetworkVertex nextVertex;
            while (true) {
<span class="fc" id="L123">                 nextVertex = stack.remove(stack.size() - 1);</span>
<span class="fc bfc" id="L124" title="All 2 branches covered.">                if (nextVertex != null)</span>
<span class="fc" id="L125">                    break;</span>
<span class="fc" id="L126">                stack.remove(stack.size() - 1);</span>
            }

<span class="fc" id="L129">            log.debug(&quot;Iterator: provides next vertex{}&quot;, nextVertex);</span>
<span class="fc" id="L130">            boolean nextGreedy = greedyStack.remove(greedyStack.size() - 1);</span>

<span class="fc" id="L132">            putSeenData(nextVertex, nextGreedy);</span>
<span class="fc" id="L133">            stack.add(nextVertex);</span>
<span class="fc" id="L134">            stack.add(null); // add sentinel that we know when we are ready</span>

<span class="fc" id="L136">            addUnseenChildrenOf(nextVertex, nextGreedy);</span>

<span class="fc" id="L138">            return nextVertex;</span>
        } else {
<span class="nc" id="L140">            throw new NoSuchElementException();</span>
        }
    }


    private void putSeenData(NetworkVertex vertex, boolean greedy) {
<span class="fc bfc" id="L146" title="All 2 branches covered.">        if (!vertex.isSide()) {</span>
<span class="fc" id="L147">            seen.put(vertex, greedyState.SEEN);</span>
<span class="fc" id="L148">            log.debug(&quot;Iterator:  Vertex {} seen with greedyState = seen&quot;, vertex);</span>
<span class="fc" id="L149">            return;</span>
        }
        // side
<span class="fc bfc" id="L152" title="All 2 branches covered.">        if (seen.containsKey(vertex)){</span>
<span class="fc" id="L153">            seen.put(vertex, greedyState.DONE);</span>
<span class="fc" id="L154">            log.debug(&quot;Iterator:  Vertex {} seen with greedyState = done&quot;, vertex);</span>
<span class="fc bfc" id="L155" title="All 2 branches covered.">        } else if (greedy) {</span>
<span class="fc" id="L156">            seen.put(vertex, greedyState.GREEDY);</span>
<span class="fc" id="L157">            log.debug(&quot;Iterator:  Vertex {} seen with greedyState = greedy&quot;, vertex);</span>
        } else {
<span class="fc" id="L159">            seen.put(vertex, greedyState.NON_GREEDY);</span>
<span class="fc" id="L160">            log.debug(&quot;Iterator:  Vertex {} seen with greedyState = nonGreedy&quot;, vertex);</span>
        }
<span class="fc" id="L162">    }</span>

    private void addUnseenChildrenOf(NetworkVertex vertex, boolean greedy) {

<span class="fc bfc" id="L166" title="All 2 branches covered.">        if (vertex.isSink()) return;</span>
<span class="fc" id="L167">        log.debug(&quot;Iterator: Add unseen children of {}&quot;, vertex);</span>

<span class="fc bfc" id="L169" title="All 2 branches covered.">        for (NetworkEdge edge : graph.edgesOf(vertex)) {</span>
<span class="fc" id="L170">            log.debug(&quot;Iterator: Check edge for neighbor in edge {}&quot;, edge.toFullInfoString());</span>
<span class="fc bfc" id="L171" title="All 4 branches covered.">            if (!greedy || edge.isGreedy()) {</span>
<span class="fc" id="L172">                NetworkVertex oppositeV = Graphs.getOppositeVertex(graph, edge, vertex);</span>
<span class="fc" id="L173">                log.debug(&quot;Iterator: Neighbor is {}&quot;, oppositeV);</span>
<span class="fc" id="L174">                encounterVertex(oppositeV, edge);</span>
            }
<span class="fc" id="L176">        }</span>
<span class="fc" id="L177">    }</span>

    private void encounterStartVertex() {
<span class="fc" id="L180">        putSeenData(startVertex, false);</span>
<span class="fc" id="L181">        stack.add(startVertex);</span>
<span class="fc" id="L182">        greedyStack.add(false);</span>
<span class="fc" id="L183">        log.debug(&quot;Iterator: Added to stack {} with greedy set to false&quot;, startVertex);</span>
<span class="fc" id="L184">        startVertexVisited = true;</span>
<span class="fc" id="L185">    }</span>


    private void encounterVertex(NetworkVertex v, NetworkEdge e){

<span class="pc bpc" id="L190" title="1 of 2 branches missed.">        if (routeIterator) {</span>
//            if (v == startVertex) return;
            // check the stack
<span class="nc bnc" id="L193" title="All 2 branches missed.">            if (getCurrentRoute().contains(v))</span>
<span class="nc" id="L194">                return;</span>
            // check the seen components
//            if (seen.containsKey(v) &amp;&amp; (seen.get(v) == greedyState.seen &amp;&amp; !v.isSink()
//                    || seen.get(v) == greedyState.done || (e.isGreedy() &amp;&amp; seen.get(v) == greedyState.nonGreedy)
//                    || (!e.isGreedy() &amp;&amp; seen.get(v) == greedyState.greedy) )) {
//                log.debug(&quot;Do not add vertex &quot; + v  + &quot; to stack&quot;);
//                return;
//            }
        } else {
<span class="fc bfc" id="L203" title="All 2 branches covered.">            if (stack.contains(v)) return;</span>
<span class="pc bpc" id="L204" title="2 of 10 branches missed.">            if (v.isSide() &amp;&amp; seen.containsKey(v) &amp;&amp; (seen.get(v) == greedyState.DONE || (e.isGreedy() &amp;&amp; seen.get(v) == greedyState.NON_GREEDY)</span>
<span class="fc bfc" id="L205" title="All 4 branches covered.">                    || (!e.isGreedy() &amp;&amp; seen.get(v) == greedyState.GREEDY) )) {</span>
<span class="fc" id="L206">                log.debug(&quot;Leave vertex {} due to greedState rules&quot;, v);</span>
<span class="fc" id="L207">                return;</span>
            }
        }
<span class="fc" id="L210">        stack.add(v);</span>
<span class="fc bfc" id="L211" title="All 4 branches covered.">        greedyStack.add(v.isSide() &amp;&amp; !e.isGreedy());</span>
<span class="fc bfc" id="L212" title="All 4 branches covered.">        log.debug(&quot;Iterator: Added to stack {} with greedy set to {}&quot;, v, v.isSide() &amp;&amp; !e.isGreedy());</span>
<span class="fc" id="L213">    }</span>

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.5.201910111838</span></div></body></html>